# -*- ck2.decisions -*-

decisions = {
	emf_create_leon = {
		ai = no
		potential = { always = no }
		effect = {}
	}

	emf_create_castille = {
		ai = no
		potential = { always = no }
		effect = {}
	}

	emf_create_portugal = {
		ai = no
		potential = { always = no }
		effect = {}
	}

	emf_create_aragon = {
		ai = no
		potential = { always = no }
		effect = {}
	}

	emf_create_powys = {
		only_playable = yes
		is_high_prio = yes
		ai_check_interval = 120

		potential = {
			lower_tier_than = KING
			OR = {
				has_landed_title = d_powys
				has_landed_title = c_powys_wenwynwyn
				has_landed_title = c_rhwng
				has_landed_title = c_buellt
				has_landed_title = c_shrewsbury
				has_landed_title = c_hereford
			}
			d_powys = {
				NAND = {
					c_powys_wenwynwyn = { de_jure_liege = PREV }
					c_rhwng = { de_jure_liege = PREV }
					c_buellt = { de_jure_liege = PREV }
					c_shrewsbury = { de_jure_liege = PREV }
					c_hereford = { de_jure_liege = PREV }
				}
				OR = {
					has_holder = no
					holder = ROOT
				}
			}
			has_random_dejure_or_title_names = no
			emf_hiprio_decision_basic_potential = yes
		}
		allow = {
			is_adult = yes
			independent = yes
			trigger_if = {
				limit = { ai = no }
				war = no
				prisoner = no
				has_regent = no
			}
			trigger_else = {
				is_primary_war_defender = no
			}
			is_incapable = no
			trigger_if = {
				limit = { ai = no }
				prestige >= 500
			}
			custom_tooltip = {
				text = NEEDS_100_GOLD_COST
				wealth >= 100
			}
			custom_tooltip = {
				text = DIRECTLY_HOLDS_AT_LEAST_3_OF_THE_POWYS_COUNTIES_SWMH
				calc_true_if = {
					amount = 3
					has_landed_title = c_powys_wenwynwyn
					has_landed_title = c_rhwng
					has_landed_title = c_buellt
					has_landed_title = c_shrewsbury
					has_landed_title = c_hereford
				}
			}
			trigger_if = {
				limit = { NOT = { has_landed_title = c_powys_wenwynwyn } }
				c_powys_wenwynwyn = { owner_under_ROOT = yes }
			}
			trigger_if = {
				limit = { NOT = { has_landed_title = c_rhwng } }
				c_rhwng = { owner_under_ROOT = yes }
			}
			trigger_if = {
				limit = { NOT = { has_landed_title = c_buellt } }
				c_buellt = { owner_under_ROOT = yes }
			}
			trigger_if = {
				limit = { NOT = { has_landed_title = c_shrewsbury } }
				c_shrewsbury = { owner_under_ROOT = yes }
			}
			trigger_if = {
				limit = { NOT = { has_landed_title = c_hereford } }
				c_hereford = { owner_under_ROOT = yes }
			}
		}
		effect = {
			wealth = -100
			prestige = 250
			d_powys = {
				c_powys_wenwynwyn = {
					show_scope_change = no
					if = {
						limit = { NOT = { de_jure_liege = PREV } }
						de_jure_liege = PREV
					}
				}
				c_rhwng = {
					show_scope_change = no
					if = {
						limit = { NOT = { de_jure_liege = PREV } }
						de_jure_liege = PREV
					}
				}
				c_buellt = {
					show_scope_change = no
					if = {
						limit = { NOT = { de_jure_liege = PREV } }
						de_jure_liege = PREV
					}
				}
				c_shrewsbury = {
					show_scope_change = no
					if = {
						limit = { NOT = { de_jure_liege = PREV } }
						de_jure_liege = PREV
					}
				}
				c_hereford = {
					show_scope_change = no
					if = {
						limit = { NOT = { de_jure_liege = PREV } }
						de_jure_liege = PREV
					}
				}
			}
			primary_title = {
				d_powys = {
					show_scope_change = no
					if = {
						limit = { has_holder = no }
						hidden_effect = {
							if = {
								limit = { NOT = { is_title_active = THIS } }
								activate_title = { title = THIS status = yes }
							}
						}
						grant_title = ROOT
						copy_title_laws = PREV
					}
				}
			}
		}
		ai_will_do = {
			factor = 10
		}
	}

	emf_create_amalfi = {
		only_independent = yes
		is_high_prio = yes
		ai_check_interval = 60

		potential = {
			is_merchant_republic = yes
			has_landed_title = d_amalfi
			tier = DUKE
			k_amalfi = {
				has_holder = no
				is_de_jure_title = no
			}
			has_random_dejure_or_title_names = no
			emf_hiprio_decision_basic_potential = yes
		}
		allow = {
			is_adult = yes
			independent = yes
			trigger_if = {
				limit = { ai = no }
				war = no
				has_regent = no
			}
			trigger_else = {
				is_primary_war_defender = no
			}
			prisoner = no
			is_incapable = no
			trigger_if = {
				limit = { ai = no }
				prestige >= 500
				custom_tooltip = {
					text = NEEDS_500_GOLD_COST
					wealth >= 500
				}
			}
			has_landed_title = c_amalfi
			k_amalfi = {
				show_scope_change = no
				c_napoli = {
					show_scope_change = no
					OR = {
						ROOT = {
							show_scope_change = no
							has_landed_title = PREV
						}
						custom_tooltip = {
							text = THIS_WONT_BECOME_DE_JURE_VASSAL_OF_PREV
							NOT = { holder = ROOT }
						}
					}
				}
			}
			OR = {
				num_of_duke_titles >= 2
				num_of_count_titles_in_realm >= 4
			}
		}
		effect = {
			k_amalfi = { save_event_target_as = emf_new_title }
			c_amalfi = { dejure_liege_title = { save_event_target_as = emf_old_duchy } }
			if = {
				limit = { ai = no }
				wealth = -500
			}
			c_amalfi = {
				show_scope_change = no
				de_jure_liege = d_amalfi 
			}
			c_napoli = {
				show_scope_change = no
				if = {
					limit = { holder = ROOT }
					de_jure_liege = d_amalfi
				}
				else = {
					custom_tooltip = { text = THIS_WOULD_BECOME_PART_OF_NEW_TITLE_IF_YOU_HELD_IT }
					de_jure_liege = d_capua
				}
			}
			d_amalfi = {
				show_scope_change = no
				de_jure_liege = k_amalfi
				hidden_effect = { set_preferred_capital = c_amalfi }
			}
			primary_title = {
				k_amalfi = {
					show_scope_change = no
					hidden_effect = {
						if = {
							limit = { NOT = { is_title_active = THIS } }
							activate_title = { title = THIS status = yes }
						}
					}
					grant_title = { target = ROOT type = created }
					copy_title_laws = PREV
					hidden_effect = { set_preferred_capital = c_amalfi }
				}
			}
			hidden_effect = {
				# Deactivate the old duchy (d_napoli) if it's no longer de jure and is unheld or held by ROOT 
				event_target:emf_old_duchy = {
					if = {
						limit = {
							OR = {
								has_holder = no
								holder = ROOT
							}
							is_de_jure_title = no
						}
						if = {
							limit = { holder = ROOT }
							emf_destroy_title = yes
						}
						activate_title = { title = THIS status = no }
					}
				}
				narrative_event = { id = HFP.40015 }
			}
		}
	}
}
