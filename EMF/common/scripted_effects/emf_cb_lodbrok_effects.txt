# -*- ck2.scripted_effects -*-

# This CB needs to repeat its main success effect (which is upon a duchy title) as well as allow
# an arbitrary character to be treated as the subjugator of those duchy titles (i.e., not just
# ROOT / receiver [of just cause] in the casus belli).
#
# THIS = duchy title to subjugate & settle & usurp/create
# ROOT = primary attacker in war
# FROM = primary defender in war
# event_target:emf_receiver = the guy to whom the bitches should bow (usually at least ROOT)
emf_cb_lodbrok_invasion_on_success_duchy = {
	save_event_target_as = emf_lodbrok_duchy
	emf_cb_latb = yes
	pf_liege_change_under_title_begin_effect = yes

	custom_tooltip = {
		text = other_invasion_succ_tip
		hidden_tooltip = {

			any_direct_de_jure_vassal_title = {
				limit = { owner_under_FROM = yes }
				set_title_flag = emf_taken_county_tmp
			}

			emf_cb_lodbrok_invasion_on_success_duchy_vassalize_or_take_under_title = yes

			event_target:emf_receiver = {
				#vassalize_or_take_under_title = {
				#	title = PREV
				#	enemy = FROM
				#	type = invasion
				#	is_crusade = yes
				#}
				random_realm_title = {
					limit = {
						# Skip settlement / cul+rel flip step if we somehow are no longer Norse
						event_target:emf_receiver = { religion = norse_pagan }
						# Just counties taken in the duchy
						tier = COUNT
						has_title_flag = emf_taken_county_tmp
						# That do not have both our (Norse/Germanic) culture and religion
						location = {
							NAND = {
								culture = event_target:emf_receiver
								religion = event_target:emf_receiver
							}
						}
						# Take my own counties (I surely gained some in previous phase), or else take
						# an infidel's county.
						owner = {
							OR = {
								character = event_target:emf_receiver
								NOT = { religion = event_target:emf_receiver }
							}
						}
					}
					# We probably (always, realistically?) already own this county we're settling (we took it in the
					# previous phase which emulates a vassalize_or_take_under_title), but in case we don't,
					# subjugated Saxon lords are about to lose their title(s)...
					usurp_title_plus_barony_if_unlanded = { target = event_target:emf_receiver type = invasion }
					any_direct_de_jure_vassal_title = {
						limit = {
							owner = {
								is_liege_or_above = event_target:emf_receiver
								NOT = { religion = event_target:emf_receiver }
							}
						}
						gain_title = { target = event_target:emf_receiver type = invasion }
					}
					# Get that Anglo-Norse all seeded and shit
					# (Norse + Anglo-Saxons will make Anglo-Danish / Anglo-Norse babies)
					location = {
						culture = event_target:emf_receiver
						religion = event_target:emf_receiver
					}
				}
			}

			# In same spirit as the viking_invasion CB, refill the levies in the conquered-to-be-settled lands
			# and ease the occupation malus. 
			any_de_jure_vassal_title = {
				limit = {
					tier = BARON
					dejure_liege_title = { has_title_flag = emf_taken_county_tmp }
					owner_under_PREV = yes # but seriously, we did take it / control it
				}
				remove_holding_modifier = recently_conquered
				refill_holding_levy = yes
				set_title_flag = emf_refill_levy
				event_target:emf_receiver = { character_event = { id = emf_core.40 days = 3 } } # refill levies again in 3 days
			}

			any_direct_de_jure_vassal_title = { clr_title_flag = emf_taken_county_tmp }

			# There are a few reasons to have the receiver try to usurp/create the duchy title itself, one of which is
			# the beautiful border gore that it'll hopefully produce when the initial vikings die.
			emf_cb_lodbrok_invasion_on_success_duchy_usurp = yes
		}
	}
	
	pf_liege_change_under_title_end_effect = yes
	clear_event_target = emf_lodbrok_duchy
}

emf_cb_lodbrok_invasion_on_success_duchy_vassalize_or_take_under_title = {
	any_de_jure_vassal_title = {
		limit = {
			owner = {
				under_FROM = yes
				OR = {
					any_realm_title = { # Seize title if holder has land outside duchy
						tier = BARON
						NOT = { de_jure_liege_or_above = event_target:emf_lodbrok_duchy }
					}
					NOT = { lower_real_tier_than = event_target:emf_receiver } # ... or can't be vassalized
				}
			}
		}
		if = {
			limit = { tier = COUNT }
			log = "---> [This.GetBaseName] ([This.GetID]) shall be TAKEN"
		}
		gain_title = { target = event_target:emf_receiver type = invasion }
	}
	# Anyone with titles remaining under FROM within the duchy should be subjugated
	any_de_jure_vassal = {
		limit = { under_FROM = yes }
		log = "---> [This.GetTitledFirstName] shall be SUBJUGATED"
		emf_ROOT_subjugate_ruler_effect = yes
	}
}

emf_cb_lodbrok_invasion_on_success_duchy_usurp = {
	if = {
		limit = {
			NOT = { holder = event_target:emf_receiver }
			OR = {
				has_holder = no
				event_target:emf_receiver = {
					OR = {
						AND = {
							num_of_realm_counties = { value = 1 title = PREV }
							event_target:emf_lodbrok_duchy = {
								NOT = { owner = { num_of_realm_counties = { value = 1 title = PREV } } }
							}
						}
						AND = {
							num_of_realm_counties = { value = 2 title = PREV }
							event_target:emf_lodbrok_duchy = {
								NOT = { owner = { num_of_realm_counties = { value = 2 title = PREV } } }
							}
						}
						AND = {
							num_of_realm_counties = { value = 3 title = PREV }
							event_target:emf_lodbrok_duchy = {
								NOT = { owner = { num_of_realm_counties = { value = 3 title = PREV } } }
							}
						}
						AND = {
							num_of_realm_counties = { value = 4 title = PREV }
							event_target:emf_lodbrok_duchy = {
								NOT = { owner = { num_of_realm_counties = { value = 4 title = PREV } } }
							}
						}
						AND = {
							num_of_realm_counties = { value = 5 title = PREV }
							event_target:emf_lodbrok_duchy = {
								NOT = { owner = { num_of_realm_counties = { value = 5 title = PREV } } }
							}
						}
					}
				}
			}
		}
		log = "---> [emf_receiver.GetTitledFirstName] shall usurp/create the [This.GetFullName] ([This.GetID])"
		if = {
			limit = { has_holder = yes }
			usurp_title_plus_barony_if_unlanded = { target = event_target:emf_receiver type = invasion }
		}
		if = {
			limit = { has_holder = no }
			grant_title = { target = event_target:emf_receiver type = created }
		}
	}
}
