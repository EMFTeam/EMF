# -*- ck2.scripted_effects -*-

# what on earth is "emf_revolt_spawn_troops_LI10_LC4_A6_scale100" ?
#
# read it as: spawn revolt troop composition of 10:4:6 LI:LC:A (light_infantry:light_cavalry:archers) scaled to 100% of
# biggest garrison size in province ROOT.
#
# all the rebel troop spawn effects follow this convention.
emf_revolt_spawn_troops_LI10_LC4_A6_scale100 = {
	spawn_unit = {
		province = ROOT
		home = ROOT
		owner = THIS
		scaled_by_biggest_garrison = 1.0
		troops = {
			archers = { 6 6 }
			light_cavalry = { 4 4 }
			light_infantry = { 10 10 }
		}
		attrition = 1.0
		cannot_inherit = yes
		disband_on_peace = yes
		earmark = emf_revolt
	}
	emf_revolt_spawn_peasant_leader_commander = yes
	new_character = {
		emf_new_character = yes
		spawn_unit = {
			province = ROOT
			home = ROOT
			owner = PREV
			scaled_by_biggest_garrison = 1.0
			troops = {
				archers = { 6 6 }
				light_cavalry = { 4 4 }
				light_infantry = { 10 10 }
			}
			attrition = 1.0
			disband_on_peace = yes
			earmark = emf_revolt
		}
	}
	emf_revolt_spawn_peasant_leader_commander = yes
	new_character = {
		emf_new_character = yes
		spawn_unit = {
			province = ROOT
			home = ROOT
			owner = PREV
			scaled_by_biggest_garrison = 1.0
			troops = {
				archers = { 6 6 }
				light_cavalry = { 4 4 }
				light_infantry = { 10 10 }
			}
			attrition = 1.0
			disband_on_peace = yes
			earmark = emf_revolt
		}
	}
}
emf_revolt_spawn_troops_LI12_LC2_A6_scale100 = {
	spawn_unit = {
		province = ROOT
		home = ROOT
		owner = THIS
		scaled_by_biggest_garrison = 1.0
		troops = {
			archers = { 6 6 }
			light_cavalry = { 2 2 }
			light_infantry = { 12 12 }
		}
		attrition = 1.0
		cannot_inherit = yes
		disband_on_peace = yes
		earmark = emf_revolt
	}
	emf_revolt_spawn_peasant_leader_commander = yes
	new_character = {
		emf_new_character = yes
		spawn_unit = {
			province = ROOT
			home = ROOT
			owner = PREV
			scaled_by_biggest_garrison = 1.0
			troops = {
				archers = { 6 6 }
				light_cavalry = { 2 2 }
				light_infantry = { 12 12 }
			}
			attrition = 1.0
			disband_on_peace = yes
			earmark = emf_revolt
		}
	}
	emf_revolt_spawn_peasant_leader_commander = yes
	new_character = {
		emf_new_character = yes
		spawn_unit = {
			province = ROOT
			home = ROOT
			owner = PREV
			scaled_by_biggest_garrison = 1.0
			troops = {
				archers = { 6 6 }
				light_cavalry = { 2 2 }
				light_infantry = { 12 12 }
			}
			attrition = 1.0
			disband_on_peace = yes
			earmark = emf_revolt
		}
	}
}
emf_revolt_spawn_troops_LI14_A6_scale100 = {
	spawn_unit = {
		province = ROOT
		home = ROOT
		owner = THIS
		scaled_by_biggest_garrison = 1.0
		troops = {
			archers = { 6 6 }
			light_infantry = { 14 14 }
		}
		attrition = 1.0
		cannot_inherit = yes
		disband_on_peace = yes
		earmark = emf_revolt
	}
	emf_revolt_spawn_peasant_leader_commander = yes
	new_character = {
		emf_new_character = yes
		spawn_unit = {
			province = ROOT
			home = ROOT
			owner = PREV
			scaled_by_biggest_garrison = 1.0
			troops = {
				archers = { 6 6 }
				light_infantry = { 14 14 }
			}
			attrition = 1.0
			disband_on_peace = yes
			earmark = emf_revolt
		}
	}
	emf_revolt_spawn_peasant_leader_commander = yes
	new_character = {
		emf_new_character = yes
		spawn_unit = {
			province = ROOT
			home = ROOT
			owner = PREV
			scaled_by_biggest_garrison = 1.0
			troops = {
				archers = { 6 6 }
				light_infantry = { 14 14 }
			}
			attrition = 1.0
			disband_on_peace = yes
			earmark = emf_revolt
		}
	}
}

# event_target:emf_province
emf_revolt_spawn_post_siege_reinforcements = {
	FROM = {
		location = {
			ROOT = {
				spawn_unit = {
					province = PREV
					home = PREV
					owner = THIS
					scaled_by_biggest_garrison = 0.5
					troops = {
						archers = { 10 10 }
						light_infantry = { 10 10 }
					}
					attrition = 1.0
					disband_on_peace = yes
					earmark = emf_revolt
				}
			}
		}
	}
}

emf_revolt_spawn_peasant_leader_commander = {
	random_list = {
		20 = { emf_revolt_spawn_peasant_leader_commander_young = yes }
		30 = { emf_revolt_spawn_peasant_leader_commander_mid = yes }
		15 = { emf_revolt_spawn_peasant_leader_commander_old = yes }
	}
}
emf_revolt_spawn_peasant_leader_commander_young = {
	create_character = {
		random_traits = yes
		dynasty = none
		religion = THIS
		culture = THIS
		female = no
		age = 23
		trait = peasant_leader
		trait = tough_soldier
	}
	new_character = {
		random = { chance = 33 remove_trait = tough_soldier add_trait = skilled_tactician }
	}
}
emf_revolt_spawn_peasant_leader_commander_mid = {
	create_character = {
		random_traits = yes
		dynasty = none
		religion = THIS
		culture = THIS
		female = no
		age = 32
		trait = peasant_leader
		trait = tough_soldier
	}
	new_character = {
		random = { chance = 33 remove_trait = tough_soldier add_trait = skilled_tactician }
	}
}
emf_revolt_spawn_peasant_leader_commander_old = {
	create_character = {
		random_traits = yes
		dynasty = none
		religion = THIS
		culture = THIS
		female = no
		age = 50
		trait = peasant_leader
		trait = tough_soldier
	}
	new_character = {
		random = { chance = 33 remove_trait = tough_soldier add_trait = skilled_tactician }
	}
}

# expects intended religion and culture to be stored in event_target:emf_spawn_relcul
emf_spawn_religious_revolt_leader = {
	random_list = {
		20 = {
			create_character = {
				age = 32
				random_traits = yes
				dynasty = none
				religion = event_target:emf_spawn_relcul
				culture = event_target:emf_spawn_relcul
				female = no
				health = 7
				attributes = {
					martial = 7
					learning = 7
				}
				trait = peasant_leader
			}
		}
		10 = {
			create_character = {
				age = 42
				random_traits = yes
				dynasty = none
				religion = event_target:emf_spawn_relcul
				culture = event_target:emf_spawn_relcul
				female = no
				health = 7
				attributes = {
					martial = 7
					learning = 7
				}
				trait = peasant_leader
			}
		}
		10 = {
			create_character = {
				age = 27
				random_traits = yes
				dynasty = none
				religion = event_target:emf_spawn_relcul
				culture = event_target:emf_spawn_relcul
				female = no
				health = 7
				attributes = {
					martial = 7
					learning = 7
				}
				trait = peasant_leader
			}
		}
		10 = {
			create_character = {
				age = 50
				random_traits = yes
				dynasty = none
				religion = event_target:emf_spawn_relcul
				culture = event_target:emf_spawn_relcul
				female = no
				health = 7
				attributes = {
					martial = 7
					learning = 7
				}
				trait = peasant_leader
			}
		}
	}
}

emf_customize_spawned_religious_revolt_leader = {
	emf_remove_education_traits = yes
	random_list = {
		10 = { add_trait = tough_soldier }
		25 = { add_trait = skilled_tactician }
		10 = { add_trait = brilliant_strategist }
		10 = { add_trait = martial_cleric }
		25 = { add_trait = scholarly_theologian }
	}
	emf_remove_leadership_traits = yes
	add_trait = holy_warrior
	if = {
		limit = { NOR = { trait = martial_cleric trait = scholarly_theologian } }
		event_target:emf_revolt_origin = {
			random_list = {
				100 = {
					trigger = { OR = { terrain = plains terrain = farmlands terrain = steppe } }
					ROOT = { add_trait = flat_terrain_leader }
				}
				100 = {
					trigger = { OR = { terrain = forest terrain = hills } }
					ROOT = { add_trait = rough_terrain_leader }
				}
				100 = {
					trigger = { terrain = mountain }
					ROOT = { add_trait = mountain_terrain_leader }
				}
				100 = {
					trigger = { terrain = desert }
					ROOT = { add_trait = desert_terrain_leader }
				}
				100 = {
					trigger = { terrain = jungle }
					ROOT = { add_trait = jungle_terrain_leader }
				}
				1 = { }
			}
		}
	}
	if = {
		limit = {
			OR = {
				trait = brilliant_strategist
				NOT = { event_target:emf_revolt_origin = { always = yes } }
			}
		}
		random_list = {
			10 = { add_trait = inspiring_leader }
			10 = { add_trait = light_foot_leader }
			10 = { add_trait = organizer }
			10 = { add_trait = siege_leader }
			20 = { }
		}
	}
	emf_remove_lifestyle_traits = yes
	random_list = {
		15 = { add_trait = theologian }
		10 = { add_trait = scholar }
		10 = { add_trait = duelist }
		5  = { add_trait = socializer }
		5  = { }
	}
	add_trait = zealous
	remove_trait = craven
	remove_trait = slothful
	random = { chance = 50 add_trait = brave }
	random_list = {
		30 = { }
		10 = { add_trait = quick }
		2 = { add_trait = genius }
	}
	random = { chance = 20 add_trait = strong remove_trait = feeble }
	emf_new_character = yes
	add_trait = peasant_leader
	set_character_flag = emf_religious_revolt_leader
}

emf_cb_religious_revolt_cleanup = {
	hidden_tooltip = {
		ROOT = {
			disband_event_forces = emf_revolt
			clr_character_flag = emf_religious_revolt_leader
			set_character_flag = emf_was_religious_revolt_leader
			any_claim = {
				limit = {
					tier = COUNT
					ROOT = { has_strong_claim = PREV }
				}
				remove_claim = ROOT
			}
		}
	}
}

emf_cb_religious_revolt_take_province = {
	county = {
		ROOT = {
			vassalize_or_take_under_title = {
				title = PREV
				enemy = FROM
				same_religion = yes
				is_religious = yes
				type = revolt
			}
		}
		usurp_title_plus_barony_if_unlanded = { target = ROOT type = revolt }
	}
}

emf_cb_religious_revolt_on_success = {
	ROOT = {
		prestige = 200
		piety = 100
		occupy_minors_of_occupied_settlements = FROM
		# Setup emf_revolt_tmp_claim/capital flags & create a titular duchy
		hidden_tooltip = { character_event = { id = emf_revolt.20 } }
		FROM = {
			random_realm_province = {
				limit = { has_province_flag = emf_revolt_tmp_capital }
				emf_cb_religious_revolt_take_province = yes
				ROOT = { capital = PREV }
			}
			while = {
				limit = {
					any_realm_province = {
						has_province_flag = emf_revolt_tmp_claim
						owner = {
							religion = ROOT
							lower_tier_than = ROOT
							in_revolt = no
							is_patrician = no
							NOT = {
								any_demesne_province = {
									NOT = { has_province_flag = emf_revolt_tmp_claim }
								}
							}
						}
					}
				}
				random_realm_province = {
					limit = {
						has_province_flag = emf_revolt_tmp_claim
						owner = {
							religion = ROOT
							lower_tier_than = ROOT
							in_revolt = no
							is_patrician = no
							NOT = {
								any_demesne_province = {
									NOT = { has_province_flag = emf_revolt_tmp_claim }
								}
							}
						}
					}
					owner = { emf_ROOT_subjugate_ruler = yes }
				}
			}
			any_realm_province = {
				limit = { has_province_flag = emf_revolt_tmp_claim }
				emf_cb_religious_revolt_take_province = yes
			}
		}
		# Setup the newly-acquired titles/vassals and realm
		hidden_tooltip = { character_event = { id = emf_revolt.25 } }
	}
	FROM = {
		prestige = -500
		piety = -250
		religion_authority = { modifier = lost_religious_revolt }
	}
}

