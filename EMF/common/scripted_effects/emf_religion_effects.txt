# -*- ck2.scripted_effects -*-

emf_ai_wrong_religion_liege_decision_effect = {
	# First try to transfer to a higher-tier liege that matches our religion:
	if = {
		limit = { top_liege = { religion = PREV } } # Note that liege of liege of a duke is an emperor
		top_liege = { set_defacto_vassal = PREV }
		set_flag = ai_flag_never_transfer
	}
	# Otherwise, go independent
	else = {
		liege = { save_event_target_as = emf_old_wrong_religion_liege_tmp }
		any_demesne_title = {
			limit = { emf_is_title_type_special = no }
			gain_title = { target = event_target:emf_old_wrong_religion_liege_tmp type = revoke }
			add_pressed_claim = PREV
		}
		clear_event_target = emf_old_wrong_religion_liege_tmp
		set_defacto_liege = THIS
	}
	emf_liege_change = yes
}

emf_fix_wrong_religion_lieges_in_realm = {
	any_realm_lord = {
		limit = { is_decision_potential = emf_ai_wrong_religion_liege }
		emf_ai_wrong_religion_liege_decision_effect = yes
	}
}

emf_set_theocracy_government_safe = {
	if = {
		limit = {
			NOR = {
				religion_group = muslim
				religion = hip_religion
			}
		}
		if = {
			limit = { is_government_potential = theocracy_government }
			set_government_type = theocracy_government
		}
		else = {
			random_list = {
				50 = {
					trigger = { religion_allows_female_temple_holders = yes }
					create_random_priest = {
						random_traits = yes
						religion = THIS
						culture = THIS
						female = yes
						flag = needs_fake_feudal_government
					}
				}
				50 = {
					trigger = { religion_allows_male_temple_holders = yes }
					create_random_priest = {
						random_traits = yes
						religion = THIS
						culture = THIS
						female = no
						flag = needs_fake_feudal_government
					}
				}
			}
			new_character = {
				emf_new_character_priest = yes
				wealth = PREV
				if = {
					limit = { event_target:emf_abdicate_real_heir = { always = yes } }
					event_target:emf_abdicate_real_heir = { save_event_target_as = emf_religion_swap_tmp }
				}
				save_event_target_as = emf_abdicate_real_heir
			}
			clear_wealth = yes
			emf_willfully_abdicate = yes
			event_target:emf_abdicate_real_heir = {
				set_government_type = theocracy_government
				clr_flag = needs_fake_feudal_government
			}
			if = {
				limit = { event_target:emf_religion_swap_tmp = { always = yes } }
				event_target:emf_religion_swap_tmp = { save_event_target_as = emf_abdicate_real_heir }
				clear_event_target = emf_religion_swap_tmp
			}
			else = {
				clear_event_target = emf_abdicate_real_heir
			}
		}
	}
}

emf_copy_caste_from_PREV = {
	if = {
		limit = { PREV = { trait = brahmin } }
		add_trait = brahmin
	}
	else_if = {
		limit = { PREV = { trait = kshatriya } }
		add_trait = kshatriya
	}
	else_if = {
		limit = { PREV = { trait = vaishya } }
		add_trait = vaishya
	}
}

emf_copy_caste_from_ROOT = {
	if = {
		limit = { ROOT = { trait = brahmin } }
		add_trait = brahmin
	}
	else_if = {
		limit = { ROOT = { trait = kshatriya } }
		add_trait = kshatriya
	}
	else_if = {
		limit = { ROOT = { trait = vaishya } }
		add_trait = vaishya
	}
}

emf_copy_caste_from_FROM = {
	if = {
		limit = { FROM = { trait = brahmin } }
		add_trait = brahmin
	}
	else_if = {
		limit = { FROM = { trait = kshatriya } }
		add_trait = kshatriya
	}
	else_if = {
		limit = { FROM = { trait = vaishya } }
		add_trait = vaishya
	}
}
