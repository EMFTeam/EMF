# -*- ck2.cb_types -*-

# This casus belli replaces the vanilla one, and instead uses a tier system to determine what kingdoms are valid targets
# To unlock a tier, all tiers before it have to be completely conquered
# Tier 1: Byzantium
# Tier 2: Balkans and Sicily
# Tier 3: Italy, Levant, and Eastern/Central North Africa
# Tier 4: Western North Africa and Iberia
# Tier 5: France
# Tier 6: England, Wales, and (southern) Germany
imperial_reconquest = {
	name = CB_NAME_IMPERIAL
	war_name = WAR_NAME_IMPERIAL
	sprite = 17
	truce_days = 1825
	is_permanent = yes
	# this scans all de-jure duchies for the counties which are held by OR vassals (OR below) of selected character.
	# Only valid if is_permanent = yes
	check_de_jure_tier = DUKE
	allowed_to_target_tributaries = no
	allowed_to_target_suzerains = no

	can_use_gui = {
		emf_cb_can_use_gui_trigger = yes
		ROOT = {
			prestige = 500
		}
	}

	can_use = {
		emf_cb_can_use_trigger = yes
		ROOT = {
			OR = {
				has_landed_title = e_byzantium
				has_landed_title = e_roman_empire
			}
			independent = yes
			religion_group = christian
			NOT = { same_realm = FROM }
			mercenary = no
		}
	}

	can_use_title = {
		emf_cb_can_use_de_jure_title_trigger = yes
		any_direct_de_jure_vassal_title = { owner_under_FROM = yes }
		OR = {
			region = emf_region_ir_tier_1
			AND = {
				NOT = {
					any_province = {
						region = emf_region_ir_tier_1
						owner_under_ROOT = no
					}
				}
				OR = {
					region = emf_region_ir_tier_2
					AND = {
						NOT = {
							any_province = {
								region = emf_region_ir_tier_2
								owner_under_ROOT = no
							}
						}
						OR = {
							region = emf_region_ir_tier_3
							AND = {
								NOT = {
									any_province = {
										region = emf_region_ir_tier_3
										owner_under_ROOT = no
									}
								}
								OR = {
									region = emf_region_ir_tier_4
									AND = {
										NOT = {
											any_province = {
												region = emf_region_ir_tier_4
												owner_under_ROOT = no
											}
										}
										OR = {
											region = emf_region_ir_tier_5
											AND = {
												region = emf_region_ir_tier_6
												NOT = {
													any_province = {
														region = emf_region_ir_tier_5
														owner_under_ROOT = no
													}
												}
											}
										}
									}
								}
							}
						}
					}
				}
			}
		}
	}

	is_valid = {
		ROOT = {
			OR = {
				has_landed_title = e_byzantium
				has_landed_title = e_roman_empire
			}
			independent = yes
			religion_group = christian
			NOT = { same_realm = FROM }
		}
	}
	
	is_valid_title = {
		any_de_jure_vassal_title = { owner_under_FROM = yes }
	}

	on_add = {
		log = "CB(imperial_reconquest): START: title=[FromFrom.GetID]: [Root.GetTitledFirstName] of [Root.PrimaryTitle.GetBaseName] ([Root.GetID]/[Root.PrimaryTitle.GetID]) vs. [From.GetTitledFirstName] of [From.PrimaryTitle.GetBaseName] ([From.GetID]/[From.PrimaryTitle.GetID])"
		ROOT = { prestige = -100 }
	}

	on_success = {
		log = "CB(imperial_reconquest): VICTORY: title=[FromFrom.GetID]: [Root.GetTitledFirstName] of [Root.PrimaryTitle.GetBaseName] ([Root.GetID]/[Root.PrimaryTitle.GetID]) vs. [From.GetTitledFirstName] of [From.PrimaryTitle.GetBaseName] ([From.GetID]/[From.PrimaryTitle.GetID])"
		emf_cb_victory_effect = yes
		emf_imperial_decay_victory_effect = yes
		any_attacker = {
			limit = { character = ROOT }
			participation_scaled_prestige = 100
		}
		any_attacker = {
			limit = { NOT = { character = ROOT } }
			hidden_tooltip = { participation_scaled_prestige = 100 }
		}
		FROM = { prestige = -100 }
	}

	on_success_title = {
		emf_cb_latb_effect = yes
		hidden_tooltip = {
			if = {
				limit = { owner_under_FROM = yes }
				set_title_flag = can_be_usurped_tmp
			}
		}
		custom_tooltip = {
			text = other_invasion_succ_tip
			hidden_tooltip = {
				pf_liege_change_under_title_begin_effect = yes
				ROOT = {
					vassalize_or_take_under_title = {
						title = PREV
						enemy = FROM
						type = invasion
					}
				}
				pf_liege_change_under_title_end_effect = yes
			}
		}
		hidden_tooltip = {
			if = {
				limit = {
					owner_under_ROOT = yes
					has_title_flag = can_be_usurped_tmp
				}
				usurp_title_only = {
					target = ROOT
					type = invasion
				}
			}
			clr_title_flag = can_be_usurped_tmp
		}
	}

	on_success_posttitle = { emf_cb_on_success_posttitle_effect = yes }

	on_fail = {
		log = "CB(imperial_reconquest): WHITEPEACE: title=[FromFrom.GetID]: [Root.GetTitledFirstName] of [Root.PrimaryTitle.GetBaseName] ([Root.GetID]/[Root.PrimaryTitle.GetID]) vs. [From.GetTitledFirstName] of [From.PrimaryTitle.GetBaseName] ([From.GetID]/[From.PrimaryTitle.GetID])"
		ROOT = { prestige = -200 }
	}

	on_reverse_demand = {
		log = "CB(imperial_reconquest): DEFEAT: title=[FromFrom.GetID]: [Root.GetTitledFirstName] of [Root.PrimaryTitle.GetBaseName] ([Root.GetID]/[Root.PrimaryTitle.GetID]) vs. [From.GetTitledFirstName] of [From.PrimaryTitle.GetBaseName] ([From.GetID]/[From.PrimaryTitle.GetID])"
		emf_cb_defeat_effect = yes
		emf_imperial_decay_loss_effect = yes
		ROOT = {
			transfer_scaled_wealth = {
				to = FROM
				value = 4.0
			}
			ROOT = { prestige = -250 }
		}
		any_defender = {
			limit = { character = FROM }
			participation_scaled_piety = 100
			participation_scaled_prestige = 250
			if = {
				limit = { uses_decadence = yes }
				participation_scaled_decadence = -10
			}
		}
		any_defender = {
			limit = { NOT = { character = FROM } }
			hidden_tooltip = {
				participation_scaled_piety = 100
				participation_scaled_prestige = 250
				if = {
					limit = { uses_decadence = yes }
					participation_scaled_decadence = -10
				}
			}
		}
	}

	on_invalidation = {
		log = "CB(imperial_reconquest): INVALIDATED: [Root.GetTitledFirstName] of [Root.PrimaryTitle.GetBaseName] ([Root.GetID]/[Root.PrimaryTitle.GetID]) vs. [From.GetTitledFirstName] of [From.PrimaryTitle.GetBaseName] ([From.GetID]/[From.PrimaryTitle.GetID])"
	}

	attacker_ai_victory_worth = {
		factor = -1 # always accept
	}

	attacker_ai_defeat_worth = {
		factor = 100
	}

	defender_ai_victory_worth = {
		factor = -1 # always accept
	}

	defender_ai_defeat_worth = {
		factor = 100
	}

	# ai importance placed on this CB: scope is the targeted title, ROOT is the attacking character, FROM is the defending character
	ai_will_do = {
		factor = 1
		modifier = {
			factor = 2
			any_direct_de_jure_vassal_title = {
				owner_under_FROM = yes
				location = { any_neighbor_province = { owner_under_ROOT = yes } }
			}
		}
		modifier = {
			factor = 1.25
			any_direct_de_jure_vassal_title = { owner_under_ROOT = yes }
		}
		modifier = {
			factor = 1.5
			ROOT = { trait = lucky_ruler }
		}
		modifier = {
			factor = 0.5 # Keep normal preference order under holy war if that CB is available
			FROM = {
				OR = {
					NOT = { religion_group = ROOT }
					is_heresy_of = ROOT
					is_parent_religion = ROOT
				}
			}
		}
		modifier = {
			factor = 10
			FROM = { ai = no }
			had_global_flag = { flag = EMF days = 730 }
		}
	}
}
