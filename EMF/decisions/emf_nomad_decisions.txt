# -*- ck2.decisions -*-

decisions = {
	emf_become_nomad = {
		only_playable = yes
		ai_check_interval = 24

		potential = {
			culture_group = altaic
			is_tribal = yes
			pacifist = no
			capital_scope = { num_of_empty_holdings > 0 }
			OR = {
				tier = DUKE
				tier = KING
			}
			is_government_potential = nomadic_government
		}
		allow = {
			is_adult = yes
			is_female = no
			war = no
			is_ill = no
			prisoner = no
			is_incapable = no
			has_regent = no
			prestige >= 1000
			martial >= 12
			custom_tooltip = {
				text = IS_PHYSICALLY_CAPABLE
				hidden_tooltip = {
					is_weak_trigger = no
					has_severe_disability_trigger = no
					has_medium_disability_trigger = no
				}
			}
			NOT = { trait = content }
			trigger_if = {
				limit = { liege = { is_nomadic = no } }
				independent = yes
				num_of_count_titles >= 3
			}
			custom_tooltip = { text = NEEDS_500_PRESTIGE_COST }
		}
		effect = {
			prestige = -500
			clr_flag = emf_context_tribal_to_nomadic
			set_flag = emf_context_tribal_to_nomadic
			set_government_type = nomadic_government
			if = {
				limit = { prestige > 10000 }
				population = 9500
			}
			else_if = {
				limit = { prestige > 9500 }
				population = 500
			}
			else_if = {
				limit = { prestige > 9000 }
				population = 8500
			}
			else_if = {
				limit = { prestige > 8500 }
				population = 500
			}
			else_if = {
				limit = { prestige > 8000 }
				population = 7500
			}
			else_if = {
				limit = { prestige > 7500 }
				population = 500
			}
			else_if = {
				limit = { prestige > 7000 }
				population = 6500
			}
			else_if = {
				limit = { prestige > 6500 }
				population = 500
			}
			else_if = {
				limit = { prestige > 6000 }
				population = 5500
			}
			else_if = {
				limit = { prestige > 5500 }
				population = 500
			}
			else_if = {
				limit = { prestige > 5000 }
				population = 4500
			}
			else_if = {
				limit = { prestige > 4500 }
				population = 500
			}
			else_if = {
				limit = { prestige > 4000 }
				population = 3500
			}
			else_if = {
				limit = { prestige > 3500 }
				population = 500
			}
			else_if = {
				limit = { prestige > 3000 }
				population = 2500
			}
			else_if = {
				limit = { prestige > 2500 }
				population = 2000
			}
			else_if = {
				limit = { prestige > 2000 }
				population = 1500
			}
			else_if = {
				limit = { prestige > 1500 }
				population = 1000
			}
			else = {
				population = 500
			}
			hidden_effect = {
				disband_event_forces = settled_nomads
				if = {
					limit = { independent = yes }
					narrative_event = { id = emf_nomad.101 }
				}
				else = {
					narrative_event = { id = emf_nomad.102 }
				}
			}
		}
		ai_will_do = {
			factor = 1
			modifier = {
				factor = 0
				total_years_played < 30
			}
			modifier = {
				factor = 0
				independent = no
				liege = {
					OR = {
						dynasty = ROOT
						any_vassal = {
							is_nomadic = yes
							dynasty = ROOT
						}
						any_vassal = {
							is_nomadic = yes
							count = 5
						}
					}
				}
			}
			modifier = {
				factor = 0
				independent = yes
				NOT = {
					calc_true_if = {
						amount = 2
						martial >= 15
						martial >= 20
						trait = brave
						trait = strong
						trait = robust
						combat_rating > 60
					}
				}
			}
			modifier = {
				factor = 0
				any_realm_title = {
					count = 4
					tier = BARON
					holding_type = castle
				}
			}
			modifier = {
				factor = 0
				NOT = { any_realm_province = { region = world_steppe } }
			}
		}
	}
}

title_decisions = {
	emf_nomad_adopt_tribalism = {
		is_high_prio = yes
		only_playable = yes
		filter = sub_realm_owned
		ai_target_filter = sub_realm_owned
		ai_check_interval = 12

		from_potential = {
			is_nomadic = yes
			is_landed = yes
			OR = {
				ai = yes
				emf_unsafe_religion_if_not_nomad = no
			}
		}
		potential = {
			tier = COUNT
			owner = {
				OR = {
					character = FROM
					AND = {
						ai = yes
						is_liege_or_above = FROM
						NOR = {
							is_nomadic = yes
							any_liege = {
								NOT = { character = FROM }
								is_nomadic = yes
							}
						}
					}
				}
			}
		}
		allow = {
			FROM = {
				independent = yes
				war = no
			}
			location = {
				OR = {
					custom_tooltip = {
						text = CONTAINS_TRIBAL_HOLDING
						hidden_tooltip = {
							any_province_holding = { holding_type = tribal }
						}
					}
					custom_tooltip = {
						text = MAY_BUILD_TRIBAL_HOLDING
						hidden_tooltip = {
							AND = {
								has_empty_holding = yes
								OR = {
									FROM = { capital_holding = { has_building = no_baghatur_council_2 } }
									any_province_holding = { holding_type = castle }
									AND = {
										FROM = {
											OR = {
												religion_group = muslim
												religion = bogomilist
											}
										}
										any_province_holding = { holding_type = temple }
									}
								}
							}
						}
					}
					custom_tooltip = {
						text = IS_CAPITAL_BAGHATUR_COUNCIL_2
						hidden_tooltip = {
							any_province_holding = {
								holding_type = nomad
								has_building = no_baghatur_council_2
							}
						}
					}
				}
			}
		}
		effect = {
			log = "INFO: emf_nomad_adopt_tribalism: [From.GetTitledFirstName] of the [From.PrimaryTitle.GetFullName] (#[From.GetID]/[From.PrimaryTitle.GetID]) settling in [Root.GetBaseName] ([Root.GetID])..."
			save_event_target_as = new_base_title
			FROM = { capital_holding = { save_event_target_as = current_capital } }
			# Change culture and religion of new capital province and possibly more provinces depending on nomad population_and_manpower
			location = {
				if = {
					limit = { NOT = { culture = FROM } }
					culture = FROM
				}
				if = {
					limit = { NOT = { religion = FROM } }
					religion = FROM
				}
			}
			if = {
				limit = { FROM = { population_and_manpower = 5000 } }
				custom_tooltip = { text = nomad_settle_conversion_tooltip }
			}
			hidden_tooltip = { # Pre-settlement accounting
				FROM = { character_event = { id = emf_nomad.0 } }
			}
			# Change name of Avaria to Hungary if relevant.
			if = {
				limit = {
					FROM = { culture = hungarian }
					location = { kingdom = { title = k_hungary } }
					k_hungary = {
						OR = {
							has_holder = no
							holder = FROM
						}
					}
				}
				set_global_flag = avar_khaganate_renamed
				if = {
					limit = { NOT = { is_title_active = k_hungary } }
					activate_title = { title = k_hungary status = yes }
				}
				k_hungary = {
					reset_coa = THIS
					set_name = ""
					adjective = ""
					grant_title = {
						target = FROM
						type = created
					}
				}
			}
			# Spawn event troops based on amount of empty holdings abandoned.
			custom_tooltip = {
				text = NOMAD_CONVERSION_TROOP_SPAWN
				hidden_tooltip = {
					location = {
						save_event_target_as = emf_new_capital
						FROM = { character_event = { id = emf_nomad.5 } }
						clear_event_target = emf_new_capital
					}
				}
			}
			# Usurp any vassal king titles, plus the county and its duchy
			hidden_tooltip = {
				# Usurp any non-nomadic vassals' king titles; if can't usurp king title, set them independent and take
				# all their other titles
				FROM = {
					any_vassal = {
						limit = {
							is_nomadic = no
							any_demesne_title = {
								higher_tier_than = DUKE
								OR = {
									is_landless_type_title = yes
									temporary = yes
									controls_religion = yes
									holy_order = yes
									mercenary = yes
								}
							}
						}
						any_demesne_title = {
							limit = {
								NOR = {
									is_landless_type_title = yes
									temporary = yes
									controls_religion = yes
									holy_order = yes
									mercenary = yes
								}
							}
							usurp_title = ROOT_FROM
						}
						set_defacto_liege = THIS
					}
					any_vassal = {
						limit = { is_nomadic = no }
						any_demesne_title = {
							limit = { tier = KING }
							usurp_title = ROOT_FROM
						}
					}
				}
				# Usurp duchy of target title, if in realm
				location = {
					duchy = {
						if = {
							limit = { owner_under_FROM = yes }
							usurp_title = FROM
						}
					}
				}
				# Usurp the county
				if = {
					limit = { NOT = { holder = FROM } }
					usurp_title = FROM
				}
			}
			custom_tooltip = { text = TT_BUILD_TRIBAL_HOLDINGS }
			# Switch capital to the new province, creating a tribal holding if necessary
			hidden_tooltip = {
				location = {
					random_province_holding = {
						limit = {
							OR = {
								holding_type = tribal
								holding_type = nomad
							}
						}
						preferred_limit = {
							holding_type = nomad
						}
						preferred_limit = {
							holding_type = tribal
							is_capital = yes
						}
						preferred_limit = {
							holding_type = tribal
						}
						if = {
							limit = {
								holding_type = tribal
								is_capital = no
							}
							make_capital_holding = yes
						}
						save_event_target_as = new_capital
					}
					if = {
						limit = { NOT = { event_target:new_capital = { always = yes } } }
						build_holding = { type = tribal holder = FROM }
						random_province_holding = {
							limit = { holding_type = tribal }
							make_capital_holding = yes
							save_event_target_as = new_capital
							emf_transfer_nomad_buildings = yes
						}
					}
				}
			}
			FROM = {
				clr_flag = emf_context_nomadic_to_tribal
				set_flag = emf_context_nomadic_to_tribal
				if = {
					limit = { ai = no }
					chronicle = {
						entry = CHRONICLE_ADOPTED_TRIBALISM
						picture = GFX_evt_tribal_lands
					}
				}
				hidden_effect = {
					any_vassal = {
						limit = { is_nomadic = yes }
						character_event = { id = emf_nomad.100 days = 1 }
					}
				}
				set_government_type = tribal_government
				set_flag = emf_no_law_penalties
				hidden_effect = {
					if = {
						limit = { lower_tier_than = KING }
						create_title = {
							tier = KING
							landless = no
							temporary = no
							custom_created = yes
							culture = FROM
							holder = FROM
							name = "TRIBAL_CUSTOM"
							base_title = event_target:new_base_title
							copy_title_laws = yes
						}
					}
					if = {
						limit = {
							religion_group = pagan_group
							is_reformed_religion = no
						}
						primary_title = {
							add_law = tribal_organization_1
							add_law = centralization_0
						}
					}
					else_if = {
						limit = {
							capital_scope = { NOT = { any_province_holding = { holding_type = castle } } }
						}
						primary_title = {
							add_law = tribal_organization_2
							add_law = centralization_1
						}
					}
					else = {
						primary_title = {
							add_law = tribal_organization_3
							add_law = centralization_1
						}
					}
					# Post-settlement effects / adjustments (incl. culture
					# settlement and anti-border-gore measures) ...
					character_event = { id = emf_nomad.1 }
				}
				clr_flag = emf_no_law_penalties
			}
			hidden_effect = {
				FROM = { capital = event_target:new_capital }
				any_player = {
					limit = { NOT = { character = FROM } }
					narrative_event = { id = HL.2 }
				}
			}
		}
		ai_will_do = {
			factor = 1

			modifier = {
				factor = 0
				location = {
					NOR = {
						kingdom = { capital_scope = { province = PREVPREV } }
						any_province_holding = { holding_type = nomad }
						any_province_holding = { count = 5 }
					}
				}
			}
			modifier = {
				factor = 0
				location = {
					any_province_holding = { holding_type = nomad }
				}
				FROM = {
					any_realm_province = {
						owner_under_PREV = yes
						owner = {
							OR = {
								is_nomadic = no
								character = PREVPREV
							}
							OR = {
								any_liege = { character = PREVPREVPREV }
								NOT = { any_liege = { is_nomadic = yes } }
							}
						}
						OR = {
							kingdom = { capital_scope = { province = PREVPREV } }
							any_province_holding = { count = 5 }
						}
					}
				}
			}
			modifier = {
				factor = 0
				location = {
					any_province_holding = { count = 5 }
				}
				FROM = {
					any_realm_province = {
						owner_under_PREV = yes
						owner = {
							OR = {
								is_nomadic = no
								character = PREVPREV
							}
							OR = {
								any_liege = { character = PREVPREVPREV }
								NOT = { any_liege = { is_nomadic = yes } }
							}
						}
						kingdom = { capital_scope = { province = PREVPREV } }
						NOT = { county = { title = ROOT } }
					}
				}
			}
			modifier = {
				factor = 0
				FROM = {
					NOT = { num_of_subrealm_castles = 20 }
					population_and_manpower = 5000
				}
			}
			modifier = {
				factor = 0
				FROM = {
					NOT = { num_of_subrealm_castles = 10 }
				}
			}
			modifier = {
				factor = 0
				FROM = {
					OR = {
						trait = ambitious
						trait = stubborn
						trait = proud
					}
				}
			}
			modifier = {
				factor = 0
				FROM = {
					NOT = {
						holding_diff = {
							first_type = castle
							first_count_vassals = yes
							second_type = none
							value = 1.5
						}
					}
				}
			}
			modifier = {
				factor = 0
				FROM = {
					OR = {
						has_landed_title = e_mongol_empire
						has_landed_title = e_golden_horde
						has_landed_title = e_chagatai
					}
				}
			}
			modifier = {
				factor = 0
				has_global_flag = emf_magyar_migration_completed
				NOT = { has_global_flag = emf_conquest_hungary_completed }
				FROM = {
					culture = hungarian
					capital_scope = { kingdom = { title = k_hungary } }
				}
				emf_alternate_start = no
			}
		}
	}
}
