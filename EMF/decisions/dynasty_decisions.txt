# -*- ck2.decisions -*-

# Targetted decisions are possible vs _all_ other characters and shown are in the Diplomacy View, not the Intrigue View. The taker is in the FROM scope.
#
# filter = [self/court/home_court/vassals/sub_realm/realm/dynasty/all] ('self' MUST be set for decisions targetting only the taker, the other filter types can be set to lessen CPU load)
# ai_target_filter = [self/court/home_court/vassals/sub_realm/realm/dynasty/all] (which characters for which the AI evaluates the decision.)
#	court: all characters in the AI's host court, including prisoners, and characters currently away (wards, prisoners, etc)
#	home_court: all characters in the AI's home court, including prisoners, and characters currently away (wards, prisoners, etc)
#	vassals: direct vassal rulers of the AI's employer
#	sub_realm: all characters below the AI's employer
#	realm: all characters in the same top realm as the AI
#	dynasty: all members of the same dynasty
#	rivals: your rivals plus any character you have an opinion modifier with 'crime = yes' set (the same set of characters the 'is_foe' trigger evaluates)
#	all: all living characters (Avoid if possible. VERY CPU-HEAVY!)
#

targetted_decisions = {

	commit_suicide = {
		filter = self
		ai_target_filter = self

		potential = {
			is_adult = yes
			OR = {
				trait = depressed
				AND = {
					is_incapable = yes
					has_dlc = "Reapers"
				}
			}
			immortal = no
		}
		allow = {
			custom_tooltip = {
				text = commit_suicide_allow_tooltip
				hidden_tooltip = {
					OR = {
						trait = depressed
						is_incapable = yes
					}
				}
			}
			prisoner = no
			custom_tooltip = {
				text = is_not_busy_trigger_tooltip
				hidden_tooltip = {
					# NOR  = { has_character_flag = do_not_disturb is_inaccessible_trigger = yes }
					# Line above outcommented to account for Seclusion (below)
					OR = {
						in_seclusion = yes
						NOR = {
							has_character_flag = do_not_disturb
							is_inaccessible_trigger = yes
						}
					}
				}
			}
			custom_tooltip = {
				NOT = { has_character_flag = attempting_suicide }
				text = attempting_suicide_tooltip
			}
		}
		effect = {
			if = {
				limit = { has_dlc = "Reapers" }

				set_character_flag = attempting_suicide

				if = {
					limit = { is_incapable = no }
					character_event = { id = RIP.30200 }
				}
				if = {
					limit = { is_incapable = yes }
					character_event = { id = RIP.30210 }
				}
			}
			if = {
				limit = { NOT = { has_dlc = "Reapers" } }
				prestige = -200
				add_character_modifier = {
					modifier = suicide
					duration = -1
				}
				death = { death_reason = death_suicide }
			}
		}
		ai_will_do = {
			factor = 1
			modifier = {
				factor = 0.005
				always = yes
			}
			modifier = {
				factor = 0
				NAND = {
					trait = stressed
					war = no
					in_revolt = no
				}
			}
		}
	}

	legitimize_bastard = {
		only_playable = yes
		filter = close_relatives
		ai_target_filter = close_relatives
		ai_check_interval = 30

		from_potential = {
			has_children = yes
			has_polygamy = no
		}
		potential = {
			trait = bastard
			is_child_of = FROM
			is_liege_or_above = FROM
		}
		allow = {
			trigger_if = {
				limit = {
					FROM = {
						NOT = {
							any_owned_bloodline = {
								has_bloodline_flag = bloodline_legitimize
								bloodline_is_active_for = PREV
							}
						}
					}
				}
				FROM = {
					custom_tooltip = { text = NEEDS_50_PIETY_COST piety >= 50 }
					prisoner = no
					is_incapable = no
				}
			}
		}
		effect = {
			hidden_effect = {
				any_child_even_if_dead = {
					limit = { dynasty = ROOT }
					dynasty = FROM
					any_child_even_if_dead = {
						limit = { dynasty = ROOT }
						dynasty = FROM
						any_child_even_if_dead = {
							limit = { dynasty = ROOT }
							dynasty = FROM
						}
					}
				}
			}
			dynasty = FROM
			remove_trait = bastard
			add_trait = legit_bastard
			hidden_effect = {
				character_event = { id = emf_cadet.0 } # Inherit cadet dynasty PET if applicable
				any_child_even_if_dead = {
					limit = { dynasty = ROOT }
					character_event = { id = emf_cadet.0 } # Inherit cadet dynasty PET if applicable
					any_child_even_if_dead = {
						limit = { dynasty = ROOT }
						character_event = { id = emf_cadet.0 } # Inherit cadet dynasty PET if applicable
						any_child_even_if_dead = {
							limit = { dynasty = ROOT }
							character_event = { id = emf_cadet.0 } # Inherit cadet dynasty PET if applicable
						}
					}
				}
			}
			recalc_succession = yes
			FROM = {
				show_scope_change = no
				if = {
					limit = {
						NOT = {
							any_owned_bloodline = {
								has_bloodline_flag = bloodline_legitimize
								bloodline_is_active_for = PREV
							}
						}
					}
					FROM = {
						piety = -50
					}
				}
				recalc_succession = yes
			}
			if = {
				limit = {
					prisoner = yes
					host = { character = FROM }
				}
				imprison = no
			}

			if = {
				limit = { FROM = { is_female = no } }
				mother = {
					show_scope_change = no
					opinion = {
						who = FROM
						modifier = legitimized_child
						years = 10
					}
				}
			}
			FROM = {
				show_scope_change = no
				any_spouse = {
					show_scope_change = no
					if = {
						limit = {
							NOT = {
								any_child = {
									character = ROOT
								}
							}
						}
						opinion = {
							who = ROOT_FROM
							modifier = legitimized_bastard
							years = 20
						}
					}
				}
				if = {
					limit = {
						any_child = {
							dynasty = ROOT_FROM
							NOT = { character = ROOT }
							NOT = { trait = bastard }
						}
					}
					custom_tooltip = {
						text = any_child_gets_angry_tt
						any_child = {
							show_scope_change = no
							limit = {
								NOT = { character = ROOT }
								dynasty = ROOT_FROM
								NOT = { trait = bastard }
							}
							opinion = {
								who = ROOT_FROM
								modifier = legitimized_bastard
								months = 12
							}
						}
					}
				}
			}
		}

		ai_will_do = {
			factor = 1
			modifier = {
				factor = 0.3
				always = yes
			}
			modifier = {
				factor = 0
				FROM = {
					OR = {
						NOT = { age = 50 }
						trait = zealous
						current_heir = { dynasty = PREV }
						current_heir = { is_child_of = PREV }
						is_pregnant = yes
						any_spouse = { is_pregnant = yes }
						any_consort = { is_pregnant = yes }
						primary_title = {
							NOR = {
								has_law = succ_gavelkind
								has_law = succ_primogeniture
								has_law = succ_ultimogeniture
								has_law = succ_seniority
							}
						}
					}
				}
			}
			modifier = {
				factor = 0.1
				FROM = { trait = cruel }
			}
			modifier = {
				factor = 0.5
				FROM = { trait = proud }
			}
			modifier = {
				factor = 0.5
				FROM = { NOT = { ai_ambition = -39 } }
			}
			modifier = {
				factor = 2
				FROM = { trait = kind }
			}
			modifier = {
				factor = 2
				FROM = { trait = cynical }
			}
			modifier = {
				factor = 2
				FROM = { NOT = { health = 3.1 } }
			}
			modifier = {
				factor = 2
				FROM = { NOT = { health = 2.1 } }
			}
			modifier = {
				factor = 2
				FROM = { NOT = { fertility = 0.1 } }
			}
			modifier = {
				factor = 2.5
				FROM = { age = 55 }
			}
			modifier = {
				factor = 2.5
				FROM = { age = 60 }
			}
			modifier = {
				factor = 2.5
				FROM = { age = 65 }
			}
			modifier = {
				factor = 2.5
				FROM = { age = 70 }
			}
			modifier = {
				factor = 0
				FROM = {
					is_feudal = no
					is_tribal = no
				}
			}
			modifier = {
				factor = 0
				is_female = yes
				FROM = { primary_title = { has_law = agnatic_succession } }
			}
			modifier = {
				factor = 0
				is_female = no
				FROM = { primary_title = { has_law = enatic_succession } }
			}
			modifier = {
				factor = 0
				OR = {
					ai = no
					is_incapable = yes
					trait = inbred
					trait = imbecile
					NOT = { religion = FROM }
					NOT = { culture = FROM }
					is_ascetic_trigger = yes
					trait = eunuch
					trait = horse
					AND = {
						OR = {
							culture_group = byzantine
							culture = kasogi
							culture = roman
						}
						trait = blinded
					}
					is_consort = yes # Concubines cannot inherit
					holy_order = yes
					any_liege = { holy_order = yes }
					AND = {
						NOR = {
							religion_group = pagan_group
							religion_group = muslim
						}
						OR = {
							is_theocracy = yes
							AND = { # Nominees
								is_ruler = no
								any_heir_title = { is_theocracy = yes }
							}
						}
					}
				}
			}
		}
	}

	# Muslim dynasty head tries to convince a dynasty member to lose the 'Decadent' Trait
	convince_to_straighten_up = {
		only_playable = yes
		filter = dynasty
		ai_target_filter = dynasty
		ai_check_interval = 6

		from_potential = {
			is_playable = yes
			religion_group = muslim
			OR = {
				independent = yes
				NOT = { any_dynasty_member = { is_vassal_or_below = FROM } }
			}
		}
		potential = {
			trait = decadent
			dynasty = FROM
			prisoner = no
			is_liege_or_above = FROM
			is_incapable = no
			NOT = { trait = on_hajj }
		}
		allow = {
			OR = {
				custom_tooltip = {
					text = NON_RULER_PIETY_50
					hidden_tooltip = {
						ROOT = { is_ruler = no }
						FROM = { piety = 50 }
					}
				}
				custom_tooltip = {
					text = IS_RULER_PIETY_100
					hidden_tooltip = {
						ROOT = { is_ruler = yes }
						FROM = { piety = 100 }
					}
				}
			}
			FROM = {
				has_regent = no
				NOT = { trait = decadent }
			}
			ROOT = {
				custom_tooltip = {
					text = NOT_ALREADY_NEGOTIATED
					hidden_tooltip = {
						NOT = { has_opinion_modifier = { who = FROM modifier = negotiated_to_drop_decadence } }
					}
				}
			}
		}
		effect = {
			hidden_tooltip = {
				opinion = { who = FROM modifier = negotiated_to_drop_decadence }
			}
			if = {
				limit = { is_ruler = no }
				FROM = { piety = -50 }
			}
			if = {
				limit = { is_ruler = yes }
				FROM = { piety = -100 }
			}
			character_event = {
				id = 91350
			}
		}
		ai_will_do = {
			factor = 1
			modifier = {
				factor = 0.1
				always = yes
			}
			modifier = {
				factor = 0.5
				reverse_opinion = { who = FROM value = 25 }
			}
			modifier = {
				factor = 0.5
				reverse_opinion = { who = FROM value = 50 }
			}
			modifier = {
				factor = 2
				NOT = { reverse_opinion = { who = FROM value = 0 } }
			}
			modifier = {
				factor = 2
				NOT = { reverse_opinion = { who = FROM value = -25 } }
			}
			modifier = {
				factor = 2
				NOT = { reverse_opinion = { who = FROM value = -50 } }
			}
			modifier = {
				factor = 0.5
				FROM = { trait = slothful }
			}
			modifier = {
				factor = 0.5
				FROM = { trait = kind }
			}
			modifier = {
				factor = 0.5
				FROM = { trait = patient }
			}
			modifier = {
				factor = 0.5
				FROM = { NOT = { ai_ambition = -39 } }
			}
			modifier = {
				factor = 2
				FROM = { trait = diligent }
			}
			modifier = {
				factor = 2
				FROM = { trait = cruel }
			}
			modifier = {
				factor = 2
				FROM = { trait = wroth }
			}
			modifier = {
				factor = 5
				FROM = { trait = zealous }
			}
		}
	}

	# Unhardcoded decision.
	order_to_take_vows = {
		only_playable = yes
		filter = court
		ai_target_filter = court
		ai_check_interval = 120 #Check every 120 months
		
		from_potential = {
			is_playable = yes
			has_regent = no
			prisoner = no
			is_adult = yes
			has_dlc = "Sons of Abraham"
			OR = {
				AND = {
					NOT = { has_alternate_start_parameter = { key = religion_names value = random } }
					OR = {	
						religion_group = christian
						religion = hindu
						religion = buddhist
						religion = jain
						religion = manichean
						religion = west_african_pagan
					}
				}
				has_religion_feature = religion_monastic
				has_religion_feature = religion_feature_west_african
				has_religion_feature = religion_syncretic_christian
				AND = {
					religion = west_african_pagan_reformed
					has_religion_features = no
				}
			}
		}
		
		potential = {
			is_adult = yes
			is_ruler = no
			religion = FROM
			is_incapable = no
			is_ascetic_trigger = no
			host = { character = FROM }
		}
		
		allow = {
			OR = { 
				AND = { 
					is_married = no
					custom_tooltip = {
						text = NOT_HEIR_TITLE_TT
						NOT = {
                        	any_heir_title = { 
                            	always = yes
                            }
                        }
                    }
				}
				prisoner = yes
				conditional_tooltip = {
					trigger = { dynasty = FROM }
					custom_tooltip = { #Matilde's Bloodline
						text = BLOODLINE_EASIER_VOWS_TOOLTIP
						AND = { 
							FROM = { 
								dynasty = ROOT
								any_owned_bloodline = {
									has_bloodline_flag = bloodline_easy_monks
									bloodline_is_active_for = PREV
								}
							}
							ROOT = { 
								any_owned_bloodline = {
									has_bloodline_flag = bloodline_easy_monks
									bloodline_is_active_for = PREV
								}
							}
						}
					}
				}
			}
			FROM = { piety = 50 }
		}

		effect = {
			FROM = { piety = -50 }
			add_ascetic_trait_effect = yes #Adds religion-based monk-traits.
			if = {
				limit = { prisoner = yes }
				prisoner = no
			}
			if = {
				limit = { is_married = yes }
				any_spouse = { remove_spouse = ROOT }
			}
			if = { #Make them actually become monks/nuns if you have Societies.
				limit = { 
					has_dlc = "Mystics"	
					is_in_society = no		
					OR = {
						religion = catholic
						AND = {
							is_heretic = no
							OR = {
								religion = fraticelli
								religion = waldensian
								religion = lollard
								religion = cathar
								religion = adoptionist
								religion = arian
							}
						}
					} 
				}
				custom_tooltip = { text = tooltip_vows_monk_joins_society }
				hidden_tooltip = { 
					random_list = { 
						50 = { 
							trigger = { religion = catholic } 
							join_society = monastic_order_benedictine 
						} 
						50 = { join_society = monastic_order_dominican } 
					}
				}
			}
			if = {
				limit = { 
					has_dlc = "Mystics" 
					is_in_society = no
					OR = {
						religion = orthodox
						AND = {
							is_heretic = no
							OR = {
								religion = bogomilist
								religion = monothelite
								religion = iconoclast
								religion = paulician
							}
						}
					}
				}
				custom_tooltip = { text = tooltip_vows_monk_joins_society }
				hidden_tooltip = { 
					join_society = monastic_order_orthodox
				}
			}
			if = {
				limit = { 
					has_dlc = "Mystics" 
					is_in_society = no
					OR = {
						religion = nestorian
						AND = {
							is_heretic = no
							religion = messalian
						}
					}
				}
				custom_tooltip = { text = tooltip_vows_monk_joins_society }
				hidden_tooltip = { 
					join_society = monastic_order_nestorian
				}
			}
			if = {
				limit = { 
					has_dlc = "Mystics" 
					is_in_society = no
					OR = {
						religion = miaphysite
						AND = {
							is_heretic = no
							religion = monophysite
						}
					}
				}
				custom_tooltip = { text = tooltip_vows_monk_joins_society }
				hidden_tooltip = { 
					join_society = monastic_order_monophysite
				}
			}
			if = {
				limit = { 
					has_dlc = "Mystics" 
					is_in_society = no
					religion = hindu 
				}
				custom_tooltip = { text = tooltip_vows_monk_joins_society }
				hidden_tooltip = { 
					join_society = monastic_order_hindu
				}
			}
			if = {
				limit = { 
					has_dlc = "Mystics" 
					is_in_society = no
					religion = buddhist 
				}
				custom_tooltip = { text = tooltip_vows_monk_joins_society }
				hidden_tooltip = { 
					join_society = monastic_order_buddhist
				}
			}
			if = {
				limit = { 
					has_dlc = "Mystics" 
					is_in_society = no
					religion = jain
				}
				custom_tooltip = { text = tooltip_vows_monk_joins_society }
				hidden_tooltip = { 
					join_society = monastic_order_jain
				}
			}
			if = {
				limit = { 
					any_realm_lord = { is_theocracy = yes religion = ROOT }
				}
				custom_tooltip = { text = tooltip_vows_monk_goes_to_theocracy }
				hidden_tooltip = { 
					random_realm_lord = { 
						limit = { is_theocracy = yes religion = ROOT }
						preferred_limit = { 
							reverse_opinion = { who = FROM value = 20 }
							vassal_of = FROM
							same_society_as = ROOT #The one he just joined.
						} 
						preferred_limit = { 
							vassal_of = FROM
							same_society_as = ROOT #The one he just joined.
						} 
						preferred_limit = { 
							same_society_as = ROOT #The one he just joined.
						} 
						preferred_limit = { 
							vassal_of = FROM
						} 
						ROOT = { 
							move_character = PREV
						} 
					}
				}
			}
			if = {
				limit = { NOR = { trait = zealous dynasty = FROM } }
				opinion = { modifier = opinion_cloistered_me who = FROM years = 20 }
			}
			if = {
				limit = { NOT = { trait = zealous } dynasty = FROM }
				opinion = { modifier = opinion_cloistered_me_family who = FROM years = 20 }
			}
			if = {
				limit = { is_child_of = FROM }
				hidden_tooltip = { FROM = { character_event = { id = HFP.23001 } } }
			}
			
		}
		ai_will_do = {
			factor = 1
			modifier = { #Hate you too much to just send you off.
				factor = 0
				prisoner = yes
				NOT = { is_child_of = FROM }
				FROM = { is_benevolent_trigger = no }
				NOT = {
					reverse_opinion = {
						who = FROM
						value = -20
					}
				}
			}
			modifier = { #Like him too much to do it.
				factor = 0
				reverse_opinion = {
					who = FROM
					value = 50
				}
			}
			modifier = { #I'm a good ruler and he is a dynastic heir.
				factor = 0
				is_child_of = FROM
				dynasty = FROM
				FROM = { is_benevolent_trigger = yes }
				reverse_opinion = {
					who = FROM
					value = 0
				}
			}
			modifier = { #Must protect the line.
				factor = 5
				is_child_of = FROM
				NOT = { dynasty = FROM }
			}
			modifier = { #Hate you.
				factor = 5
				is_child_of = FROM
				is_rival = FROM
			}
			modifier = { #There are better spares.
				factor = 20
				is_child_of = FROM
				OR = { 
					has_negative_congenital_trigger = yes
					has_infertile_trait_trigger = yes
					has_severe_disability_trigger = yes
				}
				FROM = { 
					any_child = { 
						is_alive = yes
						NOR = { 
							character = ROOT 
							has_negative_congenital_trigger = yes
							has_infertile_trait_trigger = yes
							has_severe_disability_trigger = yes
						}
					}
				}
			}
			modifier = { #Must preserve the realm from falling to evil.
				factor = 5
				is_evil_trigger = yes
				FROM = { 
					is_benevolent_trigger = yes 
					any_child = { 
						is_alive = yes
						NOR = { 
							character = ROOT 
							is_evil_trigger = yes
						}
					}
				}
			}
		}
	}
	send_child_into_hiding = {
		only_rulers = yes
		is_high_prio = yes

		filter = dynasty
		ai_target_filter = dynasty
		ai_check_interval = 12

		from_potential = {
			is_playable = yes
			has_regent = no
			has_children = yes
			OR = {
				ai = no
				has_education_intrigue_trigger = yes
			}
		}

		potential = {
			NOT = { is_inaccessible_trigger = yes }
			is_ruler = no
			vassal_of = FROM
			NAND = {
				is_plot_target_of = FROM
				FROM = {
					OR = {
						has_plot = plot_kill_character
						has_plot = plot_kill_spouse
					}
				}
			}
			NOT = { is_married = FROM }
			is_child_of = FROM
			OR = {
				FROM = { ai = no }
				is_primary_heir = yes
				any_heir_title = { higher_tier_than = BARON }
				FROM = { ROOT = { emf_is_preferred_gender_for_laws_of_PREV = yes } }
			}
		}

		allow = {
			in_command = no
			prisoner = no
			custom_tooltip = {
				text = is_not_busy_trigger_tooltip
				hidden_tooltip = { NOT = { has_character_flag = do_not_disturb } }
			}
			has_job_title = no
			custom_tooltip = {
				text = is_target_of_murder_plot_tooltip
				hidden_tooltip = {
					OR = {
						has_character_modifier = suspected_murder_plot
						FROM = {
							any_known_plotter = {
								target = PREV
								OR = {
									has_plot = plot_kill_character
									has_plot = plot_kill_spouse
								}
							}
						}
					}
				}
			}
			custom_tooltip = {
				text = recently_went_out_of_hiding_tooltip
				hidden_tooltip = {
					NOT = { has_character_modifier = went_out_of_hiding_timer }
				}
			}
		}
		effect = {
			custom_tooltip = { text = go_into_hiding_info_tooltip }
			add_trait = in_hiding
			set_character_flag = do_not_disturb
			hidden_tooltip = {
				ROOT = {
					any_plotter = {
						target = ROOT
						limit = {
							NOT = { has_character_flag = murder_in_motion }
							OR = {
								has_plot = plot_kill_character
								has_plot = plot_kill_spouse
							}
						}
						character_event = { id = CM.6004 }
						any_backed_character = {
							character_event = { id = CM.6004 }
						}
					}
					any_plotter = {
						target = ROOT
						limit = {
							has_character_flag = murder_in_motion
							OR = {
								has_plot = plot_kill_character
								has_plot = plot_kill_spouse
							}
						}
						character_event = { id = CM.6180 }
						any_backed_character = {
							character_event = { id = CM.6004 }
						}
					}
				}
				father = {
					if = {
						limit = {
							NOR = {
								character = FROM
								AND = {
									OR = {
										has_plot = plot_kill_character
										has_plot = plot_kill_spouse
									}
									plot_target_char = { character = ROOT }
								}
							}
						}
						character_event = { id = CM.6004 }
					}
				}
				mother = {
					if = {
						limit = {
							NOR = {
								character = FROM
								AND = {
									OR = {
										has_plot = plot_kill_character
										has_plot = plot_kill_spouse
									}
									plot_target_char = { character = ROOT }
								}
							}
						}
						character_event = { id = CM.6004 }
					}
				}
				any_spouse = {
					limit = {
						NOR = {
							character = FROM
							AND = {
								OR = {
									has_plot = plot_kill_character
									has_plot = plot_kill_spouse
								}
								plot_target_char = { character = ROOT }
							}
							is_parent_of = ROOT
						}
					}
					character_event = { id = CM.6004 }
				}
				any_child = {
					limit = {
						NOR = {
							character = FROM
							AND = {
								OR = {
									has_plot = plot_kill_character
									has_plot = plot_kill_spouse
								}
								plot_target_char = { character = ROOT }
							}
							is_parent_of = ROOT
							is_married = ROOT
						}
					}
					character_event = { id = CM.6004 }
				}
				any_lover = {
					limit = {
						NOR = {
							character = FROM
							AND = {
								OR = {
									has_plot = plot_kill_character
									has_plot = plot_kill_spouse
								}
								plot_target_char = { character = ROOT }
							}
							is_parent_of = ROOT
							is_married = ROOT
							is_child_of = ROOT
						}
					}
					character_event = { id = CM.6004 }
				}
				any_sibling = {
					limit = {
						NOR = {
							character = FROM
							AND = {
								OR = {
									has_plot = plot_kill_character
									has_plot = plot_kill_spouse
								}
								plot_target_char = { character = ROOT }
							}
							is_parent_of = ROOT
							is_married = ROOT
							is_child_of = ROOT
							is_lover = ROOT
						}
					}
					character_event = { id = CM.6004 }
				}
				any_rival = {
					limit = {
						NOR = {
							character = FROM
							AND = {
								OR = {
									has_plot = plot_kill_character
									has_plot = plot_kill_spouse
								}
								plot_target_char = { character = ROOT }
							}
							is_parent_of = ROOT
							is_married = ROOT
							is_child_of = ROOT
							is_lover = ROOT
							sibling = ROOT
						}
					}
					character_event = { id = CM.6004 }
				}
			}
		}

		ai_will_do = {
			factor = 1
			modifier = {
				factor = 0.5
			}
			modifier = {
				factor = 0.5
				NOT = {
					FROM = {
						trait = in_hiding
					}
				}
			}
			modifier = {
				factor = 0.5
				NOT = {
					reverse_opinion = {
						who = FROM
						value = -24
					}
				}
			}
			modifier = {
				factor = 1.5
				reverse_opinion = {
					who = FROM
					value = 25
				}
			}
			modifier = {
				factor = 5
				FROM = { trait = in_hiding }
			}
			modifier = {
				factor = 10
				FROM = { trait = paranoid }
			}
		}
	}

	take_child_out_of_hiding = {
		only_rulers = yes
		is_high_prio = yes

		filter = dynasty
		ai_target_filter = dynasty
		ai_check_interval = 12

		from_potential = {
			is_ruler = yes
			has_regent = no
			has_children = yes
		}

		potential = {
			trait = in_hiding
			is_ruler = no
			vassal_of = FROM
			is_child_of = FROM
			prisoner = no
			NOT = { is_married = FROM }
			NOT = { has_character_flag = emf_siege_in_hiding } # EMF: Siege module
		}

		allow = {
			trait = in_hiding
		}
		effect = {
			custom_tooltip = { text = come_out_of_hiding_info_tooltip }
			remove_trait = in_hiding
			clr_character_flag = do_not_disturb
			add_character_modifier = {
				name = went_out_of_hiding_timer
				duration = 180
				hidden = yes
			}
			hidden_tooltip = {
				any_plotter = {
					target = ROOT
					limit = {
						NOT = { character = FROM }
						OR = {
							has_plot = plot_kill_character
							has_plot = plot_kill_spouse
						}
					}
					character_event = { id = CM.6005 }
					any_backed_character = {
						limit = { NOT = { character = FROM } }
						character_event = { id = CM.6005 }
					}
				}
				father = {
					if = {
						limit = {
							NOR = {
								character = FROM
								AND = {
									OR = {
										has_plot = plot_kill_character
										has_plot = plot_kill_spouse
									}
									plot_target_char = { character = ROOT }
								}
							}
						}
						character_event = { id = CM.6005 }
					}
				}
				mother = {
					if = {
						limit = {
							NOR = {
								character = FROM
								AND = {
									OR = {
										has_plot = plot_kill_character
										has_plot = plot_kill_spouse
									}
									plot_target_char = { character = ROOT }
								}
							}
						}
						character_event = { id = CM.6005 }
					}
				}
				any_spouse = {
					limit = {
						NOR = {
							character = FROM
							AND = {
								OR = {
									has_plot = plot_kill_character
									has_plot = plot_kill_spouse
								}
								plot_target_char = { character = ROOT }
							}
							is_parent_of = ROOT
						}
					}
					character_event = { id = CM.6005 }
				}
				any_child = {
					limit = {
						NOR = {
							character = FROM
							AND = {
								OR = {
									has_plot = plot_kill_character
									has_plot = plot_kill_spouse
								}
								plot_target_char = { character = ROOT }
							}
							is_parent_of = ROOT
							is_married = ROOT
						}
					}
					character_event = { id = CM.6005 }
				}
				any_lover = {
					limit = {
						NOR = {
							character = FROM
							AND = {
								OR = {
									has_plot = plot_kill_character
									has_plot = plot_kill_spouse
								}
								plot_target_char = { character = ROOT }
							}
							is_parent_of = ROOT
							is_married = ROOT
							is_child_of = ROOT
						}
					}
					character_event = { id = CM.6005 }
				}
				any_sibling = {
					limit = {
						NOR = {
							character = FROM
							AND = {
								OR = {
									has_plot = plot_kill_character
									has_plot = plot_kill_spouse
								}
								plot_target_char = { character = ROOT }
							}
							is_parent_of = ROOT
							is_married = ROOT
							is_child_of = ROOT
							is_lover = ROOT
						}
					}
					character_event = { id = CM.6005 }
				}
				any_rival = {
					limit = {
						NOR = {
							character = FROM
							AND = {
								OR = {
									has_plot = plot_kill_character
									has_plot = plot_kill_spouse
								}
								plot_target_char = { character = ROOT }
							}
							is_parent_of = ROOT
							is_married = ROOT
							is_child_of = ROOT
							is_lover = ROOT
							sibling = ROOT
						}
					}
					character_event = { id = CM.6005 }
				}
			}
		}

		ai_will_do = {
			factor = 1
			modifier = {
				factor = 0.3
				FROM = { trait = paranoid }
			}
			modifier = {
				factor = 0
				OR = {
					has_character_modifier = suspected_murder_plot
					FROM = {
						any_known_plotter = {
							target = PREV
							OR = {
								has_plot = plot_kill_character
								has_plot = plot_kill_spouse
							}
						}
					}
				}
			}
		}
	}

	go_into_hiding = {
		only_rulers = yes
		is_high_prio = yes

		filter = self
		ai_target_filter = self
		ai_check_interval = 12

		potential = {
			prisoner = no
			is_inaccessible_trigger = no
			OR = {
				ai = no
				has_education_intrigue_trigger = yes
			}
		}
		allow = {
			in_command = no
			prisoner = no
			custom_tooltip = {
				text = is_not_busy_trigger_tooltip
				hidden_tooltip = { NOT = { has_character_flag = do_not_disturb } }
			}
			has_job_title = no
			custom_tooltip = {
				text = is_target_of_murder_plot_tooltip
				hidden_tooltip = {
					OR = {
						has_character_modifier = suspected_murder_plot
						any_known_plotter = {
							target = ROOT
							OR = {
								has_plot = plot_kill_character
								has_plot = plot_kill_spouse
							}
						}
					}
				}
			}
			custom_tooltip = {
				text = recently_went_out_of_hiding_tooltip
				hidden_tooltip = {
					NOT = { has_character_modifier = went_out_of_hiding_timer }
				}
			}
		}
		effect = {
			set_character_flag = do_not_disturb
			custom_tooltip = { text = go_into_hiding_info_tooltip }
			add_trait = in_hiding
			hidden_tooltip = {					# Notify player and close family and plotters
				ROOT = {
					any_plotter = {
						target = ROOT
						limit = {
							NOT = { has_character_flag = murder_in_motion }
							OR = {
								has_plot = plot_kill_character
								has_plot = plot_kill_spouse
							}
						}
						character_event = { id = CM.6000 }
						any_backed_character = {
							character_event = { id = CM.6000 }
						}
					}
					any_plotter = {
						target = ROOT
						limit = {
							has_character_flag = murder_in_motion
							OR = {
								has_plot = plot_kill_character
								has_plot = plot_kill_spouse
							}
						}
						character_event = { id = CM.6180 }
						any_backed_character = {
							character_event = { id = CM.6000 }
						}
					}
				}
				father = {
					if = {
						limit = {
							NAND = {
								OR = {
									has_plot = plot_kill_character
									has_plot = plot_kill_spouse
								}
								plot_target_char = { character = ROOT }
							}
						}
						character_event = { id = CM.6000 }
					}
				}
				mother = {
					if = {
						limit = {
							NAND = {
								OR = {
									has_plot = plot_kill_character
									has_plot = plot_kill_spouse
								}
								plot_target_char = { character = ROOT }
							}
						}
						character_event = { id = CM.6000 }
					}
				}
				any_spouse = {
					limit = {
						NOR = {
							AND = {
								OR = {
									has_plot = plot_kill_character
									has_plot = plot_kill_spouse
								}
								plot_target_char = { character = ROOT }
							}
							is_parent_of = ROOT
						}
					}
					character_event = { id = CM.6000 }
				}
				any_child = {
					limit = {
						NOR = {
							AND = {
								OR = {
									has_plot = plot_kill_character
									has_plot = plot_kill_spouse
								}
								plot_target_char = { character = ROOT }
							}
							is_parent_of = ROOT
							is_married = ROOT
						}
					}
					character_event = { id = CM.6000 }
				}
				any_lover = {
					limit = {
						NOR = {
							AND = {
								OR = {
									has_plot = plot_kill_character
									has_plot = plot_kill_spouse
								}
								plot_target_char = { character = ROOT }
							}
							is_parent_of = ROOT
							is_married = ROOT
							is_child_of = ROOT
						}
					}
					character_event = { id = CM.6000 }
				}
				any_sibling = {
					limit = {
						NOR = {
							AND = {
								OR = {
									has_plot = plot_kill_character
									has_plot = plot_kill_spouse
								}
								plot_target_char = { character = ROOT }
							}
							is_parent_of = ROOT
							is_married = ROOT
							is_child_of = ROOT
							is_lover = ROOT
						}
					}
					character_event = { id = CM.6000 }
				}
				any_rival = {
					limit = {
						NOR = {
							AND = {
								OR = {
									has_plot = plot_kill_character
									has_plot = plot_kill_spouse
								}
								plot_target_char = { character = ROOT }
							}
							is_parent_of = ROOT
							is_married = ROOT
							is_child_of = ROOT
							is_lover = ROOT
							sibling = ROOT
						}
					}
					character_event = { id = CM.6000 }
				}
			}
		}
		ai_will_do = {
			factor = 1

			modifier = {
				factor = 0.5
			}
			modifier = {
				factor = 0.1
				practical_age = 65
			}
			modifier = {
				factor = 0.1
				trait = brave
			}
			modifier = {
				factor = 2
				trait = depressed
			}
			modifier = {
				factor = 5
				trait = craven
			}
			modifier = {
				factor = 10
				trait = paranoid
			}
		}
	}

	come_out_of_hiding = {
		is_high_prio = yes

		filter = self
		ai_target_filter = self
		ai_check_interval = 12

		potential = {
			OR = {
				is_ruler = yes
				NOR = {
					# Spouse can take them out of hiding
					any_spouse = {
						is_ruler = yes
						is_liege_of = PREV
					}
					# Parents can take them out of hiding
					father = {
						is_ruler = yes
						is_liege_of = PREV
					}
					mother = {
						is_ruler = yes
						is_liege_of = PREV
					}
				}
			}
			trait = in_hiding
			NOT = { has_character_flag = in_religious_seclusion }
			NOT = { has_character_flag = emf_siege_in_hiding } # EMF: Siege module
		}
		allow = {
			prisoner = no
			NOT = {
				regent = {
					OR = {
						trait = deceitful
						trait = ambitious
						is_rival = ROOT
					}
				}
			}
		}
		effect = {
			add_character_modifier = {
				name = went_out_of_hiding_timer
				duration = 180
				hidden = yes
			}
			clr_character_flag = do_not_disturb
			custom_tooltip = { text = come_out_of_hiding_info_tooltip }
			remove_trait = in_hiding
			hidden_tooltip = {					# Notify player and close family and plotters
				ROOT = {
					any_plotter = {
						target = ROOT
						limit = {
							OR = {
								has_plot = plot_kill_character
								has_plot = plot_kill_spouse
							}
						}
						character_event = { id = CM.6001 }
						any_backed_character = {
							character_event = { id = CM.6001 }
						}
					}
				}
				father = {
					if = {
						limit = {
							NAND = {
								OR = {
									has_plot = plot_kill_character
									has_plot = plot_kill_spouse
								}
								plot_target_char = { character = ROOT }
							}
						}
						character_event = { id = CM.6001 }
					}
				}
				mother = {
					if = {
						limit = {
							NAND = {
								OR = {
									has_plot = plot_kill_character
									has_plot = plot_kill_spouse
								}
								plot_target_char = { character = ROOT }
							}
						}
						character_event = { id = CM.6001 }
					}
				}
				any_spouse = {
					limit = {
						NOR = {
							AND = {
								OR = {
									has_plot = plot_kill_character
									has_plot = plot_kill_spouse
								}
								plot_target_char = { character = ROOT }
							}
							is_parent_of = ROOT
						}
					}
					character_event = { id = CM.6001 }
				}
				any_child = {
					limit = {
						NOR = {
							AND = {
								OR = {
									has_plot = plot_kill_character
									has_plot = plot_kill_spouse
								}
								plot_target_char = { character = ROOT }
							}
							is_parent_of = ROOT
							is_married = ROOT
						}
					}
					character_event = { id = CM.6001 }
				}
				any_lover = {
					limit = {
						NOR = {
							AND = {
								OR = {
									has_plot = plot_kill_character
									has_plot = plot_kill_spouse
								}
								plot_target_char = { character = ROOT }
							}
							is_parent_of = ROOT
							is_married = ROOT
							is_child_of = ROOT
						}
					}
					character_event = { id = CM.6001 }
				}
				any_sibling = {
					limit = {
						NOR = {
							AND = {
								OR = {
									has_plot = plot_kill_character
									has_plot = plot_kill_spouse
								}
								plot_target_char = { character = ROOT }
							}
							is_parent_of = ROOT
							is_married = ROOT
							is_child_of = ROOT
							is_lover = ROOT
						}
					}
					character_event = { id = CM.6001 }
				}
				any_rival = {
					limit = {
						NOR = {
							AND = {
								OR = {
									has_plot = plot_kill_character
									has_plot = plot_kill_spouse
								}
								plot_target_char = { character = ROOT }
							}
							is_parent_of = ROOT
							is_married = ROOT
							is_child_of = ROOT
							is_lover = ROOT
							sibling = ROOT
						}
					}
					character_event = { id = CM.6001 }
				}
			}
		}
		ai_will_do = {
			factor = 1
			modifier = {
				factor = 0.3
				trait = paranoid
			}
			modifier = {
				factor = 0
				NOT = {
					ROOT = {
						any_plotter = {
							target = ROOT
							is_primary_heir = yes
							ai = no
						}
					}
				}
				OR = {
					has_character_modifier = suspected_murder_plot
					any_known_plotter = {
						target = ROOT
						OR = {
							has_plot = plot_kill_character
							has_plot = plot_kill_spouse
						}
					}
				}
			}
		}
	}

	send_spouse_into_hiding = {
		only_rulers = yes
		is_high_prio = yes

		filter = spouse
		ai_target_filter = spouse
		ai_check_interval = 12

		from_potential = {
			is_playable = yes
			has_regent = no
			OR = {
				ai = no
				has_education_intrigue_trigger = yes
			}
		}

		potential = {
			NOT = { is_inaccessible_trigger = yes }
			is_ruler = no
			is_married = FROM
			vassal_of = FROM
			NAND = {
				is_plot_target_of = FROM
				FROM = {
					OR = {
						has_plot = plot_kill_character
						has_plot = plot_kill_spouse
					}
				}
			}
		}

		allow = {
			in_command = no
			prisoner = no
			custom_tooltip = {
				text = is_not_busy_trigger_tooltip
				hidden_tooltip = { NOT = { has_character_flag = do_not_disturb } }
			}
			has_job_title = no
			NOT = { is_ruler = yes }
			custom_tooltip = {
				text = is_target_of_murder_plot_tooltip
				hidden_tooltip = {
					OR = {
						has_character_modifier = suspected_murder_plot
						FROM = {
							any_known_plotter = {
								target = PREV
								OR = {
									has_plot = plot_kill_character
									has_plot = plot_kill_spouse
								}
							}
						}
					}
				}
			}
			custom_tooltip = {
				text = recently_went_out_of_hiding_tooltip
				hidden_tooltip = {
					NOT = { has_character_modifier = went_out_of_hiding_timer }
				}
			}
		}

		effect = {
			set_character_flag = do_not_disturb
			custom_tooltip = { text = go_into_hiding_info_tooltip }
			add_trait = in_hiding
			hidden_tooltip = {					# Notify player and close family and plotters
				any_plotter = {
					target = ROOT
					limit = {
						NOT = { has_character_flag = murder_in_motion }
						OR = {
							has_plot = plot_kill_character
							has_plot = plot_kill_spouse
						}
					}
					character_event = { id = CM.6002 }
					any_backed_character = {
						character_event = { id = CM.6002 }
					}
				}
				any_plotter = {
					target = ROOT
					limit = {
						has_character_flag = murder_in_motion
						OR = {
							has_plot = plot_kill_character
							has_plot = plot_kill_spouse
						}
					}
					character_event = { id = CM.6180 }
					any_backed_character = {
						character_event = { id = CM.6002 }
					}
				}
				father = {
					if = {
						limit = {
							NOR = {
								character = FROM
								AND = {
									OR = {
										has_plot = plot_kill_character
										has_plot = plot_kill_spouse
									}
									plot_target_char = { character = ROOT }
								}
							}
						}
						character_event = { id = CM.6002 }
					}
				}
				mother = {
					if = {
						limit = {
							NOR = {
								character = FROM
								AND = {
									OR = {
										has_plot = plot_kill_character
										has_plot = plot_kill_spouse
									}
									plot_target_char = { character = ROOT }
								}
							}
						}
						character_event = { id = CM.6002 }
					}
				}
				any_spouse = {
					limit = {
						NOR = {
							character = FROM
							AND = {
								OR = {
									has_plot = plot_kill_character
									has_plot = plot_kill_spouse
								}
								plot_target_char = { character = ROOT }
							}
							is_parent_of = ROOT
						}
					}
					character_event = { id = CM.6002 }
				}
				any_child = {
					limit = {
						NOR = {
							character = FROM
							AND = {
								OR = {
									has_plot = plot_kill_character
									has_plot = plot_kill_spouse
								}
								plot_target_char = { character = ROOT }
							}
							is_parent_of = ROOT
							is_married = ROOT
						}
					}
					character_event = { id = CM.6002 }
				}
				any_lover = {
					limit = {
						NOR = {
							character = FROM
							AND = {
								OR = {
									has_plot = plot_kill_character
									has_plot = plot_kill_spouse
								}
								plot_target_char = { character = ROOT }
							}
							is_parent_of = ROOT
							is_married = ROOT
							is_child_of = ROOT
						}
					}
					character_event = { id = CM.6002 }
				}
				any_sibling = {
					limit = {
						NOR = {
							character = FROM
							AND = {
								OR = {
									has_plot = plot_kill_character
									has_plot = plot_kill_spouse
								}
								plot_target_char = { character = ROOT }
							}
							is_parent_of = ROOT
							is_married = ROOT
							is_child_of = ROOT
							is_lover = ROOT
						}
					}
					character_event = { id = CM.6002 }
				}
				any_rival = {
					limit = {
						NOR = {
							character = FROM
							AND = {
								OR = {
									has_plot = plot_kill_character
									has_plot = plot_kill_spouse
								}
								plot_target_char = { character = ROOT }
							}
							is_parent_of = ROOT
							is_married = ROOT
							is_child_of = ROOT
							is_lover = ROOT
							sibling = ROOT
						}
					}
					character_event = { id = CM.6002 }
				}
			}
		}
		ai_will_do = {
			factor = 1

			modifier = {
				factor = 0.5
			}
			modifier = {
				factor = 0.1
				FROM = {
					practical_age = 65
				}
			}
			modifier = {
				factor = 0.1
				trait = pregnant
				father_of_unborn_known = yes
				NOT = {
					father_of_unborn = {
						character = FROM
					}
				}
			}
			modifier = {
				factor = 0.5
				NOT = {
					reverse_opinion = {
						who = FROM
						value = -24
					}
				}
			}
			modifier = {
				factor = 1.5
				reverse_opinion = {
					who = FROM
					value = 25
				}
			}
			modifier = {
				factor = 5
				FROM = { trait = in_hiding }
			}
			modifier = {
				factor = 10
				FROM = { trait = paranoid }
			}
			modifier = {
				factor = 10
				trait = pregnant
				OR = {
					father_of_unborn = {
						character = FROM
					}
					father_of_unborn_known = no
				}
			}
		}
	}

	take_spouse_out_of_hiding = {
		only_rulers = yes
		is_high_prio = yes

		filter = spouse
		ai_target_filter = spouse
		ai_check_interval = 12

		from_potential = {
			is_ruler = yes
			has_regent = no
		}

		potential = {
			trait = in_hiding
			is_ruler = no
			is_married = FROM
			vassal_of = FROM
			prisoner = no
			NOT = { has_character_flag = emf_siege_in_hiding } # EMF: Siege module
		}

		allow = {
			trait = in_hiding
		}

		effect = {
			add_character_modifier = {
				name = went_out_of_hiding_timer
				duration = 180
				hidden = yes
			}
			clr_character_flag = do_not_disturb
			custom_tooltip = { text = come_out_of_hiding_info_tooltip }
			remove_trait = in_hiding
			hidden_tooltip = {					# Notify player and close family and plotters
				any_plotter = {
					target = ROOT
					limit = {
						NOT = { character = FROM }
						OR = {
							has_plot = plot_kill_character
							has_plot = plot_kill_spouse
						}
					}
					character_event = { id = CM.6003 }
					any_backed_character = {
						limit = {
							NOT = { character = FROM }
						}
						character_event = { id = CM.6003 }
					}
				}
				father = {
					if = {
						limit = {
							NOR = {
								character = FROM
								AND = {
									OR = {
										has_plot = plot_kill_character
										has_plot = plot_kill_spouse
									}
									plot_target_char = { character = ROOT }
								}
							}
						}
						character_event = { id = CM.6003 }
					}
				}
				mother = {
					if = {
						limit = {
							NOR = {
								character = FROM
								AND = {
									OR = {
										has_plot = plot_kill_character
										has_plot = plot_kill_spouse
									}
									plot_target_char = { character = ROOT }
								}
							}
						}
						character_event = { id = CM.6003 }
					}
				}
				any_spouse = {
					limit = {
						NOR = {
							character = FROM
							AND = {
								OR = {
									has_plot = plot_kill_character
									has_plot = plot_kill_spouse
								}
								plot_target_char = { character = ROOT }
							}
							is_parent_of = ROOT
						}
					}
					character_event = { id = CM.6003 }
				}
				any_child = {
					limit = {
						NOR = {
							character = FROM
							AND = {
								OR = {
									has_plot = plot_kill_character
									has_plot = plot_kill_spouse
								}
								plot_target_char = { character = ROOT }
							}
							is_parent_of = ROOT
							is_married = ROOT
						}
					}
					character_event = { id = CM.6003 }
				}
				any_lover = {
					limit = {
						NOR = {
							character = FROM
							AND = {
								OR = {
									has_plot = plot_kill_character
									has_plot = plot_kill_spouse
								}
								plot_target_char = { character = ROOT }
							}
							is_parent_of = ROOT
							is_married = ROOT
							is_child_of = ROOT
						}
					}
					character_event = { id = CM.6003 }
				}
				any_sibling = {
					limit = {
						NOR = {
							character = FROM
							AND = {
								OR = {
									has_plot = plot_kill_character
									has_plot = plot_kill_spouse
								}
								plot_target_char = { character = ROOT }
							}
							is_parent_of = ROOT
							is_married = ROOT
							is_child_of = ROOT
							is_lover = ROOT
						}
					}
					character_event = { id = CM.6003 }
				}
				any_rival = {
					limit = {
						NOR = {
							character = FROM
							AND = {
								OR = {
									has_plot = plot_kill_character
									has_plot = plot_kill_spouse
								}
								plot_target_char = { character = ROOT }
							}
							is_parent_of = ROOT
							is_married = ROOT
							is_child_of = ROOT
							is_lover = ROOT
							sibling = ROOT
						}
					}
					character_event = { id = CM.6003 }
				}
			}
		}
		ai_will_do = {
			factor = 1
			modifier = {
				factor = 0.3
				trait = paranoid
			}
			modifier = {
				factor = 0
				ROOT = {
					OR = {
						has_character_modifier = suspected_murder_plot
						FROM = {
							any_known_plotter = {
								target = ROOT
								OR = {
									has_plot = plot_kill_character
									has_plot = plot_kill_spouse
								}
							}
						}
					}
				}
			}
		}
	}
}
