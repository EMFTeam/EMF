# -*- ck2.decisions -*-

decisions = {
	form_knights_of_calatrava = {
		is_high_prio = yes
		only_playable = yes
		ai_check_interval = 60

		potential = {
			has_dlc = "Sons of Abraham"

			any_demesne_title = {
				tier = COUNT
				NOT = {
					title = c_calatrava
				}
			}

			any_demesne_title = {
				higher_tier_than = DUKE
				region = world_europe_west_iberia
			}
			NOT = {
				is_title_active = d_knights_calatrava
			}
			OR = {
				religion = catholic
				religion = cathar
				religion = fraticelli
				religion = waldensian
				religion = lollard
			}

			OR = {
				has_landed_title = c_calatrava
				any_realm_lord = {
					has_landed_title = c_calatrava
				}
			}

			OR = {
				has_global_flag = christian_crusades_unlocked #Prevent Army from being created at start.
				has_global_flag = pagan_ghws_unlocked 
				has_global_flag = muslim_jihads_unlocked
				has_global_flag = jewish_ghws_unlocked
				has_global_flag = zoroastrian_ghws_unlocked
			}

			NOT = {
				has_alternate_start_parameter = { key = religion_names value = random }
			}
		}
		allow = {
			war = no
			piety = 500
			wealth = 500
			is_heretic = no
			culture_group = iberian
			independent = yes

			NOT = {
				trait = excommunicated
			}

			custom_tooltip = {
				text = only_one_vassalized_holy_order_TT

				NOT = {
					any_realm_lord = {
						holy_order = yes
					}
				}
			}
		}
		effect = {
			wealth = -500
			piety = -500

			custom_tooltip = {
				text = form_knights_of_calatrava_TT

				create_random_soldier = {
					random_traits = yes
					dynasty = random
					culture = castillan
					religion = ROOT
					age = 25
					trait = shrewd
					trait = zealous
					trait = diligent
					trait = inspiring_leader
					trait = organizer
				}
				new_character = {
					set_government_type = order_government
					if = {
						limit = {
							NOT = {
								trait = brilliant_strategist
							}
						}
						remove_trait = misguided_warrior
						remove_trait = tough_soldier
						remove_trait = skilled_tactician
						add_trait = brilliant_strategist
					}
					grant_title_no_opinion = d_knights_calatrava
					grant_title_no_opinion = c_calatrava
					set_defacto_liege = ROOT
					save_event_target_as = grandmaster_of_calatrava

					opinion = {
						modifier = opinion_formed_order
						who = ROOT
						years = 25
					}
					add_friend = ROOT

					primary_title = {
						holy_order_set_law_effect = yes
					}
					emf_new_character_noble = yes
				}

				c_calatrava = {
					any_direct_de_jure_vassal_title = {
						limit = { owner_under_ROOT = yes }
						if = {
							limit = { owner = { character = ROOT } }
							if = {
								limit = { holding_type = city }
								create_random_steward = {
									random_traits = yes
									dynasty = random
								}
								new_character = { emf_new_character_steward = yes }
							}
							else_if = {
								limit = { holding_type = temple }
								create_random_priest = {
									random_traits = yes
									dynasty = random
								}
								new_character = { emf_new_character_priest = yes }
							}
							else = {
								create_random_soldier = {
									random_traits = yes
									dynasty = random
								}
								new_character = { emf_new_character_noble = yes }
							}
							new_character = {
								grant_title_no_opinion = PREV
								set_defacto_liege = event_target:grandmaster_of_calatrava
							}
						}
						else_if = {
							limit = { has_owner = yes }
							owner = {
								set_defacto_liege = event_target:grandmaster_of_calatrava
								religion = ROOT
							}
						}
					}
				}

				d_knights_calatrava = {
					holder_scope = {
						set_defacto_liege = ROOT
					}
				}
			}

			ROOT = {
				narrative_event = { id = HFP.40029 }
			}
			any_playable_ruler = {
				narrative_event = { id = HFP.40029 }
			}

			sound_effect = generic_click_01
		}
	}

	vassalize_knights_of_calatrava = {
		is_high_prio = yes
		only_playable = yes
		ai_check_interval = 60

		potential = {
			is_title_active = d_knights_calatrava

			any_demesne_title = {
				tier = COUNT
				NOT = {
					title = c_calatrava
				}
			}

			any_demesne_title = {
				higher_tier_than = DUKE
				region = world_europe_west_iberia
			}
			OR = {
				religion = catholic
				religion = cathar
				religion = fraticelli
				religion = waldensian
				religion = lollard
			}

			NOT = { has_character_modifier = expelled_d_knights_calatrava }

			d_knights_calatrava = {
				holder_scope = {
					independent = yes
				}
			}

			NOT = {
				d_knights_calatrava = {
					owner = {
						has_opinion_modifier = {
							who = ROOT
							modifier = opinion_unfit_ruler
						}
					}
				}
			}

			OR = {
				has_landed_title = c_calatrava
				any_realm_lord = {
					has_landed_title = c_calatrava
				}
				d_knights_calatrava = {
					owner = {
						has_landed_title = c_calatrava
					}
				}
			}

			NOT = {
				has_alternate_start_parameter = { key = religion_names value = random }
			}
		}
		allow = {
			war = no
			wealth = 300
			is_heretic = no
			culture_group = iberian
			independent = yes

			conditional_tooltip = {
				trigger = {
					NOT = {
						d_knights_calatrava = {
							holder_scope = {
								opinion = {
									who = ROOT
									value = 25
								}
							}
						}
					}
				}

				custom_tooltip = {
					text = vassalize_knights_calatrava_opinion_TT

					d_knights_templar = {
						holder_scope = {
							opinion = {
								who = ROOT
								value = 25
							}
						}
					}
				}
			}
			NOT = {
				trait = excommunicated
			}

			custom_tooltip = {
				text = only_one_vassalized_holy_order_TT

				NOT = {
					any_realm_lord = {
						holy_order = yes
					}
				}
			}
		}
		effect = {
			wealth = -300

			d_knights_calatrava = {
				show_scope_change = no
				holder_scope = {
					show_scope_change = no
					grant_title_no_opinion = c_calatrava
				}
			}

			hidden_tooltip = {
				d_knights_calatrava = {
					holder_scope = {
						save_event_target_as = grandmaster_of_calatrava
						wealth = 300
					}
					set_defacto_liege = ROOT
				}

				c_calatrava = {
					any_direct_de_jure_vassal_title = {
						limit = { owner_under_ROOT = yes }
						if = {
							limit = { owner = { character = ROOT } }
							if = {
								limit = { holding_type = city }
								create_random_steward = {
									random_traits = yes
									dynasty = random
								}
								new_character = { emf_new_character_steward = yes }
							}
							else_if = {
								limit = { holding_type = temple }
								create_random_priest = {
									random_traits = yes
									dynasty = random
								}
								new_character = { emf_new_character_priest = yes }
							}
							else = {
								create_random_soldier = {
									random_traits = yes
									dynasty = random
								}
								new_character = { emf_new_character_noble = yes }
							}
							new_character = {
								grant_title_no_opinion = PREV
								set_defacto_liege = event_target:grandmaster_of_calatrava
							}
						}
						else_if = {
							limit = { has_owner = yes }
							owner = {
								set_defacto_liege = event_target:grandmaster_of_calatrava
								religion = ROOT
							}
						}
					}
				}
			}
		}
	}

	form_knights_of_santiago = {
		is_high_prio = yes
		only_playable = yes
		ai_check_interval = 60

		potential = {
			has_dlc = "Sons of Abraham"

			any_demesne_title = {
				tier = COUNT
				NOT = {
					title = c_santiago
				}
			}

			any_demesne_title = {
				higher_tier_than = DUKE
				region = world_europe_west_iberia
			}
			NOT = {
				is_title_active = d_knights_santiago
			}
			OR = {
				religion = catholic
				religion = cathar
				religion = fraticelli
				religion = waldensian
				religion = lollard
			}
			is_heretic = no

			culture_group = iberian

			independent = yes

			OR = {
				has_landed_title = c_santiago
				any_realm_lord = {
					has_landed_title = c_santiago
				}
			}

			OR = {
				has_global_flag = christian_crusades_unlocked #Prevent Army from being created at start.
				has_global_flag = pagan_ghws_unlocked 
				has_global_flag = muslim_jihads_unlocked
				has_global_flag = jewish_ghws_unlocked
				has_global_flag = zoroastrian_ghws_unlocked
			}

			NOT = {
				has_alternate_start_parameter = { key = religion_names value = random }
			}
		}
		allow = {
			war = no
			piety = 500
			wealth = 500
			NOT = {
				trait = excommunicated
			}

			custom_tooltip = {
				text = only_one_vassalized_holy_order_TT

				NOT = {
					any_realm_lord = {
						holy_order = yes
					}
				}
			}
		}
		effect = {
			wealth = -500
			piety = -500

			custom_tooltip = {
				text = form_knights_of_santiago_TT

				create_random_soldier = {
					random_traits = yes
					dynasty = random
					culture = castillan
					religion = ROOT
					age = 25
					trait = shrewd
					trait = zealous
					trait = diligent
					trait = inspiring_leader
					trait = organizer
				}
				new_character = {
					set_government_type = order_government
					if = {
						limit = {
							NOT = {
								trait = brilliant_strategist
							}
						}
						remove_trait = misguided_warrior
						remove_trait = tough_soldier
						remove_trait = skilled_tactician
						add_trait = brilliant_strategist
					}
					grant_title_no_opinion = d_knights_santiago
					grant_title_no_opinion = c_santiago
					set_defacto_liege = ROOT
					save_event_target_as = grandmaster_of_santiago

					opinion = {
						modifier = opinion_formed_order
						who = ROOT
						years = 25
					}
					add_friend = ROOT
					primary_title = {
						holy_order_set_law_effect = yes
					}
					emf_new_character_noble = yes
				}

				c_santiago = {
					any_direct_de_jure_vassal_title = {
						limit = { owner_under_ROOT = yes }
						if = {
							limit = { owner = { character = ROOT } }
							if = {
								limit = { holding_type = city }
								create_random_steward = {
									random_traits = yes
									dynasty = random
								}
								new_character = { emf_new_character_steward = yes }
							}
							else_if = {
								limit = { holding_type = temple }
								create_random_priest = {
									random_traits = yes
									dynasty = random
								}
								new_character = { emf_new_character_priest = yes }
							}
							else = {
								create_random_soldier = {
									random_traits = yes
									dynasty = random
								}
								new_character = { emf_new_character_noble = yes }
							}
							new_character = {
								grant_title_no_opinion = PREV
								set_defacto_liege = event_target:grandmaster_of_santiago
							}
						}
						else_if = {
							limit = { has_owner = yes }
							owner = {
								set_defacto_liege = event_target:grandmaster_of_santiago
								religion = ROOT
							}
						}
					}
				}

				d_knights_santiago = {
					holder_scope = {
						set_defacto_liege = ROOT
					}
				}
			}

			ROOT = {
				narrative_event = { id = HFP.40030 }
			}
			any_playable_ruler = {
				narrative_event = { id = HFP.40030 }
			}

			sound_effect = generic_click_01
		}
	}

	vassalize_knights_of_santiago = {
		is_high_prio = yes
		only_playable = yes
		ai_check_interval = 60

		potential = {
			is_title_active = d_knights_santiago
			
			any_demesne_title = {
				tier = COUNT
				NOT = {
					title = c_calatrava
				}
			}
			
			any_demesne_title = {
				higher_tier_than = DUKE
				region = world_europe_west_iberia
			}
			
			OR = {
				religion = catholic
				religion = cathar
				religion = fraticelli
				religion = waldensian
				religion = lollard
			}

			NOT = { has_character_modifier = expelled_d_knights_santiago }

			d_knights_santiago = {
				holder_scope = {
					independent = yes
				}
			}

			NOT = {
				d_knights_santiago = {
					owner = {
						has_opinion_modifier = {
							who = ROOT
							modifier = opinion_unfit_ruler
						}
					}
				}
			}

			OR = {
				has_landed_title = c_santiago
				any_realm_lord = {
					has_landed_title = c_santiago
				}
				d_knights_santiago = {
					holder_scope = {
						OR = {
							has_landed_title = c_santiago
							any_realm_lord = {
								has_landed_title = c_santiago
							}
						}
					}
				}
			}

			NOT = {
				has_alternate_start_parameter = { key = religion_names value = random }
			}
		}
		allow = {
			war = no
			wealth = 300
			is_heretic = no
			culture_group = iberian
			independent = yes

			conditional_tooltip = {
				trigger = {
					NOT = {
						d_knights_santiago = {
							holder_scope = {
								opinion = {
									who = ROOT
									value = 25
								}
							}
						}
					}
				}

				custom_tooltip = {
					text = vassalize_knights_santiago_opinion_TT

					d_knights_templar = {
						holder_scope = {
							opinion = {
								who = ROOT
								value = 25
							}
						}
					}
				}
			}
			NOT = {
				trait = excommunicated
			}

			custom_tooltip = {
				text = only_one_vassalized_holy_order_TT

				NOT = {
					any_realm_lord = {
						holy_order = yes
					}
				}
			}
		}
		effect = {
			wealth = -300

			d_knights_santiago = {
				show_scope_change = no
				holder_scope = {
					show_scope_change = no
					grant_title_no_opinion = c_santiago
				}
			}

			hidden_tooltip = {
				d_knights_santiago = {
					holder_scope = {
						save_event_target_as = grandmaster_of_santiago
						wealth = 300
					}
					set_defacto_liege = ROOT
				}

				c_santiago = {
					any_direct_de_jure_vassal_title = {
						limit = { owner_under_ROOT = yes }
						if = {
							limit = { owner = { character = ROOT } }
							if = {
								limit = { holding_type = city }
								create_random_steward = {
									random_traits = yes
									dynasty = random
								}
								new_character = { emf_new_character_steward = yes }
							}
							else_if = {
								limit = { holding_type = temple }
								create_random_priest = {
									random_traits = yes
									dynasty = random
								}
								new_character = { emf_new_character_priest = yes }
							}
							else = {
								create_random_soldier = {
									random_traits = yes
									dynasty = random
								}
								new_character = { emf_new_character_noble = yes }
							}
							new_character = {
								grant_title_no_opinion = PREV
								set_defacto_liege = event_target:grandmaster_of_santiago
							}
						}
						else_if = {
							limit = { has_owner = yes }
							owner = {
								set_defacto_liege = event_target:grandmaster_of_santiago
								religion = ROOT
							}
						}
					}
				}
			}
		}
	}

	form_teutonic_order = {
		is_high_prio = yes
		only_playable = yes
		ai_check_interval = 60

		potential = {
			any_demesne_title = {
				higher_tier_than = DUKE
			}
			NOT = {
				is_title_active = d_teutonic_order
				is_title_active = k_teutonic_state
			}
			OR = {
				religion = catholic
				religion = cathar
				religion = fraticelli
				religion = waldensian
				religion = lollard
			}
			OR = {
				has_landed_title = e_hre
				NOT = {
					is_title_active = e_hre
				}
			}

			OR = {
				culture = german
				culture = low_german
			}

			independent = yes

			OR = {
				has_global_flag = christian_crusades_unlocked #Prevent Army from being created at start.
				has_global_flag = pagan_ghws_unlocked 
				has_global_flag = muslim_jihads_unlocked
				has_global_flag = jewish_ghws_unlocked
				has_global_flag = zoroastrian_ghws_unlocked
			}

			NOT = {
				has_alternate_start_parameter = { key = religion_names value = random }
			}
		}

		allow = {
			war = no
			piety = 500
			wealth = 500
			is_heretic = no
			OR = {
				culture = german
				culture = low_german
			}
			NOT = {
				trait = excommunicated
			}
			custom_tooltip = {
				text = form_teutonic_order_jerusalem_TT

				k_jerusalem = {
					holder_scope = {
						religion = ROOT
					}
				}
			}
		}

		effect = {
			wealth = -500
			piety = -500

			custom_tooltip = {
				text = form_teutonic_order_TT

				create_random_soldier = {
					random_traits = yes
					dynasty = random
					culture = ROOT
					religion = ROOT
					age = 25
					trait = shrewd
					trait = zealous
					trait = diligent
					trait = inspiring_leader
					trait = organizer
				}
				new_character = {
					set_government_type = order_government
					if = {
						limit = {
							NOT = {
								trait = brilliant_strategist
							}
						}
						remove_trait = misguided_warrior
						remove_trait = tough_soldier
						remove_trait = skilled_tactician
						add_trait = brilliant_strategist
					}
					grant_title_no_opinion = d_teutonic_order
					save_event_target_as = teutonic_hochmeister

					opinion = {
						modifier = opinion_formed_order
						who = ROOT
						years = 25
					}
					add_friend = ROOT
					primary_title = {
						holy_order_set_law_effect = yes
					}
					emf_new_character_noble = yes
				}
			}

			ROOT = {
				narrative_event = { id = HFP.40031 }
			}
			any_playable_ruler = {
				narrative_event = { id = HFP.40031 }
			}

			sound_effect = generic_click_01
		}
	}

	vassalize_teutonic_knights = {
		is_high_prio = yes
		only_playable = yes
		ai_check_interval = 60

		potential = {
			religion_group = christian
			any_owned_bloodline = {
				has_bloodline_flag = northern_crusade_bloodline
				bloodline_is_active_for = PREV
			}
			OR = {
				AND = {
					is_title_active = d_teutonic_order
					d_teutonic_order = {
						holder_scope = {
							independent = yes
						}
					}
				}
				AND = {
					is_title_active = k_teutonic_state
					k_teutonic_state = {
						holder_scope = {
							independent = yes
						}
					}
				}
			}
			NOR = {
				d_teutonic_order = {
					holder_scope = {
						has_opinion_modifier = {
							who = ROOT
							modifier = opinion_unfit_ruler
						}
					}
				}
				k_teutonic_state = {
					holder_scope = {
						has_opinion_modifier = {
							who = ROOT
							modifier = opinion_unfit_ruler
						}
					}
				}
				has_character_modifier = expelled_d_teutonic_order
			}

			OR = {
				has_global_flag = christian_crusades_unlocked #Prevent Army from being created at start.
				has_global_flag = pagan_ghws_unlocked 
				has_global_flag = muslim_jihads_unlocked
				has_global_flag = jewish_ghws_unlocked
				has_global_flag = zoroastrian_ghws_unlocked
			}

			is_heretic = no

			NOT = {
				has_alternate_start_parameter = { key = religion_names value = random }
			}
		}

		allow = {
			independent = yes
			piety = 300

			custom_tooltip = {
				text = higher_tier_than_teutonic_knights_TT

				OR = {
					AND = {
						is_title_active = d_teutonic_order
						higher_tier_than = DUKE
					}
					AND = {
						is_title_active = k_teutonic_state
						higher_tier_than = KING
					}
				}
			}

			conditional_tooltip = {
				trigger = {
					AND = {
						NOT = {
							d_teutonic_order = {
								holder_scope = {
									opinion = {
										who = ROOT
										value = 25
									}
								}
							}
						}
						is_title_active = d_teutonic_order
					}
				}

				custom_tooltip = {
					text = teutonic_order_opinion_TT

					d_teutonic_order = {
						holder_scope = {
							opinion = {
								who = ROOT
								value = 25
							}
						}
					}
				}
			}

			conditional_tooltip = {
				trigger = {
					AND = {
						NOT = {
							k_teutonic_state = {
								holder_scope = {
									opinion = {
										who = ROOT
										value = 25
									}
								}
							}
						}
						is_title_active = k_teutonic_state
					}
				}

				custom_tooltip = {
					text = teutonic_state_opinion_TT

					k_teutonic_state = {
						holder_scope = {
							opinion = {
								who = ROOT
								value = 25
							}
						}
					}
				}
			}

			custom_tooltip = {
				text = form_teutonic_order_jerusalem_TT

				k_jerusalem = {
					holder_scope = {
						religion = ROOT
					}
				}
			}
		}

		effect = {
			piety = -300
			custom_tooltip = {
				text = vassalize_teutonic_knights_TT

				if = {
					limit = {
						is_title_active = d_teutonic_order
					}
					d_teutonic_order = {
						holder_scope = {
							set_defacto_liege = ROOT
						}
					}
				}
				else_if = {
					limit = {
						is_title_active = k_teutonic_state
					}
					k_teutonic_state = {
						holder_scope = {
							set_defacto_liege = ROOT
						}
					}
				}
			}
		}
	}

	hire_teutonic_honor_guard = {
		is_high_prio = yes
		only_playable = yes
		ai = no

		potential = {
			any_owned_bloodline = {
				has_bloodline_flag = northern_crusade_bloodline
				bloodline_is_active_for = PREV
			}
			religion_group = christian
			is_heretic = no
			NOT = {
				has_earmarked_regiments = teutonic_honor_guard
			}
			OR = {
				is_title_active = d_teutonic_order
				is_title_active = k_teutonic_state
			}
		}

		allow = {
			piety = 300
			war = yes
			conditional_tooltip = {
				trigger = {
					d_teutonic_order = {
						holder_scope = {
							is_foe = ROOT
						}
					}
					is_title_active = d_teutonic_order
				}

				NOT = {
					d_teutonic_order = {
						holder_scope = {
							is_foe = ROOT
						}
					}
				}
			}
			conditional_tooltip = {
				trigger = {
					k_teutonic_state = {
						show_scope_change = no
						holder_scope = {
							show_scope_change = no
							is_foe = ROOT
						}
					}
					is_title_active = k_teutonic_state
				}

				NOT = {
					k_teutonic_state = {
						show_scope_change = no
						holder_scope = {
							show_scope_change = no
							is_foe = ROOT
						}
					}
				}
			}
			conditional_tooltip = {
				trigger = {
					has_character_modifier = hire_teutonic_honor_guard_cooldown
				}

				custom_tooltip = {
					text = hire_teutonic_honor_guard_cooldown_TT

					always = no
				}
			}
		}

		effect = {
			piety = -300

			capital_scope = {
				show_scope_change = no
				ROOT = {
					show_scope_change = no
					spawn_unit = {
						owner = ROOT
						province = PREV
						home = PREV
						troops = {
							heavy_infantry = { 1500 1500 }
							light_infantry = { 1500 1500 }
							archers = { 1000 1000 }
						}
						attrition = 1.0
						disband_on_peace = yes
						maintenance_multiplier = 0.4
						earmark = teutonic_honor_guard
					}	
				}
			}

			hidden_tooltip = {
				add_character_modifier = {
					name = hire_teutonic_honor_guard_cooldown
					hidden = yes
					years = 1
				}
			}
			sound_effect = generic_click_01
		}
	}

	form_holy_sepulchre = {
		is_high_prio = yes
		only_playable = yes
		ai_check_interval = 60

		potential = {
			any_demesne_title = {
				higher_tier_than = BARON
			}
			NOT = {
				is_title_active = d_holy_sepulchre
			}
			OR = {
				religion = orthodox
				religion = bogomilist
				religion = monothelite
				religion = iconoclast
				religion = paulician
			}

			is_heretic = no

			OR = {
				has_landed_title = c_jerusalem
				any_realm_lord = {
					has_landed_title = c_jerusalem
				}
			}			

			independent = yes

			OR = {
				has_global_flag = christian_crusades_unlocked #Prevent Army from being created at start.
				has_global_flag = pagan_ghws_unlocked 
				has_global_flag = muslim_jihads_unlocked
				has_global_flag = jewish_ghws_unlocked
				has_global_flag = zoroastrian_ghws_unlocked
			}

			NOT = {
				has_alternate_start_parameter = { key = religion_names value = random }
			}
		}
		allow = {
			war = no
			piety = 500
			wealth = 500
			is_heretic = no
			independent = yes
			NOT = {
				trait = excommunicated
			}

			custom_tooltip = {
				text = form_holy_sepulchre_jerusalem_TT

				OR = {
					has_landed_title = c_jerusalem
					any_realm_lord = {
						has_landed_title = c_jerusalem
					}
				}
			}
		}
		effect = {
			wealth = -500
			piety = -500

			custom_tooltip = {
				text = form_holy_sepulchre_TT

				create_random_soldier = {
					random_traits = yes
					dynasty = random
					culture = greek
					religion = ROOT
					age = 25
					trait = shrewd
					trait = zealous
					trait = diligent
					trait = inspiring_leader
					trait = organizer
				}
				new_character = {
					set_government_type = order_government
					if = {
						limit = {
							NOT = {
								trait = brilliant_strategist
							}
						}
						remove_trait = misguided_warrior
						remove_trait = tough_soldier
						remove_trait = skilled_tactician
						add_trait = brilliant_strategist
					}
					grant_title_no_opinion = d_holy_sepulchre

					opinion = {
						modifier = opinion_formed_order
						who = ROOT
						years = 25
					}
					add_friend = ROOT
					primary_title = {
						holy_order_set_law_effect = yes
					}
					emf_new_character_noble = yes
				}
			}

			if = {
				limit = {
					higher_tier_than = DUKE
					NOT = {
						any_realm_lord = {
							holy_order = yes
						}
					}
				}

				custom_tooltip = {
					text = form_vassalize_holy_sepulchre_TT

					d_holy_sepulchre = {
						holder_scope = {
							set_defacto_liege = ROOT
						}
					}
				}
			}

			ROOT = {
				narrative_event = { id = HFP.40032 }
			}
			any_playable_ruler = {
				narrative_event = { id = HFP.40032 }
			}

			sound_effect = generic_click_01
		}
	}

	vassalize_holy_sepulchre = {
		is_high_prio = yes
		only_playable = yes
		ai_check_interval = 60

		potential = {
			any_demesne_title = {
				higher_tier_than = DUKE
			}
			OR = {
				religion = orthodox
				religion = bogomilist
				religion = monothelite
				religion = iconoclast
				religion = paulician
			}

			OR = {
				has_landed_title = c_jerusalem
				any_realm_lord = {
					has_landed_title = c_jerusalem
				}
			}			

			independent = yes

			d_holy_sepulchre = {
				holder_scope = {
					independent = yes
				}
			}

			NOT = {
				d_holy_sepulchre = {
					owner = {
						has_opinion_modifier = {
							who = ROOT
							modifier = opinion_unfit_ruler
						}
					}
				}
			}

			NOT = { has_character_modifier = expelled_d_holy_sepulchre }

			OR = {
				has_global_flag = christian_crusades_unlocked #Prevent Army from being created at start.
				has_global_flag = pagan_ghws_unlocked 
				has_global_flag = muslim_jihads_unlocked
				has_global_flag = jewish_ghws_unlocked
				has_global_flag = zoroastrian_ghws_unlocked
			}

			NOT = {
				has_alternate_start_parameter = { key = religion_names value = random }
			}
		}
		allow = {
			war = no
			piety = 500
			wealth = 500
			is_heretic = no
			independent = yes
			NOT = {
				trait = excommunicated
			}
			custom_tooltip = {
				text = form_holy_sepulchre_jerusalem_TT

				OR = {
					has_landed_title = c_jerusalem
					any_realm_lord = {
						has_landed_title = c_jerusalem
					}
				}
			}

			conditional_tooltip = {
				trigger = {
					NOT = {
						d_holy_sepulchre = {
							holder_scope = {
								opinion = {
									who = ROOT
									value = 25
								}
							}
						}
					}
				}

				custom_tooltip = {
					text = vassalize_holy_sepulchre_TT

					d_holy_sepulchre = {
						holder_scope = {
							opinion = {
								who = ROOT
								value = 25
							}
						}
					}
				}
			}

			custom_tooltip = {
				text = only_one_vassalized_holy_order_TT

				NOT = {
					any_realm_lord = {
						holy_order = yes
					}
				}
			}
		}
		effect = {
			wealth = -500
			piety = -500

			custom_tooltip = {
				text = form_vassalize_holy_sepulchre_TT

				d_holy_sepulchre = {
					holder_scope = {
						set_defacto_liege = ROOT
					}
				}
			}
		}
	}
}

targetted_decisions = {

	order_to_join_holy_order = {
		only_playable = yes
		filter = court
		ai_target_filter = court
		third_party_filter = all
		show_third_party_potential = no
		ai_check_interval = 1200 #Check every 1200 months

		from_potential = {
			is_playable = yes
			has_regent = no
			prisoner = no
			is_adult = yes
			is_heretic = no
		}

		third_party_potential = {
			FROMFROM = {
				religion = FROM
				holy_order = yes
			}
		}
		
		potential = {
			is_adult = yes
			is_ruler = no
			OR = {
				is_female = no
				emf_feminist_religion = yes
			}
			OR = {
				is_female = yes
				NOT = { has_religion_feature = religion_patriarchal }
			}
			religion = FROM
			is_incapable = no
			host = { character = FROM }
			holy_order_check_active_trigger = yes
		}
		
		allow = {
			OR = { 
				AND = { 
					is_married = no
					custom_tooltip = {
						text = NOT_HEIR_TITLE_TT

						NOT = {
                        	any_heir_title = { 
                            	always = yes
                            }
                        }
                    }
				}
				prisoner = yes
			}
			FROM = { piety = 50 }
		}

		effect = {
			FROM = {
				piety = -50
			}
			prisoner = no
			
			if = {
				limit = {
					OR = {
						trait = content
						trait = monk
						trait = nun
						trait = zealous
						trait = humble
						trait = brave
						trait = crusader
						trait = celibate
					}
				}
				move_character = FROMFROM
				hidden_tooltip = {
					add_trait = celibate
				}
			}
			else = {
				random_list = {
					80 = {
						# Intrigue based chance modifiers for FROM
						modifier = {
							factor = 0.5
							NOT = {
								FROM = {
									intrigue = 5
								}
							}
						}
						modifier = {
							factor = 1.5
							FROM = {
								intrigue = 10
							}
						}
						modifier = {
							factor = 1.5
							FROM = {
								intrigue = 15
							}
						}
						modifier = {
							factor = 1.5
							FROM = {
								intrigue = 20
							}
						}
						custom_tooltip = {
							text = join_holy_order_success_TT

							move_character = FROMFROM
							add_trait = celibate
						}
					}
					20 = {
						# Traits making ROOT more likely to join a Holy Order
						modifier = {
							factor = 0.5
							trait = diligent
						}
						modifier = {
							factor = 0.5
							trait = temperate
						}
						modifier = {
							factor = 0.5
							trait = chaste
						}
						modifier = {
							factor = 0.5
							trait = brave
						}
						modifier = {
							factor = 0.5
							is_married = yes
						}
						modifier = {
							factor = 0.5
							trait = holy_warrior
						}
						# Traits making ROOT less likely to join a Holy order
						modifier = {
							factor = 2
							trait = ambitious
						}
						modifier = {
							factor = 1.5
							trait = greedy
						}
						modifier = {
							factor = 1.5
							trait = cynical
						}
						modifier = {
							factor = 1.5
							trait = envious
						}
						modifier = {
							factor = 1.5
							trait = proud
						}
						# Intrigue based chance modifiers for ROOT
						modifier = {
							factor = 0.5
							NOT = {
								intrigue = 5
							}
						}
						modifier = {
							factor = 1.5
							intrigue = 10
						}
						modifier = {
							factor = 1.5
							intrigue = 15
						}
						modifier = {
							factor = 1.5
							intrigue = 20
						}
						modifier = {
							factor = 1.5
							intrigue = 25
						}
						# Tooltip
						custom_tooltip = {
							text = join_holy_order_flee_TT

							banish = yes
							add_rival = FROM
						}
					}
				}
			}
		}
	}

	ask_teutonic_for_help_teutonic = {
		only_playable = yes
		filter = independent_rulers
		ai_target_filter = independent_rulers
		third_party_filter = independent_rulers
		show_third_party_potential = no
		ai_check_interval = 60

		from_potential = {
			independent = yes
            any_demesne_title = {
                higher_tier_than = DUKE
                OR = {
                    region = world_europe_north
                    region = custom_eastern_baltic
                    region = custom_russia
                }
            }
            OR = {
				religion = catholic
				religion = cathar
				religion = fraticelli
				religion = waldensian
				religion = lollard
			}
			is_heretic = no
            NOT = {
            	has_global_flag = northern_crusade_failure
            }
            NOT = {
            	has_character_flag = northern_crusade_asked_for_help
            }
		}

		third_party_potential = {
			FROMFROM = {
				independent = yes
				conditional_tooltip = {
					trigger = {
						NOR = {
							d_teutonic_order = {
								has_title_flag = northern_crusade_target
							}
							k_teutonic_state = {
								has_title_flag = northern_crusade_target
							}
						}
					}
					higher_tier_than = COUNT
				}
				NOR = {
					holy_order = yes
					mercenary = yes
				}
				NOT = {
					religion_group = christian
				}
				any_demesne_title = {
					higher_tier_than = BARON
					OR = {
	                    region = world_europe_north
	                    region = custom_eastern_baltic
	                    region = custom_russia
	                }
				}
				NOT = {
					reverse_has_truce = ROOT
				}
				OR = {
					NOR = {
						d_teutonic_order = {
							has_title_flag = northern_crusade_target
						}
						k_teutonic_state = {
							has_title_flag = northern_crusade_target
						}
					}
					any_demesne_title = {
						kingdom = {
							has_title_flag = northern_crusade_active_target
						}
					}
				}
				emf_isolated_character = no
			}
		}

		potential = {
			has_global_flag = northern_crusades_active
			OR = {
				has_landed_title = d_teutonic_order
				has_landed_title = k_teutonic_state
			}
			NOT = {
				any_war = {
					using_cb = northern_crusade_war
				}
			}
			religion = FROM
		}

		allow = {
			FROM = {
				show_scope_change = no
				piety = 200
				#custom_tooltip = {
					#text = northern_crusade_targeted_decision_TT
					#d_teutonic_order = {
						#holder_scope = {
							#opinion = {
								#who = PREVPREV
								#value = 10
							#}
						#}
					#}
				#}
			}
			any_independent_ruler = {
				conditional_tooltip = {
					trigger = {
						NOR = {
							d_teutonic_order = {
								has_title_flag = northern_crusade_target
							}
							k_teutonic_state = {
								has_title_flag = northern_crusade_target
							}
						}
					}
					custom_tooltip = {
						text = higher_tier_than_count_TT
						higher_tier_than = COUNT
					}
				}
				NOR = {
					holy_order = yes
					mercenary = yes
				}
				NOT = {
					religion_group = christian
				}
				conditional_tooltip = {
					trigger = {
						OR = {
							d_teutonic_order = {
								has_title_flag = northern_crusade_target
							}
							k_teutonic_state = {
								has_title_flag = northern_crusade_target
							}
						}
					}
					custom_tooltip = {
						text = northern_crusade_fitting_title_TT
						any_demesne_title = {
							higher_tier_than = BARON
							OR = {
			                    region = world_europe_north
			                    region = custom_eastern_baltic
			                    region = custom_russia
			                }
			                kingdom = {
			             		has_title_flag = northern_crusade_active_target   
			                }
						}
					}
				}
				conditional_tooltip =  {
					trigger = {
						NOR = {
							d_teutonic_order = {
								has_title_flag = northern_crusade_target
							}
							k_teutonic_state = {
								has_title_flag = northern_crusade_target
							}
						}
					}
					custom_tooltip = {
						text = northern_crusade_fitting_title_02_TT
					}
				}
				custom_tooltip = {
					text = not_reverse_truce_TT
					NOT = {
						reverse_has_truce = ROOT
					}
				}
			}
			conditional_tooltip = {
				trigger = {
					FROM = {
						has_character_modifier = northern_crusade_targeted_decision_cooldown
					}
				}

				custom_tooltip = {
					text = northern_crusade_decision_cooldown_TT

					FROM = {
						NOT = {
							has_character_modifier = northern_crusade_targeted_decision_cooldown
						}
					}
				}
			}
		}

		effect = {
			FROM = {
				set_character_flag = northern_crusade_asked_for_help
				save_event_target_as = northern_crusade_asker
			}
			FROMFROM = {
				save_event_target_as = northern_crusade_potential_target
			}
			if = {
				limit = {
					is_title_active = d_teutonic_order
				}
				d_teutonic_order = {
					owner = {
						character_event = { id = HF.49105 }
					}
				}
			}
			else_if = {
				limit = {
					is_title_active = k_teutonic_state
				}
				k_teutonic_state = {
					owner = {
						character_event = { id = HF.49105 }
					}
				}
			}
			hidden_tooltip = {
				FROM = {
					add_character_modifier = {
						name = northern_crusade_targeted_decision_cooldown
						hidden = yes
						duration = 180
					}
				}
			}
		}
	}

	ask_teutonic_for_help_pagan = {
		only_playable = yes
		filter = independent_rulers
		ai = no

		from_potential = {
			independent = yes
            any_demesne_title = {
                higher_tier_than = DUKE
                OR = {
                    region = world_europe_north
                    region = custom_eastern_baltic
                    region = custom_russia
                }
            }
            OR = {
				religion = catholic
				religion = cathar
				religion = fraticelli
				religion = waldensian
				religion = lollard
			}
			is_heretic = no
            NOT = {
            	has_global_flag = northern_crusade_failure
            }
            NOT = {
            	has_character_flag = northern_crusade_asked_for_help
            }
		}

		potential = {
			has_global_flag = northern_crusades_active
			independent = yes
			conditional_tooltip = {
				trigger = {
					NOR = {
						d_teutonic_order = {
							has_title_flag = northern_crusade_target
						}
						k_teutonic_state = {
							has_title_flag = northern_crusade_target
						}
					}
				}
				higher_tier_than = COUNT
			}
			OR = {
				is_title_active = d_teutonic_order
				is_title_active = k_teutonic_state
			}
			NOR = {
				holy_order = yes
				mercenary = yes
			}
			NOT = {
				religion_group = christian
			}
			any_demesne_title = {
				higher_tier_than = BARON
				OR = {
                    region = world_europe_north
                    region = custom_eastern_baltic
                    region = custom_russia
                }
			}
			NOR = {
				d_teutonic_order = {
					owner = {
						has_truce = ROOT
					}
				}
				k_teutonic_state = {
					owner = {
						has_truce = ROOT
					}
				}
			}
			OR = {
				NOR = {
					d_teutonic_order = {
						has_title_flag = northern_crusade_target
					}
					k_teutonic_state = {
						has_title_flag = northern_crusade_target
					}
				}
				any_demesne_title = {
					kingdom = {
						has_title_flag = northern_crusade_active_target
					}
				}
			}
			NOR = {
				d_teutonic_order = {
					any_war = {
						using_cb = northern_crusade_war
					}
				}
				k_teutonic_state = {
					any_war = {
						using_cb = northern_crusade_war
					}
				}
			}
		}

		allow = {
			conditional_tooltip = {
				trigger = {
					is_title_active = d_teutonic_order 
				}
				d_teutonic_order = {
					show_scope_change = no
					holder_scope = {
						show_scope_change = no
						religion = FROM
					}
				}
			}
			conditional_tooltip = {
				trigger = {
					is_title_active = k_teutonic_state 
				}
				k_teutonic_state = {
					show_scope_change = no
					holder_scope = {
						show_scope_change = no
						religion = FROM
					}
				}
			}
			FROM = {
				show_scope_change = no
				piety = 200
				#custom_tooltip = {
					#text = northern_crusade_targeted_decision_TT
					#d_teutonic_order = {
						#holder_scope = {
							#opinion = {
								#who = PREVPREV
								#value = 10
							#}
						#}
					#}
				#}
			}
			conditional_tooltip = {
				trigger = {
					NOR = {
						d_teutonic_order = {
							has_title_flag = northern_crusade_target
						}
						k_teutonic_state = {
							has_title_flag = northern_crusade_target
						}
					}
				}
				higher_tier_than = COUNT
			}
			conditional_tooltip = {
				trigger = {
					FROM = {
						has_character_modifier = northern_crusade_targeted_decision_cooldown
					}
				}

				custom_tooltip = {
					text = northern_crusade_decision_cooldown_TT

					FROM = {
						NOT = {
							has_character_modifier = northern_crusade_targeted_decision_cooldown
						}
					}
				}
			}
			conditional_tooltip = {
				trigger = {
					d_teutonic_order = {
						has_title_flag = northern_crusade_target
					}
					is_title_active = d_teutonic_order
				}

				custom_tooltip = {
					text = northern_crusade_correct_kingdom_teutonic_order_TT

					any_demesne_title = {
						higher_tier_than = BARON
						OR = {
		                    region = world_europe_north
		                    region = custom_eastern_baltic
		                    region = custom_russia
		                }
		                kingdom = {
		             		has_title_flag = northern_crusade_active_target   
		                }
					}
				}
			}
			conditional_tooltip = {
				trigger = {
					k_teutonic_state = {
						has_title_flag = northern_crusade_target
					}
					is_title_active = k_teutonic_state
				}

				custom_tooltip = {
					text = northern_crusade_correct_kingdom_teutonic_order_TT

					any_demesne_title = {
						higher_tier_than = BARON
						OR = {
		                    region = world_europe_north
		                    region = custom_eastern_baltic
		                    region = custom_russia
		                }
		                kingdom = {
		             		has_title_flag = northern_crusade_active_target   
		                }
					}
				}
			}
			conditional_tooltip = {
				trigger = {
					AND = {
						is_title_active = d_teutonic_order
						d_teutonic_order = {
							owner = {
								war = yes
							}
						}
					}
				}
				custom_tooltip = {
					text = teutonic_order_at_peace_TT

					d_teutonic_order = {
						owner = {
							war = no
						}
					}
				}
			}
			conditional_tooltip = {
				trigger = {
					AND = {
						is_title_active = k_teutonic_state
						k_teutonic_state = {
							owner = {
								war = yes
							}
						}
					}
				}
				custom_tooltip = {
					text = teutonic_state_at_peace_TT

					k_teutonic_state = {
						owner = {
							war = no
						}
					}
				}
			}
			conditional_tooltip =  {
				trigger = {
					NOR = {
						d_teutonic_order = {
							has_title_flag = northern_crusade_target
						}
						k_teutonic_state = {
							has_title_flag = northern_crusade_target
						}
					}
				}
				custom_tooltip = {
					text = northern_crusade_fitting_title_02_TT
				}
			}
			NOR = {
				holy_order = yes
				mercenary = yes
			}
			NOT = {
				religion_group = christian
			}
			custom_tooltip = {
				text = not_reverse_truce_TT
				NOT = {
					reverse_has_truce = ROOT
				}
			}
		}

		effect = {
			FROM = {
				set_character_flag = northern_crusade_asked_for_help
				save_event_target_as = northern_crusade_asker
			}
			ROOT = {
				save_event_target_as = northern_crusade_potential_target
			}
			if = {
				limit = {
					is_title_active = d_teutonic_order
				}
				d_teutonic_order = {
					owner = {
						character_event = { id = HF.49105 }
					}
				}
			}
			else_if = {
				limit = {
					is_title_active = k_teutonic_state
				}
				k_teutonic_state = {
					owner = {
						character_event = { id = HF.49105 }
					}
				}
			}
			hidden_tooltip = {
				FROM = {
					add_character_modifier = {
						name = northern_crusade_targeted_decision_cooldown
						hidden = yes
						duration = 180
					}
				}
			}
		}
	}
}
