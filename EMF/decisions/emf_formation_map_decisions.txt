# -*- ck2.decisions -*-

decisions = {
	emf_create_leon = {
		is_high_prio = yes
		only_independent = yes
		ai_check_interval = 48
		
		potential = {
			tier = KING
			has_landed_title = k_asturias
			k_leon = { has_holder = no }
			has_random_dejure_or_title_names = no
			emf_hiprio_decision_basic_potential = yes
		}
		allow = {
			is_adult = yes
			independent = yes
			trigger_if = {
				limit = { ai = no }
				war = no
				prisoner = no
				has_regent = no
			}
			trigger_else = {
				is_primary_war_defender = no
			}
			is_incapable = no
			primary_title = { title = k_asturias }
			completely_controls = d_leon
			completely_controls = d_asturias
		}
		effect = {
			activate_title = { title = k_leon status = yes }
			k_asturias = {
				show_scope_change = no
				k_leon = {
					show_scope_change = no
					grant_title = ROOT
					hidden_tooltip = { make_primary_title = yes }
					copy_title_laws = PREV
					copy_title_history = PREV
					emf_copy_title_state_from_PREV = yes
				}
				hidden_tooltip = {
					any_direct_de_jure_vassal_title = {
						de_jure_liege = k_leon
					}
					activate_title = { title = k_asturias status = no }
					emf_destroy_title = yes
				}
			}
			if = {
				limit = {
					has_landed_title = c_leon
					NOT = { capital_scope = { county = { title = c_leon } } }
				}
				c_leon = { 
					show_scope_change = no
					ROOT = {
						show_scope_change = no
						capital = PREV 
					} 
				}
			}
			if = {
				limit = { has_nickname = no }
				give_nickname = nick_the_great
			}
			hidden_effect = {
				character_event = { id = 62920 }
				any_playable_ruler = {
					limit = {
						ai = no
						capital_scope = {
							region = world_europe_west_iberia
						}
					}
					character_event = { id = 62921 }
				}
			}
		}
		ai_will_do = {
			factor = 10
		}
	}

	emf_create_portugal = {
		only_independent = yes
		is_high_prio = yes
		ai_check_interval = 48
		
		potential = {
			tier = DUKE
			has_landed_title = d_porto
			k_portugal = {
				has_holder = no
				is_de_jure_title = no
			}
			has_random_dejure_or_title_names = no
			emf_hiprio_decision_basic_potential = yes
		}
		allow = {
			is_adult = yes
			independent = yes
			trigger_if = {
				limit = { ai = no }
				war = no
				prisoner = no
				has_regent = no
			}
			trigger_else = {
				is_primary_war_defender = no
			}
			is_incapable = no
			completely_controls = d_porto
			trigger_if = {
				limit = { ai = no }
				d_beja = {
					show_scope_change = no
					OR = {
						ROOT = {
							show_scope_change = no
							completely_controls = PREV
						}
						custom_tooltip = {
							text = THIS_WONT_BECOME_DE_JURE_VASSAL_OF_PORTUGAL
							NOT = { ROOT = { completely_controls = PREV } }
						}
					}
				}
				prestige = 1000
			}
			custom_tooltip = {
				text = NEEDS_200_GOLD_COST
				OR = {
					ai = yes
					wealth = 200
				}
			}
		}
		effect = {
			if = {
				limit = { ai = no }
				wealth = -200
			}
			prestige = 500
			primary_title = {
				save_event_target_as = current_primary_title
			}
			event_target:current_primary_title = {
				show_scope_change = no
				k_portugal = {
					show_scope_change = no
					grant_title = ROOT
					copy_title_laws = PREV
					emf_copy_title_state_from_PREV = yes
				}
			}
			d_porto = {
				show_scope_change = no
				de_jure_liege = k_portugal
			}
			if = {
				limit = { completely_controls = d_beja }
				d_beja = {
					show_scope_change = no
					de_jure_liege = k_portugal
				}
			}
			if = {
				limit = {
					has_landed_title = c_porto
					NOT = { capital_scope = { county = { title = c_porto } } }
				}
				c_porto = { 
					show_scope_change = no
					ROOT = { 
						show_scope_change = no
						capital = PREV 
					} 
				}
			}
			if = {
				limit = { has_nickname = no }
				give_nickname = nick_the_great
			}
			hidden_effect = {
				any_playable_ruler = {
					limit = {
						ai = no
						capital_scope = {
							region = world_europe_west_iberia
						}
					}
					character_event = { id = 62925 }
				}
				character_event = { id = 62924 }
			}
		}
		ai_will_do = {
			factor = 10
		}
	}

	emf_create_aragon = {
		only_independent = yes
		is_high_prio = yes
		ai_check_interval = 48
		
		potential = {
			tier = DUKE
			has_landed_title = d_aragon
			k_aragon = {
				has_holder = no
				is_de_jure_title = no
			}
			has_random_dejure_or_title_names = no
			emf_hiprio_decision_basic_potential = yes
		}
		allow = {
			is_adult = yes
			independent = yes
			trigger_if = {
				limit = { ai = no }
				war = no
				prisoner = no
				has_regent = no
			}
			trigger_else = {
				is_primary_war_defender = no
			}
			is_incapable = no
			completely_controls = d_aragon
			trigger_if = {
				limit = { ai = no }
				d_barcelona = {
					show_scope_change = no
					OR = {
						ROOT = {
							show_scope_change = no
							completely_controls = PREV
						}
						custom_tooltip = {
							text = THIS_WONT_BECOME_DE_JURE_VASSAL_OF_ARAGON
							NOT = { ROOT = { completely_controls = PREV } }
						}
					}
				}
				prestige = 1000
			}
			custom_tooltip = {
				text = NEEDS_200_GOLD_COST
				OR = {
					ai = yes
					wealth = 200
				}
			}
		}
		effect = {
			if = {
				limit = { ai = no }
				wealth = -200
			}
			prestige = 500
			primary_title = {
				show_scope_change = no
				k_aragon = {
					show_scope_change = no
					grant_title = ROOT
					copy_title_laws = PREV
					emf_copy_title_state_from_PREV = yes
				}
				save_event_target_as = current_primary_title
			}
			d_aragon = {
				show_scope_change = no
				de_jure_liege = k_aragon
			}
			if = {
				limit = { completely_controls = d_barcelona }
				d_barcelona = {
					show_scope_change = no
					de_jure_liege = k_aragon
				}
			}
			hidden_effect = {
				any_playable_ruler = {
					limit = {
						ai = no
						capital_scope = {
							region = world_europe_west_iberia
						}
					}
					character_event = { id = 62927 }
				}
				character_event = { id = 62926 }
			}
		}
		ai_will_do = {
			factor = 10
		}
	}

	emf_create_the_hansa = {
		ai = no # CP-3.0: TODO: look into the creation event for the AI and make the effects match this decision
		is_high_prio = yes

		potential = {
			has_dlc = "The Republic"
			religion_group = christian
			independent = no
			top_liege = { emf_has_hre = yes }
			OR = {
				has_landed_title = d_mecklemburg
				d_mecklemburg = {
					any_direct_de_jure_vassal_title = {
						location = {
							any_neighbor_province = {
								duchy = { holder = ROOT }
							}
						}
					}
				}
			}
			is_government_potential = merchant_republic_government
			k_hansa = {
				has_holder = no
				is_de_jure_title = no
			}
			has_random_dejure_or_title_names = no
			emf_hiprio_decision_basic_potential = yes
		}
		allow = {
			OR = {
				culture_group = central_germanic
				culture = pommeranian
			}
			is_adult = yes
			war = no
			prisoner = no
			has_regent = no
			is_incapable = no
			prestige >= 1000
			custom_tooltip = {
				text = NEEDS_1000_GOLD_COST
				wealth >= 1000
			}
			has_landed_title = d_mecklemburg
			has_landed_title = c_lubeck
			capital_scope = {
				show_scope_change = no
				county = {
					show_scope_change = no
					custom_tooltip = {
						text = CAPITAL_IS_THIS
						title = c_lubeck
					}
				}
			}
			c_lubeck = {
				show_scope_change = no
				custom_tooltip = {
					text = THIS_EITHER_HAS_A_CITY_IN_IT_OR_A_SPARE_HOLDING_SLOT
					OR = {
						location = { has_empty_holding = yes }
						any_direct_de_jure_vassal_title = {
							has_holder = yes
							holding_type = CITY
						}
					}
				}
			}
			liege = {
				show_scope_change = no
				custom_tooltip = {
					text = PREV_IS_DIRECT_VASSAL_OF_THIS
					emf_has_hre = yes
				}
			}
		}
		effect = {
			d_mecklemburg = { save_event_target_as = emf_republic_duchy }
			wealth = -1000
			c_lubeck = {
				show_scope_change = no
				if = {
					limit = { NOT = { capital_holding = { holding_type = CITY } } }
					if = {
						limit = {
							NOT = {
								any_direct_de_jure_vassal_title = {
									has_holder = yes
									holding_type = CITY
								}
							}
						}
						custom_tooltip = {
							text = BUILD_NEW_CITY_IN_THIS_AND_MAKE_IT_THE_CAPITAL_HOLDING
							location = { build_holding = { type = CITY } } # made capital in block below
						}
					}
					random_direct_de_jure_vassal_title = {
						limit = {
							has_holder = yes
							holding_type = CITY
						}
						preferred_limit = { title = b_lubeck }
						preferred_limit = { num_of_buildings > 30 }
						preferred_limit = { num_of_buildings > 28 }
						preferred_limit = { num_of_buildings > 26 }
						preferred_limit = { num_of_buildings > 24 }
						preferred_limit = { num_of_buildings > 22 }
						preferred_limit = { num_of_buildings > 20 }
						preferred_limit = { num_of_buildings > 18 }
						preferred_limit = { num_of_buildings > 16 }
						preferred_limit = { num_of_buildings > 14 }
						preferred_limit = { num_of_buildings > 12 }
						preferred_limit = { num_of_buildings > 10 }
						preferred_limit = { num_of_buildings > 8 }
						preferred_limit = { num_of_buildings > 6 }
						preferred_limit = { num_of_buildings > 4 }
						preferred_limit = { num_of_buildings > 2 }
						custom_tooltip = { # If we built a holding, this custom tooltip won't be shown, which is what we want
							text = TAKE_THIS_CITY_AND_MAKE_IT_THE_CAPITAL_HOLDING_OF_PREV
							grant_title = ROOT
							make_capital_holding = yes
							ROOT = { capital = PREV }
						}
					}
				}
				else_if = {
					limit = { NOT = { capital_holding = { holder = ROOT } } }
					capital_holding = {
						grant_title = ROOT
						ROOT = { capital = PREV }
					}
				}
			}
			custom_tooltip = {
				text = create_the_hansa_tooltip
				create_family_palace = yes
				set_government_type = merchant_republic_government
				if = {
					limit = {
						NOT = {
							num_of_government_vassals = {
								government = merchant_republic_government
								value = 1
							}
						}
					}
					any_vassal = {
						limit = {
							is_republic = yes
							is_lowborn = yes
						}
						dynasty = father_bastard
						emf_new_character_noble = yes # NOTE: slight misuse, but it does what I want in Jan 2019
					}
					while = {
						limit = {
							any_vassal = {
								is_republic = yes
								is_patrician = no
								is_female = no
								NOT = {
									any_child = {
										is_female = no
										age >= 16
										emf_can_inherit = yes
									}
								}
								age < 32
							}
						}
						any_vassal = {
							limit = {
								is_republic = yes
								is_patrician = no
								is_female = no
								NOT = {
									any_child = {
										is_female = no
										age >= 16
										emf_can_inherit = yes
									}
								}
								age < 32
							}
							add_age = 3
							spouse = {
								if = {
									limit = { age < 28 }
									add_age = 3
								}
							}
						}
					}
					any_vassal = {
						limit = {
							is_republic = yes
							is_patrician = no
							is_female = no
							NOT = {
								any_child = {
									is_female = no
									age >= 16
									emf_can_inherit = yes
								}
							}
							age >= 32
						}
						spouse = { save_event_target_as = emf_mama }
						create_character = {
							random_traits = yes
							dynasty = THIS
							religion = THIS
							culture = THIS
							genetic_father = THIS
							genetic_mother = event_target:emf_mama
							female = no
							age = 16
							fertility = 0.75
						}
						new_character = {
							set_father = PREV
							if = {
								limit = { event_target:emf_mama = { age >= 28 } }
								set_mother = event_target:emf_mama
							}
							else = {
								add_trait = legit_bastard
							}
							clear_education_trait = yes
							random_list = {
								10 = { add_trait = fortune_builder }
								10 = { add_trait = midas_touched }
								10 = { add_trait = skilled_tactician }
								10 = { add_trait = brilliant_strategist }
								10 = { add_trait = intricate_webweaver }
								10 = { add_trait = elusive_shadow }
							}
							emf_new_character_noble = yes
						}
					}
					any_unique_dynasty_vassal = { # gives random vassals a family palace
						count = 4
						limit = {
							ai = yes
							is_female = no
							is_republic = yes
							is_patrician = no
							prisoner = no
							is_incapable = no
							is_adult = yes
							NOT = { dynasty = none }
						}
						create_family_palace = yes
					}
				}
				set_government_type = merchant_republic_government
			}
			if = {
				limit = { ai = no }
				set_character_flag = achievement_res_publica
				chronicle = {
					entry = CHRONICLE_FOUNDED_MERCHANT_REPUBLIC
					picture = GFX_evt_busy_trading_dock_republic
				}
			}
			event_target:emf_republic_duchy = {
				show_scope_change = no
				de_jure_liege = k_hansa
			}
			liege = { primary_title = { save_event_target_as = emf_liege_empire_title } }
			if = { # If our republic borders any counties that are already de jure vassals of our liege's empire...
				limit = {
					OR = {
						event_target:emf_republic_duchy = {
							any_direct_de_jure_vassal_title = {
								location = {
									any_neighbor_province = {
										NOT = { de_jure_liege_or_above = event_target:emf_republic_duchy }
										empire = { title = event_target:emf_liege_empire_title }
									}
								}
							}
						}
						c_hamburg = { # Purely for the tooltip on E+S since c_hamburg was not originally part of the duchy (no difference on E+V)
							location = {
								any_neighbor_province = {
									NOT = { de_jure_liege_or_above = event_target:emf_republic_duchy }
									empire = { title = event_target:emf_liege_empire_title }
								}
							}
						}
					}
				}
				k_hansa = {
					show_scope_change = no
					de_jure_liege = event_target:emf_liege_empire_title
				}
			}
			else = {
				hidden_effect = {
					k_hansa = { de_jure_liege = e_null }
				}
			}
			hidden_effect = { liege = { k_hansa = { grant_title = PREV } } } # For title history
			primary_title = {
				show_scope_change = no
				k_hansa = {
					show_scope_change = no
					grant_title_no_opinion = ROOT
					emf_try_to_make_primary_title = yes
					copy_title_laws = PREV
				}
			}
			hidden_effect = {
				liege = { remove_claim = k_hansa }
				narrative_event = { id = HFP.40000 }
				set_global_flag = hansa_formed
				liege = {
					any_realm_lord = {
						limit = { ai = no }
						narrative_event = { id = HFP.40001 days = 1 }
					}
				}
			}
		}
	}
}
