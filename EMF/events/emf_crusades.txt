# -*- ck2.events -*-

namespace = emf_crusades

# Refill holding levies after the crusade (needs to be done on a delay)
character_event = { # refills levy holdings after switching to feudal
	id = emf_crusades.1
	
	hide_window = yes
	is_triggered_only = yes
	
	immediate = {
		any_demesne_title = {
			limit = { has_title_flag = refill_levy }
			clr_title_flag = refill_levy
			remove_holding_modifier = recently_conquered
			remove_holding_modifier = new_administration
			refill_holding_levy = yes
		}
	}
}

# Post-crusade event to check whether crusade kingdom should be given away (fired from CB)
character_event = {
	id = emf_crusades.2
	desc = EVTDESC_emf_crusades_2
	picture = GFX_evt_crusaders
	
	is_triggered_only = yes
	
	immediate = {
		# Pick out possible candidates for granting the kingdom
		random_child = {
			limit = {
				is_adult = yes
				prisoner = no
				is_ruler = no
				religion = ROOT
				is_liege_or_above = ROOT
				health = 4.0
				emf_can_inherit = yes
				OR = {
					is_female = no
					ROOT = { primary_title = { has_law = true_cognatic_succession } }
					ROOT = { primary_title = { has_law = enatic_cognatic_succession } }
					ROOT = { primary_title = { has_law = enatic_succession } }
				}
				NOR = {
					trait = incapable
					any_spouse = { is_ruler = yes }
					any_heir_title = { always = yes }
				}
				OR = {
					NOT = { age = 40 }
					any_child = {
						is_female = no
						emf_can_inherit = yes
					}
				}
			}
			save_event_target_as = child_heir
		}
		random_sibling = {
			limit = {
				is_adult = yes
				prisoner = no
				is_ruler = no
				religion = ROOT
				is_liege_or_above = ROOT
				health = 4.0
				emf_can_inherit = yes
				OR = {
					is_female = no
					ROOT = { primary_title = { has_law = true_cognatic_succession } }
					ROOT = { primary_title = { has_law = enatic_cognatic_succession } }
					ROOT = { primary_title = { has_law = enatic_succession } }
				}
				NOR = {
					trait = incapable
					any_spouse = { is_ruler = yes }
					any_heir_title = { always = yes }
				}
				OR = {
					NOT = { age = 40 }
					any_child = {
						is_female = no
						emf_can_inherit = yes
					}
				}
			}
			save_event_target_as = sibling_heir
		}
		random_dynasty_member = {
			limit = {
				is_adult = yes
				prisoner = no
				is_ruler = no
				religion = ROOT
				is_liege_or_above = ROOT
				health = 4.0
				piety = 0
				reverse_opinion = { who = ROOT value = 0 }
				emf_can_inherit = yes
				OR = {
					is_female = no
					ROOT = { primary_title = { has_law = true_cognatic_succession } }
					ROOT = { primary_title = { has_law = enatic_cognatic_succession } }
					ROOT = { primary_title = { has_law = enatic_succession } }
				}
				OR = {
					diplomacy = 12
					martial = 12
					stewardship = 12
					is_smart_trigger = yes
					reverse_opinion = { who = ROOT value = 75 }
					calc_true_if = {
						amount = 2
						diplomacy = 8
						martial = 8
						stewardship = 8
					}
				}
				NOR = {
					is_father = ROOT
					is_mother = ROOT
					is_child_of = ROOT
					sibling = ROOT
					trait = incapable
					trait = lunatic
					trait = imbecile
					trait = inbred
					is_dumb_trigger = yes
					any_spouse = { is_ruler = yes }
					any_heir_title = { always = yes }
				}
				OR = {
					NOT = { age = 40 }
					any_child = {
						is_female = no
						emf_can_inherit = yes
					}
				}
			}
			save_event_target_as = relative_heir
		}
		random_dynasty_member = {
			limit = {
				NOT = { event_target:relative_heir = { always = yes } }
				is_adult = yes
				prisoner = no
				is_ruler = no
				religion = ROOT
				is_liege_or_above = ROOT
				health = 4.0
				piety = 0
				reverse_opinion = { who = ROOT value = 0 }
				emf_can_inherit = yes
				OR = {
					is_female = no
					ROOT = { primary_title = { has_law = true_cognatic_succession } }
					ROOT = { primary_title = { has_law = enatic_cognatic_succession } }
					ROOT = { primary_title = { has_law = enatic_succession } }
				}
				NOR = {
					is_father = ROOT
					is_mother = ROOT
					is_child_of = ROOT
					sibling = ROOT
					trait = incapable
					trait = lunatic
					trait = imbecile
					trait = inbred
					is_dumb_trigger = yes
					any_spouse = { is_ruler = yes }
					any_heir_title = { always = yes }
				}
				OR = {
					NOT = { age = 40 }
					any_child = {
						is_female = no
						emf_can_inherit = yes
					}
				}
			}
			save_event_target_as = relative_heir
		}
		random_courtier = {
			limit = {
				is_adult = yes
				prisoner = no
				is_ruler = no
				religion = ROOT
				is_liege_or_above = ROOT
				health = 4.0
				piety = 0
				reverse_opinion = { who = ROOT value = 0 }
				emf_can_inherit = yes
				OR = {
					is_female = no
					ROOT = { primary_title = { has_law = true_cognatic_succession } }
					ROOT = { primary_title = { has_law = enatic_cognatic_succession } }
					ROOT = { primary_title = { has_law = enatic_succession } }
				}
				OR = {
					diplomacy = 12
					martial = 12
					stewardship = 12
					is_smart_trigger = yes
					reverse_opinion = { who = ROOT value = 75 }
					calc_true_if = {
						amount = 2
						diplomacy = 8
						martial = 8
						stewardship = 8
					}
				}
				NOR = {
					is_father = ROOT
					is_mother = ROOT
					is_child_of = ROOT
					sibling = ROOT
					dynasty = ROOT
					trait = incapable
					trait = lunatic
					trait = imbecile
					trait = inbred
					is_dumb_trigger = yes
					any_spouse = { is_ruler = yes }
					any_heir_title = { always = yes }
				}
				OR = {
					NOT = { age = 40 }
					any_child = {
						is_female = no
						emf_can_inherit = yes
					}
				}
			}
			save_event_target_as = courtier_heir
		}
		
		# Free wrong-religion holy orders from vassalage
		any_realm_lord = {
			limit = {
				NOT = { religion = ROOT }
				primary_title = { holy_order = yes }
				NOT = { has_character_flag = previous_vassal }
			}
			set_defacto_liege = THIS
			emf_liege_change_effect = yes
		}
	}
	
	option = {
		name = EVTOPTA_emf_crusades_2 #To my son
		trigger = {
			event_target:child_heir = { is_alive = yes }
		}
		ai_chance = {
			factor = 100
		}
		prestige = 500
		event_target:child_heir = {
			if = {
				limit = { NOT = { is_friend = ROOT } }
				add_friend = ROOT
			}
			custom_tooltip = {
				text = WILL_INHERIT_CRUSADE_KINGDOM
				hidden_tooltip = {
					character_event = { id = emf_crusades.3 }
				}
			}
		}
	}
	option = {
		name = {
			text = EVTOPTB_emf_crusades_2_brother # To my brother
			trigger = { event_target:sibling_heir = { is_female = no } }
		}
		name = {
			text = EVTOPTB_emf_crusades_2_sister # To my sister
			trigger = { event_target:sibling_heir = { is_female = yes } }
		}
		trigger = {
			event_target:sibling_heir = { is_alive = yes }
		}
		ai_chance = {
			factor = 100
		}
		prestige = 500
		event_target:sibling_heir = {
			if = {
				limit = { NOT = { is_friend = ROOT } }
				add_friend = ROOT
			}
			custom_tooltip = {
				text = WILL_INHERIT_CRUSADE_KINGDOM
				hidden_tooltip = {
					character_event = { id = emf_crusades.3 }
				}
			}
		}
	}
	option = {
		name = EVTOPTC_emf_crusades_2 #To a capable relative
		trigger = {
			event_target:relative_heir = { is_alive = yes }
		}
		ai_chance = {
			factor = 10
		}
		prestige = 500
		event_target:relative_heir = {
			if = {
				limit = { NOT = { is_friend = ROOT } }
				add_friend = ROOT
			}
			custom_tooltip = {
				text = WILL_INHERIT_CRUSADE_KINGDOM
				hidden_tooltip = {
					character_event = { id = emf_crusades.3 }
				}
			}
		}
	}
	option = {
		name = EVTOPTD_emf_crusades_2 #To a valiant retainer
		trigger = {
			# Only if one of the other three options doesn't exist
			OR = {
				NOT = { event_target:child_heir = { is_alive = yes } }
				NOT = { event_target:sibling_heir = { is_alive = yes } }
				NOT = { event_target:relative_heir = { is_alive = yes } }
			}
		}
		ai_chance = {
			factor = 1
		}
		prestige = 500
		if = {
			limit = { event_target:courtier_heir = { always = yes } }
			event_target:courtier_heir = {
				if = {
					limit = { NOT = { is_friend = ROOT } }
					add_friend = ROOT
				}
				custom_tooltip = {
					text = WILL_INHERIT_CRUSADE_KINGDOM
					hidden_tooltip = {
						character_event = { id = emf_crusades.3 }
					}
				}
			}
		}
		if = {
			limit = { NOT = { event_target:courtier_heir = { always = yes } } }
			custom_tooltip = {
				text = RANDOM_WILL_INHERIT_CRUSADE_KINGDOM
				hidden_tooltip = {
					create_character = {
						random_traits = yes
						dynasty = random
						religion = ROOT
						culture = ROOT
						female = no
						age = 25
						health = 7
						attributes = {
							martial = 10
							diplomacy = 10
						}
					}
					new_character = {
						add_friend = ROOT
						emf_new_character_effect = yes
						character_event = { id = emf_crusades.3 }
					}
				}
			}
		}
	}
	option = {
		name = EVTOPTE_emf_crusades_2 #To myself
		ai_chance = {
			factor = 1000
		}
		trigger = {
			OR = {
				ai = no
				independent = yes
				is_feudal = yes
			}
			# Must be a player, a vassal, or the crusader kingdom borders my realm
			OR = {
				ai = no
				AND = {
					independent = no
					lower_tier_than = king
				}
				any_demesne_title = {
					tier = COUNT
					NOT = { has_title_flag = previous_holding }
					location = {
						any_neighbor_province = {
							OR = {
								county = { has_title_flag = previous_holding }
								owner = { has_character_flag = previous_vassal }
								owner = { any_liege = { has_character_flag = previous_vassal } }
							}
						}
					}
				}
			}
		}
		if = {
			limit = { independent = no }
			custom_tooltip = { text = CRUSADE_RELINQUISH_TITLES }
		}
		if = {
			limit = { independent = yes }
			custom_tooltip = { text = CRUSADE_KEEP_TITLES }
		}
		hidden_tooltip = {
			if = {
				limit = { independent = no }
				liege = {
					ROOT = {
						# Previous vassals will be reassigned to the liege
						any_character = {
							limit = { has_character_flag = previous_vassal }
							clr_character_flag = previous_vassal
							set_defacto_liege = PREVPREV
							emf_liege_change_effect = yes
						}
						# Previous non-titular titles will be reassigned to the liege
						any_demesne_title = {
							limit = {
								is_titular = no
								is_landless_type_title = no
								has_title_flag = previous_holding
							}
							clr_title_flag = previous_holding
							gain_title = PREVPREV
						}
					}
				}
				set_defacto_liege = ROOT
			}
			event_target:crusade_title = {
				emf_destroy_title_effect = yes
				gain_title = ROOT
				copy_title_laws = event_target:current_title
				capital_scope = {
					county = {
						if = {
							limit = { holder = ROOT }
							ROOT = { capital = PREV }
						}
					}
				}
			}
			
			# Refill levies of conquered holdings within target kingdom
			any_demesne_title = {
				limit = {
					tier = BARON
					de_jure_liege_or_above = event_target:crusade_title
				}
				set_title_flag = refill_levy
			}
			character_event = { id = emf_crusades.5 } # Grant fiefs to crusade participants
			character_event = { id = emf_crusades.1 days = 3 } # Refill holding levies
		}
	}
}

# The crusade kingdom has been given away
character_event = {
	id = emf_crusades.3
	
	hide_window = yes
	is_triggered_only = yes
	
	immediate = {
		# Grant titles in crusade kingdom, starting with feudal titles
		FROM = {
			any_demesne_title = {
				limit = {
					OR = {
						is_feudal = yes
						holding_type = castle
					}
					NOT = { has_title_flag = previous_holding }
				}
				grant_title = ROOT
			}
			any_demesne_title = {
				limit = { NOT = { has_title_flag = previous_holding } }
				grant_title = ROOT
			}
		}
		emf_switch_to_feudal_gov_effect = yes # just in case

		# Refill levies of conquered holdings within target kingdom
		any_demesne_title = {
			limit = {
				tier = BARON
				de_jure_liege_or_above = event_target:crusade_title
			}
			set_title_flag = refill_levy
		}

		event_target:crusade_title = {
			destroy_landed_title = yes # To reset laws
			gain_title = ROOT
			copy_title_laws = event_target:current_title
			add_law = inheritance_1
			if = {
				limit = {
					NOR = {
						has_law = succ_feudal_elective
						has_law = succ_turkish_succession
					}
				}
				add_law = succ_feudal_elective
			}
			capital_scope = {
				county = {
					if = {
						limit = { holder = ROOT }
						ROOT = { capital = PREV }
					}
				}
			}
		}
		
		add_character_modifier = {
			name = formation_of_rum
			duration = 9125
		}
		
		wealth = 500
		prestige = 200
		piety = 100
		set_defacto_liege = THIS

		# Improve the new ruler
		random_list = {
			20 = {
				modifier = {
					factor = 0
					is_smart_trigger = yes
				}
				add_trait = shrewd
			}
			20 = {
				modifier = {
					factor = 0
					trait = brave
				}
				add_trait = brave
			}
			20 = {
				modifier = {
					factor = 0
					trait = ambitious
				}
				add_trait = ambitious
			}
			20 = {
				modifier = {
					factor = 0
					trait = zealous
				}
				add_trait = zealous
			}
			20 = {
				modifier = {
					factor = 0
					trait = diligent
				}
				add_trait = diligent
			}
		}
		random_list = {
			20 = {
				modifier = {
					factor = 0
					is_smart_trigger = yes
				}
				add_trait = shrewd
			}
			20 = {
				modifier = {
					factor = 0
					trait = brave
				}
				add_trait = brave
			}
			20 = {
				modifier = {
					factor = 0
					trait = ambitious
				}
				add_trait = ambitious
			}
			20 = {
				modifier = {
					factor = 0
					trait = zealous
				}
				add_trait = zealous
			}
			20 = {
				modifier = {
					factor = 0
					trait = diligent
				}
				add_trait = diligent
			}
		}
		
		# Spawn 3 regiments
		capital_scope = {
			ROOT = {
				spawn_unit = {
					province = PREV
					home = PREV
					owner = THIS
					troops = {
						archers = { 150 150 }
						pikemen = { 150 150 }
						heavy_infantry = { 250 250 }
						light_cavalry = { 250 250 }
						knights = { 50 50 }
					}
				}
				spawn_unit = {
					province = PREV
					home = PREV
					owner = THIS
					troops = {
						archers = { 150 150 }
						pikemen = { 150 150 }
						heavy_infantry = { 250 250 }
						light_cavalry = { 250 250 }
						knights = { 50 50 }
					}
				}
				spawn_unit = {
					province = PREV
					home = PREV
					owner = THIS
					troops = {
						archers = { 150 150 }
						pikemen = { 150 150 }
						heavy_infantry = { 250 250 }
						light_cavalry = { 250 250 }
						knights = { 50 50 }
					}
				}
			}
		}
		
		# Ensure some decent councilors/generals
		emf_create_courtiers_for_ROOT = yes
		
		# Fire follow-up events
		character_event = { id = emf_crusades.5 } # Grant fiefs to crusade participants
		character_event = { id = emf_crusades.1 days = 3 } # Refill holding levies		
	}
}
	
# Crusade participant requests a fief for relative (fired from CB)
character_event = {
	id = emf_crusades.4
	desc = EVTDESC_emf_crusades_4
	picture = GFX_evt_crusaders
	
	is_triggered_only = yes
	
	option = {
		name = EVTOPTA_emf_crusades_4 #Request a fief for my son
		trigger = {
			NOT = { has_character_flag = crusader_adventurer }
			any_child = {
				is_adult = yes
				prisoner = no
				is_ruler = no
				religion = ROOT
				is_liege_or_above = ROOT
				health = 4.0
				emf_can_inherit = yes
				is_female = no
				NOR = {
					trait = incapable
					any_spouse = { is_ruler = yes }
					any_heir_title = { always = yes }
				}
				OR = {
					NOT = { age = 40 }
					any_child = {
						is_female = no
						emf_can_inherit = yes
					}
				}
			}
		}
		ai_chance = {
			factor = 100
			modifier = {
				factor = 2
				trait = ambitious
			}
			modifier = {
				factor = 2
				trait = proud
			}
		}
		prestige = 50
		random_child = {
			limit = {
				is_adult = yes
				prisoner = no
				is_ruler = no
				religion = ROOT
				is_liege_or_above = ROOT
				health = 4.0
				emf_can_inherit = yes
				is_female = no
				NOR = {
					trait = incapable
					any_spouse = { is_ruler = yes }
					any_heir_title = { always = yes }
				}
				OR = {
					NOT = { age = 40 }
					any_child = {
						is_female = no
						emf_can_inherit = yes
					}
				}
			}
			custom_tooltip = { text = GRANTED_CRUSADE_FIEF }
			opinion = { who = ROOT modifier = opinion_grateful years = 20 }
			set_character_flag = wants_fief_@event_target:crusade_victor
		}
		hidden_tooltip = {
			if = {
				limit = { ai = no }
				event_target:crusade_title = {
					holder_scope = {
						character_event = { id = emf_crusades.5 }
					}
				}
			}
		}
	}
	option = {
		name = EVTOPTB_emf_crusades_4 #Request a fief for my brother
		trigger = {
			NOT = { has_character_flag = crusader_adventurer }
			any_sibling = {
				is_adult = yes
				prisoner = no
				is_ruler = no
				religion = ROOT
				is_liege_or_above = ROOT
				health = 4.0
				emf_can_inherit = yes
				is_female = no
				NOR = {
					trait = incapable
					any_spouse = { is_ruler = yes }
					any_heir_title = { always = yes }
				}
				OR = {
					NOT = { age = 40 }
					any_child = {
						is_female = no
						emf_can_inherit = yes
					}
				}
			}
		}
		ai_chance = {
			factor = 50
			modifier = {
				factor = 2
				trait = proud
			}
		}
		prestige = 50
		random_sibling = {
			limit = {
				is_adult = yes
				prisoner = no
				is_ruler = no
				religion = ROOT
				is_liege_or_above = ROOT
				health = 4.0
				emf_can_inherit = yes
				is_female = no
				NOR = {
					trait = incapable
					any_spouse = { is_ruler = yes }
					any_heir_title = { always = yes }
				}
				OR = {
					NOT = { age = 40 }
					any_child = {
						is_female = no
						emf_can_inherit = yes
					}
				}
			}
			custom_tooltip = { text = GRANTED_CRUSADE_FIEF }
			opinion = { who = ROOT modifier = opinion_grateful years = 20 }
			set_character_flag = wants_fief_@event_target:crusade_victor
		}
		hidden_tooltip = {
			if = {
				limit = { ai = no }
				event_target:crusade_title = {
					holder_scope = {
						character_event = { id = emf_crusades.5 }
					}
				}
			}
		}
	}
	option = {
		name = EVTOPTC_emf_crusades_4 #Request a fief for a relative
		trigger = {
			NOT = { has_character_flag = crusader_adventurer }
			any_dynasty_member = {
				is_adult = yes
				prisoner = no
				is_ruler = no
				religion = ROOT
				is_liege_or_above = ROOT
				health = 4.0
				piety = 0
				reverse_opinion = { who = ROOT value = 0 }
				emf_can_inherit = yes
				is_female = no
				NOR = {
					is_child_of = ROOT
					sibling = ROOT
					trait = incapable
					trait = lunatic
					trait = imbecile
					trait = inbred
					is_dumb_trigger = yes
					any_spouse = { is_ruler = yes }
					any_heir_title = { always = yes }
				}
				OR = {
					NOT = { age = 40 }
					any_child = {
						is_female = no
						emf_can_inherit = yes
					}
				}
			}
		}
		ai_chance = {
			factor = 25
			modifier = {
				factor = 2
				trait = proud
			}
		}
		prestige = 25
		random_dynasty_member = {
			limit = {
				is_adult = yes
				prisoner = no
				is_ruler = no
				religion = ROOT
				is_liege_or_above = ROOT
				health = 4.0
				piety = 0
				reverse_opinion = { who = ROOT value = 0 }
				emf_can_inherit = yes
				is_female = no
				OR = {
					diplomacy = 12
					martial = 12
					stewardship = 12
					is_smart_trigger = yes
					reverse_opinion = { who = ROOT value = 75 }
					calc_true_if = {
						amount = 2
						diplomacy = 8
						martial = 8
						stewardship = 8
					}
				}
				NOR = {
					is_child_of = ROOT
					sibling = ROOT
					trait = incapable
					trait = lunatic
					trait = imbecile
					trait = inbred
					is_dumb_trigger = yes
					any_spouse = { is_ruler = yes }
					any_heir_title = { always = yes }
				}
				OR = {
					NOT = { age = 40 }
					any_child = {
						is_female = no
						emf_can_inherit = yes
					}
				}
			}
			custom_tooltip = { text = GRANTED_CRUSADE_FIEF }
			opinion = { who = ROOT modifier = opinion_grateful years = 20 }
			set_character_flag = wants_fief_@event_target:crusade_victor
			hidden_tooltip = {
				if = {
					limit = { ROOT = { ai = no } }
					event_target:crusade_title = {
						holder_scope = {
							character_event = { id = emf_crusades.5 }
						}
					}
				}
			}
			break = yes
		}
		random_dynasty_member = {
			limit = {
				is_adult = yes
				prisoner = no
				is_ruler = no
				religion = ROOT
				is_liege_or_above = ROOT
				health = 4.0
				piety = 0
				reverse_opinion = { who = ROOT value = 0 }
				emf_can_inherit = yes
				is_female = no
				NOR = {
					is_child_of = ROOT
					sibling = ROOT
					trait = incapable
					trait = lunatic
					trait = imbecile
					trait = inbred
					is_dumb_trigger = yes
					any_spouse = { is_ruler = yes }
					any_heir_title = { always = yes }
				}
				OR = {
					NOT = { age = 40 }
					any_child = {
						is_female = no
						emf_can_inherit = yes
					}
				}
			}
			custom_tooltip = { text = GRANTED_CRUSADE_FIEF }
			opinion = { who = ROOT modifier = opinion_grateful years = 20 }
			set_character_flag = wants_fief_@event_target:crusade_victor
		}
		hidden_tooltip = {
			if = {
				limit = { ai = no }
				event_target:crusade_title = {
					holder_scope = {
						character_event = { id = emf_crusades.5 }
					}
				}
			}
		}
	}
	option = {
		name = EVTOPTD_emf_crusades_4 #To a valiant retainer
		trigger = {
			NOT = { has_character_flag = crusader_adventurer }
			any_courtier = {
				is_adult = yes
				prisoner = no
				is_ruler = no
				religion = ROOT
				is_liege_or_above = ROOT
				health = 4.0
				piety = 0
				reverse_opinion = { who = ROOT value = 0 }
				emf_can_inherit = yes
				is_female = no
				OR = {
					diplomacy = 12
					martial = 12
					stewardship = 12
					is_smart_trigger = yes
					reverse_opinion = { who = ROOT value = 75 }
					calc_true_if = {
						amount = 2
						diplomacy = 8
						martial = 8
						stewardship = 8
					}
				}
				NOR = {
					is_child_of = ROOT
					sibling = ROOT
					dynasty = ROOT
					trait = incapable
					trait = lunatic
					trait = imbecile
					trait = inbred
					is_dumb_trigger = yes
					any_spouse = { is_ruler = yes }
					any_heir_title = { always = yes }
				}
				OR = {
					NOT = { age = 40 }
					any_child = {
						is_female = no
						emf_can_inherit = yes
					}
				}
			}
			OR = {
				NOT = {
					any_child = {
						is_adult = yes
						prisoner = no
						is_ruler = no
						religion = ROOT
						is_liege_or_above = ROOT
						health = 4.0
						emf_can_inherit = yes
						is_female = no
						NOR = {
							trait = incapable
							any_spouse = { is_ruler = yes }
							any_heir_title = { always = yes }
						}
						OR = {
							NOT = { age = 40 }
							any_child = {
								is_female = no
								emf_can_inherit = yes
							}
						}
					}
				}
				NOT = {
					any_sibling = {
						is_adult = yes
						prisoner = no
						is_ruler = no
						religion = ROOT
						is_liege_or_above = ROOT
						health = 4.0
						emf_can_inherit = yes
						is_female = no
						NOR = {
							trait = incapable
							any_spouse = { is_ruler = yes }
							any_heir_title = { always = yes }
						}
						OR = {
							NOT = { age = 40 }
							any_child = {
								is_female = no
								emf_can_inherit = yes
							}
						}
					}
				}
				NOT = {
					any_dynasty_member = {
						is_adult = yes
						prisoner = no
						is_ruler = no
						religion = ROOT
						is_liege_or_above = ROOT
						health = 4.0
						piety = 0
						reverse_opinion = { who = ROOT value = 0 }
						emf_can_inherit = yes
						is_female = no
						NOR = {
							is_child_of = ROOT
							sibling = ROOT
							trait = incapable
							trait = lunatic
							trait = imbecile
							trait = inbred
							is_dumb_trigger = yes
							any_spouse = { is_ruler = yes }
							any_heir_title = { always = yes }
						}
						OR = {
							NOT = { age = 40 }
							any_child = {
								is_female = no
								emf_can_inherit = yes
							}
						}
					}
				}
			}
		}
		ai_chance = {
			factor = 5
		}
		prestige = 10
		random_courtier = {
			limit = {
				is_adult = yes
				prisoner = no
				is_ruler = no
				religion = ROOT
				is_liege_or_above = ROOT
				health = 4.0
				piety = 0
				reverse_opinion = { who = ROOT value = 0 }
				emf_can_inherit = yes
				is_female = no
				OR = {
					diplomacy = 12
					martial = 12
					stewardship = 12
					is_smart_trigger = yes
					reverse_opinion = { who = ROOT value = 75 }
					calc_true_if = {
						amount = 2
						diplomacy = 8
						martial = 8
						stewardship = 8
					}
				}
				NOR = {
					is_child_of = ROOT
					sibling = ROOT
					dynasty = ROOT
					trait = incapable
					trait = lunatic
					trait = imbecile
					trait = inbred
					is_dumb_trigger = yes
					any_spouse = { is_ruler = yes }
					any_heir_title = { always = yes }
				}
				OR = {
					NOT = { age = 40 }
					any_child = {
						is_female = no
						emf_can_inherit = yes
					}
				}
			}
			custom_tooltip = { text = GRANTED_CRUSADE_FIEF }
			opinion = { who = ROOT modifier = opinion_grateful years = 20 }
			set_character_flag = wants_fief_@event_target:crusade_victor
		}
		hidden_tooltip = {
			if = {
				limit = { ai = no }
				event_target:crusade_title = {
					holder_scope = {
						character_event = { id = emf_crusades.5 }
					}
				}
			}
		}
	}
	option = {
		name = EVTOPTE_emf_crusades_4 #For myself (crusade adventurer)
		trigger = { has_character_flag = crusader_adventurer }
		set_character_flag = wants_fief_@event_target:crusade_victor
	}
	option = {
		name = EVTOPTF_emf_crusades_4 #No, our victory belongs to God
		trigger = { NOT = { has_character_flag = crusader_adventurer } }
		ai_chance = {
			factor = 5
			modifier = {
				factor = 5
				trait = zealous
			}
			modifier = {
				factor = 5
				trait = content
			}
		}
		piety = 25
	}
}

# Grant fiefs to crusade participants
character_event = {
	id = emf_crusades.5
	
	is_triggered_only = yes
	hide_window = yes
	
	immediate = {
		capital_scope = { duchy = { save_event_target_as = capital_duchy } }
		
		any_character = {
			limit = { has_character_flag = wants_fief_@event_target:crusade_victor }
			clr_character_flag = wants_fief_@event_target:crusade_victor
			opinion = { who = ROOT modifier = opinion_loyal_vassal multiplier = 2 }
			
			# Move characters to new king's court, unless they are crusader adventurers
			# in which case, make them vassals
			if = {
				limit = { is_ruler = no }
				move_character = ROOT
			}
			if = {
				limit = { is_ruler = yes }
				set_defacto_liege = ROOT
			}
			
			# Give them a county (and all its baronies) if the ruler has them to spare,
			# avoiding any counties in the duchy of the capital
			if = {
				limit = {
					ROOT = {
						NOT = { demesne_efficiency = 0.66 }
					}
				}
				liege = { primary_title = { save_event_target_as = liege_title } }
				save_event_target_as = wants_fief
				event_target:liege_title = {
					ROOT = {
						random_demesne_title = {
							limit = {
								tier = COUNT
								is_feudal = yes
								NOR = {
									has_title_flag = previous_holding
									any_direct_de_jure_vassal_title = { is_holy_site = ROOT }
									duchy = { title = event_target:capital_duchy }
									kingdom = {
										capital_scope = {
											county = { title = PREVPREVPREV }
										}
									}
								}
							}
							grant_title_no_opinion  = event_target:wants_fief
							
							# Give all owned baronies in the county
							any_direct_de_jure_vassal_title = {
								limit = { holder_scope = { character = ROOT } }
								grant_title_no_opinion  = event_target:wants_fief
							}
							
							# Copy old laws and change invalid succession law
							copy_title_laws = PREVPREV
							if = {
								limit = {
									NOR = {
										has_law = succ_gavelkind
										has_law = succ_primogeniture
										has_law = succ_seniority
										has_law = succ_turkish_succession
									}
								}
								add_law = succ_primogeniture
							}
							
							# Refill holding levies
							event_target:wants_fief = {
								any_demesne_title = {
									limit = { tier = BARON }
									set_title_flag = refill_levy
								}
								character_event = { id = emf_crusades.1 days = 3 } # Refill holding levies
								emf_check_adventurer_government_effect = yes
								recalc_succession = yes
							}
						}
					}
				}
			}
			
			# Deal with crusader adventurers, destroying their adventurer title
			# and re-vassalizing them, if necessary
			if = {
				limit = { has_character_flag = crusader_adventurer }
				clr_character_flag = crusader_adventurer
				if = {
					limit = {
						is_ruler = yes
						NOT = { any_demesne_title = { is_landless_type_title = no } }
					}
					any_courtier = { move_character = ROOT }
				}
				
				random_demesne_title = {
					limit = { is_landless_type_title = yes }
					set_title_landless = { title = THIS status = no }
					emf_destroy_title_effect = yes
				}
				
				set_defacto_liege = ROOT
			}
		}

		# Clear original flags
		any_landed_title = { clr_title_flag = previous_holding }
		any_character = { clr_character_flag = previous_vassal }
	}
}

# Temporarily cripple ability of Pope to quickly hire all the holy orders and mercenaries (called by on_crusade_creation on_action)
character_event = {
	id = emf_crusades.6

	hide_window = yes
	is_triggered_only = yes
	
	trigger = {
		ai = yes
		can_call_crusade = yes
		ROOT = { religion_group = christian }
	}
	
	immediate = {
		ROOT = {
			set_variable = { which = crusade_karma value = 0 }
			set_variable = { which = crusade_cash value = 0 }
			
			# Recursively subtract chunks of piety until the Pope has < 50 points.  Keep
			# track of how much was taken so that it can be faithfully restored in full.
			while = {
				limit = { piety = 50 }
				piety = -50
				change_variable = { which = crusade_karma value = 1 }
			}
			
			# Do the same for cash.
			while = {
				limit = { wealth = 100 }
				wealth = -100
				change_variable = { which = crusade_cash value = 1 }
			}
		
			# Restore the Pope's piety (and thus ability to hire holy orders) in 2 months,
			# which should be long enough to give other rulers a chance to join the crusade,
			# hire them potentially, and mobilize, while not outright preventing the Pope's
			# piety from being used to help win the war.
			character_event = { id = emf_crusades.8 days = 60 }
			
			# Do the same for cash, but return it in only 1 months (don't want to get in the
			# way of Catholic rulers asking for money)
			character_event = { id = emf_crusades.10 days = 30 }
		}
	}
}

# Restore the piety which was taken away from the Pope on crusade creation.
character_event = {
	id = emf_crusades.8
	
	hide_window = yes
	is_triggered_only = yes
	
	trigger = {
		OR = {
			check_variable = { which = crusade_karma value = 1 }
			is_variable_equal = { which = crusade_karma value = 1 }
		}
	}
	
	immediate = {
		piety = 50
		change_variable = { which = crusade_karma value = -1 }
		character_event = { id = emf_crusades.8 }
	}
}

# Restore the cash which was taken away from the Pope on crusade creation.
character_event = {
	id = emf_crusades.10

	hide_window = yes
	is_triggered_only = yes
	
	trigger = {
		OR = {
			check_variable = { which = crusade_cash value = 1 }
			is_variable_equal = { which = crusade_cash value = 1 }
		}
	}
	
	immediate = {
		wealth = 100
		change_variable = { which = crusade_cash value = -1 }
		character_event = { id = emf_crusades.10 }
	}
}

# Unlock crusades for the scenario (MTTH event).
# This starts its random countdown after the official "Crusader Kings" vanilla unlock event
character_event = {
	id = emf_crusades.13

	hide_window = yes
	
	only_playable = yes
	religion = hip_religion
	
	trigger = {
		has_landed_title = e_hip
		OR = {
			has_global_flag = christian_crusades_unlocked
			has_global_flag = muslim_jihads_unlocked
		}
		NOT = { has_global_flag = emf_crusades_unlocked }
	}
	
	mean_time_to_happen = {
		years = 5
		modifier = {
			factor = 0.01
			had_global_flag = { flag = christian_crusades_unlocked days = 3650 }
		}
	}
	
	immediate = {
		set_global_flag = emf_crusades_unlocked
	}
}

# Unlock crusades for the scenario: Catholics (MTTH event)
narrative_event = {
	id = emf_crusades.14
	title = EVTNAME39660
	picture = GFX_evt_jerusalem
	border = GFX_event_narrative_frame_religion
	
	desc = {
		text = EVTDESC39660
		trigger = {
			k_papal_state = { has_title_flag = jerusalem_crusade }
		}
	}
	desc = {
		text = EVTDESC39661
		trigger = {
			k_papal_state = { has_title_flag = byzantium_crusade }
		}
	}
	desc = {
		text = EVTDESC39662
		trigger = {
			k_papal_state = { has_title_flag = rome_crusade }
		}
	}
	desc = {
		text = EVTDESC39663
		trigger = {
			k_papal_state = { has_title_flag = europe_crusade }
		}
	}
	desc = {
		text = EVTDESC39660_generic
		trigger = {
			k_papal_state = {
				NOR = {
					has_title_flag = jerusalem_crusade
					has_title_flag = byzantium_crusade
					has_title_flag = rome_crusade
					has_title_flag = europe_crusade
				}
			}
		}
	}

	major = yes
	
	show_ROOT = yes
	hide_new = yes
	
	only_playable = yes
	religion = catholic
	has_global_flag = emf_crusades_unlocked

	trigger = {
		has_landed_title = k_papal_state
		NOT = { has_global_flag = emf_catholic_crusades_unlocked }
	}

	mean_time_to_happen = {
		years = 5
		
		modifier = {
			factor = 0.01
			had_global_flag = { flag = emf_crusades_unlocked days = 3650 }
		}
	}

	immediate = {
		set_global_flag = emf_catholic_crusades_unlocked
	}

	option = {
		name = EVTOPTA39660
		trigger = {
			religion_group = christian
		}
	}
	
	option = {
		name = EVTOPTB39660
		trigger = {
			NOT = { religion_group = christian }
		}
	}
}

# Unlock crusades for the scenario: Muslims (MTTH event).
narrative_event = {
	id = emf_crusades.15
	title = EVTNAME39670
	picture = GFX_evt_bishop
	border = GFX_event_narrative_frame_religion
	
	desc = {
		text = EVTDESC39670
		trigger = {
			k_papal_state = { has_title_flag = caliph_jihads }
		}
	}
	desc = {
		text = EVTDESC39671
		trigger = {
			k_papal_state = { has_title_flag = jerusalem_jihads }
		}
	}
	desc = {
		text = EVTDESC39672
		trigger = {
			k_papal_state = { has_title_flag = mecca_jihads }
		}
	}
	desc = {
		text = EVTDESC39673
		trigger = {
			k_papal_state = { has_title_flag = center_jihads }
		}
	}
	desc = {
		text = EVTDESC39674
		trigger = {
			k_papal_state = { has_title_flag = africa_jihads }
		}
	}
	desc = {
		text = EVTDESC39670_generic
		trigger = {
			k_papal_state = {
				NOR = {
					has_title_flag = caliph_jihads
					has_title_flag = jerusalem_jihads
					has_title_flag = mecca_jihads
					has_title_flag = center_jihads
					has_title_flag = africa_jihads
				}
			}
		}
	}

	major = yes
	
	show_ROOT = yes
	hide_new = yes
	
	only_playable = yes
	min_age = 16
	only_men = yes
	religion_group = muslim
	has_global_flag = emf_crusades_unlocked

	trigger = {
		controls_religion = yes
		NOT = { has_global_flag = emf_muslim_crusades_unlocked }
	}

	mean_time_to_happen = {
		years = 5
		
		modifier = {
			factor = 0.01
			had_global_flag = { flag = emf_crusades_unlocked days = 3650 }
		}
	}

	immediate = {
		set_global_flag = emf_muslim_crusades_unlocked
	}
	
	option = {
		name = EVTOPTA39670
		trigger = {
			religion_group = muslim
		}
	}
	
	option = {
		name = EVTOPTB39670
		trigger = {
			NOT = { religion_group = muslim }
		}
	}
}

# An adventurer decides to join the crusade
character_event = {
	id = emf_crusades.20
	
	hide_window = yes
	
	min_age = 16
	max_age = 50
	capable_only = yes
	prisoner = no
	
	trigger = {
		has_called_crusade = yes
		is_ruler = no
		is_ill = no
		
		# Must be competent and healthy
		can_be_marshal_trigger = yes
		health = 4
		OR = {
			trait = ambitious
			trait = zealous
			has_character_modifier = voice_of_jesus
		}
		calc_true_if = {
			amount = 2
			martial = 12
			martial = 16
			diplomacy = 12
			trait = brave
			is_strong_trigger = yes
			prestige = 500
		}
		location = {
			religion = ROOT
		}
		
		OR = {
			NOT = { has_minor_title = title_commander }
			liege = { war = no }
		}
		
		NOR = {
			emf_is_voter = yes
			dynasty = none
			trait = cynical
			trait = decadent
			trait = content
			trait = craven
			trait = depressed
			trait = imbecile
			has_injury_trigger = yes
			is_maimed_trigger = yes
			trait = incapable
			trait = blinded
			trait = eunuch
			is_weak_trigger = yes
			is_ascetic_trigger = yes
			any_liege = { holy_order = yes }
			any_liege = { mercenary = yes }
			any_spouse = { is_ruler = yes }
			any_heir_title = { always = yes }
			has_character_modifier = planning_claimant_adventure
			has_character_modifier = planning_duchy_adventure
			religion_head = { check_variable = { which = "crusader_adventurers" value = 4.9 } }
		}
		
		OR = {
			AND = {
				martial = 12
				calc_true_if = {
					amount = 2
					martial = 16
					martial = 20
					diplomacy = 12
					diplomacy = 16
					trait = zealous
				}
			}
			father_even_if_dead = {
				OR = {
					primary_title = { higher_tier_than = BARON }
					father_even_if_dead = {
						primary_title = { higher_tier_than = BARON }
					}
					mother_even_if_dead = {
						primary_title = { higher_tier_than = BARON }
					}
				}
			}
			mother_even_if_dead = {
				OR = {
					primary_title = { higher_tier_than = BARON }
					father_even_if_dead = {
						primary_title = { higher_tier_than = BARON }
					}
					mother_even_if_dead = {
						primary_title = { higher_tier_than = BARON }
					}
				}
			}
		}
	}

	mean_time_to_happen = {
		years = 20
		modifier = {
			factor = 0.2
			has_character_flag = flag_denied_title
		}
		modifier = {
			factor = 0.2
			has_character_flag = demon_child_non_pagan
		}
		modifier = {
			factor = 0.5
			trait = zealous
		}
		modifier = {
			factor = 0.5
			OR = {
				trait = lunatic
				trait = possessed
			}
		}
		modifier = {
			factor = 0.75
			OR = {
				trait = genius
				trait = brilliant_strategist
			}
		}
		modifier = {
			factor = 0.75
			trait = humble
		}
		modifier = {
			factor = 0.75
			trait = brave
		}
		modifier = {
			factor = 0.75
			trait = proud
		}
		modifier = {
			factor = 0.75
			trait = greedy
		}
		modifier = {
			factor = 0.75
			trait = envious
		}
		modifier = {
			factor = 0.75
			trait = wroth
		}
		modifier = {
			factor = 0.75
			trait = sayyid
		}
		modifier = {
			factor = 0.75
			diplomacy = 12
		}
		modifier = {
			factor = 1.5
			trait = slothful
		}
		modifier = {
			factor = 1.5
			trait = charitable
		}
		modifier = {
			factor = 1.5
			trait = patient
		}
		modifier = {
			factor = 2.0
			trait = kind
		}
		modifier = {
			factor = 2.0
			NOT = { diplomacy = 7 }
		}
		modifier = {
			factor = 2.0
			NOT = { diplomacy = 5 }
		}
		modifier = {
			factor = 2.0
			NOT = { diplomacy = 3 }
		}
	}

	immediate = {
		set_character_flag = crusader_adventurer
		add_trait = adventurer
		
		# Give them their adventurer title
		# NOTE: the title is not set as 'adventurer = yes' as that prevents joining the war
		liege = {
			capital_scope = {
				save_event_target_as = liege_capital
				county = {
					ROOT = {
						set_character_flag = origin_county_@PREV
						if = {
							limit = { religion_group = christian }
							create_title = {
								tier = DUKE
								landless = yes
								culture = THIS
								name = "CRUSADE_ADVENTURE"
								holder = THIS
								ruler = "LORD"
								ruler_female = "LADY"
								base_title = PREV
							}
						}
						if = {
							limit = { religion_group = muslim }
							create_title = {
								tier = DUKE
								landless = yes
								culture = THIS
								name = "CRUSADE_ADVENTURE_MUSLIM"
								holder = THIS
								ruler = "LORD"
								ruler_female = "LADY"
								base_title = PREV
							}
						}
						if = {
							limit = {
								NOT = { religion_group = christian }
								NOT = { religion_group = muslim }
							}
							create_title = {
								tier = DUKE
								landless = yes
								culture = THIS
								name = "CRUSADE_ADVENTURE_OTHER"
								holder = THIS
								ruler = "LORD"
								ruler_female = "LADY"
								base_title = PREV
							}
						}
					}
				}
			}
		}
		
		# Give them a small army
		spawn_unit = {
			province = event_target:liege_capital
			home = event_target:liege_capital
			owner = ROOT
			scaled_by_biggest_garrison = 0.5
			troops = {
				archers = { 6 6 }
				light_cavalry = { 4 4 }
				light_infantry = { 10 10 }
			}
			attrition = 0
			maintenance_multiplier = 0
			cannot_inherit = yes
			earmark = crusade_adventure
		}
		
		spawn_fleet = {
			province = closest # closest sea zone
			owner = ROOT
			troops = {
				galleys = { 50 50 }
			}
		}
		
		# Create some courtiers
		emf_create_courtiers_for_ROOT = yes
		
		# Join the crusade
		religion_head = {
			ROOT = { join_attacker_wars = PREV }
		}
		
		character_event = { id = emf_crusades.21 } # double-check war status
	}
}

# Double-check that the adventurer is at war
character_event = {
	id = emf_crusades.21
	
	is_triggered_only = yes
	hide_window = yes
	
	immediate = {
		if = {
			limit = { war = yes }
			event_target:liege_capital = {
				owner = {
					character_event = { id = emf_crusades.22 } # inform
				}
			}
			
			# Advance the religion head's count of adventurers
			religion_head = {
				change_variable = { which = "crusader_adventurers" value = 1 }
			}
		}
		
		if = {
			limit = { war = no }
			emf_teardown_crusade_adventurer_effect = yes
		}
	}
}

# Inform former liege of the adventurer
character_event = {
	id = emf_crusades.22
	desc = EVTDESC_emf_crusades_22
	picture = GFX_evt_crusaders
	
	is_triggered_only = yes
	
	option = {
		name = I_SEE
	}
}

# Crusader adventurer dies during the crusade
character_event = {
	id = emf_crusades.23
	
	is_triggered_only = yes
	hide_window = yes
	
	trigger = {
		has_character_flag = crusader_adventurer
	}
	
	immediate = {
		emf_teardown_crusade_adventurer_effect = yes
	}
}

# Crusader adventurer must decide what to do if the crusade fails
character_event = {
	id = emf_crusades.24
	desc = EVTDESC_emf_crusades_24
	picture = GFX_evt_crusaders
	
	is_triggered_only = yes
	
	trigger = {
		has_character_flag = crusader_adventurer
		any_demesne_title = { is_landless_type_title = yes }
	}

	option = {
		name = EVTOPTA_emf_crusades_24 # Return home
		ai_chance = {
			factor = 50
		}
		emf_teardown_crusade_adventurer_effect = yes
	}
	option = {
		name = EVTOPTB_emf_crusades_24 # Become a mercenary
		ai_chance = {
			factor = 50
			modifier = {
				factor = 1.5
				trait = greedy
			}
			modifier = {
				factor = 1.5
				trait = ambitious
			}
			modifier = {
				factor = 0
				OR = {
					has_injury_trigger = yes
					is_maimed_trigger = yes
					trait = depressed
					trait = stressed
					trait = craven
					trait = slothful
					trait = humble
					trait = content
				}
			}
		}
		
		# Find their original location
		random_landed_title = {
			limit = { ROOT = { has_character_flag = origin_county_@PREV } }
			ROOT = { clr_character_flag = origin_county_@PREV }
			holder_scope = { save_event_target_as = return_liege }
		}
		
		random_demesne_title = {
			limit = { is_landless_type_title = yes }
			set_title_flag = adventurer_title
		}
		disband_event_forces = crusade_adventure
		
		# Give them a mercenary title
		event_target:return_liege = {
			primary_title = {
				create_title = {
					tier = DUKE
					name = CRUSADE_ADVENTURE
					landless = yes
					temporary = yes
					adventurer = yes
					custom_created = yes
					culture = ROOT
					holder = ROOT
					base_title = THIS
					mercenary = yes
					ruler = "CAPTAIN"
					ruler_female = "CAPTAIN"
					foa = "CAPTAIN_FOA"
				}
			}
		}
		set_character_flag = is_mercenary_leader
		add_character_modifier = { modifier = started_mercenary_company months = 30 }
		
		# Get rid of their adventurer title
		random_demesne_title = {
			limit = { has_title_flag = adventurer_title }
			set_title_landless = { title = THIS status = no }
			emf_destroy_title_unsafe_effect = yes
		}
		
		# Cut cords with the former ruler (he didn't create the merc band, after all)
		primary_title = { cut_mercenary_creator_relation = yes }
	}
}
		
