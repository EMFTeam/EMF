namespace = PlusFaction

#reserved: PlusFaction.400 to PlusFaction.499

##################################
# FACTION DEMANDS EVENTS
# Original Faction System by Wiz
# Re-Written by Rylock
##################################

# Liege responds to demand from faction
letter_event = {
	id = PlusFaction.400
	
	desc = {
		text = EVTDESC_PlusFaction_400A
		trigger = { FROM = { has_character_flag = demands_lower_CA } }
	}
	desc = {
		text = EVTDESC_PlusFaction_400B
		trigger = { FROM = { has_character_flag = demands_lower_TO } }
	}
	desc = {
		text = EVTDESC_PlusFaction_400C
		trigger = { FROM = { has_character_flag = demands_tax_privilege } }
	}
	desc = {
		text = EVTDESC_PlusFaction_400D
		trigger = { FROM = { has_character_flag = demands_levy_privilege } }
	}
	desc = {
		text = EVTDESC_PlusFaction_400E
		trigger = { FROM = { has_character_flag = demands_surrender_title } }
	}
	desc = {
		text = EVTDESC_PlusFaction_400H
		trigger = { FROM = { has_character_flag = demands_share_wealth } }
	}
	desc = {
		text = EVTDESC_PlusFaction_400J
		trigger = { FROM = { has_character_flag = demands_revert_succession } }
	}
	desc = {
		text = EVTDESC_PlusFaction_400K
		trigger = { FROM = { has_character_flag = demands_council_life_terms } }
	}
	desc = {
		text = EVTDESC_PlusFaction_400L
		trigger = { FROM = { has_character_flag = demands_lower_feudal_obligations } }
	}
	desc = {
		text = EVTDESC_PlusFaction_400M
		trigger = { FROM = { has_character_flag = demands_lower_tribal_obligations } }
	}
	desc = {
		text = EVTDESC_PlusFaction_400N
		trigger = { FROM = { has_character_flag = demands_lower_city_obligations } }
	}
	desc = {
		text = EVTDESC_PlusFaction_400O
		trigger = { FROM = { has_character_flag = demands_lower_temple_obligations } }
	}
	
	is_triggered_only = yes
	
	immediate = {
		any_vassal = {
			limit = {
				OR = {
					pf_from_faction_backer_trigger = yes
					character = FROM
				}
			}
			reverse_opinion = { who = ROOT modifier = made_ultimatum years = 5 }
		}
	}
	
	option = {
		name = EVTDEMANDYES #Agree to the demand
		ai_chance = {
			factor = 50
			modifier = {
				factor = 0.5
				FROM = {
					OR = {
						has_character_flag = demands_council_life_terms
						has_character_flag = demands_revert_succession
					}
				}
			}
			modifier = {
				factor = 0.2
				FROM = {
					OR = {
						has_character_flag = demands_lower_CA
						has_character_flag = demands_lower_TO
					}
				}
			}
			modifier = {
				factor = 2
				FROM = { has_character_flag = demands_share_wealth }
				wealth = 250
			}
			modifier = {
				factor = 2
				FROM = { has_character_flag = demands_surrender_title }
				over_max_demesne_size = 1
			}
			modifier = {
				factor = 2.5
				FROM = { has_character_flag = demands_surrender_title }
				over_max_demesne_size = 2
			}
			modifier = {
				factor = 1.25
				trait = craven
			}
			modifier = {
				factor = 1.25
				trait = humble
			}
			modifier = {
				factor = 1.25
				trait = kind
			}
			modifier = {
				factor = 1.25
				trait = charitable
			}
			modifier = {
				factor = 1.25
				trait = patient
			}
			modifier = {
				factor = 1.25
				trait = content
			}
		}
		
		if = {
			limit = { lower_real_tier_than = king }
			prestige = -100
		}
		if = {
			limit = { real_tier = king }
			prestige = -250
		}
		if = {
			limit = { real_tier = emperor }
			prestige = -500
		}
		
		#faction demands implemented
		if = {
			limit = { FROM = { has_character_flag = demands_lower_CA } }
			pf_lower_CA_effect = yes
		}
		if = {
			limit = { FROM = { has_character_flag = demands_lower_TO } }
			pf_lower_TO_effect = yes
		}
		if = {
			limit = {
				FROM = { has_character_flag = demands_surrender_title }
				NOT = { has_landed_title = event_target:faction_demanded_title }
			}
			random_demesne_title = {
				limit = {
					tier = count
					can_be_given_away = yes
					location = { is_capital = no }
				}
				grant_title = FROM
				hidden_tooltip = {
					add_weak_pressed_claim = ROOT
					FROM = { set_defacto_liege = ROOT }
				}
			}
		}
		if = {
			limit = {
				FROM = { has_character_flag = demands_surrender_title }
				has_landed_title = event_target:faction_demanded_title
			}
			event_target:faction_demanded_title = {
				grant_title = event_target:faction_demanded_title_for
				hidden_tooltip = {
					add_weak_pressed_claim = ROOT
					event_target:faction_demanded_title_for = {
						if = {
							limit = { NOT = { is_liege_or_above = ROOT } }
							set_defacto_liege = ROOT
						}
					}
				}
			}
		}
		if = {
			limit = { FROM = { has_character_flag = demands_share_wealth } }
			any_vassal = {
				limit = {
					OR = {
						pf_from_faction_backer_trigger = yes
						character = FROM
					}
				}
				if = { limit = { real_tier = king }  wealth = 100 ROOT = { wealth = -100 } }
				if = { limit = { real_tier = duke }  wealth = 50  ROOT = { wealth = -50 } }
				if = { limit = { real_tier = count } wealth = 25  ROOT = { wealth = -25 } }
				if = { limit = { real_tier = baron } wealth = 10  ROOT = { wealth = -10 } }
			}
		}
		if = {
			limit = { FROM = { has_character_flag = demands_revert_succession } }
			primary_title = {
				pf_revert_succession_law_effect = yes
			}
		}
		# if = {
		# 	limit = { FROM = { has_character_flag = demands_council_life_terms } }
		# 	primary_title = {
		# 		add_law_w_cooldown = council_privileges_1
		# 	}
		# }
		if = {
			limit = { FROM = { has_character_flag = demands_lower_feudal_obligations } }
			pf_lower_feudal_obligations_effect = yes
		}
		if = {
			limit = { FROM = { has_character_flag = demands_lower_tribal_obligations } }
			pf_lower_tribal_obligations_effect = yes
		}
		if = {
			limit = { FROM = { has_character_flag = demands_lower_city_obligations } }
			pf_lower_city_obligations_effect = yes
		}
		if = {
			limit = { FROM = { has_character_flag = demands_lower_temple_obligations } }
			pf_lower_temple_obligations_effect = yes
		}
		if = {
			limit = { FROM = { leads_faction = faction_court } }
			custom_tooltip = { text = COURTFACTIONMOODPLUS }
		}
		if = {
			limit = { FROM = { leads_faction = faction_prosperity } }
			custom_tooltip = { text = PROSPERITYFACTIONMOODPLUS }
		}
		if = {
			limit = { FROM = { leads_faction = faction_glory } }
			custom_tooltip = { text = GLORYFACTIONMOODPLUS }
		}
		if = {
			limit = { FROM = { leads_faction = faction_tradition } }
			custom_tooltip = { text = TRADITIONFACTIONMOODPLUS }
		}
		hidden_tooltip = {
			any_vassal = {
				limit = {
					OR = {
						pf_from_faction_backer_trigger = yes
						character = FROM
					}
				}
				character_event = { id = PlusFaction.401 } #notify
			}
			character_event = { id = PlusFaction.200 days = 1 } #recalculate faction moods
		}
	}
	option = {
		name = EVTDEMANDNO #Refuse the demand
		ai_chance = {
			factor = 50
			modifier = {
				factor = 0.1
				has_regent = yes
			}
			modifier = {
				factor = 1.5
				FROM = {
					OR = {
						has_character_flag = demands_council_life_terms
						has_character_flag = demands_revert_succession
					}
				}
			}
			modifier = {
				factor = 1.8
				FROM = {
					OR = {
						has_character_flag = demands_lower_CA
						has_character_flag = demands_lower_TO
					}
				}
			}
			modifier = {
				factor = 1.25
				trait = brave
			}
			modifier = {
				factor = 1.25
				trait = proud
			}
			modifier = {
				factor = 1.25
				trait = envious
			}
			modifier = {
				factor = 1.25
				trait = greedy
			}
			modifier = {
				factor = 1.25
				trait = wroth
			}
			modifier = {
				factor = 1.25
				trait = ambitious
			}
			modifier = {
				factor = 5
				FROM = {
					leads_faction = faction_court
					NOT = { faction_power = { faction = faction_court power = 0.75 } }
				}
			}
			modifier = {
				factor = 5
				FROM = {
					leads_faction = faction_prosperity
					NOT = { faction_power = { faction = faction_prosperity power = 0.75 } }
				}
			}
			modifier = {
				factor = 5
				FROM = {
					leads_faction = faction_glory
					NOT = { faction_power = { faction = faction_glory power = 0.75 } }
				}
			}
			modifier = {
				factor = 5
				FROM = {
					leads_faction = faction_tradition
					NOT = { faction_power = { faction = faction_tradition power = 0.75 } }
				}
			}
			modifier = {
				factor = 0.5
				FROM = {
					leads_faction = faction_court
					faction_power = { faction = faction_court power = 1.49 }
				}
			}
			modifier = {
				factor = 0.5
				FROM = {
					leads_faction = faction_prosperity
					faction_power = { faction = faction_prosperity power = 1.49 }
				}
			}
			modifier = {
				factor = 0.5
				FROM = {
					leads_faction = faction_glory
					faction_power = { faction = faction_glory power = 1.49 }
				}
			}
			modifier = {
				factor = 0.5
				FROM = {
					leads_faction = faction_tradition
					faction_power = { faction = faction_tradition power = 1.49 }
				}
			}
			modifier = {
				factor = 0.25
				FROM = {
					leads_faction = faction_court
					faction_power = { faction = faction_court power = 1.99 }
				}
			}
			modifier = {
				factor = 0.25
				FROM = {
					leads_faction = faction_prosperity
					faction_power = { faction = faction_prosperity power = 1.99 }
				}
			}
			modifier = {
				factor = 0.25
				FROM = {
					leads_faction = faction_glory
					faction_power = { faction = faction_glory power = 1.99 }
				}
			}
			modifier = {
				factor = 0.25
				FROM = {
					leads_faction = faction_tradition
					faction_power = { faction = faction_tradition power = 1.99 }
				}
			}
			modifier = {
				factor = 0.1
				FROM = {
					leads_faction = faction_court
					faction_power = { faction = faction_court power = 2.99 }
				}
			}
			modifier = {
				factor = 0.1
				FROM = {
					leads_faction = faction_prosperity
					faction_power = { faction = faction_prosperity power = 2.99 }
				}
			}
			modifier = {
				factor = 0.1
				FROM = {
					leads_faction = faction_glory
					faction_power = { faction = faction_glory power = 2.99 }
				}
			}
			modifier = {
				factor = 0.1
				FROM = {
					leads_faction = faction_tradition
					faction_power = { faction = faction_tradition power = 2.99 }
				}
			}
		}
		if = {
			limit = { FROM = { leads_faction = faction_court } }
			custom_tooltip = { text = COURTFACTIONMOODMINUS }
		}
		if = {
			limit = { FROM = { leads_faction = faction_prosperity } }
			custom_tooltip = { text = PROSPERITYFACTIONMOODMINUS }
		}
		if = {
			limit = { FROM = { leads_faction = faction_glory } }
			custom_tooltip = { text = GLORYFACTIONMOODMINUS }
		}
		if = {
			limit = { FROM = { leads_faction = faction_tradition } }
			custom_tooltip = { text = TRADITIONFACTIONMOODMINUS }
		}
		hidden_tooltip = {
			any_vassal = {
				limit = {
					OR = {
						pf_from_faction_backer_trigger = yes
						character = FROM
					}
				}
				opinion = { who = ROOT modifier = ultimatum_refused years = 10 }
			}
		}
		FROM = {
			letter_event = { id = PlusFaction.402 tooltip = INFORM_MAY_OVERTHROW } #inform
		}
	}
}

# Faction informed that liege agreed to the demand
character_event = {
	id = PlusFaction.401
	desc = EVTDESC_PlusFaction_401
	picture = GFX_evt_council
	
	is_triggered_only = yes
	
	option = {
		name = EXCELLENT
		if = {
			limit = { has_opinion_modifier = { who = FROM modifier = ultimatum_refused } }
			hidden_tooltip = {
				remove_opinion = { who = FROM modifier = ultimatum_refused }
			}
		}
		opinion = { who = FROM modifier = faction_pleased multiplier = 10 years = 10 }
		if = {
			limit = { NOT = { character = FROMFROM } }
			opinion = { who = FROMFROM modifier = faction_pleased multiplier = 4 years = 10 }
		}
		if = {
			limit = { character = FROMFROM }
			if = {
				limit = { FROM = { lower_real_tier_than = king } }
				prestige = 50
			}
			if = {
				limit = { FROM = { real_tier = king } }
				prestige = 100
			}
			if = {
				limit = { FROM = { real_tier = emperor } }
				prestige = 250
			}
			hidden_tooltip = {
				character_event = { id = PlusFaction.399 days = 1 } #clear flags
				pf_clear_demands_flags_effect = yes
			}
		}
	}
}

# Faction leader informed that liege refused the demand
letter_event = {
	id = PlusFaction.402
	desc = EVTDESC_PlusFaction_402
	
	is_triggered_only = yes
	
	option = {
		name = EVTOPTA_PlusFaction_402 #Then we go to war!
		ai_chance = {
			factor = 100
			# modifier = {
			# 	factor = 0.5
			# 	NOT = { trait = deceitful }
			# 	liege = {
			# 		reverse_has_opinion_modifier = { who = ROOT modifier = sworn_to_support_heir }
			# 	}
			# }
			modifier = {
				factor = 0
				leads_faction = faction_court
				NOT = { faction_power = { faction = faction_court power = 0.5 } }
			}
			modifier = {
				factor = 0
				leads_faction = faction_prosperity
				NOT = { faction_power = { faction = faction_prosperity power = 0.5 } }
			}
			modifier = {
				factor = 0
				leads_faction = faction_glory
				NOT = { faction_power = { faction = faction_glory power = 0.5 } }
			}
			modifier = {
				factor = 0
				leads_faction = faction_tradition
				NOT = { faction_power = { faction = faction_tradition power = 0.5 } }
			}
			modifier = {
				factor = 0.25
				leads_faction = faction_court
				NOT = { faction_power = { faction = faction_court power = 0.75 } }
			}
			modifier = {
				factor = 0.25
				leads_faction = faction_prosperity
				NOT = { faction_power = { faction = faction_prosperity power = 0.75 } }
			}
			modifier = {
				factor = 0.25
				leads_faction = faction_glory
				NOT = { faction_power = { faction = faction_glory power = 0.75 } }
			}
			modifier = {
				factor = 0.25
				leads_faction = faction_tradition
				NOT = { faction_power = { faction = faction_tradition power = 0.75 } }
			}
			modifier = {
				factor = 2.0
				leads_faction = faction_court
				faction_power = { faction = faction_court power = 1.49 }
			}
			modifier = {
				factor = 2.0
				leads_faction = faction_prosperity
				faction_power = { faction = faction_prosperity power = 1.49 }
			}
			modifier = {
				factor = 2.0
				leads_faction = faction_glory
				faction_power = { faction = faction_glory power = 1.49 }
			}
			modifier = {
				factor = 2.0
				leads_faction = faction_tradition
				faction_power = { faction = faction_tradition power = 1.49 }
			}
			modifier = {
				factor = 5.0
				leads_faction = faction_court
				faction_power = { faction = faction_court power = 1.99 }
			}
			modifier = {
				factor = 5.0
				leads_faction = faction_prosperity
				faction_power = { faction = faction_prosperity power = 1.99 }
			}
			modifier = {
				factor = 5.0
				leads_faction = faction_glory
				faction_power = { faction = faction_glory power = 1.99 }
			}
			modifier = {
				factor = 5.0
				leads_faction = faction_tradition
				faction_power = { faction = faction_tradition power = 1.99 }
			}
			modifier = {
				factor = 10.0
				leads_faction = faction_court
				faction_power = { faction = faction_court power = 2.99 }
			}
			modifier = {
				factor = 10.0
				leads_faction = faction_prosperity
				faction_power = { faction = faction_prosperity power = 2.99 }
			}
			modifier = {
				factor = 10.0
				leads_faction = faction_glory
				faction_power = { faction = faction_glory power = 2.99 }
			}
			modifier = {
				factor = 10.0
				leads_faction = faction_tradition
				faction_power = { faction = faction_tradition power = 2.99 }
			}
			modifier = {
				factor = 2
				trait = brave
			}
			modifier = {
				factor = 0.5
				trait = craven
			}
		}
		hidden_tooltip = {
			set_character_flag = faction_demand_refused
			any_faction_backer = {
				limit = { pf_my_faction_backer_trigger = yes }
				character_event = { id = PlusFaction.343 } #vote
			}
		}
		pf_leader_vote_effect = yes
		character_event = { id = PlusFaction.344 days = 7 tooltip = EVTTOOLTIP1900737 }
	}
	option = {
		name = EVTOPTB_PlusFaction_402 #Do nothing
		ai_chance = {
			factor = 100
			modifier = {
				factor = 0.5
				leads_faction = faction_court
				faction_power = { faction = faction_court power = 1.49 }
			}
			modifier = {
				factor = 0.5
				leads_faction = faction_prosperity
				faction_power = { faction = faction_prosperity power = 1.49 }
			}
			modifier = {
				factor = 0.5
				leads_faction = faction_glory
				faction_power = { faction = faction_glory power = 1.49 }
			}
			modifier = {
				factor = 0.5
				leads_faction = faction_tradition
				faction_power = { faction = faction_tradition power = 1.49 }
			}
			modifier = {
				factor = 0.01
				leads_faction = faction_court
				faction_power = { faction = faction_court power = 1.99 }
			}
			modifier = {
				factor = 0.01
				leads_faction = faction_prosperity
				faction_power = { faction = faction_prosperity power = 1.99 }
			}
			modifier = {
				factor = 0.01
				leads_faction = faction_glory
				faction_power = { faction = faction_glory power = 1.99 }
			}
			modifier = {
				factor = 0.01
				leads_faction = faction_tradition
				faction_power = { faction = faction_tradition power = 1.99 }
			}
		}
		if = {
			limit = { lower_real_tier_than = duke }
			prestige = -25
		}
		if = {
			limit = { real_tier = duke }
			prestige = -50
		}
		if = {
			limit = { real_tier = king }
			prestige = -100
		}
		hidden_tooltip = {
			set_character_flag = faction_demand_refused
			any_faction_backer = {
				limit = { pf_my_faction_backer_trigger = yes }
				character_event = { id = PlusFaction.305 } #notify
			}
			character_event = { id = PlusFaction.399 days = 1 } #clear flags
			pf_clear_demands_flags_effect = yes
		}
	}
}

##################################
# FACTION CIVIL WAR EVENTS
##################################

# Pretender faction goes to war
# character_event = {
# 	id = PlusFaction.410
# 	picture = GFX_evt_battle
# 	desc = EVTDESC_PlusFaction_410
# 	border = GFX_event_normal_frame_war
# 
# 	only_rulers = yes
# 	prisoner = no
# 	capable_only = yes
# 	min_age = 16
# 	
# 	trigger = {
# 		ai = yes
# 		war = no
# 		leads_faction = faction_pretender
# 		faction_power = {
# 			faction = faction_pretender
# 			power = 0.75
# 		}
# 		liege = {
# 			ai = yes
# 			pf_war_trigger = no
# 		}
# 		NOR = {
# 			has_character_modifier = do_not_disturb
# 			supported_claimant = {
# 				any_war = {
# 					OR = {
# 						AND = {
# 							any_attacker = { character = PREV }
# 							any_attacker = { 
# 								ROOT = {
# 									liege = {
# 										character = PREVPREV
# 									} 
# 								}
# 							}
# 						}
# 						AND = {
# 							any_defender = { character = PREV }
# 							any_defender = { 
# 								ROOT = {
# 									liege = {
# 										character = PREVPREV
# 									} 
# 								}
# 							}
# 						}
# 					}
# 				}
# 			}
# 		}
# 		e_placeholder = { had_title_flag = { flag = startup days = 730 } }
# 	}
# 
# 	mean_time_to_happen = {
# 		months = 60
# 		modifier = {
# 			factor = 3.0
# 			NOT = {
# 				faction_power = {
# 					faction = faction_pretender
# 					power = 1.0
# 				}
# 			}
# 		}
# 		modifier = {
# 			factor = 0.5
# 			faction_power = {
# 				faction = faction_pretender
# 				power = 1.5
# 			}
# 		}
# 		modifier = {
# 			factor = 0.5
# 			faction_power = {
# 				faction = faction_pretender
# 				power = 2.0
# 			}
# 		}
# 		modifier = {
# 			factor = 0.5
# 			faction_power = {
# 				faction = faction_pretender
# 				power = 3.0
# 			}
# 		}
# 		modifier = {
# 			factor = 0.5
# 			faction_power = {
# 				faction = faction_pretender
# 				power = 4.0
# 			}
# 		}
# 	}
# 
# 	option = {
# 		name = EVTOPTA_PlusFaction_410 #Make the demand!
# 		log = "[Root.GetTitledName] has taken the Pretender faction into war"
# 		liege = {
# 			letter_event = { id = 8036 days = 7 tooltip = "EVTTOOLTIP8005" }
# 		}
# 		if = {
# 			limit = {
# 				supported_claimant = {
# 					NOT = { character = ROOT }
# 					OR = {
# 						NOT = { same_liege = ROOT }
# 						NOT = { in_faction = faction_pretender }
# 						NOT = { supported_claimant = { character = PREV } }
# 					}
# 				}
# 			}
# 			supported_claimant = {
# 				letter_event = { id = 8037 days = 1 }
# 			}
# 		}
# 		hidden_tooltip = {
# 			set_character_flag = faction_claimant_ultimatum_taken
# 		}
# 	}
# }
# 
# # Separatist faction goes to war
# character_event = {
# 	id = PlusFaction.411
# 	picture = GFX_evt_battle
# 	desc = EVTDESC_PlusFaction_411
# 	border = GFX_event_normal_frame_war
# 
# 	ai = yes
# 	only_rulers = yes
# 	capable_only = yes
# 	prisoner = no
# 
# 	trigger = {
# 		ai = yes
# 		war = no
# 		has_regent = no
# 		leads_faction = faction_separatist
# 		faction_power = {
# 			faction = faction_separatist
# 			power = 0.75
# 		}
# 		liege = { pf_war_trigger = no }
# 		NOT = { has_character_modifier = do_not_disturb }
# 		NOT = { has_character_modifier = faction_independence_ultimatum_timer }
# 		e_placeholder = { had_title_flag = { flag = startup days = 730 } }
# 	}
# 
# 	mean_time_to_happen = {
# 		months = 60
# 		modifier = {
# 			factor = 10.0
# 			NOT = {
# 				faction_power = {
# 					faction = faction_separatist
# 					power = 1.25
# 				}
# 			}
# 		}
# 		modifier = {
# 			factor = 0.5
# 			faction_power = {
# 				faction = faction_separatist
# 				power = 1.5
# 			}
# 		}
# 		modifier = {
# 			factor = 0.5
# 			faction_power = {
# 				faction = faction_separatist
# 				power = 2.0
# 			}
# 		}
# 		modifier = {
# 			factor = 0.5
# 			faction_power = {
# 				faction = faction_separatist
# 				power = 3.0
# 			}
# 		}
# 		modifier = {
# 			factor = 0.5
# 			faction_power = {
# 				faction = faction_separatist
# 				power = 4.0
# 			}
# 		}
# 	}
# 
# 	option = {
# 		name = EVTOPTA_PlusFaction_411 #We go to war!
# 		log = "[Root.GetTitledName] has taken the Independence faction into war"
# 		hidden_tooltip = {
# 			set_character_flag = original_war_liege
# 			pf_setup_rebel_effect = yes
# 			any_faction_backer = {
# 				faction = faction_separatist
# 				pf_setup_rebel_effect = yes
# 			}
# 		}
# 		liege = {
# 			set_character_flag = faction_separatist_war
# 			reverse_war = {
# 				target = ROOT
# 				casus_belli = cb_faction_independence
# 				faction = faction_separatist
# 			}
# 		}
# 	}
# }

### PICKING SIDES ONCE THE CIVIL WAR BEGINS

# Faction leader given option to join civil war
character_event = {
	id = PlusFaction.415
	desc = EVTDESC_PlusFaction_415
	picture = GFX_evt_battle
	border = GFX_event_normal_frame_war
	
	is_triggered_only = yes
	
	immediate = {
		FROM = { save_event_target_as = pf_attacker }
	}

	option = {
		name = EVTOPTA_PlusFaction_415 #join the rebellion
		ai_chance = {
			factor = 100
			modifier = {
				factor = 0
				leads_faction = faction_court
				liege = {
					NOR = {
						has_character_flag = faction_court_angry
						has_character_flag = faction_court_unhappy
					}
				}
			}
			modifier = {
				factor = 0
				leads_faction = faction_prosperity
				liege = {
					NOR = {
						has_character_flag = faction_court_angry
						has_character_flag = faction_court_unhappy
					}
				}
			}
			modifier = {
				factor = 0
				leads_faction = faction_glory
				liege = {
					NOR = {
						has_character_flag = faction_court_angry
						has_character_flag = faction_court_unhappy
					}
				}
			}
			modifier = {
				factor = 0
				leads_faction = faction_tradition
				liege = {
					NOR = {
						has_character_flag = faction_court_angry
						has_character_flag = faction_court_unhappy
					}
				}
			}
			modifier = {
				factor = 4
				leads_faction = faction_court
				liege = { has_character_flag = faction_court_angry }
			}
			modifier = {
				factor = 4
				leads_faction = faction_prosperity
				liege = { has_character_flag = faction_prosperity_angry }
			}
			modifier = {
				factor = 4
				leads_faction = faction_glory
				liege = { has_character_flag = faction_glory_angry }
			}
			modifier = {
				factor = 4
				leads_faction = faction_tradition
				liege = { has_character_flag = faction_tradition_angry }
			}
			modifier = {
				factor = 1.25
				trait = proud
			}
			modifier = {
				factor = 1.25
				trait = ambitious
			}
			modifier = {
				factor = 0.8
				trait = content
			}
			modifier = {
				factor = 0.8
				trait = craven
			}
			modifier = {
				factor = 0.8
				trait = humble
			}
			modifier = {
				factor = 0.8
				opinion = { who = liege value = 0 }
			}
			modifier = {
				factor = 1.25
				NOT = { opinion = { who = liege value = 0 } }
			}
			modifier = {
				factor = 1.25
				NOT = { opinion = { who = liege value = -25 } }
			}
			modifier = {
				factor = 1.25
				NOT = { opinion = { who = liege value = -50 } }
			}
			modifier = {
				factor = 1.25
				NOT = { opinion = { who = liege value = -75 } }
			}
			modifier = {
				factor = 1.1
				opinion = { who = FROM value = 0 }
			}
			modifier = {
				factor = 1.1
				opinion = { who = FROM value = 25 }
			}
			modifier = {
				factor = 1.1
				opinion = { who = FROM value = 50 }
			}
			modifier = {
				factor = 1.1
				opinion = { who = FROM value = 75 }
			}
			modifier = {
				factor = 0.9
				NOT = { opinion = { who = FROM value = 0 } }
			}
			modifier = {
				factor = 0.9
				NOT = { opinion = { who = FROM value = -25 } }
			}
			modifier = {
				factor = 0.9
				NOT = { opinion = { who = FROM value = -50 } }
			}
			modifier = {
				factor = 0.9
				NOT = { opinion = { who = FROM value = -75 } }
			}
			modifier = {
				factor = 0.75
				liege = { dynasty = ROOT }
				FROM = { NOT = { dynasty = ROOT } }
			}
			modifier = {
				factor = 1.5
				liege = { NOT = { dynasty = ROOT } }
				FROM = { dynasty = ROOT }
			}
		}
		if = {
			limit = { leads_faction = faction_court }
			liege = { set_character_flag = faction_court_war }
		}
		if = {
			limit = { leads_faction = faction_prosperity }
			liege = { set_character_flag = faction_prosperity_war }
		}
		if = {
			limit = { leads_faction = faction_glory }
			liege = { set_character_flag = faction_glory_war }
		}
		if = {
			limit = { leads_faction = faction_tradition }
			liege = { set_character_flag = faction_tradition_war }
		}

		hidden_tooltip = {
			liege = {
				letter_event = { id = PlusFaction.416 }
			}
			any_faction_backer = {
				limit = {
					pf_war_trait_trigger = no
					pf_my_faction_backer_trigger = yes
				}
				letter_event = { id = PlusFaction.418 } #notify
			}
		}

		if = {
			limit = { war = no }
			pf_setup_rebel_effect = yes
			hidden_tooltip = { character_event = { id = PlusFaction.440 } } # Actually join
			tooltip = { join_attacker_wars = event_target:pf_attacker }
		}
		if = {
			limit = { war = yes }
			# TODO: custom event option name to the effect of "I must fight my own wars, but my faction will heed your call to arms!"
		}
	}
	option = {
		name = EVTOPTB_PlusFaction_415 #remain loyal
		ai_chance = {
			factor = 50
			modifier = {
				factor = 0
				leads_faction = faction_court
				liege = {
					OR = {
						has_character_flag = faction_court_angry
						has_character_flag = faction_court_unhappy
					}
				}
			}
			modifier = {
				factor = 0
				leads_faction = faction_prosperity
				liege = {
					OR = {
						has_character_flag = faction_court_angry
						has_character_flag = faction_court_unhappy
					}
				}
			}
			modifier = {
				factor = 0
				leads_faction = faction_glory
				liege = {
					OR = {
						has_character_flag = faction_court_angry
						has_character_flag = faction_court_unhappy
					}
				}
			}
			modifier = {
				factor = 0
				leads_faction = faction_tradition
				liege = {
					OR = {
						has_character_flag = faction_court_angry
						has_character_flag = faction_court_unhappy
					}
				}
			}
			modifier = {
				factor = 5
				leads_faction = faction_court
				liege = { has_character_flag = faction_court_happy }
			}
			modifier = {
				factor = 5
				leads_faction = faction_prosperity
				liege = { has_character_flag = faction_prosperity_happy }
			}
			modifier = {
				factor = 5
				leads_faction = faction_glory
				liege = { has_character_flag = faction_glory_happy }
			}
			modifier = {
				factor = 5
				leads_faction = faction_tradition
				liege = { has_character_flag = faction_tradition_happy }
			}
			modifier = {
				factor = 1.25
				opinion = { who = liege value = 25 }
			}
			modifier = {
				factor = 1.25
				opinion = { who = liege value = 50 }
			}
			modifier = {
				factor = 1.25
				opinion = { who = liege value = 75 }
			}
		}
		add_trait = loyalist
		hidden_tooltip = {
			liege = {
				opinion = { who = ROOT modifier = supported_civil_war years = 100 }
				letter_event = { id = PlusFaction.417 }
			}
			any_faction_backer = {
				limit = {
					pf_war_trait_trigger = no
					pf_my_faction_backer_trigger = yes
				}
				letter_event = { id = PlusFaction.419 } #notify
			}
		}
	}
	option = {
		name = EVTOPTC_PlusFaction_415 #remain neutral
		ai_chance = {
			factor = 100
			modifier = {
				factor = 1.25
				trait = craven
			}
			modifier = {
				factor = 0.8
				trait = brave
			}
		}
		add_trait = neutral
		hidden_tooltip = {
			liege = {
				opinion = { who = ROOT modifier = neutral_civil_war years = 100 }
			}
			any_faction_backer = {
				limit = {
					pf_war_trait_trigger = no
					pf_my_faction_backer_trigger = yes
				}
				letter_event = { id = PlusFaction.420 } #notify
			}
		}
	}
}

# Notify liege that the faction has joined the rebellion
letter_event = {
	id = PlusFaction.416
	border = GFX_event_letter_frame_war
	
	desc = {
		text = EVTDESC_PlusFaction_416A
		trigger = { FROM = { leads_faction = faction_court } }
	}
	desc = {
		text = EVTDESC_PlusFaction_416B
		trigger = { FROM = { leads_faction = faction_prosperity } }
	}
	desc = {
		text = EVTDESC_PlusFaction_416C
		trigger = { FROM = { leads_faction = faction_glory } }
	}
	desc = {
		text = EVTDESC_PlusFaction_416D
		trigger = { FROM = { leads_faction = faction_tradition } }
	}
	
	is_triggered_only = yes

	option = {
		name = EVTOPTA_PlusFaction_416
	}
}

# Notify liege that the faction is loyal
letter_event = {
	id = PlusFaction.417
	border = GFX_event_letter_frame_war
	
	desc = {
		text = EVTDESC_PlusFaction_417A
		trigger = { FROM = { leads_faction = faction_court } }
	}
	desc = {
		text = EVTDESC_PlusFaction_417B
		trigger = { FROM = { leads_faction = faction_prosperity } }
	}
	desc = {
		text = EVTDESC_PlusFaction_417C
		trigger = { FROM = { leads_faction = faction_glory } }
	}
	desc = {
		text = EVTDESC_PlusFaction_417D
		trigger = { FROM = { leads_faction = faction_tradition } }
	}
	
	is_triggered_only = yes

	option = {
		name = EXCELLENT
	}
}

# Faction member is called into the rebellion
letter_event = {
	id = PlusFaction.418
	desc = EVTDESC_PlusFaction_418
	border = GFX_event_letter_frame_war
	
	is_triggered_only = yes
	
	immediate = {
		FROMFROM = { save_event_target_as = pf_attacker }
	}

	option = {
		name = TOARMS
		trigger = { war = no }
		if = {
			limit = {
				prisoner = yes
				OR = {
					host = { character = FROM } # Faction leader
					host = { character = FROMFROM } # Initiating faction leader
				}
			}
			prisoner = no
		}
		pf_setup_rebel_effect = yes
		hidden_tooltip = { character_event = { id = PlusFaction.440 } } # Actually join
		tooltip = { join_attacker_wars = event_target:pf_attacker }
	}
	option = {
		name = EVTOPTF_PlusFaction_421 # I have my own wars to fight!
		trigger = {
			war = yes
		}
	}
}

# Faction member is informed of the faction's loyalty
letter_event = {
	id = PlusFaction.419
	desc = EVTDESC_PlusFaction_419
	border = GFX_event_letter_frame_war
	
	is_triggered_only = yes

	option = {
		name = TOARMS
		add_trait = loyalist
		hidden_tooltip = {
			liege = { opinion = { who = ROOT modifier = supported_civil_war years = 100 } }
		}
	}
}

# Faction member informed of faction's neutrality -- may pick sides
letter_event = {
	id = PlusFaction.420
	desc = EVTDESC_PlusFaction_420
	border = GFX_event_letter_frame_war
	
	is_triggered_only = yes
	
	immediate = {
		FROMFROM = { save_event_target_as = pf_attacker }
	}

	option = {
		name = EVTOPTA_PlusFaction_420 #join the rebellion anyway
		trigger = {
			war = no
		}
		ai_chance = {
			factor = 10
			modifier = {
				factor = 0
				is_adult = no
			}
			modifier = {
				factor = 0
				liege = { current_heir = { character = ROOT } }
			}
			modifier = {
				factor = 0.5
				liege = {
					OR = {
						is_allied_with = ROOT
						dynasty = ROOT
						is_close_relative = ROOT
					}
				}
			}
			modifier = {
				factor = 5
				liege = { is_rival = ROOT }
			}
			modifier = {
				factor = 1.5
				trait = ambitious
			}
			modifier = {
				factor = 1.25
				OR = {
					is_allied_with = FROMFROM
					is_close_relative = FROMFROM
				}
			}
			modifier = {
				factor = 0.8
				NOT = { opinion = { who = FROMFROM value = 0 } }
			}
			modifier = {
				factor = 0.8
				NOT = { opinion = { who = FROMFROM value = -25 } }
			}
			modifier = {
				factor = 0.5
				NOT = { opinion = { who = FROMFROM value = -50 } }
			}
			modifier = {
				factor = 0.5
				NOT = { opinion = { who = FROMFROM value = -75 } }
			}
			modifier = {
				factor = 1.25
				opinion = { who = FROMFROM value = 25 }
			}
			modifier = {
				factor = 1.25
				opinion = { who = FROMFROM value = 50 }
			}
			modifier = {
				factor = 1.25
				opinion = { who = FROMFROM value = 75 }
			}
			modifier = {
				factor = 0
				opinion = { who = liege value = 0 }
			}
			modifier = {
				factor = 2
				NOT = { opinion = { who = liege value = 0 } }
			}
			modifier = {
				factor = 2
				NOT = { opinion = { who = liege value = -25 } }
			}
			modifier = {
				factor = 2
				NOT = { opinion = { who = liege value = -50 } }
			}
			modifier = {
				factor = 2
				NOT = { opinion = { who = liege value = -75 } }
			}
		}

		pf_setup_rebel_effect = yes
		hidden_tooltip = { character_event = { id = PlusFaction.440 } } # Actually join
		tooltip = { join_attacker_wars = event_target:pf_attacker }
	}
	option = {
		name = EVTOPTB_PlusFaction_420 #support the liege anyway
		trigger = { war = no }
		ai_chance = {
			factor = 10
			modifier = {
				factor = 0
				is_adult = no
			}
			modifier = {
				factor = 0
				NOT = { opinion = { who = liege value = -50 } }
			}
			modifier = {
				factor = 0.1
				NOT = { opinion = { who = liege value = 0 } }
			}
			modifier = {
				factor = 10
				liege = { current_heir = { character = ROOT } }
			}
			modifier = {
				factor = 5
				liege = {
					OR = {
						is_allied_with = ROOT
						dynasty = ROOT
						is_close_relative = ROOT
					}
				}
			}
			modifier = {
				factor = 1.5
				trait = content
			}
			modifier = {
				factor = 3
				opinion = { who = liege value = 25 }
			}
			modifier = {
				factor = 3
				opinion = { who = liege value = 50 }
			}
			modifier = {
				factor = 3
				opinion = { who = liege value = 75 }
			}
		}
		add_trait = loyalist
		hidden_tooltip = {
			liege = { opinion = { who = ROOT modifier = supported_civil_war years = 100 } }
		}
	}
	option = {
		name = EVTOPTC_PlusFaction_420 #stay neutral
		trigger = { war = no }
		ai_chance = {
			factor = 100
			modifier = {
				factor = 2
				trait = craven
			}
			modifier = {
				factor = 0.5
				trait = brave
			}
		}
		add_trait = neutral
		hidden_tooltip = {
			liege = { opinion = { who = ROOT modifier = neutral_civil_war years = 100 } }
		}
	}
	option = {
		name = EVTOPTF_PlusFaction_421 # I have my own wars to fight!
		trigger = {
			war = yes
		}
	}
}

# Factionless vassals pick a side in the civil war
#
# FROM = Initiating faction leader
character_event = {
	id = PlusFaction.421
	desc = EVTDESC_PlusFaction_421
	picture = GFX_evt_battle
	border = GFX_event_normal_frame_war
	
	is_triggered_only = yes

	trigger = {
		is_playable = yes
		num_of_baron_titles = 1
		pf_war_trait_trigger = no
		pf_member_trigger = no
	}
	
	immediate = {
		FROM = { save_event_target_as = pf_attacker }
	}

	option = {
		name = EVTOPTA_PlusFaction_421 #join the rebellion
		trigger = {
			prisoner = no
			NOT = { trait = incapable }
			war = no
		}
		ai_chance = {
			factor = 10
			modifier = {
				factor = 0
				is_adult = no
			}
			modifier = {
				factor = 0
				liege = { current_heir = { character = ROOT } }
			}
			modifier = {
				factor = 0.5
				liege = {
					OR = {
						is_allied_with = ROOT
						dynasty = ROOT
						is_close_relative = ROOT
					}
				}
			}
			modifier = {
				factor = 5
				liege = { is_rival = ROOT }
			}
			modifier = {
				factor = 1.5
				trait = ambitious
			}
			modifier = {
				factor = 1.25
				OR = {
					is_allied_with = FROM
					is_close_relative = FROM
				}
			}
			modifier = {
				factor = 0.8
				NOT = { opinion = { who = FROM value = 0 } }
			}
			modifier = {
				factor = 0.8
				NOT = { opinion = { who = FROM value = -25 } }
			}
			modifier = {
				factor = 0.5
				NOT = { opinion = { who = FROM value = -50 } }
			}
			modifier = {
				factor = 0.5
				NOT = { opinion = { who = FROM value = -75 } }
			}
			modifier = {
				factor = 1.25
				opinion = { who = FROM value = 25 }
			}
			modifier = {
				factor = 1.25
				opinion = { who = FROM value = 50 }
			}
			modifier = {
				factor = 1.25
				opinion = { who = FROM value = 75 }
			}
			modifier = {
				factor = 0
				opinion = { who = liege value = 0 }
			}
			modifier = {
				factor = 3
				NOT = { opinion = { who = liege value = 0 } }
			}
			modifier = {
				factor = 3
				NOT = { opinion = { who = liege value = -25 } }
			}
			modifier = {
				factor = 3
				NOT = { opinion = { who = liege value = -50 } }
			}
			modifier = {
				factor = 3
				NOT = { opinion = { who = liege value = -75 } }
			}
		}
		pf_setup_rebel_effect = yes
		hidden_tooltip = { character_event = { id = PlusFaction.440 } } # Actually join
		tooltip = { join_attacker_wars = event_target:pf_attacker }
	}
	option = {
		name = EVTOPTB_PlusFaction_421 #remain loyal
		trigger = {
			prisoner = no
			NOT = { trait = incapable }
			war = no
		}
		ai_chance = {
			factor = 10
			modifier = {
				factor = 0
				is_adult = no
			}
			modifier = {
				factor = 0
				NOT = { opinion = { who = liege value = -50 } }
			}
			modifier = {
				factor = 0.1
				NOT = { opinion = { who = liege value = 0 } }
			}
			modifier = {
				factor = 10
				liege = { current_heir = { character = ROOT } }
			}
			modifier = {
				factor = 5
				liege = {
					OR = {
						is_allied_with = ROOT
						dynasty = ROOT
						is_close_relative = ROOT
					}
				}
			}
			modifier = {
				factor = 1.5
				trait = content
			}
			modifier = {
				factor = 3
				opinion = { who = liege value = 25 }
			}
			modifier = {
				factor = 3
				opinion = { who = liege value = 50 }
			}
			modifier = {
				factor = 3
				opinion = { who = liege value = 75 }
			}
		}
		add_trait = loyalist
		hidden_tooltip = {
			liege = { opinion = { who = ROOT modifier = supported_civil_war years = 100 } }
		}
	}
	option = {
		name = EVTOPTC_PlusFaction_421 #remain neutral
		trigger = {
			prisoner = no
			NOT = { trait = incapable }
			war = no
		}
		ai_chance = {
			factor = 100
			modifier = {
				factor = 2
				trait = craven
			}
			modifier = {
				factor = 0.5
				trait = brave
			}
		}
		add_trait = neutral
		hidden_tooltip = {
			liege = { opinion = { who = ROOT modifier = neutral_civil_war years = 100 } }
		}
	}
	option = {
		name = EVTOPTD_PlusFaction_421 #I am imprisoned
		trigger = {
			prisoner = yes
		}
	}
	option = {
		name = EVTOPTE_PlusFaction_421 #I am NOT up to such a fight...
		tooltip_info = incapable
		trigger = {
			trait = incapable
		}
	}
	option = {
		name = EVTOPTF_PlusFaction_421 # I have my own wars to fight!
		trigger = {
			prisoner = no
			NOT = { trait = incapable }
			war = yes
		}
	}
}


### CIVIL WAR SUPPORT EVENTS

# PlusFaction.440 [3rd-Party Rebel Attempting to Join War]
#
# Attempt to join a civil war.
# The primary attacker is expected in event_target:pf_attacker, and
# at some point prior, pf_setup_rebel_effect should've been used on ROOT.
character_event = {
	id = PlusFaction.440

	is_triggered_only = yes
	hide_window = yes

	immediate = {

		if = {
			limit = {
				OR = {
					war = yes
					in_revolt = yes
				}
			}
			log = "SERIOUS: ruler tried to join revolt against liege while already involved in a war: aborting!"
			break = yes
		}
		if = {
			limit = {
				event_target:pf_attacker = {
					OR = {
						character = ROOT
						war = no
					}
				}
			}
			log = "SERIOUS: ruler tried to join own revolt or primary attacker is not at war: aborting!"
			break = yes
		}
		if = {
			limit = { is_liege_or_above = event_target:pf_attacker }
			log = "SERIOUS: ruler tried to join revolt but was already under the attacker: aborting!"
			break = yes
		}

		liege = {
			if = {
				limit = { character = PREV } # We are independent
				log = "SERIOUS: ruler tried to join revolt against liege while effectively independent: aborting!"
				break = yes
			}

			hidden_tooltip = {
				liege = {
					if = {
						limit = { character = PREV } # Liege is independent
						ROOT = { set_defacto_liege = ROOT }
					}
					if = {
						limit = { NOT = { character = PREV } } # Liege is a vassal
						set_defacto_vassal = ROOT
					}
				}
			}

			ROOT = {
				join_attacker_wars = event_target:pf_attacker
			}

			if = {
				limit = {
					NOT = {
						any_war = {
							defender = { character = PREVPREV }
							attacker = { character = event_target:pf_attacker }
							any_attacker = { character = ROOT }
						}
					}
				}
				hidden_tooltip = {
					ROOT = {
						set_defacto_liege = PREV
						pf_teardown_rebel_effect = yes

						if = {
							limit = { NOT = { vassal_of = PREV } }
							log = "SERIOUS: ruler tried to join revolt, failed, and then failed to be revassalized: [Root.GetTitledFirstName] of the [Root.PrimaryTitle.GetFullBaseName] ([Root.GetID])"
						}

						log = "DEBUG: ruler failed to join revolt"
						break = yes
					}
				}
			}
		}
	}

	log = "DEBUG: ruler successfully joined revolt [PF state dump follows]"
	pf_log_civil_war_state_effect = yes
}


# PlusFaction.445 [New Holder]
#
# Civil war state passes to a new liege <on_action>
character_event = {
	id = PlusFaction.445

	is_triggered_only = yes
	hide_window = yes

	only_playable = yes

	trigger = {
		FROM = { higher_tier_than = count }
		FROMFROM = { # Previous holder
			pf_war_trigger = yes # Has at least one civil war flag (and is alive)
		}
		any_war = { # We've inherited at least one of FROMFROM's civil wars
			defender = { character = ROOT }
			attacker = {
				has_opinion_modifier = { who = FROMFROM modifier = revolting_against }
			}
		}
	}

	immediate = {

		# Note the liege change for our PF civil wars
		any_war = {
			limit = {
				defender = { character = ROOT }
				attacker = { has_opinion_modifier = { who = FROMFROM modifier = revolting_against } }
			}
			attacker = { clr_character_flag = original_war_liege }
		}

		# Note that demands flags need no manual transfer. However, it's perhaps possible
		# for faction_succession_war that ROOT simply does/will not have the demesne title
		# to which the succession demand refers. If that can happen, it'd probably be a
		# good idea to embed that logic in the CB `is_valid`, as it can't be sanely
		# handled here (assuming on_invalidation will work properly for tearing down
		# the _right_ revolters, otherwise something more manual should be done).

		FROMFROM = {
			log = "DEBUG: civil war leader changed due to title usurpation. old war-liege's PF state dump prior to state transfer:"
			pf_log_civil_war_state_effect = yes

			any_opinion_modifier_target = { # Those that are revolting against FROMFROM
				limit = { reverse_has_opinion_modifier = { who = PREV modifier = revolting_against_me } }
				
				if = {
					limit = { NOT = { has_opinion_modifier = { who = ROOT modifier = revolting_against } } }
					opinion = { who = ROOT modifier = revolting_against }
				}
				if = {
					limit = { NOT = { reverse_has_opinion_modifier = { who = ROOT modifier = revolting_against_me } } }
					reverse_opinion = { who = ROOT modifier = revolting_against_me }
				}

				remove_opinion = { who = PREV modifier = revolting_against }
				reverse_remove_opinion = { who = PREV modifier = revolting_against_me }
			}
			any_opinion_modifier_target = { # Those that are loyal to FROMFROM
				limit = { reverse_has_opinion_modifier = { who = PREV modifier = supported_civil_war } }
				if = {
					limit = { NOT = { reverse_has_opinion_modifier = { who = ROOT modifier = supported_civil_war } } }
					reverse_opinion = { who = ROOT modifier = supported_civil_war }
				}
				reverse_remove_opinion = { who = PREV modifier = supported_civil_war }
			}
			any_opinion_modifier_target = { # Those that are neutral in FROMFROM's civil war
				limit = { reverse_has_opinion_modifier = { who = PREV modifier = neutral_civil_war } }
				if = {
					limit = { NOT = { reverse_has_opinion_modifier = { who = ROOT modifier = neutral_civil_war } } }
					reverse_opinion = { who = ROOT modifier = neutral_civil_war }
				}
				reverse_remove_opinion = { who = PREV modifier = neutral_civil_war }
			}

			# War flag transfer [ NOTE: Rylock, you may want to consider how generalized
			# this state transfer is; it may not be what you want for all types of
			# PF-style civil wars. ]
			if = {
				limit = { has_character_flag = faction_court_war }
				ROOT = { set_character_flag = faction_court_war }
			}
			if = {
				limit = { has_character_flag = faction_prosperity_war }
				ROOT = { set_character_flag = faction_prosperity_war }
			}
			if = {
				limit = { has_character_flag = faction_glory_war }
				ROOT = { set_character_flag = faction_glory_war }
			}
			if = {
				limit = { has_character_flag = faction_tradition_war }
				ROOT = { set_character_flag = faction_tradition_war }
			}
			if = {
				limit = { has_character_flag = faction_pretender_war }
				ROOT = { set_character_flag = faction_pretender_war }
			}
			if = {
				limit = { has_character_flag = faction_separatist_war }
				ROOT = { set_character_flag = faction_separatist_war }
			}
			if = {
				limit = { has_character_flag = faction_religious_war }
				ROOT = { set_character_flag = faction_religious_war }
			}
			if = {
				limit = { has_character_flag = faction_succession_war }
				ROOT = { set_character_flag = faction_succession_war }
			}
			if = {
				limit = { has_character_flag = faction_authority_war }
				ROOT = { set_character_flag = faction_authority_war }
			}

			log = "DEBUG: PF state dump of old war-liege post-state-transfer follows:"
			pf_log_civil_war_state_effect = yes
		}

		log = "DEBUG: PF state dump of new war-liege post-state-transfer follows:"
		pf_log_civil_war_state_effect = yes
	}
}


# PlusFaction.446 [New Holder]
#
# Civil war state cleanup when revolter drops-out of war <on_action>
character_event = {
	id = PlusFaction.446

	is_triggered_only = yes
	hide_window = yes

	only_playable = yes

	trigger = {
		FROMFROM = {
			trait = rebel
			in_revolt = no
			any_opinion_modifier_target = { # War liege
				reverse_has_opinion_modifier = { who = PREV modifier = revolting_against }
				any_war = {
					defender = { character = PREVPREV } # War liege is defender
					attacker = {
						# It's a PF-style civil war, for sure
						has_opinion_modifier = { who = PREVPREV modifier = revolting_against }
					}
					NOR = {
						 # Old title holder is no longer in the war, yet they have TOMs for it
						any_attacker = { character = PREVPREVPREV } # Neither as a main participant
						attacker = { # Nor as a faction member
							is_liege_of = PREVPREVPREV
						}
					}
				}
			}
		}
	}

	immediate = {
		FROMFROM = {
			log = "DEBUG: revolter dropped-out of civil war. ex-revolter's PF state dump prior to cleanup:"
			pf_log_civil_war_state_effect = yes

			random_opinion_modifier_target = { # War liege
				limit = { reverse_has_opinion_modifier = { who = PREV modifier = revolting_against } }

				if = {
					limit = {
						# We were not involved in this revolt beforehand...
						NOT = { has_opinion_modifier = { who = ROOT modifier = revolting_against_me } }
						
						# And we are now.
						any_war = {
							defender = { character = PREVPREV }
							attacker = { has_opinion_modifier = { who = PREVPREV modifier = revolting_against } }
							OR = {
								any_attacker = { character = ROOT }
								attacker = {
									ROOT = {
										vassal_of = PREV
										in_revolt = yes
									}
								}
							}
						}
					}
					# Pull-out of the war and revassalize to the war liege.
					set_defacto_vassal = ROOT
				}

				reverse_remove_opinion = { who = PREV modifier = revolting_against }
				remove_opinion = { who = PREV modifier = revolting_against_me }
			}

			remove_trait = rebel

			log = "DEBUG: ex-revolter's PF state dump after cleanup:"
			pf_log_civil_war_state_effect = yes
		}
	}
}

	
### THE CIVIL WAR ENDS

# The victorious side rewards their supporters & punishes opponents
character_event = {
	id = PlusFaction.450
	desc = EVTDESC_PlusFaction_450A
	picture = GFX_evt_council
	border = GFX_event_normal_frame_war
	
	is_triggered_only = yes
	hide_from = yes
	
	trigger = {
		has_any_opinion_modifier = opinion_civil_war_supporter
	}

	immediate = {
		# Release all supporters who are prisoners
		any_opinion_modifier_target = {
			limit = {
				reverse_has_opinion_modifier = { who = ROOT modifier = opinion_civil_war_supporter }
				prisoner = yes
				host = {
					OR = {
						character = ROOT
						is_liege_or_above = ROOT
					}
				}
			}
			prisoner = no
		}
	}

	option = {
		name = EVTOPTA_PlusFaction_450 #They will be granted tax privileges			
		ai_chance = {
			factor = 100
			modifier = {
				factor = 0.5
				trait = greedy
			}
			modifier = {
				factor = 2.0
				trait = charitable
			}
		}
		
		# Tax penalty applied to the ruler's provinces
		any_demesne_title = {
			limit = { tier = COUNT }
			hidden_tooltip = {
				location = {
					remove_province_modifier = tax_privileges
					remove_province_modifier = tax_reduction
				}
			}
			location = {
				add_province_modifier = {
					name = tax_reduction
					duration = 3650
				}
			}
		}

		# Tax penalty applied to any vassals who opposed ruler or who chose to be neutral
		hidden_tooltip = {
			any_vassal = {
				limit = {
					num_of_count_titles = 1
					OR = {
						reverse_has_opinion_modifier = { who = ROOT modifier = opinion_civil_war_loser }
						reverse_has_opinion_modifier = { who = ROOT modifier = opinion_civil_war_neutral }
					}
				}
				character_event = { id = PlusFaction.451 } #notify
			}
		}
		
		# Tax reward applied to any vassals who supported ruler
		any_vassal = {
			limit = {
				num_of_count_titles = 1
				reverse_has_opinion_modifier = { who = ROOT modifier = opinion_civil_war_supporter }
			}
			custom_tooltip = {
				text = CUSTOMTOOLTIP39
				hidden_tooltip = {
					if = {
						limit = { NOT = { has_opinion_modifier = { who = ROOT modifier = opinion_very_grateful } } }
						opinion = { who = ROOT modifier = opinion_pleased months = 120 }
					}
					character_event = { id = PlusFaction.452 } #notify
				}
			}
		}
	}
	option = {
		name = EVTOPTB_PlusFaction_450 #Glory and Honor
		ai_chance = {
			factor = 100
			modifier = {
				factor = 0.5
				trait = content
			}
			modifier = {
				factor = 2.0
				trait = ambitious
			}
			modifier = {
				factor = 0.5
				trait = proud
			}
			modifier = {
				factor = 2.0
				trait = humble
			}
			modifier = {
				factor = 0
				OR = {
					AND = {
						tier = duke
						NOT = { prestige = 500 }
					}
					AND = {
						tier = king
						NOT = { prestige = 750 }
					}
					AND = {
						tier = emperor
						NOT = { prestige = 1000 }
					}
				}
			}
		}
		# Ruler takes a prestige penalty
		if = {
			limit = { lower_real_tier_than = DUKE }
			prestige = -250
		}
		if = {
			limit = { real_tier = DUKE }
			prestige = -500
		}
		if = {
			limit = { real_tier = KING }
			prestige = -750
		}
		if = {
			limit = { real_tier = EMPEROR }
			prestige = -1000
		}
		
		# All opponents receive a prestige penalty
		hidden_tooltip = {
			any_vassal = {
				limit = {
					OR = {
						reverse_has_opinion_modifier = { who = ROOT modifier = opinion_civil_war_loser }
						reverse_has_opinion_modifier = { who = ROOT modifier = opinion_civil_war_neutral }
					}
				}
				character_event = { id = PlusFaction.453 } #notify
			}
		}
		
		# All supporters receive a prestige bonus
		any_vassal = {
			limit = {
				reverse_has_opinion_modifier = { who = ROOT modifier = opinion_civil_war_supporter }
			}
			custom_tooltip = {
				text = CUSTOMTOOLTIP40
				hidden_tooltip = {
					if = {
						limit = { NOT = { has_opinion_modifier = { who = ROOT modifier = opinion_very_grateful } } }
						opinion = { who = ROOT modifier = opinion_pleased months = 120 }
					}
					character_event = { id = PlusFaction.454 } #notify
				}
			}
		}
	}
	option = {
		name = EVTOPTC_PlusFaction_450 #Nothing
		ai_chance = {
			factor = 10
			modifier = {
				factor = 0.1
				OR = {
					trait = humble
					trait = content
					trait = charitable
					trait = just
				}
			}
			modifier = {
				factor = 1.5
				trait = arbitrary
			}
			modifier = {
				factor = 1.5
				trait = wroth
			}
			modifier = {
				factor = 2.0
				trait = cruel
			}
			modifier = {
				factor = 5.0
				trait = lunatic
			}
			modifier = {
				factor = 5.0
				trait = possessed
			}
		}
		custom_tooltip = {
			text = CUSTOMTOOLTIP27
			hidden_tooltip = {
				any_vassal = {
					limit = {
						reverse_has_opinion_modifier = { who = ROOT modifier = opinion_civil_war_supporter }
					}
					if = {
						limit = { NOT = { has_opinion_modifier = { who = ROOT modifier = opinion_very_grateful } } }
						remove_opinion = { who = ROOT modifier = opinion_very_grateful }
					}
					character_event = { id = PlusFaction.455 } #notify
				}
			}
		}
	}
}

# Notify vassal of tax reduction penalty
character_event = {
	id = PlusFaction.451
	picture = GFX_evt_council
	border = GFX_event_normal_frame_war
	
	desc = {
		text = EVTDESC_PlusFaction_451A
		trigger = { reverse_has_opinion_modifier = { who = FROM modifier = opinion_civil_war_loser } }
	}
	desc = {
		text = EVTDESC_PlusFaction_451B
		trigger = { NOT = { reverse_has_opinion_modifier = { who = FROM modifier = opinion_civil_war_loser } } }
	}
	
	is_triggered_only = yes

	trigger = {
		independent = no
	}

	immediate = {
		any_demesne_title = {
			limit = { tier = COUNT }
			location = {
				remove_province_modifier = tax_privileges
				remove_province_modifier = tax_reduction
			}
		}
	}

	option = {
		name = CURSES
		if = {
			limit = { reverse_has_opinion_modifier = { who = FROM modifier = opinion_civil_war_loser } }
			any_demesne_title = {
				limit = { tier = COUNT }
				location = {
					add_province_modifier = {
						name = "tax_reduction"
						duration = 3650
					}
				}
			}
		}
		if = {
			limit = { NOT = { reverse_has_opinion_modifier = { who = FROM modifier = opinion_civil_war_loser } } }
			any_demesne_title = {
				limit = { tier = COUNT }
				location = {
					add_province_modifier = {
						name = "tax_reduction"
						duration = 1825
					}
				}
			}
		}
	}
}

# Notify loyal vassal of tax privilege reward
character_event = {
	id = PlusFaction.452
	desc = EVTDESC_PlusFaction_452
	picture = GFX_evt_council
	border = GFX_event_normal_frame_war
	
	is_triggered_only = yes

	trigger = {
		independent = no
	}

	immediate = {
		any_demesne_title = {
			limit = { tier = COUNT }
			location = {
				remove_province_modifier = tax_privileges
				remove_province_modifier = tax_reduction
			}
		}
	}

	option = {
		name = EXCELLENT
		any_demesne_title = {
			limit = { tier = COUNT }
			location = {
				add_province_modifier = {
					name = tax_privileges
					duration = 3650
				}
			}
		}
	}
}

# Notify vassal of prestige penalty
character_event = {
	id = PlusFaction.453
	picture = GFX_evt_council
	border = GFX_event_normal_frame_war
	
	desc = {
		text = EVTDESC_PlusFaction_453A
		trigger = { reverse_has_opinion_modifier = { who = FROM modifier = opinion_civil_war_loser } }
	}
	desc = {
		text = EVTDESC_PlusFaction_453B
		trigger = { NOT = { reverse_has_opinion_modifier = { who = FROM modifier = opinion_civil_war_loser } } }
	}
	
	is_triggered_only = yes

	trigger = {
		independent = no
	}

	option = {
		name = CURSES
		if = {
			limit = { reverse_has_opinion_modifier = { who = FROM modifier = opinion_civil_war_loser } }
			if = {
				limit = { real_tier = BARON }
				prestige = -100
			}
			if = {
				limit = { real_tier = COUNT }
				prestige = -250
			}
			if = {
				limit = { real_tier = DUKE }
				prestige = -500
			}
			if = {
				limit = { real_tier = KING }
				prestige = -750
			}
		}
		if = {
			limit = { NOT = { reverse_has_opinion_modifier = { who = FROM modifier = opinion_civil_war_loser } } }
			if = {
				limit = { real_tier = BARON }
				prestige = -50
			}
			if = {
				limit = { real_tier = COUNT }
				prestige = -100
			}
			if = {
				limit = { real_tier = DUKE }
				prestige = -250
			}
			if = {
				limit = { real_tier = KING }
				prestige = -400
			}
		}
	}
}

# Notify loyal vassal of prestige reward
character_event = {
	id = PlusFaction.454
	desc = EVTDESC_PlusFaction_454
	picture = GFX_evt_council
	border = GFX_event_normal_frame_war
	
	is_triggered_only = yes

	trigger = {
		independent = no
	}

	option = {
		name = EXCELLENT
		if = {
			limit = { real_tier = BARON }
			prestige = 100
		}
		if = {
			limit = { real_tier = COUNT }
			prestige = 250
		}
		if = {
			limit = { real_tier = DUKE }
			prestige = 500
		}
		if = {
			limit = { real_tier = KING }
			prestige = 750
		}
	}
}

# Notify loyal vassal that there will be no reward
character_event = {
	id = PlusFaction.455
	desc = EVTDESC_PlusFaction_455
	picture = GFX_evt_council
	border = GFX_event_normal_frame_war
	
	is_triggered_only = yes

	trigger = {
		independent = no
	}

	option = {
		name = EVTOPTA_PlusFaction_455 #Treachery!
		opinion = {
			who = FROM
			modifier = opinion_upset
			months = 120
			multiplier = 2
		}
	}
}

### WAR MAINTENANCE EVENTS

# Glory faction happy that war was won
character_event = {
	id = PlusFaction.460
	
	hide_window = yes
	is_triggered_only = yes
	
	immediate = {
		random_vassal = {
			limit = { leads_faction = faction_glory }
			set_variable = { which = "faction_mood_increase" value = 2 }
			ROOT = { character_event = { id = PlusFaction.200 days = 1 } } # recalculate faction moods
		}
	}
}

# Glory faction unhappy that war was lost
character_event = {
	id = PlusFaction.461
	
	hide_window = yes
	is_triggered_only = yes
	
	immediate = {
		random_vassal = {
			limit = { leads_faction = faction_glory }
			set_variable = { which = "faction_mood_decrease" value = 2 }
			ROOT = { character_event = { id = PlusFaction.200 days = 1 } } # recalculate faction moods
		}
	}
}

### SUCCESSION FACTIONS

# Ultimatum made to liege
letter_event = {
	id = PlusFaction.470
	
	desc = {
		text = EVTDESC_PlusFaction_470_seniority
		trigger = { FROM = { has_character_flag = demands_seniority } }
	}
	desc = {
		text = EVTDESC_PlusFaction_470_primogeniture
		trigger = { FROM = { has_character_flag = demands_primogeniture } }
	}
	desc = {
		text = EVTDESC_PlusFaction_470_gavelkind
		trigger = { FROM = { has_character_flag = demands_gavelkind } }
	}
	desc = {
		text = EVTDESC_PlusFaction_470_feudal_elective
		trigger = { FROM = { has_character_flag = demands_feudal_elective } }
	}
	
	is_triggered_only = yes
	
	immediate = {
		FROM = {
			if = {
				limit = { has_character_flag = demands_seniority }
				faction_succ_seniority = { save_event_target_as = succession_title }
			}
			if = {
				limit = { has_character_flag = demands_primogeniture }
				faction_succ_primogeniture = { save_event_target_as = succession_title }
			}
			if = {
				limit = { has_character_flag = demands_gavelkind }
				faction_succ_gavelkind = { save_event_target_as = succession_title }
			}
			if = {
				limit = { has_character_flag = demands_feudal_elective }
				faction_succ_feudal_elective = { save_event_target_as = succession_title }
			}
		}
	}
	
	option = {
		name = EVTOPTA8000 #Accept
		ai_chance = {
			factor = 20
			modifier = {
				factor = 0
				FROM = { has_character_flag = demands_seniority }
				NOT = { FROM = { faction_power = { faction = faction_succ_seniority power = 0.5 } } }
			}
			modifier = {
				factor = 0
				FROM = { has_character_flag = demands_primogeniture }
				NOT = { FROM = { faction_power = { faction = faction_succ_primogeniture power = 0.5 } } }
			}
			modifier = {
				factor = 0
				FROM = { has_character_flag = demands_gavelkind }
				NOT = { FROM = { faction_power = { faction = faction_succ_gavelkind power = 0.5 } } }
			}
			modifier = {
				factor = 0
				FROM = { has_character_flag = demands_feudal_elective }
				NOT = { FROM = { faction_power = { faction = faction_succ_feudal_elective power = 0.5 } } }
			}
			modifier = {
				factor = 1.25
				trait = weak
			}
			modifier = {
				factor = 1.25
				trait = craven
			}
			modifier = {
				factor = 1.25
				trait = humble
			}
			modifier = {
				factor = 1.25
				trait = kind
			}
			modifier = {
				factor = 1.25
				trait = charitable
			}
			modifier = {
				factor = 1.25
				trait = patient
			}
			modifier = {
				factor = 1.25
				trait = content
			}
		}
		hidden_tooltip = {
			FROM = {
				if = {
					limit = { has_character_flag = demands_seniority }
					ROOT = {
						any_vassal = {
							limit = {
								ai = no
								NOT = { in_faction = faction_succ_seniority }
							}
							character_event = { id = PlusFaction.473 }
						}
					}
					letter_event = { id = PlusFaction.471 }
					any_faction_backer = {
						faction = faction_succ_seniority
						letter_event = { id = PlusFaction.472 }
					}
				}
				if = {
					limit = { has_character_flag = demands_primogeniture }
					ROOT = {
						any_vassal = {
							limit = {
								ai = no
								NOT = { in_faction = faction_succ_primogeniture }
							}
							character_event = { id = PlusFaction.473 }
						}
					}
					letter_event = { id = PlusFaction.471 }
					any_faction_backer = {
						faction = faction_succ_primogeniture
						letter_event = { id = PlusFaction.472 }
					}
				}
				if = {
					limit = { has_character_flag = demands_gavelkind }
					ROOT = {
						any_vassal = {
							limit = {
								ai = no
								NOT = { in_faction = faction_succ_gavelkind }
							}
							character_event = { id = PlusFaction.473 }
						}
					}
					letter_event = { id = PlusFaction.471 }
					any_faction_backer = {
						faction = faction_succ_gavelkind
						letter_event = { id = PlusFaction.472 }
					}
				}
				if = {
					limit = { has_character_flag = demands_feudal_elective }
					ROOT = {
						any_vassal = {
							limit = {
								ai = no
								NOT = { in_faction = faction_succ_feudal_elective }
							}
							character_event = { id = PlusFaction.473 }
						}
					}
					letter_event = { id = PlusFaction.471 }
					any_faction_backer = {
						faction = faction_succ_feudal_elective
						letter_event = { id = PlusFaction.472 }
					}
				}
			}
		}
		FROM = {
			if = {
				limit = { has_character_flag = demands_seniority }
				clr_character_flag = demands_seniority
				faction_succ_seniority = { # The target (title) of the faction
					succession = seniority
				}
			}
			if = {
				limit = { has_character_flag = demands_primogeniture }
				clr_character_flag = demands_primogeniture
				faction_succ_primogeniture = { # The target (title) of the faction
					succession = primogeniture
				}
			}
			if = {
				limit = { has_character_flag = demands_gavelkind }
				clr_character_flag = demands_gavelkind
				faction_succ_gavelkind = { # The target (title) of the faction
					succession = gavelkind
				}
			}
			if = {
				limit = { has_character_flag = demands_feudal_elective }
				clr_character_flag = demands_feudal_elective
				faction_succ_feudal_elective = { # The target (title) of the faction
					succession = feudal_elective
				}
			}
		}
	}
	option = {
		name = EVTOPTB8005 #Refuse
		ai_chance = {
			factor = 80
			modifier = {
				factor = 1.25
				trait = strong
			}
			modifier = {
				factor = 1.25
				trait = brave
			}
			modifier = {
				factor = 1.25
				trait = proud
			}
			modifier = {
				factor = 1.25
				trait = envious
			}
			modifier = {
				factor = 1.25
				trait = greedy
			}
			modifier = {
				factor = 1.25
				trait = wroth
			}
			modifier = {
				factor = 1.25
				trait = ambitious
			}
			modifier = {
				factor = 0.75
				FROM = { has_character_flag = demands_seniority }
				FROM = { faction_power = { faction = faction_succ_seniority power = 1.0 } }
			}
			modifier = {
				factor = 0.5
				FROM = { has_character_flag = demands_seniority }
				FROM = { faction_power = { faction = faction_succ_seniority power = 1.5 } }
			}
			modifier = {
				factor = 0.5
				FROM = { has_character_flag = demands_seniority }
				FROM = { faction_power = { faction = faction_succ_seniority power = 2.0 } }
			}
			modifier = {
				factor = 0.5
				FROM = { has_character_flag = demands_seniority }
				FROM = { faction_power = { faction = faction_succ_seniority power = 3.0 } }
			}	
			modifier = {
				factor = 0.5
				FROM = { has_character_flag = demands_seniority }
				FROM = { faction_power = { faction = faction_succ_seniority power = 4.0 } }
			}
			modifier = {
				factor = 0.75
				FROM = { has_character_flag = demands_primogeniture }
				FROM = { faction_power = { faction = faction_succ_primogeniture power = 1.0 } }
			}
			modifier = {
				factor = 0.5
				FROM = { has_character_flag = demands_primogeniture }
				FROM = { faction_power = { faction = faction_succ_primogeniture power = 1.5 } }
			}
			modifier = {
				factor = 0.5
				FROM = { has_character_flag = demands_primogeniture }
				FROM = { faction_power = { faction = faction_succ_primogeniture power = 2.0 } }
			}
			modifier = {
				factor = 0.5
				FROM = { has_character_flag = demands_primogeniture }
				FROM = { faction_power = { faction = faction_succ_primogeniture power = 3.0 } }
			}	
			modifier = {
				factor = 0.5
				FROM = { has_character_flag = demands_primogeniture }
				FROM = { faction_power = { faction = faction_succ_primogeniture power = 4.0 } }
			}
			modifier = {
				factor = 0.75
				FROM = { has_character_flag = demands_gavelkind }
				FROM = { faction_power = { faction = faction_succ_gavelkind power = 1.0 } }
			}
			modifier = {
				factor = 0.5
				FROM = { has_character_flag = demands_gavelkind }
				FROM = { faction_power = { faction = faction_succ_gavelkind power = 1.5 } }
			}
			modifier = {
				factor = 0.5
				FROM = { has_character_flag = demands_gavelkind }
				FROM = { faction_power = { faction = faction_succ_gavelkind power = 2.0 } }
			}
			modifier = {
				factor = 0.5
				FROM = { has_character_flag = demands_gavelkind }
				FROM = { faction_power = { faction = faction_succ_gavelkind power = 3.0 } }
			}	
			modifier = {
				factor = 0.5
				FROM = { has_character_flag = demands_gavelkind }
				FROM = { faction_power = { faction = faction_succ_gavelkind power = 4.0 } }
			}
			modifier = {
				factor = 0.75
				FROM = { has_character_flag = demands_feudal_elective }
				FROM = { faction_power = { faction = faction_succ_feudal_elective power = 1.0 } }
			}
			modifier = {
				factor = 0.5
				FROM = { has_character_flag = demands_feudal_elective }
				FROM = { faction_power = { faction = faction_succ_feudal_elective power = 1.5 } }
			}
			modifier = {
				factor = 0.5
				FROM = { has_character_flag = demands_feudal_elective }
				FROM = { faction_power = { faction = faction_succ_feudal_elective power = 2.0 } }
			}
			modifier = {
				factor = 0.5
				FROM = { has_character_flag = demands_feudal_elective }
				FROM = { faction_power = { faction = faction_succ_feudal_elective power = 3.0 } }
			}	
			modifier = {
				factor = 0.5
				FROM = { has_character_flag = demands_feudal_elective }
				FROM = { faction_power = { faction = faction_succ_feudal_elective power = 4.0 } }
			}
		}
		FROM = {
			letter_event = { id = PlusFaction.474 days = 3 tooltip = EVTTOOLTIP8100 }
			if = {
				limit = { has_character_flag = demands_seniority }
				tooltip = { any_faction_backer = { faction = faction_succ_seniority } }
			}
			if = {
				limit = { has_character_flag = demands_primogeniture }
				tooltip = { any_faction_backer = { faction = faction_succ_primogeniture } }
			}
			if = {
				limit = { has_character_flag = demands_gavelkind }
				tooltip = { any_faction_backer = { faction = faction_succ_gavelkind } }
			}
			if = {
				limit = { has_character_flag = demands_feudal_elective }
				tooltip = { any_faction_backer = { faction = faction_succ_feudal_elective } }
			}
		}
	}
}

# Demand accepted - Inform faction leader
letter_event = {
	id = PlusFaction.471
	desc = EVTDESC_PlusFaction_471
	
	is_triggered_only = yes
	
	option = {
		name = EXCELLENT
		clr_character_flag = faction_succ_seniority_ultimatum_taken
		clr_character_flag = faction_succ_primogeniture_ultimatum_taken
		clr_character_flag = faction_succ_gavelkind_ultimatum_taken
		clr_character_flag = faction_succ_feudal_elective_ultimatum_taken
	}
}

# Demand accepted - Inform faction backer
letter_event = {
	id = PlusFaction.472
	desc = EVTDESC_PlusFaction_472
	
	show_from_from = yes
	
	is_triggered_only = yes
	
	option = {
		name = GOOD
		reverse_opinion = {
			modifier = opinion_grateful
			who = FROMFROM
			years = 10
		}
	}
}

# Demand accepted - Inform other vassals
character_event = {
	id = PlusFaction.473
	desc = EVTDESC_PlusFaction_473
	picture = GFX_evt_council
	border = GFX_event_normal_frame_intrigue
	
	show_from_from = yes
	
	is_triggered_only = yes
	
	option = {
		name = I_SEE
	}
}

# Demand rejected
letter_event = {
	id = PlusFaction.474
	desc = EVTDESC_PlusFaction_474
	
	is_triggered_only = yes
	
	option = {
		name = EVTOPTA8100 #Then war it is!
		clr_character_flag = faction_succ_seniority_ultimatum_taken
		clr_character_flag = faction_succ_primogeniture_ultimatum_taken
		clr_character_flag = faction_succ_gavelkind_ultimatum_taken
		clr_character_flag = faction_succ_feudal_elective_ultimatum_taken
		if = {
			limit = { has_character_flag = demands_seniority }
			faction_succ_seniority = { set_title_flag = change_seniority }
			liege = {
				hidden_tooltip = {
					set_character_flag = faction_succession_war
					ROOT = {
						set_character_flag = original_war_liege
						pf_setup_rebel_effect = yes
						any_faction_backer = {
							faction = faction_succ_seniority
							pf_setup_rebel_effect = yes
						}
					}
					any_vassal = {
						limit = { pf_war_trait_trigger = no }
						character_event = { id = PlusFaction.475 days = 1 } #invite other vassals to join
					}
				}
				reverse_war = {
					target = ROOT
					casus_belli = cb_faction_overthrow_ruler
					faction = faction_succ_seniority
				}
			}
		}
		if = {
			limit = { has_character_flag = demands_primogeniture }
			faction_succ_primogeniture = { set_title_flag = change_primogeniture }
			liege = {
				hidden_tooltip = {
					set_character_flag = faction_succession_war
					ROOT = {
						set_character_flag = original_war_liege
						pf_setup_rebel_effect = yes
						any_faction_backer = {
							faction = faction_succ_primogeniture
							pf_setup_rebel_effect = yes
						}
					}
					any_vassal = {
						limit = { pf_war_trait_trigger = no }
						character_event = { id = PlusFaction.475 days = 1 } #invite other vassals to join
					}
				}
				reverse_war = {
					target = ROOT
					casus_belli = cb_faction_overthrow_ruler
					faction = faction_succ_primogeniture
				}
			}
		}
		if = {
			limit = { has_character_flag = demands_gavelkind }
			faction_succ_gavelkind = { set_title_flag = change_gavelkind }
			liege = {
				hidden_tooltip = {
					set_character_flag = faction_succession_war
					ROOT = {
						set_character_flag = original_war_liege
						pf_setup_rebel_effect = yes
						any_faction_backer = {
							faction = faction_succ_gavelkind
							pf_setup_rebel_effect = yes
						}
					}
					any_vassal = {
						limit = { pf_war_trait_trigger = no }
						character_event = { id = PlusFaction.475 days = 1 } #invite other vassals to join
					}
				}
				reverse_war = {
					target = ROOT
					casus_belli = cb_faction_overthrow_ruler
					faction = faction_succ_gavelkind
				}
			}
		}
		if = {
			limit = { has_character_flag = demands_feudal_elective }
			faction_succ_feudal_elective = { set_title_flag = change_feudal_elective }
			liege = {
				hidden_tooltip = {
					set_character_flag = faction_succession_war
					ROOT = {
						set_character_flag = original_war_liege
						pf_setup_rebel_effect = yes
						any_faction_backer = {
							faction = faction_succ_feudal_elective
							pf_setup_rebel_effect = yes
						}
					}
					any_vassal = {
						limit = { pf_war_trait_trigger = no }
						character_event = { id = PlusFaction.475 days = 1 } #invite other vassals to join
					}
				}
				reverse_war = {
					target = ROOT
					casus_belli = cb_faction_overthrow_ruler
					faction = faction_succ_feudal_elective
				}
			}
		}
	}
}

# Vassal chooses sides at the outbreak of a succession war
character_event = {
	id = PlusFaction.475
	picture = GFX_evt_battle
	border = GFX_event_normal_frame_war
	
	desc = {
		text = EVTDESC_PlusFaction_475_seniority
		trigger = { FROM = { has_character_flag = demands_seniority } }
	}
	desc = {
		text = EVTDESC_PlusFaction_475_primogeniture
		trigger = { FROM = { has_character_flag = demands_primogeniture } }
	}
	desc = {
		text = EVTDESC_PlusFaction_475_gavelkind
		trigger = { FROM = { has_character_flag = demands_gavelkind } }
	}
	desc = {
		text = EVTDESC_PlusFaction_475_feudal_elective
		trigger = { FROM = { has_character_flag = demands_feudal_elective } }
	}

	is_triggered_only = yes

	trigger = {
		is_playable = yes
		num_of_baron_titles = 1
		pf_war_trait_trigger = no
	}
	
	immediate = {
		FROM = { save_event_target_as = pf_attacker }
	}

	option = {
		name = EVTOPTA_PlusFaction_421 #join the rebellion
		trigger = {
			prisoner = no
			NOT = { trait = incapable }
			war = no
		}
		ai_chance = {
			factor = 10
			modifier = {
				factor = 0
				is_adult = no
			}
			modifier = {
				factor = 0
				liege = { current_heir = { character = ROOT } }
			}
			modifier = {
				factor = 0.5
				liege = {
					OR = {
						is_allied_with = ROOT
						dynasty = ROOT
						is_close_relative = ROOT
					}
				}
			}
			modifier = {
				factor = 5
				liege = { is_rival = ROOT }
			}
			modifier = {
				factor = 5
				trait = zealous
			}
			modifier = {
				factor = 1.5
				trait = ambitious
			}
			modifier = {
				factor = 0.5
				trait = cynical
			}
			modifier = {
				factor = 1.25
				OR = {
					is_allied_with = FROM
					is_close_relative = FROM
				}
			}
			modifier = {
				factor = 0.8
				NOT = { opinion = { who = FROM value = 0 } }
			}
			modifier = {
				factor = 0.8
				NOT = { opinion = { who = FROM value = -25 } }
			}
			modifier = {
				factor = 0.5
				NOT = { opinion = { who = FROM value = -50 } }
			}
			modifier = {
				factor = 0.5
				NOT = { opinion = { who = FROM value = -75 } }
			}
			modifier = {
				factor = 1.25
				opinion = { who = FROM value = 25 }
			}
			modifier = {
				factor = 1.25
				opinion = { who = FROM value = 50 }
			}
			modifier = {
				factor = 1.25
				opinion = { who = FROM value = 75 }
			}
			modifier = {
				factor = 0
				opinion = { who = liege value = 0 }
			}
			modifier = {
				factor = 3
				NOT = { opinion = { who = liege value = 0 } }
			}
			modifier = {
				factor = 3
				NOT = { opinion = { who = liege value = -25 } }
			}
			modifier = {
				factor = 3
				NOT = { opinion = { who = liege value = -50 } }
			}
			modifier = {
				factor = 3
				NOT = { opinion = { who = liege value = -75 } }
			}
		}

		pf_setup_rebel_effect = yes
		hidden_tooltip = { character_event = { id = PlusFaction.440 } } # Actually join
		tooltip = { join_attacker_wars = event_target:pf_attacker }
	}
	option = {
		name = EVTOPTB_PlusFaction_421 #remain loyal
		trigger = {
			prisoner = no
			NOT = { trait = incapable }
			war = no
		}
		ai_chance = {
			factor = 10
			modifier = {
				factor = 0
				is_adult = no
			}
			modifier = {
				factor = 0
				liege = { NOT = { religion = ROOT } }
			}
			modifier = {
				factor = 0
				NOT = { opinion = { who = liege value = -50 } }
			}
			modifier = {
				factor = 0.1
				NOT = { opinion = { who = liege value = 0 } }
			}
			modifier = {
				factor = 10
				liege = { current_heir = { character = ROOT } }
			}
			modifier = {
				factor = 5
				liege = {
					OR = {
						is_allied_with = ROOT
						dynasty = ROOT
						is_close_relative = ROOT
					}
				}
			}
			modifier = {
				factor = 1.5
				trait = content
			}
			modifier = {
				factor = 3
				opinion = { who = liege value = 25 }
			}
			modifier = {
				factor = 3
				opinion = { who = liege value = 50 }
			}
			modifier = {
				factor = 3
				opinion = { who = liege value = 75 }
			}
		}
		add_trait = loyalist
		hidden_tooltip = {
			liege = { opinion = { who = ROOT modifier = supported_civil_war years = 100 } }
		}
	}
	option = {
		name = EVTOPTC_PlusFaction_421 #remain neutral
		trigger = {
			prisoner = no
			NOT = { trait = incapable }
			war = no
		}
		ai_chance = {
			factor = 100
			modifier = {
				factor = 2
				trait = craven
			}
			modifier = {
				factor = 0.5
				trait = brave
			}
		}
		add_trait = neutral
		hidden_tooltip = {
			liege = { opinion = { who = ROOT modifier = neutral_civil_war years = 100 } }
		}
	}
	option = {
		name = EVTOPTD_PlusFaction_421 #I am imprisoned
		trigger = {
			prisoner = yes
		}
	}
	option = {
		name = EVTOPTE_PlusFaction_421 #I am NOT up to such a fight...
		tooltip_info = incapable
		trigger = {
			trait = incapable
		}
	}
	option = {
		name = EVTOPTF_PlusFaction_421 # I have my own wars to fight!
		trigger = {
			prisoner = no
			NOT = { trait = incapable }
			war = yes
		}
	}
}

