
namespace = emf_faction

# emf_faction.0 [Faction Leader]
# Liege refused ultimatum - lower CA
# FROM = liege
letter_event = {
	id = emf_faction.0
	desc = EVTDESC8100

	is_triggered_only = yes

	option = {
		name = EVTOPTA8100 # Then, war it is!

		clr_character_flag = faction_lower_CA_ultimatum_taken

		log = "emf_faction.0: Lower CA: Liege (ID: [Root.Liege.GetID]) refused ultimatum, declaring war"

		liege = {
			hidden_tooltip = {
				set_character_flag = faction_authority_war
				any_vassal = {
					limit = { in_faction = faction_lower_crown_authority }
					pf_setup_rebel_effect = yes
				}
				any_vassal = {
					limit = {
						is_playable = yes
						not = { in_faction = faction_lower_crown_authority }
					}
					character_event = { id = emf_faction.1 days = 1 } # Call-to-arms
				}
			}
			reverse_war = {
				target = ROOT
				casus_belli = cb_faction_overthrow_ruler
				faction = faction_lower_crown_authority
			}
		}
	}
}


# emf_faction.1 [Vassal, Non-Faction Member]
# Invite vassal to join civil war - lower CA
character_event = {
	id = emf_faction.1
	picture = GFX_evt_battle
	border = GFX_event_normal_frame_war

	is_triggered_only = yes

	trigger = {
		is_playable = yes
		num_of_baron_titles = 1
		pf_war_trait_trigger = no
	}

	option = {
		name = EVTOPTA_PlusFaction_421 #join the rebellion
		trigger = {
			prisoner = no
			NOT = { trait = incapable }
		}
		ai_chance = {
			factor = 10
			modifier = {
				factor = 0
				is_adult = no
			}
			modifier = {
				factor = 0
				liege = {
					any_demesne_title = {
						is_crown_law_title = yes
						current_heir = { character = ROOT }
					}
				}
			}
			modifier = {
				factor = 0.5
				liege = {
					OR = {
						is_allied_with = ROOT
						dynasty = ROOT
						is_close_relative = ROOT
					}
				}
			}
			modifier = {
				factor = 5
				liege = { is_rival = ROOT }
			}
			modifier = {
				factor = 1.5
				trait = ambitious
			}
			modifier = {
				factor = 1.25
				trait = envious
			}
			modifier = {
				factor = 1.5
				liege = {
					any_war = {
						defender = { character = PREVPREV }
						attacker = { character = FROM }
						any_attacker = {
							OR = {
								is_allied_with = ROOT
								is_close_relative = ROOT
							}
						}
					}
				}
			}
			modifier = {
				factor = 0.8
				NOT = { opinion = { who = FROM value = 0 } }
			}
			modifier = {
				factor = 0.8
				NOT = { opinion = { who = FROM value = -25 } }
			}
			modifier = {
				factor = 0.5
				NOT = { opinion = { who = FROM value = -50 } }
			}
			modifier = {
				factor = 0.5
				NOT = { opinion = { who = FROM value = -75 } }
			}
			modifier = {
				factor = 1.25
				opinion = { who = FROM value = 25 }
			}
			modifier = {
				factor = 1.25
				opinion = { who = FROM value = 50 }
			}
			modifier = {
				factor = 1.25
				opinion = { who = FROM value = 75 }
			}
			modifier = {
				factor = 0
				opinion = { who = liege value = 0 }
			}
			modifier = {
				factor = 3
				NOT = { opinion = { who = liege value = 0 } }
			}
			modifier = {
				factor = 3
				NOT = { opinion = { who = liege value = -25 } }
			}
			modifier = {
				factor = 3
				NOT = { opinion = { who = liege value = -50 } }
			}
			modifier = {
				factor = 3
				NOT = { opinion = { who = liege value = -75 } }
			}
		}

		log = "emf_faction.1: Lower CA: Non-faction vassal [Root.GetTitledFirstName] of [Root.PrimaryTitle.GetBaseName] (ID: [Root.GetID]) attempting to join revolt against liege (ID: [Root.Liege.GetID])"

		pf_setup_rebel_effect = yes
		pf_rebel_independence_effect = yes
		join_attacker_wars = FROM

		character_event = { id = emf_faction.2 }
	}
	option = {
		name = EVTOPTB_PlusFaction_421 #remain loyal
		trigger = {
			prisoner = no
			NOT = { trait = incapable }
		}
		ai_chance = {
			factor = 10
			modifier = {
				factor = 0
				is_adult = no
			}
			modifier = {
				factor = 10
				liege = {
					any_demesne_title = {
						is_crown_law_title = yes
						current_heir = { character = ROOT }
					}
				}
			}
			modifier = {
				factor = 0
				liege = { NOT = { religion = ROOT } }
			}
			modifier = {
				factor = 0
				NOT = { opinion = { who = liege value = -50 } }
			}
			modifier = {
				factor = 0.1
				NOT = { opinion = { who = liege value = 0 } }
			}
			modifier = {
				factor = 5
				liege = {
					OR = {
						is_allied_with = ROOT
						dynasty = ROOT
						is_close_relative = ROOT
					}
				}
			}
			modifier = {
				factor = 1.5
				trait = content
			}
			modifier = {
				factor = 3
				opinion = { who = liege value = 25 }
			}
			modifier = {
				factor = 3
				opinion = { who = liege value = 50 }
			}
			modifier = {
				factor = 3
				opinion = { who = liege value = 75 }
			}
		}
		add_trait = loyalist
		hidden_tooltip = {
			liege = { opinion = { who = ROOT modifier = supported_civil_war multiplier = 4 years = 100 } }
		}
	}
	option = {
		name = EVTOPTC_PlusFaction_421 #remain neutral
		trigger = {
			prisoner = no
			NOT = { trait = incapable }
		}
		ai_chance = {
			factor = 100
			modifier = {
				factor = 2
				trait = craven
			}
			modifier = {
				factor = 0.5
				trait = brave
			}
		}
		add_trait = neutral
	}
	option = {
		name = EVTOPTD_PlusFaction_421 #I am imprisoned
		trigger = {
			prisoner = yes
		}
	}
	option = {
		name = EVTOPTE_PlusFaction_421 #I am not up to such a fight...
		tooltip_info = incapable
		trigger = {
			trait = incapable
		}
	}
}


character_event = {
	id = emf_faction.2

	is_triggered_only = yes
	hide_window = yes

	trigger = {
		NOT = {
			any_war = {
				defender = { character = FROMFROMFROM }
				attacker = { character = FROMFROM }
				any_attacker = { character = ROOT }
				using_cb = cb_faction_overthrow_ruler
			}
		}
	}

	immediate = {
		if = {
			limit = {
				any_war = {
					attacker = { character = FROMFROM }
					any_attacker = { character = ROOT }
				}
			}
			log = "emf_faction.2: SERIOUS: Non-faction vassal [Root.GetTitledFirstName] of [Root.PrimaryTitle.GetBaseName] (ID: [Root.GetID]) failed to join revolt BUT is a secondary participant attacker in one of the revolt leader's wars! (Leader ID: [FromFrom.GetID])"
		}
		pf_teardown_rebel_effect = yes
		set_defacto_liege = FROMFROMFROM
	}
}



character_event = { # Check for stray war traits/TOMs <Debug MTTH on ALL characters>
	id = emf_faction.3
	
	hide_window = yes

	trigger = {
		war = no
		OR = {
			pf_war_trait_trigger = yes
			has_any_opinion_modifier = revolting_against
			has_any_opinion_modifier = revolting_against_me
			has_any_opinion_modifier = supported_civil_war
			has_any_opinion_modifier = neutral_civil_war
		}
		OR = {
			independent = yes
			liege = { war = no }
			is_ruler = no
		}
	}

	mean_time_to_happen = {
		days = 1
	}

	immediate = {
		if = {
			limit = { trait = rebel }
			remove_trait = rebel
			log = "ERROR: [Root.GetTitledFirstName] of the [Root.PrimaryTitle.GetFullBaseName] ([Root.GetID]) has a Rebel trait but is not in a war"
		}
		if = {
			limit = { trait = loyalist }
			remove_trait = loyalist
			log = "ERROR: [Root.GetTitledFirstName] of the [Root.PrimaryTitle.GetFullBaseName] ([Root.GetID]) has a Loyalist trait but is not in a war"
		}
		if = {
			limit = { trait = neutral }
			remove_trait = neutral
			log = "ERROR: [Root.GetTitledFirstName] of the [Root.PrimaryTitle.GetFullBaseName] ([Root.GetID]) has a Neutral trait but is not in a war"
		}
		if = {
			limit = { has_any_opinion_modifier = revolting_against }
			random_opinion_modifier_target = {
				limit = { reverse_has_opinion_modifier = { who = ROOT modifier = revolting_against } }
				reverse_remove_opinion = { who = ROOT modifier = revolting_against }
				log = "ERROR: [Root.GetTitledFirstName] of the [Root.PrimaryTitle.GetFullBaseName] ([Root.GetID]) has a revolting_against TOM vs. [This.GetTitledFirstName] of the [This.PrimaryTitle.GetFullBaseName] ([This.GetID]), but is not currently in a war"
			}
		}
		if = {
			limit = { has_any_opinion_modifier = revolting_against_me }
			random_opinion_modifier_target = {
				limit = { reverse_has_opinion_modifier = { who = ROOT modifier = revolting_against_me } }
				reverse_remove_opinion = { who = ROOT modifier = revolting_against_me }
				log = "ERROR: [Root.GetTitledFirstName] of the [Root.PrimaryTitle.GetFullBaseName] ([Root.GetID]) has a revolting_against_me TOM vs. [This.GetTitledFirstName] of the [This.PrimaryTitle.GetFullBaseName] ([This.GetID]), but is not currently in a war"
			}
		}
		if = {
			limit = { has_any_opinion_modifier = supported_civil_war }
			random_opinion_modifier_target = {
				limit = { reverse_has_opinion_modifier = { who = ROOT modifier = supported_civil_war } }
				reverse_remove_opinion = { who = ROOT modifier = supported_civil_war }
				log = "ERROR: [Root.GetTitledFirstName] of the [Root.PrimaryTitle.GetFullBaseName] ([Root.GetID]) has a supported_civil_war TOM vs. [This.GetTitledFirstName] of the [This.PrimaryTitle.GetFullBaseName] ([This.GetID]), but is not currently in a war"
			}
		}
		if = {
			limit = { has_any_opinion_modifier = neutral_civil_war }
			random_opinion_modifier_target = {
				limit = { reverse_has_opinion_modifier = { who = ROOT modifier = neutral_civil_war } }
				reverse_remove_opinion = { who = ROOT modifier = neutral_civil_war }
				log = "ERROR: [Root.GetTitledFirstName] of the [Root.PrimaryTitle.GetFullBaseName] ([Root.GetID]) has a neutral_civil_war TOM vs. [This.GetTitledFirstName] of the [This.PrimaryTitle.GetFullBaseName] ([This.GetID]), but is not currently in a war"
			}
		}
	}
}
