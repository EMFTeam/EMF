
namespace = emf_faction

# emf_faction.0 [Faction Leader]
# Liege refused ultimatum - lower CA
# FROM = liege
letter_event = {
	id = emf_faction.0
	desc = EVTDESC8100

	is_triggered_only = yes

	option = {
		name = EVTOPTA8100 # Then, war it is!

		clr_character_flag = faction_lower_CA_ultimatum_taken

		log = "emf_faction.0: Lower CA: Liege (ID: [Root.Liege.GetID]) refused ultimatum, declaring war"
		set_character_flag = demands_lower_CA

		liege = {
			hidden_tooltip = {
				set_character_flag = faction_authority_war
				any_vassal = {
					limit = { in_faction = faction_lower_crown_authority }
					pf_setup_rebel_effect = yes
				}
				any_vassal = {
					limit = {
						is_playable = yes
						not = { in_faction = faction_lower_crown_authority }
					}
					character_event = { id = emf_faction.1 days = 1 } # Call-to-arms
				}
			}
			reverse_war = {
				target = ROOT
				casus_belli = cb_faction_overthrow_ruler
				faction = faction_lower_crown_authority
			}
		}
	}
}


# emf_faction.1 [Vassal, Non-Faction Member]
# Invite vassal to join civil war - lower CA
character_event = {
	id = emf_faction.1
	picture = GFX_evt_battle
	border = GFX_event_normal_frame_war

	is_triggered_only = yes

	trigger = {
		is_playable = yes
		num_of_baron_titles = 1
		pf_war_trait_trigger = no
	}
	
	immediate = {
		FROM = { save_event_target_as = pf_attacker }
	}

	option = {
		name = EVTOPTA_PlusFaction_421 #join the rebellion
		trigger = {
			prisoner = no
			NOT = { trait = incapable }
			war = no
		}
		ai_chance = {
			factor = 10
			modifier = {
				factor = 0
				is_adult = no
			}
			modifier = {
				factor = 0
				liege = {
					any_demesne_title = {
						is_crown_law_title = yes
						current_heir = { character = ROOT }
					}
				}
			}
			modifier = {
				factor = 0.5
				liege = {
					OR = {
						is_allied_with = ROOT
						dynasty = ROOT
						is_close_relative = ROOT
					}
				}
			}
			modifier = {
				factor = 5
				liege = { is_rival = ROOT }
			}
			modifier = {
				factor = 1.5
				trait = ambitious
			}
			modifier = {
				factor = 1.25
				trait = envious
			}
			modifier = {
				factor = 1.5
				liege = {
					any_war = {
						defender = { character = PREVPREV }
						attacker = { character = FROM }
						any_attacker = {
							OR = {
								is_allied_with = ROOT
								is_close_relative = ROOT
							}
						}
					}
				}
			}
			modifier = {
				factor = 0.8
				NOT = { opinion = { who = FROM value = 0 } }
			}
			modifier = {
				factor = 0.8
				NOT = { opinion = { who = FROM value = -25 } }
			}
			modifier = {
				factor = 0.5
				NOT = { opinion = { who = FROM value = -50 } }
			}
			modifier = {
				factor = 0.5
				NOT = { opinion = { who = FROM value = -75 } }
			}
			modifier = {
				factor = 1.25
				opinion = { who = FROM value = 25 }
			}
			modifier = {
				factor = 1.25
				opinion = { who = FROM value = 50 }
			}
			modifier = {
				factor = 1.25
				opinion = { who = FROM value = 75 }
			}
			modifier = {
				factor = 0
				opinion = { who = liege value = 0 }
			}
			modifier = {
				factor = 3
				NOT = { opinion = { who = liege value = 0 } }
			}
			modifier = {
				factor = 3
				NOT = { opinion = { who = liege value = -25 } }
			}
			modifier = {
				factor = 3
				NOT = { opinion = { who = liege value = -50 } }
			}
			modifier = {
				factor = 3
				NOT = { opinion = { who = liege value = -75 } }
			}
		}

		pf_setup_rebel_effect = yes
		hidden_tooltip = { character_event = { id = PlusFaction.440 } } # Actually join
		tooltip = { join_attacker_wars = event_target:pf_attacker }
	}
	option = {
		name = EVTOPTB_PlusFaction_421 #remain loyal
		trigger = {
			prisoner = no
			NOT = { trait = incapable }
			war = no
		}
		ai_chance = {
			factor = 10
			modifier = {
				factor = 0
				is_adult = no
			}
			modifier = {
				factor = 10
				liege = {
					any_demesne_title = {
						is_crown_law_title = yes
						current_heir = { character = ROOT }
					}
				}
			}
			modifier = {
				factor = 0
				liege = { NOT = { religion = ROOT } }
			}
			modifier = {
				factor = 0
				NOT = { opinion = { who = liege value = -50 } }
			}
			modifier = {
				factor = 0.1
				NOT = { opinion = { who = liege value = 0 } }
			}
			modifier = {
				factor = 5
				liege = {
					OR = {
						is_allied_with = ROOT
						dynasty = ROOT
						is_close_relative = ROOT
					}
				}
			}
			modifier = {
				factor = 1.5
				trait = content
			}
			modifier = {
				factor = 3
				opinion = { who = liege value = 25 }
			}
			modifier = {
				factor = 3
				opinion = { who = liege value = 50 }
			}
			modifier = {
				factor = 3
				opinion = { who = liege value = 75 }
			}
		}
		add_trait = loyalist
		hidden_tooltip = {
			liege = { opinion = { who = ROOT modifier = supported_civil_war years = 100 } }
		}
	}
	option = {
		name = EVTOPTC_PlusFaction_421 #remain neutral
		trigger = {
			prisoner = no
			NOT = { trait = incapable }
			war = no
		}
		ai_chance = {
			factor = 100
			modifier = {
				factor = 2
				trait = craven
			}
			modifier = {
				factor = 0.5
				trait = brave
			}
		}
		add_trait = neutral
		hidden_tooltip = {
			liege = { opinion = { who = ROOT modifier = neutral_civil_war years = 100 } }
		}
	}
	option = {
		name = EVTOPTD_PlusFaction_421 #I am imprisoned
		trigger = {
			prisoner = yes
		}
	}
	option = {
		name = EVTOPTE_PlusFaction_421 #I am not up to such a fight...
		tooltip_info = incapable
		trigger = {
			trait = incapable
		}
	}
	option = {
		name = EVTOPTF_PlusFaction_421 # I have my own wars to fight!
		trigger = {
			prisoner = no
			NOT = { trait = incapable }
			war = yes
		}
	}
}


character_event = { # Check for stray war traits/TOMs <Debug MTTH on ALL characters>
	id = emf_faction.3
	
	hide_window = yes

	trigger = {
		OR = {
			pf_war_trait_trigger = yes
			has_any_opinion_modifier = revolting_against
			has_any_opinion_modifier = revolting_against_me
			has_any_opinion_modifier = supported_civil_war
			has_any_opinion_modifier = neutral_civil_war
		}
		war = no
		OR = {
			independent = yes
			liege = { war = no }
		}
		NOT = { has_character_flag = pf_logged_error }
	}

	mean_time_to_happen = {
		days = 1
	}

	immediate = {
		set_character_flag = pf_logged_error
		pf_log_civil_war_state_effect = yes
	}
}


character_event = {
	id = emf_faction.10
	desc = TOARMS
	picture = GFX_evt_battle
	border = GFX_event_normal_frame_war

	option = {
		name = OK

		random_vassal = {
			limit = {
				pf_leader_trigger = yes
				any_faction_backer = { pf_my_faction_backer_trigger = yes }
			}
			pf_setup_rebel_effect = yes
			any_faction_backer = {
				limit = { pf_my_faction_backer_trigger = yes }
				pf_setup_rebel_effect = yes
			}
			if = {
				limit = { leads_faction = faction_court }
				war = {
					target = ROOT
					casus_belli = cb_faction_overthrow_ruler
					faction = faction_court
				}
			}
			if = {
				limit = { leads_faction = faction_prosperity }
				war = {
					target = ROOT
					casus_belli = cb_faction_overthrow_ruler
					faction = faction_prosperity
				}
			}
			if = {
				limit = { leads_faction = faction_glory }
				war = {
					target = ROOT
					casus_belli = cb_faction_overthrow_ruler
					faction = faction_glory
				}
			}
			if = {
				limit = { leads_faction = faction_tradition }
				war = {
					target = ROOT
					casus_belli = cb_faction_overthrow_ruler
					faction = faction_tradition
				}
			}
			save_event_target_as = pf_attacker
			ROOT = {
				any_vassal = {
					limit = {
						is_playable = yes
						num_of_baron_titles = 1
						war = no
						pf_war_trait_trigger = no
					}
					pf_setup_rebel_effect = yes
					hidden_tooltip = { character_event = { id = PlusFaction.440 } }
				}
			}
		}
	}
}


character_event = {
	id = emf_faction.11
	desc = I_SEE
	picture = GFX_evt_pale_rider
	border = GFX_event_normal_frame_war

	immediate = {
		random_playable_ruler = {
			limit = { ai = no }
			save_event_target_as = player
		}
	}

	option = {
		name = OK
		custom_tooltip = { text = "usurp primary-tier titles" }
		custom_tooltip = { text = emf_ctt_break }
		any_demesne_title = {
			limit = { is_primary_holder_title_tier = yes }
			usurp_title_plus_barony_if_unlanded = event_target:player
		}
	}
	option = {
		name = YES
		custom_tooltip = { text = "usurp primary-tier titles (no_adj)" }
		custom_tooltip = { text = emf_ctt_break }
		any_demesne_title = {
			limit = { is_primary_holder_title_tier = yes }
			usurp_title_plus_barony_if_unlanded_and_vassals_no_adj = { target = event_target:player type = invasion }
		}
	}
	option = {
		name = EXCELLENT
		custom_tooltip = { text = "usurp_title all" }
		custom_tooltip = { text = emf_ctt_break }
		any_demesne_title = {
			usurp_title = event_target:player
		}
	}
	option = {
		name = ALAS
		custom_tooltip = { text = "usurp_title_only all" }
		custom_tooltip = { text = emf_ctt_break }
		any_demesne_title = {
			usurp_title_only = event_target:player
		}
	}
}


character_event = {
	id = emf_faction.12
	desc = I_SEE
	picture = GFX_evt_small_town
	border = GFX_event_normal_frame_diplomacy

	immediate = {
		random_playable_ruler = {
			limit = { ai = no }
			save_event_target_as = player
		}
	}

	option = {
		name = OK
		custom_tooltip = { text = "abdicate" }
		custom_tooltip = { text = emf_ctt_break }
		abdicate = yes
	}
	option = {
		name = YES
		custom_tooltip = { text = "abdicate_to me" }
		custom_tooltip = { text = emf_ctt_break }
		abdicate_to = event_target:player
	}
	option = {
		name = EXCELLENT
		custom_tooltip = { text = "grant all titles" }
		custom_tooltip = { text = emf_ctt_break }
		any_demesne_title = {
			grant_title = event_target:player
		}
	}
	option = {
		name = ALAS
		custom_tooltip = { text = "set_defacto_liege" }
		custom_tooltip = { text = emf_ctt_break }
		any_demesne_title = {
			limit = { not = { lower_tier_than = event_target:player } }
			grant_title = { target = event_target:player type = invasion }
		}
		set_defacto_liege = event_target:player
	}
}


character_event = {
	id = emf_faction.20
	desc = OK
	picture = GFX_evt_castle_construction
	border = GFX_event_normal_frame_diplomacy

	immediate = {
		create_character = {
			random_traits = yes
			dynasty = random
			female = no
		}
		new_character = {
			save_event_target_as = nc
		}

		d_sicily = {
			destroy_landed_title = THIS
			any_direct_de_jure_vassal_title = {
				grant_title = { target = ROOT type = invasion }
				set_title_flag = tmp_county
			}
		}
	}
}
