# -*- ck2.events -*-

namespace = pb_crusades

# Refill holding levies (needs to be done on a delay)
character_event = { # refills levy holdings after switching to feudal
	id = pb_crusades.1
	
	hide_window = yes
	is_triggered_only = yes
	
	immediate = {
		any_demesne_title = {
			limit = { has_title_flag = refill_levy }
			clr_title_flag = refill_levy
			remove_holding_modifier = recently_conquered
			remove_holding_modifier = new_administration
			refill_holding_levy = yes
		}
	}
}

# pb_crusades.2
# Post-crusade event to check whether kingdom should be given away
# FROMFROM is ther former title owner (CB loser), ROOT is the winner, FROM is the religion head
# all of ROOT's titles held prior to the crusade gain have the "previous_holding" title flag
# all of ROOT's vassals held prior to the crusade gain have the "previous_vassal" character flag
# ROOT's primary title prior to the crusade gain is saved as current_title event target
# The crusade title is saved as crusade_title event target
character_event = {
	id = pb_crusades.2
	desc = EVTDESC_Plus_400
	picture = GFX_evt_crusaders
	
	is_triggered_only = yes
	
	immediate = {
		random_child = {
			limit = {
				is_adult = yes
				prisoner = no
				is_ruler = no
				religion = ROOT
				is_liege_or_above = ROOT
				health = 4.0
				emf_can_inherit_trigger = yes
				OR = {
					is_female = no
					ROOT = { primary_title = { has_law = true_cognatic_succession } }
					ROOT = { primary_title = { has_law = enatic_cognatic_succession } }
					ROOT = { primary_title = { has_law = enatic_succession } }
				}
				NOR = {
					trait = incapable
					any_spouse = { is_ruler = yes }
					any_heir_title = { always = yes }
				}
				OR = {
					NOT = { age = 40 }
					any_child = {
						is_female = no
						emf_can_inherit_trigger = yes
					}
				}
			}
			save_event_target_as = child_heir
		}
		random_sibling = {
			limit = {
				is_adult = yes
				prisoner = no
				is_ruler = no
				religion = ROOT
				is_liege_or_above = ROOT
				health = 4.0
				emf_can_inherit_trigger = yes
				OR = {
					is_female = no
					ROOT = { primary_title = { has_law = true_cognatic_succession } }
					ROOT = { primary_title = { has_law = enatic_cognatic_succession } }
					ROOT = { primary_title = { has_law = enatic_succession } }
				}
				NOR = {
					trait = incapable
					any_spouse = { is_ruler = yes }
					any_heir_title = { always = yes }
				}
				OR = {
					NOT = { age = 40 }
					any_child = {
						is_female = no
						emf_can_inherit_trigger = yes
					}
				}
			}
			save_event_target_as = sibling_heir
		}
		random_dynasty_member = {
			limit = {
				is_adult = yes
				prisoner = no
				is_ruler = no
				religion = ROOT
				is_liege_or_above = ROOT
				health = 4.0
				piety = 0
				reverse_opinion = { who = ROOT value = 0 }
				emf_can_inherit_trigger = yes
				OR = {
					is_female = no
					ROOT = { primary_title = { has_law = true_cognatic_succession } }
					ROOT = { primary_title = { has_law = enatic_cognatic_succession } }
					ROOT = { primary_title = { has_law = enatic_succession } }
				}
				OR = {
					diplomacy = 12
					martial = 12
					stewardship = 12
					is_smart_trigger = yes
					reverse_opinion = { who = ROOT value = 75 }
					calc_true_if = {
						amount = 2
						diplomacy = 8
						martial = 8
						stewardship = 8
					}
				}
				NOR = {
					is_child_of = ROOT
					sibling = ROOT
					trait = incapable
					trait = lunatic
					trait = imbecile
					trait = inbred
					is_dumb_trigger = yes
					any_spouse = { is_ruler = yes }
					any_heir_title = { always = yes }
				}
				OR = {
					NOT = { age = 40 }
					any_child = {
						is_female = no
						emf_can_inherit_trigger = yes
					}
				}
			}
			save_event_target_as = relative_heir
		}
		random_dynasty_member = {
			limit = {
				NOT = { event_target:relative_heir = { always = yes } }
				is_adult = yes
				prisoner = no
				is_ruler = no
				religion = ROOT
				is_liege_or_above = ROOT
				health = 4.0
				piety = 0
				reverse_opinion = { who = ROOT value = 0 }
				emf_can_inherit_trigger = yes
				OR = {
					is_female = no
					ROOT = { primary_title = { has_law = true_cognatic_succession } }
					ROOT = { primary_title = { has_law = enatic_cognatic_succession } }
					ROOT = { primary_title = { has_law = enatic_succession } }
				}
				NOR = {
					is_child_of = ROOT
					sibling = ROOT
					trait = incapable
					trait = lunatic
					trait = imbecile
					trait = inbred
					is_dumb_trigger = yes
					any_spouse = { is_ruler = yes }
					any_heir_title = { always = yes }
				}
				OR = {
					NOT = { age = 40 }
					any_child = {
						is_female = no
						emf_can_inherit_trigger = yes
					}
				}
			}
			save_event_target_as = relative_heir
		}
		random_courtier = {
			limit = {
				is_adult = yes
				prisoner = no
				is_ruler = no
				religion = ROOT
				is_liege_or_above = ROOT
				health = 4.0
				piety = 0
				reverse_opinion = { who = ROOT value = 0 }
				emf_can_inherit_trigger = yes
				OR = {
					is_female = no
					ROOT = { primary_title = { has_law = true_cognatic_succession } }
					ROOT = { primary_title = { has_law = enatic_cognatic_succession } }
					ROOT = { primary_title = { has_law = enatic_succession } }
				}
				OR = {
					diplomacy = 12
					martial = 12
					stewardship = 12
					is_smart_trigger = yes
					reverse_opinion = { who = ROOT value = 75 }
					calc_true_if = {
						amount = 2
						diplomacy = 8
						martial = 8
						stewardship = 8
					}
				}
				NOR = {
					is_child_of = ROOT
					sibling = ROOT
					dynasty = ROOT
					trait = incapable
					trait = lunatic
					trait = imbecile
					trait = inbred
					is_dumb_trigger = yes
					any_spouse = { is_ruler = yes }
					any_heir_title = { always = yes }
				}
				OR = {
					NOT = { age = 40 }
					any_child = {
						is_female = no
						emf_can_inherit_trigger = yes
					}
				}
			}
			save_event_target_as = courtier_heir
		}
		# Free wrong-religion holy orders from vassalage
		any_realm_lord = {
			limit = {
				NOT = { religion = ROOT }
				primary_title = { holy_order = yes }
				NOT = { has_character_flag = previous_vassal }
			}
			set_defacto_liege = THIS
			emf_liege_change_effect = yes
		}
	}
	
	option = {
		name = "EVTOPTA_Plus_400" #To my son
		trigger = {
			event_target:child_heir = { is_alive = yes }
		}
		ai_chance = {
			factor = 100
		}
		prestige = 500
		event_target:child_heir = {
			custom_tooltip = {
				if = {
					limit = { NOT = { is_friend = ROOT } }
					add_friend = ROOT
				}
				text = WILL_INHERIT_CRUSADE_KINGDOM
				hidden_tooltip = {
					character_event = { id = pb_crusades.3 }
				}
			}
		}
	}
	option = {
		name = {
			text = EVTOPTB_Plus_400_brother
			trigger = { event_target:sibling_heir = { is_female = no } }
		}
		name = {
			text = EVTOPTB_Plus_400_sister
			trigger = { event_target:sibling_heir = { is_female = yes } }
		}
		trigger = {
			event_target:sibling_heir = { is_alive = yes }
		}
		ai_chance = {
			factor = 100
		}
		prestige = 500
		event_target:sibling_heir = {
			custom_tooltip = {
				if = {
					limit = { NOT = { is_friend = ROOT } }
					add_friend = ROOT
				}
				text = WILL_INHERIT_CRUSADE_KINGDOM
				hidden_tooltip = {
					character_event = { id = pb_crusades.3 }
				}
			}
		}
	}
	option = {
		name = "EVTOPTC_Plus_400" #To a capable relative
		trigger = {
			event_target:relative_heir = { is_alive = yes }
		}
		ai_chance = {
			factor = 10
		}
		prestige = 500
		event_target:relative_heir = {
			custom_tooltip = {
				if = {
					limit = { NOT = { is_friend = ROOT } }
					add_friend = ROOT
				}
				text = WILL_INHERIT_CRUSADE_KINGDOM
				hidden_tooltip = {
					character_event = { id = pb_crusades.3 }
				}
			}
		}
	}
	option = {
		name = EVTOPTD_Plus_400 #To a valiant retainer
		trigger = {
			OR = {
				NOT = { event_target:child_heir = { is_alive = yes } }
				NOT = { event_target:sibling_heir = { is_alive = yes } }
				NOT = { event_target:relative_heir = { is_alive = yes } }
			}
		}
		ai_chance = {
			factor = 1
		}
		prestige = 500
		if = {
			limit = { event_target:courtier_heir = { always = yes } }
			event_target:courtier_heir = {
				custom_tooltip = {
					if = {
						limit = { NOT = { is_friend = ROOT } }
						add_friend = ROOT
					}
					text = WILL_INHERIT_CRUSADE_KINGDOM
					hidden_tooltip = {
						character_event = { id = pb_crusades.3 }
					}
				}
			}
		}
		if = {
			limit = { NOT = { event_target:courtier_heir = { always = yes } } }
			custom_tooltip = {
				text = RANDOM_WILL_INHERIT_CRUSADE_KINGDOM
				hidden_tooltip = {
					create_character = {
						random_traits = yes
						dynasty = random
						religion = ROOT
						culture = ROOT
						female = no
						age = 25
						health = 7
						attributes = {
							martial = 10
							diplomacy = 10
						}
					}
					new_character = {
						add_friend = ROOT
						character_event = { id = pb_crusades.3 }
					}
				}
			}
		}
	}
	option = {
		name = "EVTOPTE_Plus_400" #To myself
		ai_chance = {
			factor = 1000
		}
		trigger = {
			OR = {
				ai = no
				independent = yes
				is_feudal = yes
			}
			OR = {
				ai = no
				AND = {
					independent = no
					lower_tier_than = king
				}
				any_demesne_title = {
					tier = COUNT
					NOT = { has_title_flag = previous_holding }
					location = {
						any_neighbor_province = {
							OR = {
								county = { has_title_flag = previous_holding }
								owner = { has_character_flag = previous_vassal }
								owner = { any_liege = { has_character_flag = previous_vassal } }
							}
						}
					}
				}
			}
		}
		if = {
			limit = { independent = no }
			custom_tooltip = { text = CRUSADE_RELINQUISH_TITLES }
		}
		if = {
			limit = { independent = yes }
			custom_tooltip = { text = CRUSADE_KEEP_TITLES }
		}
		hidden_tooltip = {
			if = {
				limit = { independent = no }
				liege = {
					ROOT = {
						# Previous vassals will be reassigned to the liege
						any_character = {
							limit = { has_character_flag = previous_vassal }
							clr_character_flag = previous_vassal
							set_defacto_liege = PREVPREV
							pf_liege_change_effect = yes
						}
						# Previous non-titular titles will be reassigned to the liege
						any_demesne_title = {
							limit = {
								is_titular = no
								is_landless_type_title = no
								has_title_flag = previous_holding
							}
							clr_title_flag = previous_holding
							gain_title = PREVPREV
						}
					}
				}
				set_defacto_liege = ROOT
			}
			event_target:crusade_title = {
				destroy_landed_title = yes
				gain_title = ROOT
				copy_title_laws = event_target:current_title
				capital_scope = {
					county = {
						if = {
							limit = { holder = ROOT }
							ROOT = { capital = PREV }
						}
					}
				}
			}
			# Refill levies of conquered holdings within target kingdom
			any_demesne_title = {
				limit = {
					tier = BARON
					de_jure_liege_or_above = event_target:crusade_title
				}
				set_title_flag = refill_levy
			}
			character_event = { id = pb_crusades.5 } # Grant fiefs to crusade participants
			character_event = { id = pb_crusades.1 days = 3 } # Refill holding levies
		}
	}
}

character_event = {
	id = pb_crusades.3
	
	hide_window = yes
	is_triggered_only = yes
	
	immediate = {
		# Grant titles in crusade kingdom, starting with feudal titles
		FROM = {
			any_demesne_title = {
				limit = {
					OR = {
						is_feudal = yes
						holding_type = castle
					}
					NOT = { has_title_flag = previous_holding }
				}
				grant_title = ROOT
			}
			any_demesne_title = {
				limit = { NOT = { has_title_flag = previous_holding } }
				grant_title = ROOT
			}
		}
		emf_switch_to_feudal_gov_effect = yes # just in case

		# Refill levies of conquered holdings within target kingdom
		any_demesne_title = {
			limit = {
				tier = BARON
				de_jure_liege_or_above = event_target:crusade_title
			}
			set_title_flag = refill_levy
		}

		event_target:crusade_title = {
			destroy_landed_title = yes
			gain_title = ROOT
			copy_title_laws = event_target:current_title
			add_law = inheritance_1
			if = {
				limit = {
					NOR = {
						has_law = succ_gavelkind
						has_law = succ_primogeniture
						has_law = succ_seniority
						has_law = succ_feudal_elective
						has_law = succ_turkish_succession
					}
				}
				add_law = succ_primogeniture
			}
			capital_scope = {
				county = {
					if = {
						limit = { holder = ROOT }
						ROOT = { capital = PREV }
					}
				}
			}
		}
		
		add_character_modifier = {
			name = formation_of_rum
			duration = 9125
		}
		
		wealth = 500
		prestige = 200
		piety = 100
		set_defacto_liege = THIS
		add_alliance = { who = event_target:crusade_victor years = 50 }

		# Improve the new ruler
		random_list = {
			20 = {
				modifier = {
					factor = 0
					is_smart_trigger = yes
				}
				add_trait = shrewd
			}
			20 = {
				modifier = {
					factor = 0
					trait = brave
				}
				add_trait = brave
			}
			20 = {
				modifier = {
					factor = 0
					trait = ambitious
				}
				add_trait = ambitious
			}
			20 = {
				modifier = {
					factor = 0
					trait = zealous
				}
				add_trait = zealous
			}
			20 = {
				modifier = {
					factor = 0
					trait = diligent
				}
				add_trait = diligent
			}
		}
		random_list = {
			20 = {
				modifier = {
					factor = 0
					is_smart_trigger = yes
				}
				add_trait = shrewd
			}
			20 = {
				modifier = {
					factor = 0
					trait = brave
				}
				add_trait = brave
			}
			20 = {
				modifier = {
					factor = 0
					trait = ambitious
				}
				add_trait = ambitious
			}
			20 = {
				modifier = {
					factor = 0
					trait = zealous
				}
				add_trait = zealous
			}
			20 = {
				modifier = {
					factor = 0
					trait = diligent
				}
				add_trait = diligent
			}
		}
		
		# Spawn 3 regiments
		capital_scope = {
			ROOT = {
				spawn_unit = {
					province = PREV
					home = PREV
					owner = THIS
					troops = {
						archers = { 150 150 }
						pikemen = { 150 150 }
						heavy_infantry = { 250 250 }
						light_cavalry = { 250 250 }
						knights = { 50 50 }
					}
				}
				spawn_unit = {
					province = PREV
					home = PREV
					owner = THIS
					troops = {
						archers = { 150 150 }
						pikemen = { 150 150 }
						heavy_infantry = { 250 250 }
						light_cavalry = { 250 250 }
						knights = { 50 50 }
					}
				}
				spawn_unit = {
					province = PREV
					home = PREV
					owner = THIS
					troops = {
						archers = { 150 150 }
						pikemen = { 150 150 }
						heavy_infantry = { 250 250 }
						light_cavalry = { 250 250 }
						knights = { 50 50 }
					}
				}
			}
		}
		
		# Ensure some decent councilors/generals
		create_random_soldier = {
			random_traits = yes
			dynasty = random
			religion = ROOT
			culture = ROOT
			female = no
			age = 30
			attributes = {
				martial = 12
			}
		}
		new_character = {
			opinion = { who = ROOT modifier = opinion_loyal_servant }
		}
		create_random_soldier = {
			random_traits = yes
			dynasty = random
			religion = ROOT
			culture = ROOT
			female = no
			age = 30
			attributes = {
				martial = 12
			}
		}
		new_character = {
			opinion = { who = ROOT modifier = opinion_loyal_servant }
		}
		create_random_soldier = {
			random_traits = yes
			dynasty = random
			religion = ROOT
			culture = ROOT
			female = no
			age = 30
			attributes = {
				martial = 12
			}
		}
		new_character = {
			opinion = { who = ROOT modifier = opinion_loyal_servant }
		}
		create_random_priest = {
			random_traits = yes
			dynasty = random
			female = no
			religion = ROOT
			culture = ROOT
		}
		new_character = {
			opinion = { who = ROOT modifier = opinion_loyal_servant }
		}
		create_random_steward = {
			random_traits = yes
			dynasty = random
			female = no
			religion = ROOT
			culture = ROOT
		}
		new_character = {
			opinion = { who = ROOT modifier = opinion_loyal_servant }
		}
		create_random_intriguer = {
			random_traits = yes
			dynasty = random
			female = no
			religion = ROOT
			culture = ROOT
		}
		new_character = {
			opinion = { who = ROOT modifier = opinion_loyal_servant }
		}
		create_random_diplomat = {
			random_traits = yes
			dynasty = random
			female = no
			religion = ROOT
			culture = ROOT
		}
		new_character = {
			opinion = { who = ROOT modifier = opinion_loyal_servant }
		}
		
		# Fire follow-up events
		character_event = { id = pb_crusades.5 } # Grant fiefs to crusade participants
		character_event = { id = pb_crusades.1 days = 3 } # Refill holding levies		
	}
}
	
# Crusade participant requests a fief for relative
character_event = {
	id = pb_crusades.4
	desc = EVTDESC_Plus_401
	picture = GFX_evt_crusaders
	
	is_triggered_only = yes
	
	option = {
		name = "EVTOPTA_Plus_401" #Request a fief for my son
		trigger = {
			any_child = {
				is_adult = yes
				prisoner = no
				is_ruler = no
				religion = ROOT
				is_liege_or_above = ROOT
				health = 4.0
				emf_can_inherit_trigger = yes
				is_female = no
				NOR = {
					trait = incapable
					any_spouse = { is_ruler = yes }
					any_heir_title = { always = yes }
				}
				OR = {
					NOT = { age = 40 }
					any_child = {
						is_female = no
						emf_can_inherit_trigger = yes
					}
				}
			}
		}
		ai_chance = {
			factor = 100
			modifier = {
				factor = 2
				trait = ambitious
			}
			modifier = {
				factor = 2
				trait = proud
			}
		}
		prestige = 50
		random_child = {
			limit = {
				is_adult = yes
				prisoner = no
				is_ruler = no
				religion = ROOT
				is_liege_or_above = ROOT
				health = 4.0
				emf_can_inherit_trigger = yes
				is_female = no
				NOR = {
					trait = incapable
					any_spouse = { is_ruler = yes }
					any_heir_title = { always = yes }
				}
				OR = {
					NOT = { age = 40 }
					any_child = {
						is_female = no
						emf_can_inherit_trigger = yes
					}
				}
			}
			custom_tooltip = { text = GRANTED_CRUSADE_FIEF }
			opinion = { who = ROOT modifier = opinion_grateful years = 20 }
			set_character_flag = wants_fief_@event_target:crusade_victor
		}
		hidden_tooltip = {
			if = {
				limit = { ai = no }
				event_target:crusade_title = {
					holder_scope = {
						character_event = { id = pb_crusades.5 }
					}
				}
			}
		}
	}
	option = {
		name = "EVTOPTB_Plus_401" #Request a fief for my brother
		trigger = {
			any_sibling = {
				is_adult = yes
				prisoner = no
				is_ruler = no
				religion = ROOT
				is_liege_or_above = ROOT
				health = 4.0
				emf_can_inherit_trigger = yes
				is_female = no
				NOR = {
					trait = incapable
					any_spouse = { is_ruler = yes }
					any_heir_title = { always = yes }
				}
				OR = {
					NOT = { age = 40 }
					any_child = {
						is_female = no
						emf_can_inherit_trigger = yes
					}
				}
			}
		}
		ai_chance = {
			factor = 50
			modifier = {
				factor = 2
				trait = proud
			}
		}
		prestige = 50
		random_sibling = {
			limit = {
				is_adult = yes
				prisoner = no
				is_ruler = no
				religion = ROOT
				is_liege_or_above = ROOT
				health = 4.0
				emf_can_inherit_trigger = yes
				is_female = no
				NOR = {
					trait = incapable
					any_spouse = { is_ruler = yes }
					any_heir_title = { always = yes }
				}
				OR = {
					NOT = { age = 40 }
					any_child = {
						is_female = no
						emf_can_inherit_trigger = yes
					}
				}
			}
			custom_tooltip = { text = GRANTED_CRUSADE_FIEF }
			opinion = { who = ROOT modifier = opinion_grateful years = 20 }
			set_character_flag = wants_fief_@event_target:crusade_victor
		}
		hidden_tooltip = {
			if = {
				limit = { ai = no }
				event_target:crusade_title = {
					holder_scope = {
						character_event = { id = pb_crusades.5 }
					}
				}
			}
		}
	}
	option = {
		name = "EVTOPTC_Plus_401" #Request a fief for a relative
		trigger = {
			any_dynasty_member = {
				is_adult = yes
				prisoner = no
				is_ruler = no
				religion = ROOT
				is_liege_or_above = ROOT
				health = 4.0
				piety = 0
				reverse_opinion = { who = ROOT value = 0 }
				emf_can_inherit_trigger = yes
				is_female = no
				NOR = {
					is_child_of = ROOT
					sibling = ROOT
					trait = incapable
					trait = lunatic
					trait = imbecile
					trait = inbred
					is_dumb_trigger = yes
					any_spouse = { is_ruler = yes }
					any_heir_title = { always = yes }
				}
				OR = {
					NOT = { age = 40 }
					any_child = {
						is_female = no
						emf_can_inherit_trigger = yes
					}
				}
			}
		}
		ai_chance = {
			factor = 25
			modifier = {
				factor = 2
				trait = proud
			}
		}
		prestige = 25
		random_dynasty_member = {
			limit = {
				is_adult = yes
				prisoner = no
				is_ruler = no
				religion = ROOT
				is_liege_or_above = ROOT
				health = 4.0
				piety = 0
				reverse_opinion = { who = ROOT value = 0 }
				emf_can_inherit_trigger = yes
				is_female = no
				OR = {
					diplomacy = 12
					martial = 12
					stewardship = 12
					is_smart_trigger = yes
					reverse_opinion = { who = ROOT value = 75 }
					calc_true_if = {
						amount = 2
						diplomacy = 8
						martial = 8
						stewardship = 8
					}
				}
				NOR = {
					is_child_of = ROOT
					sibling = ROOT
					trait = incapable
					trait = lunatic
					trait = imbecile
					trait = inbred
					is_dumb_trigger = yes
					any_spouse = { is_ruler = yes }
					any_heir_title = { always = yes }
				}
				OR = {
					NOT = { age = 40 }
					any_child = {
						is_female = no
						emf_can_inherit_trigger = yes
					}
				}
			}
			custom_tooltip = { text = GRANTED_CRUSADE_FIEF }
			opinion = { who = ROOT modifier = opinion_grateful years = 20 }
			set_character_flag = wants_fief_@event_target:crusade_victor
			hidden_tooltip = {
				if = {
					limit = { ROOT = { ai = no } }
					event_target:crusade_title = {
						holder_scope = {
							character_event = { id = pb_crusades.5 }
						}
					}
				}
			}
			break = yes
		}
		random_dynasty_member = {
			limit = {
				is_adult = yes
				prisoner = no
				is_ruler = no
				religion = ROOT
				is_liege_or_above = ROOT
				health = 4.0
				piety = 0
				reverse_opinion = { who = ROOT value = 0 }
				emf_can_inherit_trigger = yes
				is_female = no
				NOR = {
					is_child_of = ROOT
					sibling = ROOT
					trait = incapable
					trait = lunatic
					trait = imbecile
					trait = inbred
					is_dumb_trigger = yes
					any_spouse = { is_ruler = yes }
					any_heir_title = { always = yes }
				}
				OR = {
					NOT = { age = 40 }
					any_child = {
						is_female = no
						emf_can_inherit_trigger = yes
					}
				}
			}
			custom_tooltip = { text = GRANTED_CRUSADE_FIEF }
			opinion = { who = ROOT modifier = opinion_grateful years = 20 }
			set_character_flag = wants_fief_@event_target:crusade_victor
		}
		hidden_tooltip = {
			if = {
				limit = { ai = no }
				event_target:crusade_title = {
					holder_scope = {
						character_event = { id = pb_crusades.5 }
					}
				}
			}
		}
	}
	option = {
		name = "EVTOPTD_Plus_401" #To a valiant retainer
		trigger = {
			any_courtier = {
				is_adult = yes
				prisoner = no
				is_ruler = no
				religion = ROOT
				is_liege_or_above = ROOT
				health = 4.0
				piety = 0
				reverse_opinion = { who = ROOT value = 0 }
				emf_can_inherit_trigger = yes
				is_female = no
				OR = {
					diplomacy = 12
					martial = 12
					stewardship = 12
					is_smart_trigger = yes
					reverse_opinion = { who = ROOT value = 75 }
					calc_true_if = {
						amount = 2
						diplomacy = 8
						martial = 8
						stewardship = 8
					}
				}
				NOR = {
					is_child_of = ROOT
					sibling = ROOT
					dynasty = ROOT
					trait = incapable
					trait = lunatic
					trait = imbecile
					trait = inbred
					is_dumb_trigger = yes
					any_spouse = { is_ruler = yes }
					any_heir_title = { always = yes }
				}
				OR = {
					NOT = { age = 40 }
					any_child = {
						is_female = no
						emf_can_inherit_trigger = yes
					}
				}
			}
			OR = {
				NOT = {
					any_child = {
						is_adult = yes
						prisoner = no
						is_ruler = no
						religion = ROOT
						is_liege_or_above = ROOT
						health = 4.0
						emf_can_inherit_trigger = yes
						is_female = no
						NOR = {
							trait = incapable
							any_spouse = { is_ruler = yes }
							any_heir_title = { always = yes }
						}
						OR = {
							NOT = { age = 40 }
							any_child = {
								is_female = no
								emf_can_inherit_trigger = yes
							}
						}
					}
				}
				NOT = {
					any_sibling = {
						is_adult = yes
						prisoner = no
						is_ruler = no
						religion = ROOT
						is_liege_or_above = ROOT
						health = 4.0
						emf_can_inherit_trigger = yes
						is_female = no
						NOR = {
							trait = incapable
							any_spouse = { is_ruler = yes }
							any_heir_title = { always = yes }
						}
						OR = {
							NOT = { age = 40 }
							any_child = {
								is_female = no
								emf_can_inherit_trigger = yes
							}
						}
					}
				}
				NOT = {
					any_dynasty_member = {
						is_adult = yes
						prisoner = no
						is_ruler = no
						religion = ROOT
						is_liege_or_above = ROOT
						health = 4.0
						piety = 0
						reverse_opinion = { who = ROOT value = 0 }
						emf_can_inherit_trigger = yes
						is_female = no
						NOR = {
							is_child_of = ROOT
							sibling = ROOT
							trait = incapable
							trait = lunatic
							trait = imbecile
							trait = inbred
							is_dumb_trigger = yes
							any_spouse = { is_ruler = yes }
							any_heir_title = { always = yes }
						}
						OR = {
							NOT = { age = 40 }
							any_child = {
								is_female = no
								emf_can_inherit_trigger = yes
							}
						}
					}
				}
			}
		}
		ai_chance = {
			factor = 5
		}
		prestige = 10
		random_courtier = {
			limit = {
				is_adult = yes
				prisoner = no
				is_ruler = no
				religion = ROOT
				is_liege_or_above = ROOT
				health = 4.0
				piety = 0
				reverse_opinion = { who = ROOT value = 0 }
				emf_can_inherit_trigger = yes
				is_female = no
				OR = {
					diplomacy = 12
					martial = 12
					stewardship = 12
					is_smart_trigger = yes
					reverse_opinion = { who = ROOT value = 75 }
					calc_true_if = {
						amount = 2
						diplomacy = 8
						martial = 8
						stewardship = 8
					}
				}
				NOR = {
					is_child_of = ROOT
					sibling = ROOT
					dynasty = ROOT
					trait = incapable
					trait = lunatic
					trait = imbecile
					trait = inbred
					is_dumb_trigger = yes
					any_spouse = { is_ruler = yes }
					any_heir_title = { always = yes }
				}
				OR = {
					NOT = { age = 40 }
					any_child = {
						is_female = no
						emf_can_inherit_trigger = yes
					}
				}
			}
			custom_tooltip = { text = GRANTED_CRUSADE_FIEF }
			opinion = { who = ROOT modifier = opinion_grateful years = 20 }
			set_character_flag = wants_fief_@event_target:crusade_victor
		}
		hidden_tooltip = {
			if = {
				limit = { ai = no }
				event_target:crusade_title = {
					holder_scope = {
						character_event = { id = pb_crusades.5 }
					}
				}
			}
		}
	}
	option = {
		name = "EVTOPTE_Plus_401" #No, our victory belongs to God
		ai_chance = {
			factor = 5
			modifier = {
				factor = 5
				trait = zealous
			}
			modifier = {
				factor = 5
				trait = content
			}
		}
		piety = 25
	}
}

# Grant fiefs to crusade participants
character_event = {
	id = pb_crusades.5
	
	is_triggered_only = yes
	hide_window = yes
	
	immediate = {
		capital_scope = {
			duchy = { save_event_target_as = capital_duchy }
		}
		any_character = {
			limit = { has_character_flag = wants_fief_@event_target:crusade_victor }
			clr_character_flag = wants_fief_@event_target:crusade_victor
			move_character = ROOT
			opinion = { who = ROOT modifier = opinion_loyal_vassal multiplier = 2 }
			if = {
				limit = {
					ROOT = {
						NOT = { demesne_efficiency = 1.00 }
					}
				}
				liege = { primary_title = { save_event_target_as = liege_title } }
				save_event_target_as = wants_fief
				event_target:liege_title = {
					ROOT = {
						random_demesne_title = {
							limit = {
								tier = COUNT
								is_feudal = yes
								NOR = {
									has_title_flag = previous_holding
									any_direct_de_jure_vassal_title = { is_holy_site = ROOT }
									duchy = { title = event_target:capital_duchy }
									kingdom = {
										capital_scope = {
											county = { title = PREVPREVPREV }
										}
									}
								}
							}
							grant_title_no_opinion  = event_target:wants_fief
							any_direct_de_jure_vassal_title = {
								limit = { holder_scope = { character = ROOT } }
								grant_title_no_opinion  = event_target:wants_fief
							}
							copy_title_laws = PREVPREV
							if = {
								limit = {
									NOR = {
										has_law = succ_gavelkind
										has_law = succ_primogeniture
										has_law = succ_seniority
										has_law = succ_feudal_elective
										has_law = succ_turkish_succession
									}
								}
								add_law = succ_primogeniture
							}
							event_target:wants_fief = {
								any_demesne_title = {
									limit = { tier = BARON }
									add_title_flag = refill_levy
								}
								character_event = { id = pb_crusades.1 days = 3 } # Refill holding levies
								recalc_succession = yes
							}
						}
					}
				}
			}
		}

		# Clear original flags
		any_landed_title = { clr_title_flag = previous_holding }
		any_character = { clr_character_flag = previous_vassal }
	}
}

# Temporarily cripple ability of Pope to quickly hire all the holy orders and mercenaries
# right after Christian Crusade creation. [Now applies to mercenaries too.]
#
# Called by on_crusade_creation on_action.
#
# ROOT = religious head
# FROM = target kingdom title
# new_character = targetted enemy
#
# NOTE: the other on_crusade_creation events seem to have a weird default scope
# (though I think this is just because they're major = yes narrative events),
# so I'm just going to code this CB-style and make no assumptions about scopes.
character_event = {
	id = pb_crusades.6

	hide_window = yes
	is_triggered_only = yes
	
	trigger = {
		can_call_crusade = yes
		ROOT = { religion_group = christian }
	}
	
	immediate = {
		ROOT = {
			# Recursively subtract chunks of piety until the Pope has < 50 points.  Keep
			# track of how much was taken so that it can be faithfully restored in full.
			character_event = { id = pb_crusades.7 }
			
			# Do the same for cash.
			character_event = { id = pb_crusades.9 }
		
			# Restore the Pope's piety (and thus ability to hire holy orders) in 2 months,
			# which should be long enough to give other rulers a chance to join the crusade,
			# hire them potentially, and mobilize, while not outright preventing the Pope's
			# piety from being used to help win the war.
			character_event = { id = pb_crusades.8 days = 60 }
			
			# Do the same for cash, but return it in only 1 months (don't want to get in the
			# way of Catholic rulers asking for money)
			character_event = { id = pb_crusades.10 days = 30 }
		}
	}
}

# Recursively subtract piety from ROOT and save it in a karmic debt counter.
# Invoked by pb_crusades.6
character_event = {
	id = pb_crusades.7

	hide_window = yes
	is_triggered_only = yes
	
	trigger = {
		piety = 50
	}
	
	immeditate = {
		piety = -50
		change_variable = { which = crusade_karma value = 1 }
		character_event = { id = pb_crusades.7 }
	}
}

# Restore the piety which was taken away from the Pope on crusade creation.
# ROOT = religious head
character_event = {
	id = pb_crusades.8
	
	hide_window = yes
	is_triggered_only = yes
	
	trigger = {
		OR = {
			check_variable = { which = crusade_karma value = 1 }
			is_variable_equal = { which = crusade_karma value = 1 }
		}
	}
	
	immediate = {
		piety = 50
		change_variable = { which = crusade_karma value = -1 }
		character_event = { id = pb_crusades.8 }
	}
}

# Recursively subtract cash from ROOT and save it in a debt counter.
# Invoked by pb_crusades.6
character_event = {
	id = pb_crusades.9

	hide_window = yes
	is_triggered_only = yes
	
	trigger = {
		wealth = 100
	}
	
	immediate = {
		wealth = -100
		change_variable = { which = crusade_cash value = 1 }
		character_event = { id = pb_crusades.9 }
	}
}

# Restore the cash which was taken away from the Pope on crusade creation.
# ROOT = religious head
character_event = {
	id = pb_crusades.10

	hide_window = yes
	is_triggered_only = yes
	
	trigger = {
		OR = {
			check_variable = { which = crusade_cash value = 1 }
			is_variable_equal = { which = crusade_cash value = 1 }
		}
	}
	
	immediate = {
		wealth = 100
		change_variable = { which = crusade_cash value = -1 }
		character_event = { id = pb_crusades.10 }
	}
}

# Unlock crusades for the scenario (MTTH event).
#
# This starts its random countdown after the official "Crusader Kings"
# vanilla unlock event.
character_event = {
	id = pb_crusades.13

	hide_window = yes
	
	only_playable = yes
	religion = catholic
	
	trigger = {
		has_landed_title = k_papal_state
		has_global_flag = christian_crusades_unlocked # Unlocked at same time as jihad and before GHWs
		NOT = { has_global_flag = emf_crusades_unlocked }
	}
	
	mean_time_to_happen = {
		years = 5
		modifier = {
			factor = 0.01
			had_global_flag = { flag = christian_crusades_unlocked days = 3650 }
		}
	}
	
	immediate = {
		set_global_flag = emf_crusades_unlocked
	}
}

# Unlock crusades for the scenario: Catholics (MTTH event).
#
# This starts its random countdown along with the Muslim version once
# pb_crusades.13 fires.
character_event = {
	id = pb_crusades.14

	hide_window = yes

	only_playable = yes
	religion = catholic

	trigger = {
		has_landed_title = k_papal_state
		has_global_flag = emf_crusades_unlocked
		NOT = { has_global_flag = emf_catholic_crusades_unlocked }
	}

	mean_time_to_happen = {
		years = 5
		
		modifier = {
			factor = 0.01
			had_global_flag = { flag = emf_crusades_unlocked days = 3650 }
		}
	}

	immediate = {
		set_global_flag = emf_catholic_crusades_unlocked
	}

	option = { name = OK }
}

# Unlock crusades for the scenario: Muslims (MTTH event).
#
# This starts its random countdown along with the Muslim version once
# pb_crusades.13 fires.
character_event = {
	id = pb_crusades.15

	hide_window = yes

	only_playable = yes
	religion = catholic

	trigger = {
		has_landed_title = k_papal_state
		has_global_flag = emf_crusades_unlocked
		NOT = { has_global_flag = emf_muslim_crusades_unlocked }
	}

	mean_time_to_happen = {
		years = 5
		
		modifier = {
			factor = 0.01
			had_global_flag = { flag = emf_crusades_unlocked days = 3650 }
		}
	}

	immediate = {
		set_global_flag = emf_muslim_crusades_unlocked
	}
}

