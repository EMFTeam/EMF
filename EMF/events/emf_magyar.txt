# -*- ck2.events -*-

namespace = emf_magyar

#######################################
# MAGYAR EVENTS
# Written by Rylock
#######################################

### MAGYAR PRE-MIGRATION EVENTS

# Neighboring realms turn against the Magyars
character_event = {
	id = emf_magyar.2000

	hide_window = yes
	
	religion_group = pagan_group
	only_playable = yes
	only_independent = yes

	trigger = {
		year = 890
		has_landed_title = k_magyar
		trigger_if = {
			limit = { emf_has_swmh = yes }
			culture = old_hungarian
		}
		trigger_else = {
			culture = hungarian
		}
		is_tribal = yes
		any_independent_ruler = {
			ai = yes
			war = no
			OR = {
				culture = bulgarian
				culture = pecheneg
				realm_levy_diff = { who = ROOT value = 1000 }
			}
			any_realm_province = { any_neighbor_province = { owner_under_ROOT = yes } }
			OR = {
				NOR = {
					is_allied_with = ROOT
					has_non_aggression_pact_with = ROOT
				}
				ROOT = { ai = yes }
			}
			NOR = {
				is_rival = ROOT
				has_truce = ROOT
				pays_tribute_to = ROOT
				ROOT = { pays_tribute_to = PREV }
			}
		}
		# We are still at the point where we will remain in Etelkoz
		trigger_if = {
			limit = { emf_has_swmh = yes }
			num_of_count_titles_in_realm = 10
		}
		trigger_else = {
			num_of_count_titles_in_realm = 8
		}
		NOR = {
			# We are not already in 2 or more wars
			any_war = {
				defender = { character = ROOT }
				count = 2
			}
			has_global_flag = emf_magyar_migration_completed
			year = 920
		}
		emf_alternate_start = no
	}

	mean_time_to_happen = {
		months = 6
		modifier = {
			factor = 0.25
			war = yes
		}
		#modifier = { #redundant
		#	factor = 2
		#	OR = {
		#		culture = bulgarian
		#		culture = pecheneg
		#	}
		#}
		#modifier = {
		#	factor = 2
		#	NOT = { culture = bulgarian }
		#	NOT = { culture = pecheneg }
		#}
	}

	immediate = {
		random_independent_ruler = {
			limit = {
				ai = yes
				war = no
				OR = {
					culture = bulgarian
					culture = pecheneg
					realm_levy_diff = { who = ROOT value = 1000 }
				}
				any_realm_province = { any_neighbor_province = { owner_under_ROOT = yes } }
				OR = {
					NOR = {
						is_allied_with = ROOT
						has_non_aggression_pact_with = ROOT
					}
					ROOT = { ai = yes }
				}
				NOR = {
					is_rival = ROOT
					has_truce = ROOT
					pays_tribute_to = ROOT
					ROOT = { pays_tribute_to = PREV }
				}
			}
			save_event_target_as = claim_ruler
			add_rival = ROOT

			# Break any existing alliances/NAP's (AI only)
			if = {
				limit = { is_allied_with = ROOT }
				break_alliance = ROOT
			}
			if = {
				limit = { has_non_aggression_pact_with = ROOT }
				reverse_remove_opinion = { modifier = in_non_aggression_pact who = ROOT }
				remove_opinion = { modifier = in_non_aggression_pact who = ROOT }
				reverse_opinion = { modifier = broken_non_aggression_pact who = ROOT years = 35 }
			}

			# Give them a claim on a neighboring province
			random_realm_province = {
				limit = {
					any_neighbor_province = {
						owner_under_ROOT = yes
						county = {
							NOT = { claimed_by = PREVPREVPREV }
						}
					}
				}
				random_neighbor_province = {
					limit = {
						owner_under_ROOT = yes
						county = {
							NOT = { claimed_by = PREVPREVPREV }
						}
					}
					county = {
						add_claim = PREVPREVPREV
						save_event_target_as = claim_title
					}
				}
			}

			# Start the claim war if they have more levies than us
			if = {
				limit = {
					OR = {
						realm_levy_diff = { who = ROOT value = 2000 }
						AND = {
							ROOT = { ai = yes }
							realm_levy_diff = { who = ROOT value = 1000 }
						}
					}
				}
				event_target:claim_title = {
					event_target:claim_ruler = {
						war = {
							casus_belli = claim
							target = ROOT
							thirdparty_title = PREV
						}
					}
				}
			}
		}
	}
}

# Add the Magyar Divisions building
character_event = {
	id = emf_magyar.2001

	hide_window = yes
	
	religion_group = pagan_group
	only_playable = yes

	trigger = {
		is_tribal = yes
		trigger_if = {
			limit = { emf_has_swmh = yes }
			OR = {
				culture = old_hungarian
				culture = khavar
			}
		}
		trigger_else = {
			culture = hungarian
		}
		any_demesne_title = {
			tier = BARON
			holding_type = tribal
			NOT = { has_building = tb_emf_magyar_1 }
		}
		NOT = { has_global_flag = emf_magyar_migration_completed }
		year < 920
		emf_alternate_start = no
	}

	mean_time_to_happen = {
		days = 1
	}

	immediate = {
		any_demesne_title = {
			limit = {
				tier = BARON
				holding_type = tribal
				NOT = { has_building = tb_emf_magyar_1 }
			}
			add_building = tb_emf_magyar_1
		}
	}
}

# Magyar tribal ruler unlanded prior to the migration
character_event = {
	id = emf_magyar.2003

	hide_window = yes
	is_triggered_only = yes

	trigger = {
		trigger_if = {
			limit = { emf_has_swmh = yes }
			OR = {
				culture = old_hungarian
				culture = khavar
			}
		}
		trigger_else = {
			culture = hungarian
		}
		has_game_started = yes
		is_alive = yes
		is_dying = no
		prisoner = no
		is_nomadic = no
		is_incapable = no
		year < 920
		NOT = { has_global_flag = emf_magyar_migration_completed }
		emf_alternate_start = no
	}

	immediate = {
		set_flag = vassal_khan
		character_event = { id = emf_magyar.2004 days = 1 }
	}
}

character_event = {
	id = emf_magyar.2004

	hide_window = yes
	is_triggered_only = yes

	trigger = {
		trigger_if = {
			limit = { emf_has_swmh = yes }
			OR = {
				culture = old_hungarian
				culture = khavar
			}
		}
		trigger_else = {
			culture = hungarian
		}
		is_ruler = no
		is_alive = yes
		prisoner = no
		is_nomadic = no
		is_incapable = no
	}

	fail_trigger_effect = {
		clr_flag = vassal_khan
	}

	immediate = {
		k_magyar = {
			holder_scope = {
				ROOT = {
					move_character = PREV
					any_spouse = { move_character = PREVPREV }
					any_consort = { move_character = PREVPREV }
					any_child = {
						limit = {
							is_ruler = no
							OR = {
								is_adult = no
								AND = {
									emf_is_voter = no
									in_command = no
									NOT = { any_spouse = { is_ruler = yes } }
									OR = {
										is_female = no
										NOR = {
											is_married = yes
											is_consort = yes
										}
									}
								}
							}
						}
						move_character = PREVPREV
					}
					any_child_even_if_dead = {
						any_child = {
							limit = {
								is_ruler = no
								OR = {
									is_adult = no
									AND = {
										emf_is_voter = no
										in_command = no
										NOT = { any_spouse = { is_ruler = yes } }
										OR = {
											is_female = no
											NOR = {
												is_married = yes
												is_consort = yes
											}
										}
									}
								}
							}
							move_character = PREVPREVPREV
						}
					}
				}
			}
		}
	}
}


### MAGYAR MIGRATION TO CARPATHIA

# Magyar Migration Event - Start
character_event = {
	id = emf_magyar.3000

	hide_window = yes
	
	religion_group = pagan_group
	only_playable = yes
	only_independent = yes
	capable_only = yes
	prisoner = no
	min_age = 16
	war = no

	trigger = {
		trigger_if = {
			limit = { emf_has_swmh = yes }
			culture = old_hungarian
		}
		trigger_else = {
			culture = hungarian
		}
		ai = yes
		in_revolt = no
		OR = {
			is_nomadic = yes
			AND = {
				is_tribal = yes
				has_landed_title = k_magyar
			}
		}
		OR = {
			trigger_if = {
				limit = { emf_has_swmh = yes }
				NOT = { num_of_count_titles_in_realm = 7 }
			}
			trigger_else = {
				NOT = { num_of_count_titles_in_realm = 5 }
			}
			year = 895
		}
		any_realm_province = { region = emf_region_etelkoz }
		NOR = {
			has_global_flag = emf_magyar_migration_started
			any_realm_title = { de_jure_liege_or_above = k_hungary }
			trigger_if = {
				limit = { emf_has_swmh = yes }
				num_of_count_titles_in_realm = 10
			}
			trigger_else = {
				num_of_count_titles_in_realm = 8
			}
		}
		any_independent_ruler = {
			in_revolt = no
			any_realm_title = {
				tier = COUNT
				de_jure_liege_or_above = k_hungary
				is_occupied = no
				count = 3
			}
			any_realm_province = {
				county = {
					is_occupied = no
					is_contested = no
				}
				region = emf_region_lower_carpathia
			}
			NOR = {
				reverse_has_truce = ROOT
				is_allied_with = ROOT
				has_non_aggression_pact_with = ROOT
				pays_tribute_to = ROOT
			}
		}
		emf_alternate_start = no
	}

	mean_time_to_happen = {
		months = 6
		modifier = {
			factor = 0.5
			year = 900
		}
		modifier = {
			factor = 0.1
			year = 905
		}
		modifier = {
			factor = 0.1
			trigger_if = {
				limit = { emf_has_swmh = yes }
				NOT = { num_of_count_titles_in_realm = 7 }
			}
			trigger_else = {
				NOT = { num_of_count_titles_in_realm = 5 }
			}
		}
		modifier = {
			factor = 0.01
			trigger_if = {
				limit = { emf_has_swmh = yes }
				NOT = { num_of_count_titles_in_realm = 5 }
			}
			trigger_else = {
				NOT = { num_of_count_titles_in_realm = 3 }
			}
		}
	}

	immediate = {
		set_global_flag = emf_magyar_migration_started
		disband_event_forces = start_troops
		if = {
			limit = {
				k_hungary = { NOT = { has_flag = migration_troops_received } }
			}
			capital_scope = {
				while = {
					count = 18
					limit = { always = yes }
					ROOT = {
						spawn_unit = {
							province = PREV
							owner = THIS
							merge = yes
							maintenance_multiplier = 0
							attrition = 0.25
							troops = {
								horse_archers = { 250 250 }
							}
							reinforces = yes
						}
					}
				}
				if = {
					limit = { emf_has_swmh = yes }
					while = {
						count = 42
						limit = { always = yes }
						ROOT = {
							spawn_unit = {
								province = PREV
								owner = THIS
								merge = yes
								maintenance_multiplier = 0
								attrition = 0.25
								troops = {
									horse_archers = { 250 250 }
								}
								earmark = magyar_migration_troops
							}
						}
					}
				}
				else = {
					while = {
						count = 21
						limit = { always = yes }
						ROOT = {
							spawn_unit = {
								province = PREV
								owner = THIS
								merge = yes
								maintenance_multiplier = 0
								attrition = 0.25
								troops = {
									horse_archers = { 250 250 }
								}
								earmark = magyar_migration_troops
							}
						}
					}
				}
			}
			k_hungary = { set_flag = migration_troops_received }
		}

		# Pick largest valid target in Hungary
		random_independent_ruler = {
			limit = {
				NOR = {
					reverse_has_truce = ROOT
					is_allied_with = ROOT
					has_non_aggression_pact_with = ROOT
					pays_tribute_to = ROOT
				}
				any_realm_province = {
					region = emf_region_lower_carpathia
					county = {
						is_occupied = no
						is_contested = no
					}
				}
				any_realm_title = {
					tier = COUNT
					de_jure_liege_or_above = k_hungary
					is_occupied = no
				}
			}
			preferred_limit = {
				any_realm_title = {
					count = 7
					tier = COUNT
					de_jure_liege_or_above = k_hungary
					is_occupied = no
				}
			}
			preferred_limit = {
				any_realm_title = {
					count = 6
					tier = COUNT
					de_jure_liege_or_above = k_hungary
					is_occupied = no
				}
			}
			preferred_limit = {
				any_realm_title = {
					count = 5
					tier = COUNT
					de_jure_liege_or_above = k_hungary
					is_occupied = no
				}
			}
			preferred_limit = {
				any_realm_title = {
					count = 4
					tier = COUNT
					de_jure_liege_or_above = k_hungary
					is_occupied = no
				}
			}
			preferred_limit = {
				any_realm_title = {
					count = 3
					tier = COUNT
					de_jure_liege_or_above = k_hungary
					is_occupied = no
				}
			}
			character_event = { id = emf_magyar.3001 }
		}
	}
}

# Target realm must decide whether to oppose the migration
character_event = {
	id = emf_magyar.3001
	desc = EVTDESC_emf_magyar_3001
	picture = GFX_evt_magyars

	is_triggered_only = yes

	option = {
		name = EVTOPTA_emf_magyar_3001 # Let them be
		trigger = {
			OR = {
				NOT = { capital_scope = { kingdom = { title = k_hungary } } }
				culture = avar # No evidence of fighting with the Avars
				culture = russian # No evidence of fighting with the White Croats
				ai = no
			}
		}
		k_hungary = {
			FROM = {
				gain_settlements_under_title = {
					title = PREV
					enemy = ROOT
					is_crusade = yes
					type = invasion
				}
			}
		}
		hidden_tooltip = {
			FROM = {
				character_event = { id = emf_magyar.3002 } # Begin migration
			}
		}
	}
	option = {
		name = EVTOPTB_emf_magyar_3001 # Fight them!
		trigger = {
			OR = {
				AND = {
					capital_scope = { kingdom = { title = k_hungary } }
					NOR = {
						culture = avar # No evidence of fighting with the Avars
						culture = russian # No evidence of fighting with the White Croats
					}
				}
				ai = no
			}
		}
		reverse_war = {
			casus_belli = emf_magyar_invasion
			target = FROM
			thirdparty_title = k_hungary
			infamy = 0
		}
	}
}

# Migration takes place
# NOTE: this is fired either from the event (if the target agrees to allow the migration to happen peacefully)
# or from the on_success condition in the emf_magyar_invasion cb
character_event = {
	id = emf_magyar.3002
	desc = EVTDESC_emf_magyar_3002
	picture = GFX_evt_magyars

	is_triggered_only = yes

	immediate = {
		set_global_flag = emf_magyar_migration_completed
		wealth = 250
		prestige = 250

		# Remove tributary statuses
		if = {
			limit = { is_tributary = yes }
			suzerain = { remove_tributary = ROOT }
		}
		any_tributary = {
			ROOT = { remove_tributary = PREV }
		}

		# Hungarian provinces no longer in the realm lose Hungarian culture
		any_province = {
			limit = {
				trigger_if = {
					limit = { emf_has_swmh = yes }
					OR = {
						culture = old_hungarian
						culture = khavar
					}
				}
				trigger_else = {
					culture = hungarian
				}
				NOT = { kingdom = { title = k_hungary } }
				owner = {
					trigger_if = {
						limit = { emf_has_swmh = yes }
						NOR = {
							culture = old_hungarian
							culture = khavar
						}
					}
					trigger_else = {
						NOT = { culture = hungarian }
					}
					under_ROOT = no
				}
			}
			province_event = { id = emf_magyar.3006 days = 1 }
		}

		# Inform players
		any_playable_ruler = {
			limit = {
				NOT = { character = ROOT }
				is_within_diplo_range = ROOT
			}
			narrative_event = { id = emf_magyar.3005 }
		}
	}

	option = {
		name = EVTOPTA_emf_magyar_3002
		trigger = { is_nomadic = yes }
		custom_tooltip = { text = WILL_MIGRATE_TO_HUNGARY }

		hidden_tooltip = {
			clan_title = { save_event_target_as = liege_clan }
			# Deal with Khavar vassals (SWMH only)
			if = {
				limit = { emf_has_swmh = yes }
				any_realm_lord = {
					limit = {
						ai = yes
						is_playable = yes
						culture = khavar
					}
					opinion = { who = ROOT modifier = opinion_support_migration years = 25 }
					# Move their courtiers to the liege's court
					any_courtier = {
						limit = {
							is_ruler = no
							OR = {
								is_close_relative = PREV
								dynasty = PREV
								martial = 10
							}
						}
						move_character = ROOT
					}
					# Destroy any titles of Duke+
					any_demesne_title = {
						limit = { higher_tier_than = COUNT }
						unsafe_destroy_landed_title = THIS
					}
					set_defacto_liege = ROOT
					# Mark them so they prompt to get land later
					set_flag = vassal_khan
					set_immune_to_pruning = yes
					# Gain all their remaining titles
					any_demesne_title = { grant_title = ROOT }
					# Move them to the liege's court
					move_character = ROOT
				}
			}

			# All non-Hungarian or player vassals in the realm go free
			any_realm_lord = {
				limit = {
					is_playable = yes
					OR = {
						trigger_if = {
							limit = { emf_has_swmh = yes }
							NOR = {
								culture = old_hungarian
								culture = khavar
							}
						}
						trigger_else = {
							NOT = { culture = hungarian }
						}
						ai = no
					}
				}
				set_defacto_liege = THIS
			}

			# Switch over to Tribal government
			any_vassal = {
				limit = { is_nomadic = yes }
				set_government_type = tribal_government
				set_defacto_liege = ROOT
			}
			set_government_type = tribal_government

			# Destroy any duchies
			any_demesne_title = {
				limit = {
					tier = DUKE
					is_titular = no
				}
				destroy_landed_title = THIS
			}

			# Deal with hungarian vassals in the realm
			any_playable_ruler = {
				limit = {
					same_realm = ROOT
					trigger_if = {
						limit = { emf_has_swmh = yes }
						culture = old_hungarian
					}
					trigger_else = {
						culture = hungarian
					}
				}
				opinion = { who = ROOT modifier = opinion_support_migration years = 25 }
				# Destroy any titles of Duke+
				any_demesne_title = {
					limit = { higher_tier_than = COUNT }
					unsafe_destroy_landed_title = THIS
				}
				set_defacto_liege = ROOT
				# Move their courtiers to the liege's court
				any_courtier = {
					limit = {
						is_ruler = no
						OR = {
							is_close_relative = PREV
							dynasty = PREV
							martial = 10
						}
					}
					move_character = ROOT
				}
				# Mark them so they prompt to get land later
				set_flag = vassal_khan
				set_immune_to_pruning = yes
				# Gain all their remaining titles
				any_demesne_title = { grant_title = ROOT }
				# Move them to the liege's court
				move_character = ROOT
			}

			# Hungarian and Khazar provinces in the Etelkoz are lost
			any_realm_province = {
				limit = {
					kingdom = {
						NOT = { title = k_hungary }
					}
				}
				# Build a tribal holding if it's empty
				if = {
					limit = { NOT = { num_of_settlements  = 1 } }
					build_holding = { type = tribal }
				}
				# Mark any existing settlements so they don't get destroyed
				any_province_holding = { set_flag = do_not_destroy }
				# Find a neighboring province of a different culture, if one is available
				if = {
					limit = {
						has_owner = yes
						trigger_if = {
							limit = { emf_has_swmh = yes }
							NOR = {
								culture = old_hungarian
								culture = khavar
							}
						}
						trigger_else = {
							NOT = { culture = hungarian }
						}
					}
					save_event_target_as = neighbor_province
				}
				if = {
					limit = { NOT = { event_target:neighbor_province = { always = yes } } }
					random_neighbor_province = {
						limit = {
							has_owner = yes
							trigger_if = {
								limit = { emf_has_swmh = yes }
								NOR = {
									culture = old_hungarian
									culture = khavar
								}
							}
							trigger_else = {
								NOT = { culture = hungarian }
							}
						}
						save_event_target_as = neighbor_province
					}
				}
				if = {
					limit = { NOT = { event_target:neighbor_province = { always = yes } } }
					ROOT = { location = { save_event_target_as = neighbor_province } }
				}
				# Now create a peasant leader of the new culture/religion
				county = {
					create_character = {
						random_traits = yes
						dynasty = RANDOM
						religion = event_target:neighbor_province
						culture = event_target:neighbor_province
						female = no
						age = 25
						trait = peasant_ruler
					}
					new_character = {
						save_event_target_as = new_province_owner
						emf_new_character_peasant = yes
					}
					grant_title = event_target:new_province_owner
					any_direct_de_jure_vassal_title = {
						limit = { holder = ROOT }
						grant_title = event_target:new_province_owner
					}
					event_target:new_province_owner = {
						set_government_type = tribal_government
						set_defacto_liege = THIS
					}
				}
				# Then remove any new tribal holdings which have been built via the process
				any_province_holding = {
					limit = { NOT = { has_flag = do_not_destroy } }
					destroy_settlement = THIS
				}
				any_province_holding = {
					limit = { has_flag = do_not_destroy }
					clr_flag = do_not_destroy
				}
				# Then apply culture/religion change
				culture = event_target:neighbor_province
				religion = event_target:neighbor_province
			}

			# Refill levies of newly-acquired provinces
			character_event = { id = emf_crusades.1 days = 3 }
			any_demesne_title = {
				limit = { tier = BARON }
				set_flag = refill_levy
			}
		}
	}
	option = {
		name = EVTOPTA_emf_magyar_3002
		trigger = { is_tribal = yes }
		custom_tooltip = { text = WILL_MIGRATE_TO_HUNGARY }
		hidden_tooltip = {
			# Deal with Khavar vassals (SWMH only)
			if = {
				limit = { emf_has_swmh = yes }
				any_realm_lord = {
					limit = {
						ai = yes
						is_playable = yes
						culture = khavar
					}
					opinion = { who = ROOT modifier = opinion_support_migration years = 25 }
					# Move their courtiers to the liege's court
					any_courtier = {
						limit = {
							is_ruler = no
							OR = {
								is_close_relative = PREV
								dynasty = PREV
								martial = 10
							}
						}
						move_character = ROOT
					}
					# Destroy any titles of Duke+
					any_demesne_title = {
						limit = { higher_tier_than = COUNT }
						unsafe_destroy_landed_title = THIS
					}
					set_defacto_liege = ROOT
					# Mark them so they prompt to get land later
					set_flag = vassal_khan
					set_immune_to_pruning = yes
					# Gain all their remaining titles
					any_demesne_title = { grant_title = ROOT }
					# Move them to the liege's court
					move_character = ROOT
				}
			}

			# All non-Hungarian or player vassals in the realm go free
			any_realm_lord = {
				limit = {
					is_playable = yes
					OR = {
						trigger_if = {
							limit = { emf_has_swmh = yes }
							NOR = {
								culture = old_hungarian
								culture = khavar
							}
						}
						trigger_else = {
							NOT = { culture = hungarian }
						}
						ai = no
					}
				}
				set_defacto_liege = THIS
			}

			# Destroy any duchies
			any_demesne_title = {
				limit = {
					tier = DUKE
					is_titular = no
				}
				destroy_landed_title = THIS
			}

			# Deal with hungarian vassals in the realm
			any_playable_ruler = {
				limit = {
					same_realm = ROOT
					trigger_if = {
						limit = { emf_has_swmh = yes }
						culture = old_hungarian
					}
					trigger_else = {
						culture = hungarian
					}
				}
				opinion = { who = ROOT modifier = opinion_support_migration years = 25 }
				# Move their courtiers to the liege's court
				any_courtier = {
					limit = {
						is_ruler = no
						OR = {
							is_close_relative = PREV
							dynasty = PREV
							martial = 10
						}
					}
					move_character = ROOT
				}
				# Destroy any titles of Duke+
				any_demesne_title = {
					limit = { higher_tier_than = COUNT }
					unsafe_destroy_landed_title = THIS
				}
				set_defacto_liege = ROOT
				# Mark them so they prompt to get land later
				set_flag = vassal_khan
				set_immune_to_pruning = yes
				# Gain all their remaining titles
				any_demesne_title = { grant_title = ROOT }
				# Move them to the liege's court
				move_character = ROOT
			}

			# Hungarian and Khavar provinces in the Etelkoz are lost
			any_realm_province = {
				limit = {
					kingdom = {
						NOT = { title = k_hungary }
					}
				}
				# Build a tribal holding if it's empty
				if = {
					limit = { NOT = { num_of_settlements  = 1 } }
					build_holding = { type = tribal }
				}
				# Mark any existing settlements so they don't get destroyed
				any_province_holding = { set_flag = do_not_destroy }
				# Find a neighboring province of a different culture, if one is available
				if = {
					limit = {
						has_owner = yes
						trigger_if = {
							limit = { emf_has_swmh = yes }
							NOR = {
								culture = old_hungarian
								culture = khavar
							}
						}
						trigger_else = {
							NOT = { culture = hungarian }
						}
					}
					save_event_target_as = neighbor_province
				}
				if = {
					limit = { NOT = { event_target:neighbor_province = { always = yes } } }
					random_neighbor_province = {
						limit = {
							has_owner = yes
							trigger_if = {
								limit = { emf_has_swmh = yes }
								NOR = {
									culture = old_hungarian
									culture = khavar
								}
							}
							trigger_else = {
								NOT = { culture = hungarian }
							}
						}
						save_event_target_as = neighbor_province
					}
				}
				if = {
					limit = { NOT = { event_target:neighbor_province = { always = yes } } }
					ROOT = { location = { save_event_target_as = neighbor_province } }
				}
				# Now create a peasant leader of the new culture/religion
				county = {
					create_character = {
						random_traits = yes
						dynasty = RANDOM
						religion = event_target:neighbor_province
						culture = event_target:neighbor_province
						female = no
						age = 25
						trait = peasant_ruler
					}
					new_character = {
						save_event_target_as = new_province_owner
						emf_new_character_peasant = yes
					}
					grant_title = event_target:new_province_owner
					any_direct_de_jure_vassal_title = {
						limit = { holder = ROOT }
						grant_title = event_target:new_province_owner
					}
					event_target:new_province_owner = {
						set_government_type = tribal_government
						set_defacto_liege = THIS
					}
				}
				# Then remove any new tribal holdings which have been built via the process
				any_province_holding = {
					limit = { NOT = { has_flag = do_not_destroy } }
					destroy_settlement = THIS
				}
				any_province_holding = {
					limit = { has_flag = do_not_destroy }
					clr_flag = do_not_destroy
				}
				# Then apply culture/religion change
				culture = event_target:neighbor_province
				religion = event_target:neighbor_province
			}

			# TODO: use the standard effect for this in emf_core.40 (or so)
			# Refill levies of newly-acquired provinces
			character_event = { id = emf_crusades.1 days = 1 }
			any_demesne_title = {
				limit = { tier = BARON }
				set_flag = refill_levy
			}
		}
	}
}

# Notice to the rest of the world that the migration has occurred
narrative_event = {
	id = emf_magyar.3005
	title = EVTNAME_emf_magyar_3005
	desc = EVTDESC_emf_magyar_3005
	picture = GFX_evt_magyars

	is_triggered_only = yes

	option = {
		name = I_SEE
	}
}

# Hungarian provinces will join the migration
province_event = {
	id = emf_magyar.3006
	desc = EVTDESC_emf_magyar_3006
	picture = GFX_evt_magyars

	is_triggered_only = yes

	immediate = {
		owner = { save_event_target_as = emf_owner }
	}

	option = {
		name = EVTOPTA_emf_magyar_3006
		culture = event_target:emf_owner
		religion = event_target:emf_owner
	}
}


### POST-MIGRATION EVENTS

# Unlanded Magyar noble passes on vassal_khan flag
character_event = {
	id = emf_magyar.3010

	hide_window = yes
	is_triggered_only = yes

	trigger = {
		has_flag = vassal_khan
		NOT = { num_of_count_titles = 1 }
	}

	immediate = {
		if = {
			limit = {
				is_ruler = yes
				is_nomadic = yes
			}
			current_heir = {
				if = {
					limit = { NOT = { is_liege_of = ROOT } }
					set_flag = vassal_khan
				}
			}
		}
		else_if = {
			limit = {
				any_child = {
					is_ruler = no
					emf_is_preferred_gender_for_laws_of_PREV = yes
					dynasty = ROOT
					same_realm = ROOT
				}
			}
			random_child = {
				limit = {
					is_ruler = no
					emf_is_preferred_gender_for_laws_of_PREV = yes
					dynasty = ROOT
					same_realm = ROOT
					NOT = {
						any_sibling = {
							NOT = { character = PREV }
							ROOT = { PREV = { emf_is_preferred_gender_for_laws_of_PREV = yes } }
							dynasty = ROOT
							is_older_than = PREV
						}
					}
				}
				set_flag = vassal_khan
			}
		}
		else = {
			random_dynasty_member = {
				limit = {
					is_ruler = no
					emf_is_preferred_gender_for_laws_of_PREV = yes
					same_realm = ROOT
					NOT = {
						any_dynasty_member = {
							NOT = { character = PREV }
							is_ruler = no
							ROOT = { PREV = { emf_is_preferred_gender_for_laws_of_PREV = yes } }
							is_older_than = PREV
						}
					}
				}
				set_flag = vassal_khan
			}
		}
	}
}

# Unlanded Magyar noble is imprisoned by liege
character_event = {
	id = emf_magyar.3011

	hide_window = yes
	is_triggered_only = yes

	trigger = {
		has_flag = vassal_khan
		FROM = { is_liege_of = ROOT }
	}

	immediate = {
		clr_flag = vassal_khan
	}
}

# Unlanded Magyar noble requests land from their liege
character_event = {
	id = emf_magyar.3012

	hide_window = yes

	has_character_flag = vassal_khan
	min_age = 16
	capable_only = yes
	prisoner = no
	has_global_flag = emf_magyar_migration_completed

	trigger = {
		NOT = { num_of_count_titles = 1 }
		liege = {
			war = no
			culture = ROOT
			religion = ROOT
			num_of_count_titles = 4
			any_demesne_title = {
				tier = COUNT
				can_be_given_away = yes
				NOT = { title = c_pest }
				NOT = { location = { is_capital = yes } }
				location = { has_empty_holding = yes }
			}
			NOT = { has_flag = vassal_khan_request }
		}
		emf_alternate_start = no
	}

	mean_time_to_happen = {
		months = 6
		modifier = {
			factor = 0.1
			liege = { ai = yes }
		}
		modifier = {
			factor = 0.5
			trait = ambitious
		}
		modifier = {
			factor = 0.5
			trait = proud
		}
		modifier = {
			factor = 2
			trait = content
		}
		modifier = {
			factor = 2
			trait = humble
		}
	}

	immediate = {
		liege = {
			set_flag = vassal_khan_request
			random_demesne_title = {
				limit = {
					tier = COUNT
					can_be_given_away = yes
					NOT = { title = c_pest }
					NOT = { location = { is_capital = yes } }
					location = { has_empty_holding = yes }
				}
				save_event_target_as = requested_title
			}
			letter_event = { id = emf_magyar.3013 }
		}
	}
}

# Liege considers whether to grant the request
letter_event = {
	id = emf_magyar.3013
	desc = EVTDESC_emf_magyar_3013

	is_triggered_only = yes

	option = {
		name = EVTOPTA_emf_magyar_3013 # Agree
		clr_flag = vassal_khan_request
		event_target:requested_title = {
			grant_title = FROM
			any_direct_de_jure_vassal_title = {
				limit = { holder = ROOT }
				grant_title = FROM
			}
		}
		FROM = {
			opinion = { who = ROOT modifier = opinion_grateful multiplier = 2 years = 10 }
			hidden_tooltip = {
				if = {
					limit = { is_nomadic = no }
					any_spouse = {
						limit = { is_ruler = no }
						move_character = PREV
					}
					any_child = {
						limit = {
							is_adult = yes
							is_ruler = no
						}
						move_character = PREV
					}
				}
			}
		}
	}
	option = {
		name = EVTOPTB_emf_magyar_3013 # Refuse
		trigger = { ai = no }
		clr_flag = vassal_khan_request
		prestige = -100
		add_rival = FROM
		primary_title = { add_pressed_claim = FROM }
		FROM = { clr_flag = vassal_khan }
	}
}

# Avar province converts to Hungarian
province_event = {
	id = emf_magyar.3014
	desc = EVTDESC_emf_magyar_3014
	picture = GFX_evt_magyars2

	trigger = {
		culture = avar
		county = { is_occupied = no }
		owner = {
			OR = {
				culture = ROOT
				trigger_if = {
					limit = { emf_has_swmh = yes }
					OR = {
						culture = old_hungarian
						culture = khavar
					}
				}
				trigger_else = {
					culture = hungarian
				}
			}
			religion = ROOT
			top_liege = {
				trigger_if = {
					limit = { emf_has_swmh = yes }
					culture = old_hungarian
				}
				trigger_else = {
					culture = hungarian
				}
				religion = ROOT
			}
		}
		has_global_flag = emf_magyar_migration_completed
		NOT = { has_flag = hungarian_conversion }
		emf_alternate_start = no
	}

	mean_time_to_happen = {
		years = 10
		modifier = {
			factor = 0.1
			is_capital = yes
			owner = { independent = yes }
		}
		modifier = {
			factor = 2
			is_capital = no
		}
		modifier = {
			factor = 0.5
			any_neighbor_province = {
				trigger_if = {
					limit = { emf_has_swmh = yes }
					OR = {
						culture = old_hungarian
						culture = khavar
					}
				}
				trigger_else = {
					culture = hungarian
				}
				religion = ROOT
			}
		}
		modifier = {
			factor = 0.5
			has_global_flag = emf_conquest_hungary_completed
		}
	}

	option = {
		name = EXCELLENT
		save_event_target_as = emf_province
		set_flag = hungarian_conversion
		owner = {
			if = {
				limit = { culture = khavar }
				save_event_target_as = hungarian_overlord
			}
			else = {
				top_liege = { save_event_target_as = hungarian_overlord }
			}
		}
		culture = event_target:hungarian_overlord
		owner = {
			hidden_tooltip = {
				character_event = { id = emf_ambitions.1 }
				any_liege = { character_event = { id = emf_ambitions.1 } }
			}
			if = {
				limit = { culture = avar }
				culture = event_target:hungarian_overlord
			}
			hidden_tooltip = {
				any_courtier = {
					limit = {
						is_ruler = no
						culture = avar
						religion = ROOT
					}
					culture = event_target:hungarian_overlord
				}
			}
		}
		county = {
			any_direct_de_jure_vassal_title = {
				limit = {
					owner = {
						culture = avar
						religion = ROOT
					}
				}
				owner = {
					culture = event_target:hungarian_overlord
					hidden_tooltip = {
						any_courtier = {
							limit = {
								is_ruler = no
								culture = avar
								religion = ROOT
							}
							culture = event_target:hungarian_overlord
						}
					}
				}
			}
		}
	}
}

# Magyar ruler raises a force of raiders
character_event = {
	id = emf_magyar.3016

	hide_window = yes
	
	religion_group = pagan_group
	only_playable = yes
	capable_only = yes
	prisoner = no
	min_age = 16
	war = no
	has_global_flag = emf_magyar_migration_completed

	trigger = {
		ai = yes
		trigger_if = {
			limit = { emf_has_swmh = yes }
			culture = old_hungarian
		}
		trigger_else = {
			culture = hungarian
		}
		NOT = {
			has_game_rule = {
				name = raiding
				value = off
			}
		}
		martial = 10
		is_tribal = yes
		liege = { war = no }
		capital_scope = {
			kingdom = { title = k_hungary }
		}
		top_liege = { culture = ROOT }
		NOT = { has_earmarked_regiments = tribal_organize_raid }
		emf_alternate_start = no
	}

	mean_time_to_happen = {
		months = 120
		modifier = {
			factor = 2
			tier = COUNT
		}
		modifier = {
			factor = 0.75
			any_owned_bloodline = {
				has_bloodline_flag = more_raiders_bloodline
				bloodline_is_active_for = PREV
			}
		}
		job_event_mtth_modifier_martial_score = yes
	}

	immediate = {
		capital_scope = {
			if = { 
				limit = {
					ROOT = {
						any_owned_bloodline = {
							has_bloodline_flag = more_raiders_bloodline
							bloodline_is_active_for = PREV
						}
					}
				}
				ROOT = {
					spawn_unit = {
						province = PREV
						home = PREV
						owner = THIS
						match_character = THIS
						match_mult = 0.08333
						match_min = 300
						match_max = 5000
						attrition = 1.0
						cannot_inherit = yes
						earmark = tribal_organize_raid
						is_looter = yes
						can_toggle_looting = no
					}
					spawn_unit = {
						province = PREV
						home = PREV
						owner = THIS
						match_character = THIS
						match_mult = 0.07692 # Normally 0.08333, but normalized to 1.08333 due to previously spawned event troops
						match_min = 300
						match_max = 5000
						attrition = 1.0
						cannot_inherit = yes
						earmark = tribal_organize_raid
						is_looter = yes
						can_toggle_looting = no
					}
					spawn_unit = {
						province = PREV
						home = PREV
						owner = THIS
						match_character = THIS
						match_mult = 0.07143 # Normally 0.08333, but normalized to 1.16666 due to previously spawned event troops
						match_min = 300
						match_max = 5000
						attrition = 1.0
						cannot_inherit = yes
						earmark = tribal_organize_raid
						is_looter = yes
						can_toggle_looting = no
					}
				}
			}
			else = {
				ROOT = {
					spawn_unit = {
						province = PREV
						home = PREV
						owner = THIS
						match_character = THIS
						match_mult = 0.06667
						match_min = 200
						match_max = 3500
						attrition = 1.0
						cannot_inherit = yes
						earmark = tribal_organize_raid
						is_looter = yes
						can_toggle_looting = no
					}
					spawn_unit = {
						province = PREV
						home = PREV
						owner = THIS
						match_character = THIS
						match_mult = 0.0625 # Normally 0.06667, but normalized to 1.06667 due to previously spawned event troops
						match_min = 200
						match_max = 3500
						attrition = 1.0
						cannot_inherit = yes
						earmark = tribal_organize_raid
						is_looter = yes
						can_toggle_looting = no
					}
					spawn_unit = {
						province = PREV
						home = PREV
						owner = THIS
						match_character = THIS
						match_mult = 0.05883 # Normally 0.06667, but normalized to 1.13333 due to previously spawned event troops
						match_min = 200
						match_max = 3500
						attrition = 1.0
						cannot_inherit = yes
						earmark = tribal_organize_raid
						is_looter = yes
						can_toggle_looting = no
					}
				}
			}
		}
		clr_flag = tribal_organize_raid_troops
		set_flag = tribal_organize_raid_troops
		character_event = { id = 20223 days = 122 }
	}
}

# Event to prompt the Magyars to spread across Hungary
character_event = {
	id = emf_magyar.3017

	hide_window = yes
	
	religion_group = pagan_group
	only_playable = yes
	only_independent = yes
	capable_only = yes
	prisoner = no
	min_age = 16
	war = no
	has_global_flag = emf_magyar_migration_completed

	trigger = {
		ai = yes
		wealth = 0
		capital_scope = {
			kingdom = { title = k_hungary }
		}
		trigger_if = {
			limit = { emf_has_swmh = yes }
			culture = old_hungarian
		}
		trigger_else = {
			culture = hungarian
		}
		is_tribal = yes
		NOT = { has_global_flag = emf_conquest_hungary_completed }
		any_independent_ruler = {
			in_revolt = no
			reverse_realm_levy_diff = { who = ROOT value = 3000 }
			any_realm_province = {
				region = emf_region_carpathia
				any_neighbor_province = { owner_under_ROOT = yes }
			}
			OR = {
				NOR = {
					is_allied_with = ROOT
					has_non_aggression_pact_with = ROOT
				}
				ai = yes
			}
			NOR = {
				reverse_has_truce = ROOT
				pays_tribute_to = ROOT
				ROOT = { pays_tribute_to = PREV }
			}
		}
		emf_alternate_start = no
	}

	mean_time_to_happen = {
		months = 60
		modifier = {
			factor = 0.5
			trait = ambitious
		}
		modifier = {
			factor = 2
			trait = humble
		}
		modifier = {
			factor = 0.5
			year = 950
		}
		modifier = {
			factor = 0.5
			year = 1000
		}
	}

	immediate = {
		set_flag = received_event
		random_independent_ruler = {
			limit = {
				in_revolt = no
				reverse_realm_levy_diff = { who = ROOT value = 3000 }
				any_realm_province = {
					region = emf_region_carpathia
					any_neighbor_province = { owner_under_ROOT = yes }
				}
				OR = {
					NOR = {
						is_allied_with = ROOT
						has_non_aggression_pact_with = ROOT
					}
					ai = yes
				}
				NOR = {
					reverse_has_truce = ROOT
					pays_tribute_to = ROOT
					ROOT = { pays_tribute_to = PREV }
				}
			}
			if = {
				limit = { is_allied_with = ROOT }
				ROOT = { break_alliance = PREV }
			}
			if = {
				limit = { has_non_aggression_pact_with = ROOT }
				reverse_remove_opinion = { modifier = in_non_aggression_pact who = ROOT }
				opinion = { modifier = broken_non_aggression_pact who = ROOT years = 3 }
			}
			random_realm_title = {
				limit = {
					tier = COUNT
					location = {
						region = emf_region_carpathia
						any_neighbor_province = { owner_under_ROOT = yes }
					}
				}
				ROOT = {
					war = {
						casus_belli = emf_magyar_conquest_hungary
						target = PREVPREV
						thirdparty_title = PREV
						infamy = 0
					}
				}
			}
		}
	}
}

# AI Magyar ruler creates a new clan/vassal
character_event = {
	id = emf_magyar.3018

	hide_window = yes
	
	only_playable = yes
	only_independent = yes
	capable_only = yes
	prisoner = no
	min_age = 16
	war = no
	has_global_flag = emf_magyar_migration_completed

	trigger = {
		ai = yes
		is_tribal = yes
		capital_scope = {
			kingdom = { title = k_hungary }
		}
		trigger_if = {
			limit = { emf_has_swmh = yes }
			culture = old_hungarian
		}
		trigger_else = {
			culture = hungarian
		}
		num_of_count_titles > 4
		any_demesne_title = {
			tier = COUNT
			can_be_given_away = yes
			NOT = { title = c_pest }
			NOT = { location = { is_capital = yes } }
		}
		any_courtier = {
			is_ruler = no
			is_adult = yes
			is_female = no
			is_ill = no
			prisoner = no
			fertility = 0.33
			emf_can_inherit = yes
			opinion = { who = ROOT value = 20 }
			calc_true_if = {
				amount = 2
				martial = 12
				martial = 16
				diplomacy = 12
				stewardship = 12
				trait = strong
				is_smart_trigger = yes
			}
			OR = {
				dynasty = none
				ROOT = { NOT = { any_vassal = { dynasty = PREVPREV } } }
			}
			NOR = {
				practical_age = 40
				dynasty = ROOT
				is_inaccessible_trigger = yes
				trait = weak
				trait = inbred
				is_incapable = yes
				is_maimed_trigger = yes
				trait = lunatic
				trait = possessed
				trait = imbecile
			}
		}
		NOT = {
			any_courtier = { has_flag = vassal_khan }
		}
		emf_alternate_start = no
	}

	mean_time_to_happen = {
		days = 0
	}

	immediate = {
		random_courtier = {
			limit = {
				is_ruler = no
				is_adult = yes
				is_female = no
				is_ill = no
				prisoner = no
				fertility = 0.33
				emf_can_inherit = yes
				opinion = { who = ROOT value = 20 }
				calc_true_if = {
					amount = 2
					martial = 12
					martial = 16
					diplomacy = 12
					stewardship = 12
					trait = strong
					is_smart_trigger = yes
				}
				OR = {
					dynasty = none
					ROOT = { NOT = { any_vassal = { dynasty = PREVPREV } } }
				}
				NOR = {
					age = 40
					dynasty = ROOT
					is_inaccessible_trigger = yes
					trait = weak
					trait = inbred
					is_incapable = yes
					is_maimed_trigger = yes
					trait = lunatic
					trait = possessed
					trait = imbecile
				}
			}
			if = {
				limit = { dynasty = none }
				dynasty = father_bastard
			}
			save_event_target_as = new_clan_leader
		}
		random_demesne_title = {
			limit = {
				tier = COUNT
				can_be_given_away = yes
				NOT = { title = c_pest }
				NOT = { location = { is_capital = yes } }
			}
			grant_title = event_target:new_clan_leader
			any_direct_de_jure_vassal_title = {
				limit = { holder = ROOT }
				grant_title = event_target:new_clan_leader
			}
		}
		event_target:new_clan_leader = {
			if = {
				limit = { is_tribal = no }
				if = {
					limit = {
						capital_scope = {
							has_empty_holding = yes
							NOT = { any_province_holding = { holding_type = tribal } }
						}
					}
					capital_scope = {
						build_holding = { type = tribal }
					}
				}
				capital_scope = {
					random_province_holding = {
						limit = { holding_type = tribal }
						make_capital_holding = yes
					}
				}
				if = {
					limit = {
						capital_scope = {
							any_province_holding = { holding_type = tribal }
						}
					}
					set_government_type = tribal_government
				}
			}
			if = {
				limit = { NOT = { has_opinion_modifier = { who = ROOT modifier = opinion_loyal_servant } } }
				opinion = { who = ROOT modifier = opinion_loyal_servant }
			}
			set_defacto_liege = ROOT
		}
	}
}

# Extra Magyar adventurers appear
character_event = {
	id = emf_magyar.3019

	hide_window = yes
	
	religion_group = pagan_group
	only_playable = yes
	war = no
	has_global_flag = emf_magyar_migration_completed

	trigger = {
		capital_scope = {
			kingdom = { title = k_hungary }
		}
		trigger_if = {
			limit = { emf_has_swmh = yes }
			culture = old_hungarian
		}
		trigger_else = {
			culture = hungarian
		}
		NOR = {
			has_flag = received_extra_magyar_adventurer
			has_game_rule = { name = adventurers value = none }
			any_courtier = {
				is_ruler = no
				has_flag = extra_magyar_adventurer
			}
		}
		emf_alternate_start = no
	}

	mean_time_to_happen = {
		months = 24
		modifier = {
			factor = 2
			has_global_flag = emf_conquest_hungary_completed
		}
		modifier = {
			factor = 0.5
			independent = yes
		}
		modifier = {
			factor = 0.5
			is_nomadic = yes
		}
		modifier = {
			factor = 5
			has_game_rule = { name = adventurers value = rare }
		}
	}

	immediate = {
		if = {
			limit = { independent = no }
			set_flag = received_extra_magyar_adventurer
		}
		random_list = {
			50 = {
				modifier = {
					factor = 0
					has_religion_feature = religion_matriarchal
				}
				create_random_soldier = {
					random_traits = yes
					dynasty = none
					religion = ROOT
					culture = ROOT
					female = no
					age = 25
					health = 6
					attributes = {
						martial = 8
					}
					trait = skilled_tactician
					trait = ambitious
				}
			}
			50 = {
				modifier = {
					factor = 0
					gender_equality_trigger = no
					NOT = { has_religion_feature = religion_matriarchal }
				}
				create_random_soldier = {
					random_traits = yes
					dynasty = none
					religion = ROOT
					culture = ROOT
					female = yes
					age = 25
					health = 6
					attributes = {
						martial = 8
					}
					trait = skilled_tactician
					trait = ambitious
				}
			}
		}
		new_character = {
			set_flag = extra_magyar_adventurer
			opinion = { who = ROOT modifier = opinion_loyal_servant }
			set_defacto_liege = ROOT
			remove_trait = humble
			remove_trait = depressed
			remove_trait = feeble
			remove_trait = blinded
			remove_trait = celibate
			remove_trait = craven
			random = {
				chance = 50
				remove_trait = skilled_tactician
				add_trait = brilliant_strategist
			}
			random_list = {
				50 = { add_trait = brave }
				50 = { add_trait = strong }
				50 = {}
			}
			emf_dna_set_flags_for_high_health = yes
			emf_new_character_noble = yes
			if = {
				limit = { trait = imbecile }
				emf_dna_remove_trait_imbecile = yes
			}
			emf_dna_improve_homozygous_recessive_for_strength = yes
			remove_trait = delicate
			remove_trait = weak
		}
	}
}

### SETTLING IN CARPATHIA

# Magyars have conquered enough of Hungary
character_event = {
	id = emf_magyar.3020
	desc = EVTDESC_emf_magyar_3020
	picture = GFX_evt_magyars

	only_independent = yes
	capable_only = yes
	prisoner = no
	min_age = 16
	war = no
	has_global_flag = emf_magyar_migration_completed

	trigger = {
		capital_scope = {
			kingdom = { title = k_hungary }
		}
		trigger_if = {
			limit = { emf_has_swmh = yes }
			culture = old_hungarian
		}
		trigger_else = {
			culture = hungarian
		}
		k_hungary = {
			NOT = {
				any_direct_de_jure_vassal_title = {
					any_direct_de_jure_vassal_title = {
						location = {
							region = emf_region_carpathia
							owner_under_ROOT = no
						}
					}
				}
			}
		}
		NOT = { has_global_flag = emf_conquest_hungary_completed }
		emf_alternate_start = no
	}

	mean_time_to_happen = {
		days = 1
	}

	option = {
		name = EXCELLENT
		set_global_flag = emf_conquest_hungary_completed
		prestige = 1000
		wealth = 500

		if = {
			limit = { has_earmarked_regiments = magyar_migration_troops }
			disband_event_forces = magyar_migration_troops
		}
		if = {
			limit = { NOT = { is_title_active = k_hungary } }
			activate_title = { title = k_hungary status = yes }
		}
	}
}

# Hungary title name change
character_event = {
	id = emf_magyar.3021

	is_triggered_only = yes
	hide_window = yes

	trigger = {
		FROM = { title = k_hungary }
		OR = {
			has_landed_title = k_magyar
			AND = {
				culture_group = magyar
				k_hungary = { NOT = { has_flag = hungary_name_change } }
			}
			k_magyar = {
				is_title_active = THIS
				has_holder = no
			}
		}
		has_random_title_names = no
	}

	immediate = {
		if = {
			limit = {
				culture_group = magyar
				k_hungary = { NOT = { has_flag = hungary_name_change } }
			}
			set_global_flag = avar_khaganate_renamed
			k_hungary = {
				set_flag = hungary_name_change
				set_name = ""
				adjective = ""
			}
		}
		if = {
			limit = { emf_alternate_start = no }
			# If title receiver also owns the Magyar tribal title, then
			# we can safely destroy and deactivate that title now.
			k_magyar = { # Magyar
				if = {
					limit = { holder = ROOT }
					k_hungary = {
						copy_title_laws = PREV
						copy_title_history = PREV
						emf_copy_title_state_from_PREV = yes # will transfer claims, nec. flags, etc.
						emf_make_primary_title = yes
					}
				}
				if = {
					limit = {
						OR = {
							has_holder = no
							holder = ROOT
						}
					}
					hidden_tooltip = {
						# If it somehow became non-titular, then we must be sure
						# to transfer its de jure territory to k_hungary first.
						any_direct_de_jure_vassal_title = { de_jure_liege = k_hungary }
					}
					emf_destroy_title = yes
					set_flag = emf_defunct
				}
			}
		}
	}
}

# Feudal Hungarian king prompted to become Catholic
narrative_event = {
	id = emf_magyar.3022
	title = EVTNAME_emf_magyar_3022
	desc = EVTDESC_emf_magyar_3022
	picture = GFX_evt_magyars2

	major = yes

	only_independent = yes
	religion_group = pagan_group
	capable_only = yes
	prisoner = no
	min_age = 16
	has_global_flag = emf_conquest_hungary_completed

	trigger = {
		has_landed_title = k_hungary
		ai = yes
		is_feudal = yes
		trigger_if = {
			limit = { emf_has_swmh = yes }
			culture = old_hungarian
		}
		trigger_else = {
			culture = hungarian
		}
		religion_group = pagan_group
		NOT = { k_hungary = { has_flag = ai_converted_catholic } }
		emf_alternate_start = no
		emf_can_convert_religion = yes
	}

	mean_time_to_happen = {
		months = 120
		modifier = {
			factor = 5
			trait = zealous
		}
		modifier = {
			factor = 0.5
			trait = cynical
		}
	}

	immediate = {
		piety = 250
		catholic = { save_event_target_as = target_religion }
		emf_character_set_religion_to_target_religion = yes
		save_event_target_as = king_hungary
		random_realm_character = {
			limit = {
				ai = yes
				religion_group = pagan_group
				OR = {
					dynasty = ROOT
					is_close_relative = ROOT
					vassal_of = ROOT
				}
			}
			character_event = { id = emf_magyar.3023 days = 1 }
		}
	}

	option = {
		name = EVTOPTA_emf_magyar_3022
		trigger = { religion_group = christian }
	}
	option = {
		name = EVTOPTB_emf_magyar_3022
		trigger = { NOT = { religion_group = christian } }
	}
}

# Recursive conversion event for all AI vassals in Hungary
character_event = {
	id = emf_magyar.3023

	hide_window = yes
	is_triggered_only = yes

	immediate = {
		set_flag = considered_conversion
		random = {
			chance = 50
			modifier = {
				factor = 0
				OR = {
					NOT = { opinion = { who = event_target:king_hungary value = -25 } }
					trait = zealous
					emf_can_convert_religion = no
				}
			}
			modifier = {
				factor = 2
				OR = {
					opinion = { who = event_target:king_hungary value = 25 }
					trait = sympathy_christendom
					has_religion_feature = religion_syncretic_christian
					any_heir_title = { holder = event_target:king_hungary }
					AND = {
						is_ruler = no
						host = { character = event_target:king_hungary }
					}
				}
			}
			emf_character_set_religion_to_target_religion = yes
			any_child = {
				limit = {
					is_adult = no
					host = { character = PREVPREV }
					emf_can_convert_religion = yes
				}
				emf_character_set_religion_to_target_religion = yes
			}
		}
		event_target:king_hungary = {
			random_realm_character = {
				limit = {
					ai = yes
					religion_group = pagan_group
					NOT = { has_flag = considered_conversion }
					OR = {
						dynasty = PREV
						is_close_relative = PREV
						vassal_of = PREV
					}
				}
				repeat_event = { id = emf_magyar.3023 }
			}
		}
	}
}

# For Magyar players who go off the rails
character_event = {
	id = emf_magyar.3024

	hide_window = yes

	ai = no
	capable_only = yes
	prisoner = no
	min_age = 16
	war = no
	has_global_flag = emf_magyar_migration_completed

	trigger = {
		has_earmarked_regiments = magyar_migration_troops
		OR = {
			real_tier = EMPEROR
			num_of_count_titles_in_realm = 50
			trigger_if = {
				limit = { emf_has_swmh = yes }
				NOT = { culture = old_hungarian }
			}
			trigger_else = {
				NOT = { culture = hungarian }
			}
			NOT = { capital_scope = { kingdom = { title = k_hungary } } }
		}
	}

	mean_time_to_happen = {
		days = 1
	}

	immediate = {
		disband_event_forces = magyar_migration_troops
	}
}

# Magyar startup event. Called from main emf_startup.
character_event = {
	id = emf_magyar.3025

	is_triggered_only = yes
	hide_window = yes

	trigger = {
		has_landed_title = k_hungary
		NOT = { has_game_rule = { name = railroading value = passive } }
		start_date >= 907.7.4
		start_date <= 955.8.10 # Allowing for Lechfeld in theory (review actual dates of scripted war when time comes)
	}

	immediate = {
		# Spawn old_hungarian-style retinue regiments of 250 x 3 x 3 = 2250 HA, scattered about in k_hungary but
		# merged into balanced flanks
		while = {
			count = 3
			limit = { always = yes }
			random_realm_province = {
				limit = {
					owner_under_ROOT = yes
					de_jure_liege_or_above = k_hungary
					NOT = { has_flag = emf_magyar_stack_tmp }
				}
				set_flag = emf_magyar_stack_tmp
				while = {
					count = 3
					limit = { always = yes }
					ROOT = {
						spawn_unit = {
							province = PREV
							cannot_inherit = yes
							reinforces = yes
							merge = yes
							maintenance_multiplier = 0
							attrition = 1.0
							troops = {
								horse_archers = { 250 250 }
							}
						}
					}
				}
			}
		}
		any_realm_province = { clr_flag = emf_magyar_stack_tmp }
	}
}
