# -*- ck2.events -*-

namespace = HF
namespace = HFP

# Written by Joachim
# HF.49000 - HF.49199

## Fourth Crusade Event
# Start event (the moment the Crusade starts)
character_event = {
    id = HF.49000
    hide_window = yes
    is_triggered_only = yes
    has_dlc = "Holy Fury"
	# These triggers cannot change between when crusade preparation starts and whenever the 4th crusade event chain starts, so they are checked now
    trigger = {
		uses_new_crusade = yes
        has_game_rule = {
            name = fourth_crusade
            value = on
        }
    	has_global_flag = first_crusade_complete
        NOR = {
			has_global_flag = fourth_crusade_launched # TODO: Remove in next save-incompat release
			has_global_flag = fourth_crusade_complete
		}
    }
	# Bounce to Isis, who will send the actual event chain start to the Byzantine emperor at a random time betwee 30-550 days after preparation starts.
    immediate = {
    	event_target:isis = {
    		character_event = { id = emf_crusades.40 }
    	}
    }
}

## Story Events prior to the Fourth Crusade launch
# Part 1 - The Byzantine Prince/Princess flees Constantinople
narrative_event = {
    id = HF.49001
    title = EVTTITLE_HF_49001
    desc = EVTDESC_HF_49001
    picture = GFX_evt_quarrel
    border = GFX_event_narrative_frame_religion
    portrait = event_target:fourth_crusade_byzantine_refugee
    religion_group = christian
    is_triggered_only = yes
    has_dlc = "Holy Fury"
    trigger = {
		realm_size = 50
		OR = {
			has_landed_title = c_byzantion
			any_vassal = {
				has_landed_title = c_byzantion
			}
		}
		NOT = { religion = FROMFROM }
		religion_group = FROMFROM
		d_thrace = {
    		de_jure_liege = k_thrace
    	}
        e_latin_empire = {
            has_holder = no
        }
		any_dynasty_member = {
			is_ruler = no
			OR = {
				is_married = no
				NOT = { any_spouse = { is_ruler = yes } }
			}
			OR = {
				is_consort = no
				NOT = { consort = { is_ruler = yes } }
			}
			NOR = {
				any_heir_title = {
					# Cannot be heir to any title that's not a barony in someone else's capital county (emf_gavelkind 
					# would take their barony away anyway). Note if they were actually heir to the associated county, 
					# this would fail.
					NAND = {
						tier = BARON
						location = {
							is_capital = yes
							owner = {
								higher_real_tier_than = COUNT
								is_nomadic = no
								is_merchant_republic = no
								has_landed_title = PREVPREV
							}
						}
						# Exemption for appointed successors to Bishoprics under Free Investiture
						NOT = { succ_law_title = { has_law = succ_catholic_bishopric } }
					}
				}
				is_lover = ROOT
				is_friend = ROOT
			}
			is_inaccessible_or_incapable_trigger = no
			ai_ambition = 0
			mercenary = no
			holy_order = no
			age = 12
			emf_can_inherit_if_not_bastard_or_bishop_nominee = yes
			same_realm = ROOT
			NOT = { opinion = { who = ROOT value = 0 } }
			trigger_if = {
				limit = { is_female = yes }
				NOT = { ROOT = { primary_title = { succ_law_title = { has_law = agnatic_succession } } } }
			}
			trigger_else = {
				NOT = { ROOT = { primary_title = { succ_law_title = { has_law = enatic_succession } } } }
			}
			emf_isolated_character = no
		}
    	any_playable_ruler = {
    		religion = FROMFROM
    		is_patrician = yes
			OR = {
				has_pledged_crusade_participation = yes
				pledge_crusade_trigger = yes
			}
    	}
		OR = {
			has_global_flag = qa_fourth_crusade_event
			random = 50
			AND = {
				random = 75
				any_dynasty_member = {
					count = 2
					is_ruler = no
					OR = {
						is_married = no
						NOT = { any_spouse = { is_ruler = yes } }
					}
					OR = {
						is_consort = no
						NOT = { consort = { is_ruler = yes } }
					}
					NOR = {
						any_heir_title = {
							# Cannot be heir to any title that's not a barony in someone else's capital county (emf_gavelkind 
							# would take their barony away anyway). Note if they were actually heir to the associated county, 
							# this would fail.
							NAND = {
								tier = BARON
								location = {
									is_capital = yes
									owner = {
										higher_real_tier_than = COUNT
										is_nomadic = no
										is_merchant_republic = no
										has_landed_title = PREVPREV
									}
								}
								# Exemption for appointed successors to Bishoprics under Free Investiture
								NOT = { succ_law_title = { has_law = succ_catholic_bishopric } }
							}
						}
						is_lover = ROOT
						is_friend = ROOT
					}
					is_inaccessible_or_incapable_trigger = no
					ai_ambition = 0
					mercenary = no
					holy_order = no
					age = 12
					emf_can_inherit_if_not_bastard_or_bishop_nominee = yes
					same_realm = ROOT
					NOT = { opinion = { who = ROOT value = 0 } }
					trigger_if = {
						limit = { is_female = yes }
						NOT = { ROOT = { primary_title = { succ_law_title = { has_law = agnatic_succession } } } }
					}
					trigger_else = {
						NOT = { ROOT = { primary_title = { succ_law_title = { has_law = enatic_succession } } } }
					}
				}
			}
			AND = {
				random = 88
				any_dynasty_member = {
					count = 3
					is_ruler = no
					OR = {
						is_married = no
						NOT = { any_spouse = { is_ruler = yes } }
					}
					OR = {
						is_consort = no
						NOT = { consort = { is_ruler = yes } }
					}
					NOR = {
						any_heir_title = {
							# Cannot be heir to any title that's not a barony in someone else's capital county (emf_gavelkind 
							# would take their barony away anyway). Note if they were actually heir to the associated county, 
							# this would fail.
							NAND = {
								tier = BARON
								location = {
									is_capital = yes
									owner = {
										higher_real_tier_than = COUNT
										is_nomadic = no
										is_merchant_republic = no
										has_landed_title = PREVPREV
									}
								}
								# Exemption for appointed successors to Bishoprics under Free Investiture
								NOT = { succ_law_title = { has_law = succ_catholic_bishopric } }
							}
						}
						is_lover = ROOT
						is_friend = ROOT
					}
					is_inaccessible_or_incapable_trigger = no
					ai_ambition = 0
					mercenary = no
					holy_order = no
					age = 12
					emf_can_inherit_if_not_bastard_or_bishop_nominee = yes
					same_realm = ROOT
					NOT = { opinion = { who = ROOT value = 0 } }
					trigger_if = {
						limit = { is_female = yes }
						NOT = { ROOT = { primary_title = { succ_law_title = { has_law = agnatic_succession } } } }
					}
					trigger_else = {
						NOT = { ROOT = { primary_title = { succ_law_title = { has_law = enatic_succession } } } }
					}
				}
			}
			AND = {
				random = 94
				any_dynasty_member = {
					count = 4
					is_ruler = no
					OR = {
						is_married = no
						NOT = { any_spouse = { is_ruler = yes } }
					}
					OR = {
						is_consort = no
						NOT = { consort = { is_ruler = yes } }
					}
					NOR = {
						any_heir_title = {
							# Cannot be heir to any title that's not a barony in someone else's capital county (emf_gavelkind 
							# would take their barony away anyway). Note if they were actually heir to the associated county, 
							# this would fail.
							NAND = {
								tier = BARON
								location = {
									is_capital = yes
									owner = {
										higher_real_tier_than = COUNT
										is_nomadic = no
										is_merchant_republic = no
										has_landed_title = PREVPREV
									}
								}
								# Exemption for appointed successors to Bishoprics under Free Investiture
								NOT = { succ_law_title = { has_law = succ_catholic_bishopric } }
							}
						}
						is_lover = ROOT
						is_friend = ROOT
					}
					is_inaccessible_or_incapable_trigger = no
					ai_ambition = 0
					mercenary = no
					holy_order = no
					age = 12
					emf_can_inherit_if_not_bastard_or_bishop_nominee = yes
					same_realm = ROOT
					NOT = { opinion = { who = ROOT value = 0 } }
					trigger_if = {
						limit = { is_female = yes }
						NOT = { ROOT = { primary_title = { succ_law_title = { has_law = agnatic_succession } } } }
					}
					trigger_else = {
						NOT = { ROOT = { primary_title = { succ_law_title = { has_law = enatic_succession } } } }
					}
				}
			}
			AND = {
				random = 97
				any_dynasty_member = {
					count = 4
					is_ruler = no
					OR = {
						is_married = no
						NOT = { any_spouse = { is_ruler = yes } }
					}
					OR = {
						is_consort = no
						NOT = { consort = { is_ruler = yes } }
					}
					NOR = {
						any_heir_title = {
							# Cannot be heir to any title that's not a barony in someone else's capital county (emf_gavelkind 
							# would take their barony away anyway). Note if they were actually heir to the associated county, 
							# this would fail.
							NAND = {
								tier = BARON
								location = {
									is_capital = yes
									owner = {
										higher_real_tier_than = COUNT
										is_nomadic = no
										is_merchant_republic = no
										has_landed_title = PREVPREV
									}
								}
								# Exemption for appointed successors to Bishoprics under Free Investiture
								NOT = { succ_law_title = { has_law = succ_catholic_bishopric } }
							}
						}
						is_lover = ROOT
						is_friend = ROOT
					}
					is_inaccessible_or_incapable_trigger = no
					ai_ambition = 0
					mercenary = no
					holy_order = no
					age = 12
					emf_can_inherit_if_not_bastard_or_bishop_nominee = yes
					same_realm = ROOT
					NOT = { opinion = { who = ROOT value = 0 } }
					trigger_if = {
						limit = { is_female = yes }
						NOT = { ROOT = { primary_title = { succ_law_title = { has_law = agnatic_succession } } } }
					}
					trigger_else = {
						NOT = { ROOT = { primary_title = { succ_law_title = { has_law = enatic_succession } } } }
					}
				}
			}
			AND = {
				random = 99
				any_dynasty_member = {
					count = 5
					is_ruler = no
					OR = {
						is_married = no
						NOT = { any_spouse = { is_ruler = yes } }
					}
					OR = {
						is_consort = no
						NOT = { consort = { is_ruler = yes } }
					}
					NOR = {
						any_heir_title = {
							# Cannot be heir to any title that's not a barony in someone else's capital county (emf_gavelkind 
							# would take their barony away anyway). Note if they were actually heir to the associated county, 
							# this would fail.
							NAND = {
								tier = BARON
								location = {
									is_capital = yes
									owner = {
										higher_real_tier_than = COUNT
										is_nomadic = no
										is_merchant_republic = no
										has_landed_title = PREVPREV
									}
								}
								# Exemption for appointed successors to Bishoprics under Free Investiture
								NOT = { succ_law_title = { has_law = succ_catholic_bishopric } }
							}
						}
						is_lover = ROOT
						is_friend = ROOT
					}
					is_inaccessible_or_incapable_trigger = no
					ai_ambition = 0
					mercenary = no
					holy_order = no
					age = 12
					emf_can_inherit_if_not_bastard_or_bishop_nominee = yes
					same_realm = ROOT
					NOT = { opinion = { who = ROOT value = 0 } }
					trigger_if = {
						limit = { is_female = yes }
						NOT = { ROOT = { primary_title = { succ_law_title = { has_law = agnatic_succession } } } }
					}
					trigger_else = {
						NOT = { ROOT = { primary_title = { succ_law_title = { has_law = enatic_succession } } } }
					}
				}
			}
			any_dynasty_member = {
				count = 6
				is_ruler = no
				OR = {
					is_married = no
					NOT = { any_spouse = { is_ruler = yes } }
				}
				OR = {
					is_consort = no
					NOT = { consort = { is_ruler = yes } }
				}
				NOR = {
					any_heir_title = {
						# Cannot be heir to any title that's not a barony in someone else's capital county (emf_gavelkind 
						# would take their barony away anyway). Note if they were actually heir to the associated county, 
						# this would fail.
						NAND = {
							tier = BARON
							location = {
								is_capital = yes
								owner = {
									higher_real_tier_than = COUNT
									is_nomadic = no
									is_merchant_republic = no
									has_landed_title = PREVPREV
								}
							}
							# Exemption for appointed successors to Bishoprics under Free Investiture
							NOT = { succ_law_title = { has_law = succ_catholic_bishopric } }
						}
					}
					is_lover = PREV
					is_friend = PREV
				}
				is_inaccessible_or_incapable_trigger = no
				ai_ambition = 0
				mercenary = no
				holy_order = no
				age = 12
				emf_can_inherit_if_not_bastard_or_bishop_nominee = yes
				same_realm = PREV
				NOT = { opinion = { who = PREV value = 0 } }
				trigger_if = {
					limit = { is_female = yes }
					NOT = { ROOT = { primary_title = { succ_law_title = { has_law = agnatic_succession } } } }
				}
				trigger_else = {
					NOT = { ROOT = { primary_title = { succ_law_title = { has_law = enatic_succession } } } }
				}
			}
		}
    }

    immediate = {
		save_event_target_as = fourth_crusade_byzantine_emperor
		random_dynasty_member = {
			limit = {
				is_ruler = no
				OR = {
					is_married = no
					NOT = { any_spouse = { is_ruler = yes } }
				}
				OR = {
					is_consort = no
					NOT = { consort = { is_ruler = yes } }
				}
				NOR = {
					any_heir_title = {
						# Cannot be heir to any title that's not a barony in someone else's capital county (emf_gavelkind 
						# would take their barony away anyway). Note if they were actually heir to the associated county, 
						# this would fail.
						NAND = {
							tier = BARON
							location = {
								is_capital = yes
								owner = {
									higher_real_tier_than = COUNT
									is_nomadic = no
									is_merchant_republic = no
									has_landed_title = PREVPREV
								}
							}
							# Exemption for appointed successors to Bishoprics under Free Investiture
							NOT = { succ_law_title = { has_law = succ_catholic_bishopric } }
						}
					}
					is_lover = ROOT
					is_friend = ROOT
				}
				is_inaccessible_or_incapable_trigger = no
				ai_ambition = 0
				mercenary = no
				holy_order = no
				age = 12
				emf_can_inherit_if_not_bastard_or_bishop_nominee = yes
				same_realm = ROOT
				NOT = { opinion = { who = ROOT value = 0 } }
				trigger_if = {
					limit = { is_female = yes }
					NOT = { ROOT = { primary_title = { succ_law_title = { has_law = agnatic_succession } } } }
				}
				trigger_else = {
					NOT = { ROOT = { primary_title = { succ_law_title = { has_law = enatic_succession } } } }
				}
			}
			preferred_limit = {
				sibling = ROOT
				emf_is_preferred_gender_for_laws_of_PREV = yes
				is_adult = yes
			}
			preferred_limit = {
				sibling = ROOT
				is_adult = yes
			}
			preferred_limit = {
				is_child_of = ROOT
				emf_is_preferred_gender_for_laws_of_PREV = yes
				is_adult = yes
			}
			preferred_limit = {
				is_child_of = ROOT
				is_adult = yes
			}
			preferred_limit = {
				is_close_relative = ROOT
				emf_is_preferred_gender_for_laws_of_PREV = yes
				is_adult = yes
			}
			preferred_limit = {
				is_close_relative = ROOT
				is_adult = yes
			}
			preferred_limit = {
				is_aunt_uncle_of = ROOT
				emf_is_preferred_gender_for_laws_of_PREV = yes
				is_adult = yes
			}
			preferred_limit = {
				is_aunt_uncle_of = ROOT
				is_adult = yes
			}
			preferred_limit = {
				is_nibling_of = ROOT
				emf_is_preferred_gender_for_laws_of_PREV = yes
				is_adult = yes
			}
			preferred_limit = {
				is_nibling_of = ROOT
				is_adult = yes
			}
			preferred_limit = {
				is_cousin_of = ROOT
				emf_is_preferred_gender_for_laws_of_PREV = yes
				is_adult = yes
			}
			preferred_limit = {
				is_cousin_of = ROOT
				is_adult = yes
			}
			preferred_limit = {
				emf_is_preferred_gender_for_laws_of_PREV = yes
				is_adult = yes
			}
			preferred_limit = {
				is_adult = yes
			}
			preferred_limit = {
				sibling = ROOT
				emf_is_preferred_gender_for_laws_of_PREV = yes
			}
			preferred_limit = {
				sibling = ROOT
			}
			preferred_limit = {
				is_child_of = ROOT
				emf_is_preferred_gender_for_laws_of_PREV = yes
			}
			preferred_limit = {
				is_child_of = ROOT
			}
			preferred_limit = {
				is_close_relative = ROOT
				emf_is_preferred_gender_for_laws_of_PREV = yes
			}
			preferred_limit = {
				is_close_relative = ROOT
			}
			preferred_limit = {
				is_aunt_uncle_of = ROOT
				emf_is_preferred_gender_for_laws_of_PREV = yes
			}
			preferred_limit = {
				is_aunt_uncle_of = ROOT
			}
			preferred_limit = {
				is_nibling_of = ROOT
				emf_is_preferred_gender_for_laws_of_PREV = yes
			}
			preferred_limit = {
				is_nibling_of = ROOT
			}
			preferred_limit = {
				is_cousin_of = ROOT
				emf_is_preferred_gender_for_laws_of_PREV = yes
			}
			preferred_limit = {
				is_cousin_of = ROOT
			}
			preferred_limit = {
				emf_is_preferred_gender_for_laws_of_PREV = yes
			}
			save_event_target_as = fourth_crusade_byzantine_refugee
		}
    	random_playable_ruler = {
    		limit = {
    			religion = FROMFROM
    			is_patrician = yes
				OR = {
					has_pledged_crusade_participation = yes
					pledge_crusade_trigger = yes
				}
    		}
    		preferred_limit = {
    			tier = EMPEROR
				is_merchant_republic = yes
				capital_scope = {
					OR = {
						region = emf_region_west_med_seazone
						region = emf_region_east_med_seazone
						region = emf_region_black_seazone
					}
				}
    		}
    		preferred_limit = {
    			tier = KING
				is_merchant_republic = yes
				capital_scope = {
					OR = {
						region = emf_region_west_med_seazone
						region = emf_region_east_med_seazone
						region = emf_region_black_seazone
					}
				}
    		}
			preferred_limit = {
				is_merchant_republic = yes
				capital_scope = {
					OR = {
						region = emf_region_west_med_seazone
						region = emf_region_east_med_seazone
						region = emf_region_black_seazone
					}
				}
			}
			preferred_limit = {
    			tier = EMPEROR
				is_merchant_republic = yes
    		}
    		preferred_limit = {
    			tier = KING
				is_merchant_republic = yes
    		}
			preferred_limit = {
				is_merchant_republic = yes
			}
			preferred_limit = {
    			tier = KING
    		}
			preferred_limit = {
    			tier = DUKE
    		}
			preferred_limit = {
    			tier = COUNT
    		}
    		save_event_target_as = fourth_crusade_merchant_lord
    	}
		event_target:fourth_crusade_byzantine_refugee = {
			move_character = event_target:fourth_crusade_merchant_lord
			add_claim = e_byzantium
			add_claim = k_thrace
		}
		add_rival = event_target:fourth_crusade_byzantine_refugee
    }

    option = {
        name = EVTOPTA_HF_49001
        event_target:fourth_crusade_merchant_lord = {
        	narrative_event = { id = HF.49002 }
        }
		tooltip = {
			event_target:fourth_crusade_byzantine_refugee = {
				show_scope_change = no
				move_character = event_target:fourth_crusade_merchant_lord
			}
			if = {
				limit = {
					NOT = { is_rival = event_target:fourth_crusade_byzantine_refugee }
				}
				add_rival = event_target:fourth_crusade_byzantine_refugee
			}
		}
    }
}

# Part 2 - The Mercantile Refuge
narrative_event = {
    id = HF.49002
    title = EVTTITLE_HF_49002
    desc = EVTDESC_HF_49002
    picture = GFX_evt_busy_trading_dock_republic
    border = GFX_event_narrative_frame_religion
    portrait = event_target:fourth_crusade_byzantine_refugee
    religion_group = christian
    is_triggered_only = yes
    has_dlc = "Holy Fury"
    trigger = {
    	event_target:fourth_crusade_byzantine_refugee = {
    		is_alive = yes
    	}
    }

    immediate = {
    	trigger_switch = {
    		on_trigger = crusade_preparation_time_remaining
    		550 = { narrative_event = { id = HF.49003 days = 450 } }
    		450 = { narrative_event = { id = HF.49003 days = 350 } }
            350 = { narrative_event = { id = HF.49003 days = 250 } }
            250 = { narrative_event = { id = HF.49003 days = 150 }}
    		150 = { narrative_event = { id = HF.49003 days = 50 } }
    	}
    }

    option = {
        name = EVTOPTA_HF_49002
    }
}

# Part 3 - The Merchant Lord decides to restore the Byzantine Prince/Princess to her/his throne
narrative_event = {
    id = HF.49003
    title = EVTTITLE_HF_49003
    desc = EVTDESC_HF_49003
    picture = GFX_evt_courtiers_talking
    border = GFX_event_narrative_frame_religion
    portrait = event_target:fourth_crusade_byzantine_refugee
    is_triggered_only = yes
    has_dlc = "Holy Fury"
	
	religion_group = christian
	
    trigger = {
    	is_preparing_crusade = yes
    	e_byzantium = {
    		owner = {
    			NOT = { religion = ROOT }
    		}
    	}
    	event_target:fourth_crusade_byzantine_refugee = {
    		is_alive = yes
    		NOR = {
    			has_landed_title = e_byzantium
    			has_landed_title = k_thrace
    		}
    	}
    	OR = {
    		religion = catholic
    		religion = fraticelli
    	}
    }

    immediate = {
    	if = {
    		limit = {
    			NOT = {
    				event_target:fourth_crusade_byzantine_emperor = {
    					is_alive = yes
						has_landed_title = e_byzantium
    				}
    			}
    		}
    		e_byzantium = {
    			owner = {
    				save_event_target_as = fourth_crusade_byzantine_emperor
    			}
    		}
    	}
    }

    option = {
        name = EVTOPTA_HF_49003
		trigger = {
			OR = {
				has_pledged_crusade_participation = yes
				pledge_crusade_trigger = yes
			}
		}
        prestige = 100
        if = {
        	limit = { has_pledged_crusade_participation = no }
        	pledge_crusade_effect = yes
        }
        scaled_wealth = { value = 1.5 min = 300 max = 1200 }

        ROOT = {
            trigger_switch = {
                on_trigger = crusade_preparation_time_remaining
                200 = { narrative_event = { id = HF.49004 days = 180 } }
                180 = { narrative_event = { id = HF.49004 days = 160 } }
                160 = { narrative_event = { id = HF.49004 days = 140 } }
                140 = { narrative_event = { id = HF.49004 days = 120 } }
                120 = { narrative_event = { id = HF.49004 days = 100 } }
                100 = { narrative_event = { id = HF.49004 days = 80 } }
                80 = { narrative_event = { id = HF.49004 days = 60 } }
                60 = { narrative_event = { id = HF.49004 days = 40 } }
                40 = { narrative_event = { id = HF.49004 days = 20 }}
                20 = { narrative_event = { id = HF.49004 days = 0 } }
            }
        }

        any_playable_ruler = {
			# Religion check happens within the trigger for the event anyway
            trigger_switch = {
                on_trigger = crusade_preparation_time_remaining
                200 = { narrative_event = { id = HF.49004 days = 180 } }
                180 = { narrative_event = { id = HF.49004 days = 160 } }
                160 = { narrative_event = { id = HF.49004 days = 140 } }
                140 = { narrative_event = { id = HF.49004 days = 120 } }
                120 = { narrative_event = { id = HF.49004 days = 100 } }
                100 = { narrative_event = { id = HF.49004 days = 80 } }
                80 = { narrative_event = { id = HF.49004 days = 60 } }
                60 = { narrative_event = { id = HF.49004 days = 40 } }
                40 = { narrative_event = { id = HF.49004 days = 20 }}
                20 = { narrative_event = { id = HF.49004 days = 0 } }
            }
        }

        ai_chance = {
        	factor = 1
        }
    }
    option = {
        name = EVTOPTB_HF_49003
        prestige = -100

        ai_chance = {
        	factor = 0
        }
    }
}

# Part 3 - Narrative event that the Merchant Lord will support the Byzantine Prince/Princess for the Throne
narrative_event = {
    id = HF.49004
    title = EVTTITLE_HF_49004
    desc = EVTDESC_HF_49004
    picture = GFX_evt_doge_republic
    border = GFX_event_narrative_frame_religion
    has_dlc = "Holy Fury"
    is_triggered_only = yes
	
	trigger = {
    	religion = FROM
		OR = {
    		religion = catholic
    		religion = fraticelli
    	}
    	e_byzantium = { holder_scope = { NOT = { religion = FROM } } }
    	event_target:fourth_crusade_byzantine_refugee = {
    		is_alive = yes
    		NOR = {
    			has_landed_title = e_byzantium
    			has_landed_title = k_thrace
    		}
    	}
    }

    immediate = {
		if = {
    		limit = {
    			NOT = {
    				event_target:fourth_crusade_byzantine_emperor = {
    					is_alive = yes
						has_landed_title = e_byzantium
    				}
    			}
    		}
    		e_byzantium = { holder_scope = { save_event_target_as = fourth_crusade_byzantine_emperor } }
    	}
		event_target:fourth_crusade_byzantine_refugee = { set_character_flag = fourth_crusade_recipient }
		set_global_flag = 4th_crusade_official
        set_crusade_target = {
            character = event_target:fourth_crusade_byzantine_emperor
            title = k_thrace
        }
		if = {
			limit = { crusade_target_title = { title = k_thrace } }
			lock_crusade_target = yes
			set_official_crusade_recipient = event_target:fourth_crusade_byzantine_refugee
		}
		else = {
			log = "ERROR: Tried to set 4th Crusade target title to k_thrace, but failed for some reason."
		}
		# Zero out the crusade piety pot
		while = {
			limit = { crusade_piety_pot >= 1000 }
			add_to_crusade_piety_pot = -1000
		}
		while = {
			limit = { crusade_piety_pot >= 100 }
			add_to_crusade_piety_pot = -100
		}
		while = {
			limit = { crusade_piety_pot >= 10 }
			add_to_crusade_piety_pot = -10
		}
		while = {
			limit = { crusade_piety_pot >= 1 }
			add_to_crusade_piety_pot = -1
		}
    }

    option = {
        name = EVTOPTA_HF_49004
        custom_tooltip = { text = EVTOPTA_HF_49004_TT }
        if = {
        	limit = {
        		has_pledged_crusade_participation = yes
                NOT = { character = FROM }
        	}
        	scaled_wealth = { value = 0.2 min = 50 max = 200 }
        }
    }
}

# The Pope declares the launch of the Fourth Crusade
character_event = {
    id = HF.49006
    hide_window = yes
    is_triggered_only = yes
    has_dlc = "Holy Fury"
    trigger = {
    	check_if_fourth_crusade_trigger = yes
    }

    immediate = {
    	any_playable_ruler = { narrative_event = { id = HF.49007 } }
    }
}

# The Fourth Crusade Launches
narrative_event = {
    id = HF.49007
    title = EVTTITLE_HF_49007
    desc = EVTDESC_HF_49007
    picture = GFX_evt_mass_crusade
    border = GFX_event_narrative_frame_religion
    has_dlc = "Holy Fury"
    is_triggered_only = yes

	immediate = {
		random_list = {
			10 = {
				sound_effect = crusade_start_01
			}
			10 = {
				sound_effect = crusade_start_02
			}
		}
	}

    trigger = {
    }

    option = {
        name = EVTOPTA_HF_49007
        trigger = {
        	religion = FROM
            has_pledged_crusade_participation = yes
        }
        FROM = {
            show_scope_change = no
            opinion = {
                modifier = fourth_crusade_crusader
                who = ROOT
                years = 20
            }
        }
    }
    option = {
        name = EVTOPTE_HF_49007
        trigger = {
            religion = FROM
            has_pledged_crusade_participation = no
        }
    }
    option = {
        name = EVTOPTB_HF_49007
        trigger = {
        	has_landed_title = e_byzantium
        }
    }
    option = {
    	name = EVTOPTC_HF_49007
    	trigger = {
    		NOR = {
				religion_group = FROM
				emf_syncretized_religion_with_FROM = yes
			}
    	}
    }
    option = {
    	name = EVTOPTD_HF_49007
    	trigger = {
    		NOR = {
    			religion = FROM
    			has_landed_title = e_byzantium
    		}
    		OR = {
				religion_group = FROM
				emf_syncretized_religion_with_FROM = yes
			}
    	}
    }
}

# Byzantium falls
narrative_event = {
    id = HF.49008
    title = EVTTITLE_HF_49008
    desc = EVTDESC_HF_49008
    picture = GFX_evt_mass_crusade
    border = GFX_event_narrative_frame_religion
    portrait = event_target:latin_empire_holder
	sound = crusade_outcome_positive
    has_dlc = "Holy Fury"
    is_triggered_only = yes

    immediate = {
    	e_latin_empire = { holder_scope = { save_event_target_as = latin_empire_holder } }
		clr_character_flag = forced_to_crusade
        if = {
            limit = { has_landed_title = e_latin_empire }
            sound_effect = bloodline_added
        }
    }

    option = {
        name = EVTOPTA_HF_49008
        trigger = { religion = FROM }
    }
    option = {
        name = EVTOPTB_HF_49008
        trigger = {
        	NOR = {
				religion_group = FROM
				emf_syncretized_religion_with_FROM = yes
			}
        }
    }
    option = {
    	name = EVTOPTC_HF_49008
    	trigger = {
    		OR = {
				religion_group = FROM
				emf_syncretized_religion_with_FROM = yes
			}
    		NOT = { religion = FROM }
    	}
    }
    after = {
		if = {
			limit = { has_landed_title = e_latin_empire }
			if = {
				limit = { is_female = yes }
				create_bloodline = {
					type = destroyer_of_byzantium
					inheritance = matrilineal
				}
			}
			else = {
				create_bloodline = {
					type = destroyer_of_byzantium
				}
			}
		}
    }
}

## Crusader Bloodlines
# Grand Crusader Bloodline
narrative_event = {
    id = HF.49020
    title = EVTTITLE_HF_49020
    desc = EVTDESC_HF_49020
    picture = GFX_evt_knight_kneeling
    border = GFX_event_narrative_frame_religion
    has_dlc = "Holy Fury"
    is_triggered_only = yes

    trigger = {
        NOT = {
            any_owned_bloodline = {
                has_bloodline_flag = crusader_bloodline
                founder = { character = ROOT }
            }
        }
    }

    immediate = {
        sound_effect = bloodline_added
    }

    option = {
        name = EVTOPTA_HF_49020
        if = {
            limit = { is_female = yes }
            create_bloodline = {
                type = grand_crusader
                inheritance = matrilineal
            }
        }
		else = {
			create_bloodline = {
                type = grand_crusader
            }
		}
        set_bloodline_founder_religion_flag_effect = yes
    }
}

# Crusader Commander Bloodline
narrative_event = {
    id = HF.49021
    title = EVTTITLE_HF_49021
    desc = EVTDESC_HF_49021
    picture = GFX_evt_melee
    border = GFX_event_narrative_frame_religion
    is_triggered_only = yes
    has_dlc = "Holy Fury"

    trigger = {
        NOT = {
            any_owned_bloodline = {
                has_bloodline_flag = crusader_bloodline
                founder = { character = ROOT }
            }
        }
    }

    immediate = {
        event_target:enemy_commander = { any_controlled_unit = { morale = -1 } }
        sound_effect = bloodline_added
    }

    option = {
        name = EVTOPTA_HF_49021
        if = {
            limit = { event_target:enemy_commander = { ai = yes } }
            event_target:enemy_commander = {
                death = {
                    death_reason = death_battle
                    killer = ROOT
                }
            }
        }
        if = {
            limit = { is_female = yes }
            create_bloodline = {
                type = crusader_commander
                inheritance = matrilineal
            }
        }
		else = {
            create_bloodline = {
                type = crusader_commander
            }
        }
        set_bloodline_founder_religion_flag_effect = yes
    }
}

## The Northern Crusade
# The Teutonic Order looking elsewhere - Pre event
character_event = {
    id = HF.49100
    hide_window = yes
    is_triggered_only = yes
    has_dlc = "Holy Fury"
    trigger = {
        year = 1150
        has_landed_title = d_teutonic_order
        NOR = {
            has_global_flag = northern_crusades_active
            has_global_flag = northern_crusade_failure
            has_global_flag = northern_crusade_success
            is_preparing_crusade = yes
            any_war = { using_cb = new_crusade }
        }
        has_game_rule = {
            name = northern_crusade
            value = on
        }
        is_alternate_start = no
    }

    immediate = {
        if = {
            limit = {
                any_landed_title = {
                    OR = {
                        region = world_europe_north
                        region = custom_eastern_baltic
                        region = custom_russia
                    }
                    higher_tier_than = COUNT
                    owner = {
                        religion_group = pagan_group
                        independent = yes
                    }
                }
                NOT = {
                    any_demesne_title = {
                        tier = COUNT
                        is_titular = no
                        NOR = {
                            region = world_europe_north
                            region = custom_eastern_baltic
                            region = custom_russia
                        }
                    }
                }
            }
            any_playable_ruler = {
                narrative_event = { id = HF.49101 }
            }
            333 = {
                province_event = { id = HF.49102 }
            }
        }
    }
}

# The Teutonic Order looking elsewhere event
narrative_event = {
    id = HF.49101
    desc = EVTDESC_HF_49101
    title = EVTTITLE_HF_49101
    picture = GFX_evt_crusaders
    border = GFX_event_narrative_frame_religion
    portrait = FROM
    is_triggered_only = yes
    has_dlc = "Holy Fury"
    trigger = {

    }

    immediate = {
        set_global_flag = northern_crusades_active
    }

    option = {
        name = EVTOPTA_HF_49101
        trigger = { religion = FROM }
        if = {
            limit = {
                independent = yes
                any_demesne_title = {
                    higher_tier_than = DUKE
                    OR = {
                        region = world_europe_north
                        region = custom_eastern_baltic
                        region = custom_russia
                    }
                }
                any_neighbor_independent_ruler = {
                    religion_group = pagan_group
                }
            }
            custom_tooltip = { text = EVTOPTA_HF_49101_TT }
        }
    }
    option = {
        name = EVTOPTB_HF_49101
        trigger = {
            NOT = { religion = FROM }
            OR = {
				religion_group = FROM
				emf_syncretized_religion_with_FROM = yes
			}
        }
    }
    option = {
        name = EVTOPTC_HF_49101
        trigger = {
            NOR = {
				religion_group = FROM
				emf_syncretized_religion_with_FROM = yes
			}
        }
    }
}

# Setting up Northern Crusade - 1
province_event = {
    id = HF.49102
    hide_window = yes
    is_triggered_only = yes

    immediate = {
        if = {
            limit = { has_global_flag = qa_testing }
            333 = { province_event = { id = HF.49103 days = 1 } }
        }
        else = {
            333 = { province_event = { id = HF.49103 days = 1825 random = 1825 } }
        }
    }
}

# Setting up Northern Crusade - 2
province_event = {
    id = HF.49103
    hide_window = yes
    is_triggered_only = yes

    trigger = {
        #d_teutonic_order = {
            #NOT = {
                #has_title_flag = northern_crusade_active
            #}
        #}
        is_title_active = d_teutonic_order
    }

    immediate = {
        d_teutonic_order = { holder_scope = { character_event = { id = HF.49104 } } }
    }
}

# Potentially starting the Northern Crusade
character_event = {
    id = HF.49104
    hide_window = yes
    is_triggered_only = yes
    trigger = {

    }

    immediate = {
        if = {
            limit = {
                any_independent_ruler = {
                    any_demesne_title = {
                        higher_tier_than = COUNT
                        OR = {
                            region = world_europe_north
                            region = custom_eastern_baltic
                            region = custom_russia
                        }
                    }
                    NOT = {
                        holy_order = yes
                        mercenary = yes
                    }
                }
                NOR = {
                    d_teutonic_order = { has_title_flag = northern_crusade_target }
                    k_teutonic_state = { has_title_flag = northern_crusade_target }
                }
            }
            random_independent_ruler = {
                limit = {
                    any_demesne_title = {
                        higher_tier_than = COUNT
                        OR = {
                            region = world_europe_north
                            region = custom_eastern_baltic
                            region = custom_russia
                        }
                    }
                    religion_group = pagan_group
                    NOT = {
                        holy_order = yes
                        mercenary = yes
                    }
                }
                preferred_limit = {
                    realm_size = 30
                }
                preferred_limit = {
                    realm_size = 20
                }
                preferred_limit = {
                    realm_size = 15
                }
                preferred_limit = {
                    realm_size = 10
                }
                preferred_limit = {
                    realm_size = 5
                }
                random_demesne_title = {
                    limit = {
                        higher_tier_than = COUNT
                        OR = {
                            region = world_europe_north
                            region = custom_eastern_baltic
                            region = custom_russia
                        }
                    }
                    preferred_limit = {
                        ROOT = { capital_scope = { location = { title = PREVPREVPREV } } }
                    }
                    kingdom = {
                        set_title_flag = northern_crusade_active_target
                        save_event_target_as = northern_crusade_kingdom_title
                    }
                }
                save_event_target_as = northern_crusade_target_character
            }
            d_teutonic_order = { set_title_flag = northern_crusade_active }
            character_event = { id = HF.49109 }
        }
        else = {
            333 = { province_event = { id = HF.49103 days = 100 } }
        }
    }
}

# Teutonic Order receives target suggestion
character_event = {
    id = HF.49105
    hide_window = yes
    is_triggered_only = yes
    trigger = {

    }

    immediate = {
        if = {
            limit = {
                NOR = {
                    d_teutonic_order = { has_title_flag = northern_crusade_target }
                    k_teutonic_state = { has_title_flag = northern_crusade_target }
                }
            }
            event_target:northern_crusade_potential_target = {
                random_realm_title = {
                    limit = {
                        OR = {
                            region = world_europe_north
                            region = custom_eastern_baltic
                            region = custom_russia
                        }
                    }
                    kingdom = { save_event_target_as = northern_crusade_kingdom_title }
                }
            }
            event_target:northern_crusade_asker = {
                random_realm_province = {
                    limit = {
                        OR = {
                            region = world_europe_north
                            region = custom_eastern_baltic
                            region = custom_russia
                        }
                        kingdom = { title = event_target:northern_crusade_kingdom_title }
                        owner = {
                            OR = {
								is_vassal_or_below_of = PREVPREV
                                character = PREVPREV
                            }
                        }
                    }
                    duchy = { save_event_target_as = northern_crusade_duchy_title }
                }
            }
        }
        else = {
            event_target:northern_crusade_potential_target = {
                random_realm_title = {
                    limit = {
                        tier = COUNT
                        kingdom = { has_title_flag = northern_crusade_active_target }
                    }
                    kingdom = { save_event_target_as = northern_crusade_kingdom_title }
                }
            }
            event_target:northern_crusade_asker = {
                random_realm_province = {
                    limit = {
                        kingdom = { has_title_flag = northern_crusade_active_target }
                        owner = {
                            OR = {
								is_vassal_or_below_of = PREVPREV
                                character = PREVPREV
                            }
                        }
                    }
                    duchy = { save_event_target_as = northern_crusade_duchy_title }
                }
            }
        }
        random_list = {
            # Asks for nothing but piety
            10 = {
                trigger = {
                    opinion = {
                        who = event_target:northern_crusade_asker
                        value = 1
                    }
                }
                modifier = {
                    factor = 1.5
                    opinion = {
                        who = event_target:northern_crusade_asker
                        value = 25
                    }
                }
                modifier = {
                    factor = 1.5
                    opinion = {
                        who = event_target:northern_crusade_asker
                        value = 50
                    }
                }
                modifier = {
                    factor = 1.5
                    opinion = {
                        who = event_target:northern_crusade_asker
                        value = 75
                    }
                }
                modifier = {
                    factor = 1.5
                    opinion = {
                        who = event_target:northern_crusade_asker
                        value = 90
                    }
                }
                modifier = {
                    factor = 0.5
                    NOT = {
                        opinion = {
                            who = event_target:northern_crusade_asker
                            value = 10
                        }
                    }
                }
                modifier = {
                    factor = 0.5
                    OR = {
                        trait = ambitious
                        trait = greedy
                    }
                }
                modifier = {
                    factor = 1.5
                    OR = {
                        trait = humble
                        trait = content
                    }
                }
                modifier = {
                    factor = 0.1
                    is_rival = event_target:northern_crusade_asker
                }
                event_target:northern_crusade_asker = { letter_event = { id = HF.49106 } }
            }
            # Asks for a donation of gold
            10 = {
                event_target:northern_crusade_asker = { letter_event = { id = HF.49107 } }
            }
            # Asks for a donation of land
            10 = {
                trigger = {
                    NOT = {
                        opinion = {
                            who = event_target:northern_crusade_asker
                            value = 60
                        }
                    }
                    event_target:northern_crusade_asker = {
                        any_landed_title = {
                            kingdom = { title = event_target:northern_crusade_kingdom_title }
                            owner = {
                                OR = {
									is_vassal_or_below_of = PREVPREV
                                    character = PREVPREV
                                }
                            }
                        }
                        any_demesne_province = {
                            duchy = { NOT = { title = event_target:northern_crusade_duchy_title } }
                        }
                    }
                }
                modifier = {
                    factor = 1.5
                    NOT = {
                        opinion = {
                            who = event_target:northern_crusade_asker
                            value = -10
                        }
                    }
                }
                modifier = {
                    factor = 1.5
                    NOT = {
                        opinion = {
                            who = event_target:northern_crusade_asker
                            value = 0
                        }
                    }
                }
                modifier = {
                    factor = 1.5
                    NOT = {
                        opinion = {
                            who = event_target:northern_crusade_asker
                            value = 15
                        }
                    }
                }
                modifier = {
                    factor = 0.5
                    opinion = {
                        who = event_target:northern_crusade_asker
                        value = 25
                    }
                }
                modifier = {
                    factor = 0.5
                    opinion = {
                        who = event_target:northern_crusade_asker
                        value = 50
                    }
                }
                modifier = {
                    factor = 0.5
                    opinion = {
                        who = event_target:northern_crusade_asker
                        value = 75
                    }
                }
                modifier = {
                    factor = 0.5
                    opinion = {
                        who = event_target:northern_crusade_asker
                        value = 100
                    }
                }
                modifier = {
                    factor = 1.5
                    OR = {
                        trait = ambitious
                        trait = greedy
                    }
                }
                modifier = {
                    factor = 0.5
                    OR = {
                        trait = content
                        trait = humble
                    }
                }
                modifier = {
                    factor = 3
                    is_rival = event_target:northern_crusade_asker
                }
                event_target:northern_crusade_asker = { letter_event = { id = HF.49108 } }
            }
        }
    }
}

# Piety is all that is needed
letter_event = {
    id = HF.49106
    desc = EVTDESC_HF_49106
    is_triggered_only = yes

    # Accept offer
    option = {
        name = EVTOPTA_HF_49106
        piety = -200
        if = {
            limit = { event_target:northern_crusade_potential_target = { is_alive = yes } }
            event_target:northern_crusade_potential_target = {
                save_event_target_as = northern_crusade_target_character
            }
        }
        else_if = {
            limit = {
                event_target:northern_crusade_duchy_title = { holder_scope = { religion_group = pagan_group } }
            }
            event_target:northern_crusade_duchy_title = {
                holder_scope = { save_event_target_as = northern_crusade_target_character }
            }
        }
        else_if = {
            limit = {
                event_target:northern_crusade_duchy_title = {
                    any_direct_de_jure_vassal_title = { holder_scope = { religion_group = pagan_group } }
                }
            }
            event_target:northern_crusade_duchy_title = {
                random_direct_de_jure_vassal_title = {
                    limit = { holder_scope = { religion_group = pagan_group } }
                    holder_scope = { save_event_target_as = northern_crusade_target_character }
                }
            }
        }
        if = {
            limit = { is_title_active = d_teutonic_order }
            d_teutonic_order = { holder_scope = { character_event = { id = HF.49109 } } }
        }
        else_if = {
            limit = { is_title_active = k_teutonic_state }
            k_teutonic_state = { holder_scope = { character_event = { id = HF.49109 } } }
        }
    }
    # Reject the offer
    option = {
        name = EVTOPTB_HF_49106
    }

    after = {
        clr_character_flag = northern_crusade_asked_for_help
    }
}

# Some gold will be needed
letter_event = {
    id = HF.49107
    desc = EVTDESC_HF_49107
    is_triggered_only = yes

    immediate = {
        random_list = {
            10 = {
                trigger = {
                    FROM = {
                        opinion = {
                            who = ROOT
                            value = 1
                        }
                    }
                }
                modifier = {
                    factor = 1.5
                    FROM = {
                        opinion = {
                            who = ROOT
                            value = 25
                        }
                    }
                }
                modifier = {
                    factor = 1.5
                    FROM = {
                        opinion = {
                            who = ROOT
                            value = 50
                        }
                    }
                }
                modifier = {
                    factor = 1.5
                    FROM = {
                        opinion = {
                            who = ROOT
                            value = 75
                        }
                    }
                }
                modifier = {
                    factor = 1.5
                    FROM = {
                        opinion = {
                            who = ROOT
                            value = 90
                        }
                    }
                }
                modifier = {
                    factor = 0.5
                    FROM = {
                        NOT = {
                            opinion = {
                                who = ROOT
                                value = 10
                            }
                        }
                    }
                }
                modifier = {
                    factor = 0.5
                    FROM = {
                        OR = {
                            trait = ambitious
                            trait = greedy
                        }
                    }
                }
                modifier = {
                    factor = 1.5
                    FROM = {
                        OR = {
                            trait = humble
                            trait = content
                        }
                    }
                }
                modifier = {
                    factor = 0.1
                    FROM = { is_rival = ROOT }
                }
                set_character_flag = northern_crusade_small_donation
            }
            10 = {
                set_character_flag = northern_crusade_medium_donation
            }
            10 = {
                modifier = {
                    factor = 1.5
                    FROM = {
                        NOT = {
                            opinion = {
                                who = ROOT
                                value = -10
                            }
                        }
                    }
                }
                modifier = {
                    factor = 1.5
                    FROM = {
                        NOT = {
                            opinion = {
                                who = ROOT
                                value = 0
                            }
                        }
                    }
                }
                modifier = {
                    factor = 1.5
                    FROM = {
                        NOT = {
                            opinion = {
                                who = ROOT
                                value = 15
                            }
                        }
                    }
                }
                modifier = {
                    factor = 0.5
                    FROM = {
                        opinion = {
                            who = ROOT
                            value = 25
                        }
                    }
                }
                modifier = {
                    factor = 0.5
                    FROM = {
                        opinion = {
                            who = ROOT
                            value = 50
                        }
                    }
                }
                modifier = {
                    factor = 0.5
                    FROM = {
                        opinion = {
                            who = ROOT
                            value = 75
                        }
                    }
                }
                modifier = {
                    factor = 0.5
                    FROM = {
                        opinion = {
                            who = ROOT
                            value = 100
                        }
                    }
                }
                modifier = {
                    factor = 1.5
                    FROM = {
                        OR = {
                            trait = ambitious
                            trait = greedy
                        }
                    }
                }
                modifier = {
                    factor = 0.5
                    FROM = {
                        OR = {
                            trait = content
                            trait = humble
                        }
                    }
                }
                modifier = {
                    factor = 3
                    FROM = { is_rival = ROOT }
                }
                set_character_flag = northern_crusade_large_donation
            }
        }
    }

    # Accept offer
    option = {
        name = EVTOPTA_HF_49107
        if = {
            limit = { has_character_flag = northern_crusade_small_donation }
            scaled_wealth = { value = -0.3 min = -50 max = -200 }
        }
        else_if = {
            limit = { has_character_flag = northern_crusade_medium_donation }
            scaled_wealth = { value = -0.6 min = -100 max = -400 }
        }
        else = {
            scaled_wealth = { value = -1 min = -200 max = -800 }
        }
        piety = -200
        if = {
            limit = { event_target:northern_crusade_potential_target = { is_alive = yes } }
            event_target:northern_crusade_potential_target = {
                save_event_target_as = northern_crusade_target_character
            }
        }
        else_if = {
            limit = {
                event_target:northern_crusade_duchy_title = { holder_scope = { religion_group = pagan_group } }
            }
            event_target:northern_crusade_duchy_title = {
                holder_scope = { save_event_target_as = northern_crusade_target_character }
            }
        }
        else_if = {
            limit = {
                event_target:northern_crusade_duchy_title = {
                    any_direct_de_jure_vassal_title = { holder_scope = { religion_group = pagan_group } }
                }
            }
            event_target:northern_crusade_duchy_title = {
                random_direct_de_jure_vassal_title = {
                    limit = { holder_scope = { religion_group = pagan_group } }
                    holder_scope = { save_event_target_as = northern_crusade_target_character }
                }
            }
        }
        if = {
            limit = { is_title_active = d_teutonic_order }
            d_teutonic_order = { holder_scope = { character_event = { id = HF.49109 } } }
        }
        else_if = {
            limit = { is_title_active = k_teutonic_state }
            k_teutonic_state = { holder_scope = { character_event = { id = HF.49109 } } }
        }
    }
    # Reject the offer
    option = {
        name = EVTOPTB_HF_49107
    }

    after = {
        clr_character_flag = northern_crusade_small_donation
        clr_character_flag = northern_crusade_medium_donation
        clr_character_flag = northern_crusade_large_donation
        clr_character_flag = northern_crusade_asked_for_help
    }
}

# Some land will be needed
letter_event = {
    id = HF.49108
    desc = EVTDESC_HF_49108
    is_triggered_only = yes

    # Accept offer
    option = {
        name = EVTOPTA_HF_49108
        custom_tooltip = {
            text = EVTOPTA_HF_49108_TT

            any_realm_lord = {
                any_demesne_title = {
                    limit = {
						can_be_given_away = yes
                        OR = {
                            tier = COUNT
                            tier = BARON
                        }
						NOR = {
							holding_type = family_palace
							holding_type = nomad
						}
                        location = { duchy = { title = event_target:northern_crusade_duchy_title } }
                    }
                    grant_title_no_opinion = FROM
                }
            }
            any_demesne_title = {
                limit = {
                    can_be_given_away = yes
					OR = {
						tier = COUNT
						tier = BARON
					}
					NOR = {
						holding_type = family_palace
						holding_type = nomad
					}
                    location = { duchy = { title = event_target:northern_crusade_duchy_title } }
                }
                grant_title_no_opinion = FROM
            }
            if = {
                limit = {
                    FROM = {
                        capital_scope = {
                            location = { duchy = { title = event_target:northern_crusade_duchy_title } }
                        }
                    }
                }
                FROM = {
                    teutonic_order_upgrade_capital_effect = yes
                    character_event = { id = HFP.41090 days = 1 }
                }
            }
            FROM = {
                if = {
                    limit = { NOT = { realm_size = 10 } }
                    teutonic_order_upgrade_capital_effect = yes
                }
                holy_order_distribute_titles_effect = yes
            }
        }
        piety = -200
        if = {
            limit = { event_target:northern_crusade_potential_target = { is_alive = yes } }
            event_target:northern_crusade_potential_target = {
                save_event_target_as = northern_crusade_target_character
            }
        }
        else_if = {
            limit = {
                event_target:northern_crusade_duchy_title = { holder_scope = { religion_group = pagan_group } }
            }
            event_target:northern_crusade_duchy_title = {
                holder_scope = { save_event_target_as = northern_crusade_target_character }
            }
        }
        else_if = {
            limit = {
                event_target:northern_crusade_duchy_title = {
                    any_direct_de_jure_vassal_title = {
                        holder_scope = { religion_group = pagan_group }
                    }
                }
            }
            event_target:northern_crusade_duchy_title = {
                random_direct_de_jure_vassal_title = {
                    limit = { holder_scope = { religion_group = pagan_group } }
                    holder_scope = { save_event_target_as = northern_crusade_target_character }
                }
            }
        }
        if = {
            limit = { is_title_active = d_teutonic_order }
            d_teutonic_order = { holder_scope = { character_event = { id = HF.49109 } } }
        }
        else_if = {
            limit = { is_title_active = k_teutonic_state }
            k_teutonic_state = { holder_scope = { character_event = { id = HF.49109 } } }
        }
    }
    # Reject the offer
    option = {
        name = EVTOPTB_HF_49108
    }

    after = {
        clr_character_flag = northern_crusade_asked_for_help
    }
}

# The donation has been given to the Teutonics, and they launch the Northern Crusade
character_event = {
    id = HF.49109
    hide_window = yes
    is_triggered_only = yes
    trigger = {

    }

    immediate = {
        if = {
            limit = {
                NOR = {
                    d_teutonic_order = { has_title_flag = northern_crusade_target }
                    k_teutonic_state = { has_title_flag = northern_crusade_target }
                }
            }
            event_target:northern_crusade_target_character = {
                any_landed_title = {
                    limit = {
                        tier = DUKE
                        kingdom = { title = event_target:northern_crusade_kingdom_title }
                        any_direct_de_jure_vassal_title = {
                            holder_scope = {
                                OR = {
									is_vassal_or_below_of = event_target:northern_crusade_target_character
                                    character = event_target:northern_crusade_target_character
                                }
                            }
                        }
                    }
                    save_event_target_as = northern_crusade_start_duchy
                }
            }
            event_target:northern_crusade_kingdom_title = {
                set_title_flag = northern_crusade_active_target
                d_teutonic_order = {
                    save_persistent_event_target = {
                        name = teutonic_target
                        scope = PREV
                    }
                }
                k_teutonic_state = {
                    save_persistent_event_target = {
                        name = teutonic_target
                        scope = PREV
                    }
                }
            }
            unsafe_war = {
                target = event_target:northern_crusade_target_character
                casus_belli = northern_crusade_war
                thirdparty_title = event_target:northern_crusade_start_duchy
                tier = DUKE
            }
            location = { save_event_target_as = current_location }
            spawn_unit = {
                province = event_target:current_location
                home = event_target:current_location
                owner = ROOT
                troops = {
                    archers = { 1500 1500 }
                    light_infantry = { 2500 2500 }
                    heavy_infantry = { 1500 1500 }
                    light_cavalry = { 500 500 }
                }
                attrition = 0
                merge = yes
                reinforces = yes
            }
            spawn_unit = {
                province = event_target:current_location
                home = event_target:current_location
                owner = ROOT
                match_character = event_target:northern_crusade_target_character
                match_mult = 0.5
                match_min = 500
                attrition = 0
                merge = yes
                reinforces = yes
            }
            spawn_fleet = {
                province = closest
                owner = ROOT
                disband_on_peace = yes
                troops = {
                    galleys = { 80 80 }
                }
            }
            d_teutonic_order = { set_title_flag = northern_crusade_target }
            k_teutonic_state = { set_title_flag = northern_crusade_target }
            any_playable_ruler = { narrative_event = { id = HF.49110 } }
        }
        else = {
            event_target:northern_crusade_target_character = {
                any_landed_title = {
                    limit = {
                        tier = DUKE
                        kingdom = { has_title_flag = northern_crusade_active_target }
                        any_direct_de_jure_vassal_title = {
                            owner = {
                                OR = {
                                    is_vassal_or_below_of = event_target:northern_crusade_target_character
                                    character = event_target:northern_crusade_target_character
                                }
                            }
                        }
                    }
                    save_event_target_as = northern_crusade_start_duchy
                }
            }
            unsafe_war = {
                target = event_target:northern_crusade_target_character
                casus_belli = northern_crusade_war
                thirdparty_title = event_target:northern_crusade_start_duchy
                tier = DUKE
            }
        }
        any_war = {
            limit = { using_cb = northern_crusade_war }
            event_target:northern_crusade_asker = { join_attacker_wars = PREV }
        }
        character_event = { id = HF.49111 }
    }
}

# Narrative Event - Northern Crusade Launch
narrative_event = {
    id = HF.49110
    title = EVTTITLE_HF_49110
    desc = EVTDESC_HF_49110
    picture = GFX_evt_northern_crusade
    border = GFX_event_narrative_frame_religion
    is_triggered_only = yes
    trigger = {

    }

    immediate = {

    }

    option = {
        name = EVTOPTA_HF_49110
        trigger = { religion = FROM }
        show_portrait = event_target:northern_crusade_target_character
    }
    option = {
        name = EVTOPTB_HF_49110
        trigger = {
            NOR = {
				religion_group = FROM
				emf_syncretized_religion_with_FROM = yes
			}
        }
        show_portrait = event_target:northern_crusade_target_character
    }
    option = {
        name = EVTOPTC_HF_49110
        trigger = {
            NOT = { religion = FROM }
            OR = {
				religion_group = FROM
				emf_syncretized_religion_with_FROM = yes
			}
        }
        show_portrait = event_target:northern_crusade_target_character
    }
}

# Finding a supporter for the Northern Crusade
character_event = {
    id = HF.49111
    hide_window = yes
    is_triggered_only = yes
    trigger = {

    }

    immediate = {
        random_playable_ruler = {
            limit = {
                any_demesne_province = {
                    OR = {
                        region = world_europe_north
                        region = custom_eastern_baltic
                        region = custom_russia
                    }
                }
                higher_real_tier_than = BARON
                NOT = { any_war = { using_cb = northern_crusade_war } }
                religion = ROOT
            }
            preferred_limit = {
                higher_real_tier_than = DUKE
            }
            preferred_limit = {
                higher_real_tier_than = COUNT
            }
            save_event_target_as = northern_crusade_support
        }
        any_war = {
            limit = { using_cb = northern_crusade_war }
            event_target:northern_crusade_support = { join_attacker_wars = PREV }
        }
    }
}

# Reward letter from Teutons after the war
letter_event = {
    id = HF.49112
    desc = {
        trigger = { NOT = { has_character_flag = northern_crusade_gold_reward } }
        text = EVTDESC_HF_49112_A
    }
    desc = {
        trigger = { has_character_flag = northern_crusade_gold_reward }
        text = EVTDESC_HF_49112_B
    }
    is_triggered_only = yes

    immediate = {
        set_character_flag = alternate_crusade_artifact_name_teutonic
    }

    option = {
        name = EVTOPTA_HF_49112
        piety = 150
        if = {
            limit = { has_character_flag = northern_crusade_gold_reward }
            scaled_wealth = { value = 0.5 min = 100 }
        }
        if = {
            limit = { has_character_flag = northern_crusade_artifact_reward }
            alternate_crusade_artifact_distribution_effect = yes
        }
        FROM = {
            show_scope_change = no
            opinion = {
                modifier = opinion_grateful
                who = ROOT
                years = 15
            }
        }
    }

    after = {
        clr_character_flag = alternate_crusade_artifact_name_teutonic
        clr_character_flag = northern_crusade_artifact_reward
        clr_character_flag = northern_crusade_gold_reward
    }
}

# The Northern Crusades has failed
narrative_event = {
    id = HF.49113
    desc = EVTDESC_HF_49113
    title = EVTTITLE_HF_49113
    picture = GFX_evt_viking_battle_oldgods
    border = GFX_event_narrative_frame_religion
    portrait = FROM
    is_triggered_only = yes
    trigger = {

    }

    immediate = {
        set_global_flag = northern_crusade_failure
        clr_global_flag = northern_crusades_active
        sound_effect = pagan_warhorn
        any_landed_title = { clr_title_flag = northern_crusade_active_target }
    }

    option = {
        name = EVTOPTA_HF_49113
        trigger = { religion = FROM }
    }
    option = {
        name = EVTOPTB_HF_49113
        trigger = {
            NOT = { religion = FROM }
            OR = {
				religion_group = FROM
				emf_syncretized_religion_with_FROM = yes
			}
        }
    }
    option = {
        name = EVTOPTC_HF_49113
        trigger = {
            NOR = {
				religion_group = FROM
				emf_syncretized_religion_with_FROM = yes
                religion_group = pagan_group
            }
        }
    }
    option = {
        name = EVTOPTD_HF_49113
        trigger = { religion_group = pagan_group }
    }
}

# Northern Crusade Bloodline
narrative_event = {
    id = HF.49114
    desc = EVTDESC_HF_49114
    title = EVTTITLE_HF_49114
    picture = GFX_evt_bloodlines
    border = GFX_event_narrative_frame_religion
    has_dlc = "Holy Fury"
    is_triggered_only = yes
    trigger = {
        NOR = {
            any_owned_bloodline = {
                has_bloodline_flag = northern_crusade_bloodline
            }
            any_owned_bloodline = {
                has_bloodline_flag = crusader_bloodline
                founder = { character = ROOT }
            }
        }
    }

    immediate = {
        sound_effect = bloodline_added
    }

    option = {
        name = EVTOPTA_HF_49114
        add_artifact = crown_winged_helmet
        if = {
            limit = { is_female = yes }
            create_bloodline = {
                type = northern_crusade_bloodline
                inheritance = matrilineal
            }
        }
		else = {
            create_bloodline = {
                type = northern_crusade_bloodline
            }
        }
    }
}

# Northern Crusade Successful
narrative_event = {
    id = HF.49115
    desc = EVTDESC_HF_49115
    title = EVTTITLE_HF_49115
    picture = GFX_evt_crusaders
    border = GFX_event_narrative_frame_religion
    portrait = FROM
    is_triggered_only = yes
    trigger = {

    }

    immediate = {

    }

    option = {
        name = EVTOPTA_HF_49115
        trigger = { religion = FROM }
        piety = 100
    }
    option = {
        name = EVTOPTB_HF_49115
        trigger = {
            NOT = { religion = FROM }
            OR = {
				religion_group = FROM
				emf_syncretized_religion_with_FROM = yes
			}
        }
    }
    option = {
        name = EVTOPTC_HF_49115
        trigger = {
            NOR = {
				religion_group = FROM
				emf_syncretized_religion_with_FROM = yes
			}
        }
    }
}

# Northern Crusade check if victory yearly
character_event = {
    id = HF.49116
    hide_window = yes
    is_triggered_only = yes
    trigger = {
        OR = {
            has_landed_title = d_teutonic_order
            has_landed_title = k_teutonic_state
        }
    }

    immediate = {
        if = {
            limit = {
                any_demesne_title = {
                    kingdom = {
                        has_title_flag = northern_crusade_active_target
                        NOT = {
                            any_direct_de_jure_vassal_title = {
                                any_direct_de_jure_vassal_title = {
                                    holder_scope = { NOT = { religion_group = christian } }
                                }
                            }
                        }
                    }
                }
            }
            random_demesne_title = {
                limit = { kingdom = { has_title_flag = northern_crusade_active_target } }
                kingdom = {
                    save_event_target_as = northern_crusade_kingdom
                    clr_title_flag = northern_crusade_active_target
                }
            }
            religion_authority = { modifier = northern_crusade_won }
            any_playable_ruler = { narrative_event = { id = HF.49115 } }
            set_global_flag = northern_crusade_success
            clr_global_flag = northern_crusades_active
        }
    }
}

# Northern Crusade flavor event tombola
character_event = {
    id = HF.49120
    hide_window = yes
    is_triggered_only = yes
    ai = no
    trigger = {
        any_war = { using_cb = northern_crusade_war }
        religion_group = christian
        NOT = { has_character_modifier = northern_crusade_cooldown }
    }

    immediate = {
        if = {
            limit = {
                location = {
                    owner = {
                        OR = {
                            any_war = {
                                any_defender = { character = PREVPREV }
                                using_cb = northern_crusade_war
                            }
                            any_liege = {
                                any_war = {
                                    any_defender = { character = PREVPREV }
                                    using_cb = northern_crusade_war
                                }
                            }
                        }
                    }
                }
                any_war = {
                    using_cb = northern_crusade_war
                    any_attacker = { character = ROOT }
                }
                in_command = yes
                prisoner = no
            }
            set_character_flag = northern_crusade_flavor
            crusade_flavor_event_tombola_effect = yes
        }
    }

    after = {
        clr_character_flag = northern_crusade_flavor
        add_character_modifier = {
            name = northern_crusade_cooldown
            hidden = yes
            days = 25
        }
    }
}

# Northern Crusade flavor event randomizer
character_event = {
    id = HF.49121
    hide_window = yes
    is_triggered_only = yes
    ai = no
    trigger = {
        any_war = { using_cb = northern_crusade_war }
        religion_group = christian
    }

    immediate = {
        random_list = {
            # Nothing happens
            3 = {}
            1 = {
                character_event = { id = HF.49120 days = 1 random = 15 }
            }
        }
    }
}

# Crusade NAP dealing...
character_event = {
    id = HFP.49122
    hide_window = yes
    is_triggered_only = yes
    trigger = {
        is_alive = yes
        any_crusade_participant = { crusade_target_char = { has_non_aggression_pact_with = PREV } }
    }

    immediate = {
        any_crusade_participant = {
            limit = { crusade_target_char = { has_non_aggression_pact_with = PREV } }
            character_event = { id = HFP.49123 }
            #log = "[This.GetTitledFirstName] has a NAP with [crusade_target_char.GetTitledFirstName] - sending event to them"
        }
    }
}

# Sent from event above...
character_event = {
    id = HFP.49123
    hide_window = yes
    is_triggered_only = yes
    trigger = {
        is_alive = yes
        crusade_target_char = { has_non_aggression_pact_with = PREV }
    }

    immediate = {
        crusade_target_char = { save_event_target_as = sad_nap_target }
        reverse_opinion = {
            who = event_target:sad_nap_target
            modifier = broken_non_aggression_pact
        }
        prestige = -200
        add_character_modifier = {
            name = broken_non_aggression_pact_char_modifier
            years = 10
        }
    }
}
