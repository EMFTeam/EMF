# -*- ck2.events -*-


namespace = emf_mr


narrative_event = {
	id = emf_mr.1
	desc = emf_mr.1.desc
	title = emf_mr.1.title
	picture = GFX_evt_busy_trading_dock_republic
	border = GFX_event_narrative_frame_diplomacy

	is_triggered_only = yes

	immediate = {
		capital_scope = {
			duchy = {
				save_event_target_as = mr_duchy
			}
		}
	}

	option = {
		name = OK
		ai_chance = { factor = 100 }

		hidden_tooltip = {

			# Take control of capital duchy
			grant_title_no_opinion = event_target:mr_duchy

			# Shed extra higher-tier titles

			any_demesne_title = {
				limit = {
					NOR = {
						lower_tier_than = DUKE
						title = event_target:mr_duchy
					}
				}
				save_event_target_as = emf_title
				ROOT = { character_event = { id = emf_mr.9 } }
				clear_event_target = emf_title
			}

			# Get rid of / transfer vassals outside the capital duchy

			any_vassal = {
				limit = {
					higher_tier_than = BARON
					capital_holding = {
						NOT = { de_jure_liege_or_above = event_target:mr_duchy }
					}
				}
				set_defacto_liege = THIS # Independent, worst-case
				ROOT = {
					liege = {
						if = {
							limit = { NOT = { character = ROOT } }
							set_defacto_vassal = PREVPREV # To our liege, if we're not independent
						}
					}
				}
				capital_scope = {
					kingdom = {
						owner = {
							set_defacto_vassal = PREVPREVPREV # To their kingdom owner, if possible (tier) and owner exists
						}
					}
				}
				capital_scope = {
					duchy = {
						owner = {
							set_defacto_vassal = PREVPREVPREV # To their duchy owner, if possible (tier) and owner exists
						}
					}
				}
				emf_liege_change = yes
			}

			any_vassal = { # Non-de-jure baron vassals
				limit = {
					tier = BARON
					capital_holding = {
						NOT = { de_jure_liege_or_above = event_target:mr_duchy }
					}
				}
				# Transfer to owner of their capital holding's de jure county
				capital_holding = {
					dejure_liege_title = {
						owner = {
							set_defacto_vassal = PREVPREVPREV
						}
					}
				}
			}

			# Try to make the capital duchy our primary so that any extra vassals are bound to it and not other titles
			event_target:mr_duchy = { emf_make_primary_title = yes }

			# Now, do the dangerous thing and just destroy any extra duke-tier or higher titles that we couldn't shed
			# They are probably titular-- hopefully they weren't binding any vassals (would make a mess): apparently
			# never seems to happen in practice, so we must be doing the Right Stuff.

			any_demesne_title = {
				limit = {
					NOR = {
						lower_tier_than = DUKE
						title = event_target:mr_duchy
					}
				}
				emf_destroy_title = yes
			}

			# Try again
			event_target:mr_duchy = { emf_make_primary_title = yes }

			# Make sure we have either direct or indirect control over all de jure
			# vassal titles of capital duchy...

			event_target:mr_duchy = {
				any_de_jure_vassal_title = { # County cleanup...
					limit = {
						tier = COUNT
						owner = {
							NOR = {
								character = ROOT
								is_liege_or_above = ROOT
							}
						}
					}
					if = {
						limit = {
							owner = { higher_tier_than = COUNT } # DUKE+ should not be vassalized
						}
						grant_title_no_opinion = ROOT # Just take direct control over the county
					}
					if = {
						limit = {
							owner = { tier = COUNT } # Can definitely vassalize a count
						}
						owner = { set_defacto_liege = ROOT } # Vassalize
					}
				}
				any_de_jure_vassal_title = { # Barony cleanup...
					limit = {
						tier = BARON
						owner = {
							NOR = {
								character = ROOT
								is_liege_or_above = ROOT
							}
						}
					}
					if = {
						limit = {
							owner = { higher_tier_than = COUNT } # DUKE+ should not be vassalized
						}
						dejure_liege_title = {
							owner = {
								grant_title_no_opinion = PREVPREV # Grant barony to its county's owner
							}
						}
					}
					if = {
						limit = {
							owner = { tier = COUNT } # Counts can be directly vassalized
						}
						owner = { set_defacto_liege = ROOT } # Vassalize
					}
					if = {
						limit = {
							owner = { tier = BARON } # Barons should be vassalized by their de jure county owner
						}
						owner = { save_event_target_as = emf_baron }
						dejure_liege_title = {
							owner = { set_defacto_vassal = event_target:emf_baron } # County owner vassalizes
						}
						clear_event_target = emf_baron
					}
				}
			}

			# Grant our own provinces outside the capital duchy to other, neighboring characters in same realm
			character_event = { id = emf_mr.5 }

			# Grant our own remaining provinces outside the capital duchy to other, neighboring characters in a different realm
			character_event = { id = emf_mr.6 }

			# Become independent

			set_defacto_liege = ROOT
			emf_liege_change = yes

			# Make our vassals shed any provinces outside the capital duchy to other, neighboring characters in a different realm

			any_vassal = {
				limit = { tier = COUNT }
				character_event = { id = emf_mr.6 }
			}

			# Create family palace

			create_family_palace = yes

			emf_switch_to_merchant_republic_gov = yes

			# Make sure we own a city and that it's our capital (we assume our capital county has a city or empty holding slot)

			character_event = { id = emf_mr.10 }

			emf_switch_to_merchant_republic_gov = yes # Vanilla does this twice for some reason, so we'll do it too

			# Create a dynasty member to get around situations where we have no valid
			# republican heirs (will be our brother if we have parents)

			character_event = { id = emf_mr.7 }

			# Every family gets 500g to start with, including Doge

			wealth = 500

			# Give money and heirs and cities to the 4 auto-generated patrician families
			# after 2 game days (gives the game enough time to generate them)

			character_event = { id = emf_mr.2 days = 2 }

			# Create a custom de jure kingdom title for the MR duchy if we want
			# Avoids de jure claim CBs if want the MR to surely stay independent

			# Ask FROMFROM, if available (diplo-action) ...
			if = {
				limit = { FROMFROM = { is_alive = yes } }
				FROMFROM = { character_event = { id = emf_mr.4 } }
				break = yes
			}

			# Else, ask FROM (direct scenario customization decision)
			FROM = { character_event = { id = emf_mr.4 } }
		}
	}

	option = {
		name = CANCEL
		ai_chance = { factor = 0 }
	}
}



# emf_mr.2
#
# Triggered upon the Doge of the new merchant republic 3 game days after start.
# Gives the auto-generated rival patricians wealth and heirs.
#
# Recursive for better randomization.
character_event = {
	id = emf_mr.2
	desc = HIDE_EVENT
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		any_vassal = {
			is_patrician = yes
			NOT = { has_flag = ai_patrician }
		}
	}

	option = {
		name = OK

		random_vassal = {
			limit = {
				is_patrician = yes
				NOT = { has_flag = ai_patrician }
			}
			set_flag = ai_patrician
			character_event = { id = emf_mr.3 }
		}

		character_event = { id = emf_mr.2 }
	}
}


# emf_mr.3 [AI Patrician]
#
# Create heir
character_event = {
	id = emf_mr.3
	desc = AI_EVENT
	hide_window = yes

	is_triggered_only = yes

	option = {
		name = OK

		# Give them a city.
		character_event = { id = emf_mr.11 }

		# The engine gives auto-generated patricians 500 gold automatically,
		# so we actually don't do it explicitly.

		#wealth = 500

		if = {
			limit = { NOT = { age = 32 } }

			# Can't create an adult male son, so instead just create a dynasty member (no known relation).
			character_event = { id = emf_mr.7 }

			break = yes
		}

		# Create have an adult heir (son)
		random_list = {
			50 = {
				modifier = {
					factor = 0
					has_religion_feature = religion_matriarchal
				}
				random_list = {
					10 = {
						create_random_steward = {
							random_traits = yes
							dynasty = ROOT
							female = no
							age = 16
						}
					}
					10 = {
						modifier = {
							factor = 0
							NOT = { age = 33 }
						}
						create_random_steward = {
							random_traits = yes
							dynasty = ROOT
							female = no
							age = 17
						}
					}
					10 = {
						modifier = {
							factor = 0
							NOT = { age = 34 }
						}
						create_random_steward = {
							random_traits = yes
							dynasty = ROOT
							female = no
							age = 18
						}
					}
					10 = {
						modifier = {
							factor = 0
							NOT = { age = 35 }
						}
						create_random_steward = {
							random_traits = yes
							dynasty = ROOT
							female = no
							age = 19
						}
					}
					10 = {
						modifier = {
							factor = 0
							NOT = { age = 36 }
						}
						create_random_steward = {
							random_traits = yes
							dynasty = ROOT
							female = no
							age = 20
						}
					}
					10 = {
						modifier = {
							factor = 0
							NOT = { age = 37 }
						}
						create_random_steward = {
							random_traits = yes
							dynasty = ROOT
							female = no
							age = 21
						}
					}
				}
			}
			50 = {
				modifier = {
					factor = 0
					gender_equality_trigger = no
					NOT = { has_religion_feature = religion_matriarchal }
				}
				random_list = {
					10 = {
						create_random_steward = {
							random_traits = yes
							dynasty = ROOT
							female = yes
							age = 16
						}
					}
					10 = {
						modifier = {
							factor = 0
							NOT = { age = 33 }
						}
						create_random_steward = {
							random_traits = yes
							dynasty = ROOT
							female = yes
							age = 17
						}
					}
					10 = {
						modifier = {
							factor = 0
							NOT = { age = 34 }
						}
						create_random_steward = {
							random_traits = yes
							dynasty = ROOT
							female = yes
							age = 18
						}
					}
					10 = {
						modifier = {
							factor = 0
							NOT = { age = 35 }
						}
						create_random_steward = {
							random_traits = yes
							dynasty = ROOT
							female = yes
							age = 19
						}
					}
					10 = {
						modifier = {
							factor = 0
							NOT = { age = 36 }
						}
						create_random_steward = {
							random_traits = yes
							dynasty = ROOT
							female = yes
							age = 20
						}
					}
					10 = {
						modifier = {
							factor = 0
							NOT = { age = 37 }
						}
						create_random_steward = {
							random_traits = yes
							dynasty = ROOT
							female = yes
							age = 21
						}
					}
				}
			}
		}
		new_character = {
			dynasty = ROOT
			set_father = ROOT # Don't forget your daddy
			emf_new_character_steward = yes
		}
	}
}


# emf_mr.4 [Invoker of MR conversion decision/diplo-action]
#
# Give the option to make the new MR a de jure kingdom title
# with no de jure empire, or keep it a simple duchy-level
# republic.
character_event = {
	id = emf_mr.4
	desc = emf_mr.4.desc
	picture = GFX_evt_doge_republic
	border = GFX_event_normal_frame_diplomacy

	is_triggered_only = yes
	hide_new = yes

	trigger = {
		FROM = {
			primary_title = { title = event_target:mr_duchy }
		}
	}

	option = {
		name = YES
		ai_chance = { factor = 0 }

		hidden_tooltip = {
			FROM = {
				primary_title = {
					create_title = {
						tier = KING
						landless = no
						temporary = no
						custom_created = yes
						culture = FROM
						holder = FROM
						base_title = THIS
						copy_title_laws = yes
					}
				}

				primary_title = {
					event_target:mr_duchy = {
						de_jure_liege = PREV
					}
				}
			}
		}
	}
	option = {
		name = NO
		ai_chance = { factor = 100 }
	}
}


# emf_mr.5 [Ruler]
#
# Recursively shed counties that are not within the MR's de jure duchy.
# This version only sheds them to people in the same original realm as
# the ruler.
character_event = {
	id = emf_mr.5
	desc = HIDE_EVENT
	hide_window = yes

	is_triggered_only = yes

	trigger = {
		any_demesne_title = {
			tier = COUNT
			NOT = { de_jure_liege = event_target:mr_duchy }
			location = {
				any_neighbor_province = {
					county = {
						NOT = { de_jure_liege = event_target:mr_duchy }
					}
					owner = {
						same_realm = ROOT
						NOR = {
							character = ROOT
							is_liege_or_above = ROOT
						}
					}
				}
			}
		}
	}

	immediate = {
		random_demesne_title = {
			limit = {
				tier = COUNT
				NOT = { de_jure_liege = event_target:mr_duchy }
				location = {
					any_neighbor_province = {
						county = {
							NOT = { de_jure_liege = event_target:mr_duchy }
						}
						owner = {
							same_realm = ROOT
							NOR = {
								character = ROOT
								is_liege_or_above = ROOT
							}
						}
					}
				}
			}
			save_event_target_as = free_county
		}
	}

	option = {
		name = OK

		event_target:free_county = {
			location = {
				random_neighbor_province = {
					limit = {
						county = {
							NOT = { de_jure_liege = event_target:mr_duchy }
						}
						owner = {
							same_realm = ROOT
							NOR = {
								character = ROOT
								is_liege_or_above = ROOT
							}
						}
					}
					owner = {
						event_target:free_county = {
							grant_title_no_opinion = PREV # Grant the county

							# Grant any baronies we own under the county too...

							any_de_jure_vassal_title = {
								limit = { owner = { character = ROOT } }
								grant_title_no_opinion = PREVPREV
							}

							# Make sure the rest of the baronies are vassal to the new owner, if possible

							any_de_jure_vassal = {
								limit = {
									tier = BARON
									NOT = { character = PREVPREV }
								}
								set_defacto_liege = PREVPREV
							}
						}
					}
				}
			}
		}

		clear_event_target = free_county
		character_event = { id = emf_mr.5 } # Recurse
	}
}


# emf_mr.6 [Ruler]
#
# Same as emf_mr.5, but requires granting to neighboring provinces held outside the realm
# of the ruler. Once the MR is independent, can be used on the doge's vassals to make them
# shed their outside-duchy counties too.
character_event = {
	id = emf_mr.6
	desc = HIDE_EVENT
	hide_window = yes

	is_triggered_only = yes

	trigger = {
		any_demesne_title = {
			tier = COUNT
			NOT = { de_jure_liege = event_target:mr_duchy }
			location = {
				any_neighbor_province = {
					county = {
						NOT = { de_jure_liege = event_target:mr_duchy }
					}
					owner = {
						NOT = { same_realm = ROOT }
					}
				}
			}
		}
	}

	immediate = {
		random_demesne_title = {
			limit = {
				tier = COUNT
				NOT = { de_jure_liege = event_target:mr_duchy }
				location = {
					any_neighbor_province = {
						county = {
							NOT = { de_jure_liege = event_target:mr_duchy }
						}
						owner = {
							NOT = { same_realm = ROOT }
						}
					}
				}
			}
			save_event_target_as = free_county
		}
	}

	option = {
		name = OK

		event_target:free_county = {
			location = {
				random_neighbor_province = {
					limit = {
						county = {
							NOT = { de_jure_liege = event_target:mr_duchy }
						}
						owner = {
							NOT = { same_realm = ROOT }
						}
					}
					owner = {
						event_target:free_county = {
							grant_title_no_opinion = PREV # Grant the county

							# Grant any baronies we own under the county too...

							any_de_jure_vassal_title = {
								limit = { owner = { character = ROOT } }
								grant_title_no_opinion = PREVPREV
							}

							# Make sure the rest of the baronies are vassal to the new owner, if possible

							any_de_jure_vassal = {
								limit = {
									tier = BARON
									NOT = { character = PREVPREV }
								}
								set_defacto_liege = PREVPREV
							}
						}
					}
				}
			}
		}

		clear_event_target = free_county
		character_event = { id = emf_mr.6 } # Recurse
	}
}


# emf_mr.7
#
# Create a dynasty member fit to be a patrician's successor. Try to make them brothers if possible,
# but that can only work for the original Doge, because auto-generated patricians won't have any
# parents.
character_event = {
	id = emf_mr.7
	desc = HIDE_EVENT
	hide_window = yes
	is_triggered_only = yes

	option = {
		name = OK
		
		random_list = {
			50 = {
				modifier = {
					factor = 0
					has_religion_feature = religion_matriarchal
				}
				random_list = {
					10 = {
						create_random_steward = {
							random_traits = yes
							dynasty = ROOT
							age = 16
							female = no
						}
					}
					10 = {
						modifier = {
							factor = 0
							NOT = { age = 19 }
						}
						create_random_steward = {
							random_traits = yes
							dynasty = ROOT
							age = 18
							female = no
						}
					}
					10 = {
						modifier = {
							factor = 0
							NOT = { age = 21 }
						}
						create_random_steward = {
							random_traits = yes
							dynasty = ROOT
							age = 20
							female = no
						}
					}
					10 = {
						modifier = {
							factor = 0
							NOT = { age = 23 }
						}
						create_random_steward = {
							random_traits = yes
							dynasty = ROOT
							age = 22
							female = no
						}
					}
					10 = {
						modifier = {
							factor = 0
							NOT = { age = 25 }
						}
						create_random_steward = {
							random_traits = yes
							dynasty = ROOT
							age = 24
							female = no
						}
					}
				}
			}
			50 = {
				modifier = {
					factor = 0
					gender_equality_trigger = no
					NOT = { has_religion_feature = religion_matriarchal }
				}
				random_list = {
					10 = {
						create_random_steward = {
							random_traits = yes
							dynasty = ROOT
							age = 16
							female = yes
						}
					}
					10 = {
						modifier = {
							factor = 0
							NOT = { age = 19 }
						}
						create_random_steward = {
							random_traits = yes
							dynasty = ROOT
							age = 18
							female = yes
						}
					}
					10 = {
						modifier = {
							factor = 0
							NOT = { age = 21 }
						}
						create_random_steward = {
							random_traits = yes
							dynasty = ROOT
							age = 20
							female = yes
						}
					}
					10 = {
						modifier = {
							factor = 0
							NOT = { age = 23 }
						}
						create_random_steward = {
							random_traits = yes
							dynasty = ROOT
							age = 22
							female = yes
						}
					}
					10 = {
						modifier = {
							factor = 0
							NOT = { age = 25 }
						}
						create_random_steward = {
							random_traits = yes
							dynasty = ROOT
							age = 24
							female = yes
						}
					}
				}
			}
		}

		new_character = {
			dynasty = ROOT
			character_event = { id = emf_mr.8 }
			emf_new_character_steward = yes
		}
	}
}


# emf_mr.8
#
# Try to make a character your brother.
character_event = {
	id = emf_mr.8
	desc = HIDE_EVENT
	hide_window = yes
	is_triggered_only = yes

	option = {
		name = OK

		FROM = { # Our would-be brother
			if = {
				limit = { father_even_if_dead = { always = yes } }
				father_even_if_dead = {
					ROOT = { set_father = PREV }
				}
			}
			if = {
				limit = { mother_even_if_dead = { always = yes } }
				mother_even_if_dead = {
					ROOT = { set_mother = PREV }
				}
			}
		}
	}
}


# emf_mr.9 [Doge]
#
# Shed prior tier >= DUKE feudal title event_target:emf_title
# to an appropriate ruler.
character_event = {
	id = emf_mr.9
	hide_window = yes
	is_triggered_only = yes

	immediate = {
		random_vassal = {
			limit = {
				higher_tier_than = BARON
				is_feudal = yes
				num_of_count_titles = 4
				capital_holding = {
					de_jure_liege_or_above = event_target:emf_title
					NOT = { de_jure_liege_or_above = event_target:mr_duchy }
				}
			}
			grant_title_no_opinion = event_target:emf_title
			break = yes
		}
		random_vassal = {
			limit = {
				higher_tier_than = BARON
				is_feudal = yes
				num_of_count_titles = 3
				capital_holding = {
					de_jure_liege_or_above = event_target:emf_title
					NOT = { de_jure_liege_or_above = event_target:mr_duchy }
				}
			}
			grant_title_no_opinion = event_target:emf_title
			break = yes
		}
		random_vassal = {
			limit = {
				higher_tier_than = BARON
				is_feudal = yes
				num_of_count_titles = 2
				capital_holding = {
					de_jure_liege_or_above = event_target:emf_title
					NOT = { de_jure_liege_or_above = event_target:mr_duchy }
				}
			}
			grant_title_no_opinion = event_target:emf_title
			break = yes
		}
		random_vassal = {
			limit = {
				higher_tier_than = BARON
				is_feudal = yes
				capital_holding = {
					de_jure_liege_or_above = event_target:emf_title
					NOT = { de_jure_liege_or_above = event_target:mr_duchy }
				}
			}
			grant_title_no_opinion = event_target:emf_title
			break = yes
		}
		random_realm_lord = {
			limit = {
				higher_tier_than = BARON
				is_feudal = yes
				capital_holding = {
					de_jure_liege_or_above = event_target:emf_title
					NOT = { de_jure_liege_or_above = event_target:mr_duchy }
				}
			}
			grant_title_no_opinion = event_target:emf_title
			break = yes
		}
		random_playable_ruler = {
			limit = {
				is_feudal = yes
				religion = ROOT
				culture = ROOT
				num_of_count_titles = 3
				capital_holding = {
					de_jure_liege_or_above = event_target:emf_title
					NOT = { de_jure_liege_or_above = event_target:mr_duchy }
				}
			}
			grant_title_no_opinion = event_target:emf_title
			break = yes
		}
		random_playable_ruler = {
			limit = {
				is_feudal = yes
				religion = ROOT
				culture = ROOT
				num_of_count_titles = 2
				capital_holding = {
					de_jure_liege_or_above = event_target:emf_title
					NOT = { de_jure_liege_or_above = event_target:mr_duchy }
				}
			}
			grant_title_no_opinion = event_target:emf_title
			break = yes
		}
		random_playable_ruler = {
			limit = {
				is_feudal = yes
				religion = ROOT
				culture = ROOT
				capital_holding = {
					de_jure_liege_or_above = event_target:emf_title
					NOT = { de_jure_liege_or_above = event_target:mr_duchy }
				}
			}
			grant_title_no_opinion = event_target:emf_title
			break = yes
		}
		random_playable_ruler = {
			limit = {
				is_feudal = yes
				religion_group = ROOT
				capital_holding = {
					de_jure_liege_or_above = event_target:emf_title
					NOT = { de_jure_liege_or_above = event_target:mr_duchy }
				}
			}
			grant_title_no_opinion = event_target:emf_title
			break = yes
		}
		random_vassal = {
			limit = {
				higher_tier_than = BARON
				capital_holding = {
					de_jure_liege_or_above = event_target:emf_title
					NOT = { de_jure_liege_or_above = event_target:mr_duchy }
				}
			}
			grant_title_no_opinion = event_target:emf_title
			break = yes
		}
		random_realm_lord = {
			limit = {
				higher_tier_than = BARON
				capital_holding = {
					de_jure_liege_or_above = event_target:emf_title
					NOT = { de_jure_liege_or_above = event_target:mr_duchy }
				}
			}
			grant_title_no_opinion = event_target:emf_title
			break = yes
		}
		random_playable_ruler = {
			limit = {
				religion_group = ROOT
				capital_holding = {
					de_jure_liege_or_above = event_target:emf_title
					NOT = { de_jure_liege_or_above = event_target:mr_duchy }
				}
			}
			grant_title_no_opinion = event_target:emf_title
			break = yes
		}
		random_playable_ruler = {
			limit = {
				capital_holding = {
					de_jure_liege_or_above = event_target:emf_title
					NOT = { de_jure_liege_or_above = event_target:mr_duchy }
				}
			}
			grant_title_no_opinion = event_target:emf_title
			break = yes
		}
	}
}


# emf_mr.10 [Doge]
#
# Set our capital to a city and make sure it's the province capital.
character_event = {
	id = emf_mr.10
	hide_window = yes
	is_triggered_only = yes

	immediate = {
		capital_scope = { save_event_target_as = emf_capital }

		# If we own a city in our capital...
		random_demesne_title = {
			limit = {
				holding_type = city
				location = { province = event_target:emf_capital }
			}
			if = {
				limit = { is_capital = no }
				make_capital_holding = yes
			}
			ROOT = { capital = PREV }
			break = yes
		}

		# If there is already SOME city in our capital...
		capital_scope = {
			random_province_holding = {
				limit = {
					holding_type = city
				}
				grant_title_no_opinion = ROOT
				if = {
					limit = { is_capital = no }
					make_capital_holding = yes
				}
				ROOT = { capital = PREV }
				break = yes
			}

			if = {
				limit = { NOT = { has_empty_holding = yes } }
				log = "emf_mr.10: SERIOUS: expected empty holding slot in capital province of [This.GetName]"

				# Do something drastic
				random_province_holding = {
					limit = { holding_type = temple }
					destroy_settlement = THIS
				}

				if = {
					limit = { NOT = { has_empty_holding = yes } }
					random_province_holding = {
						limit = { holding_type = castle is_capital = no }
						destroy_settlement = THIS
					}
				}
				if = {
					limit = { NOT = { has_empty_holding = yes } }
					random_province_holding = {
						limit = { holding_type = castle }
						destroy_settlement = THIS
					}
				}
			}

			if = {
				limit = { NOT = { has_empty_holding = yes } }
				log = "emf_mr.10: FATAL: could not make empty holding slot in capital province of [This.GetName]"
				break = yes
			}

			build_holding = {
				type = city
				holder = ROOT
			}

			random_province_holding = {
				limit = {
					holding_type = city
				}
				make_capital_holding = yes
				ROOT = { capital = PREV }
			}
		}
	}
}


# emf_mr.11 [Patrician]
#
# Try to acquire or build a city.
character_event = {
	id = emf_mr.11
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		is_patrician = yes
		NOT = {
			any_demesne_title = {
				holding_type = city
			}
		}
	}

	immediate = {
		liege = {
			save_event_target_as = emf_liege
			capital_scope = { save_event_target_as = emf_capital }
		}

		# Look for an existing coastal city somewhere within the capital duchy (not owned by another patrician)
		# Try to find provinces in which we can make our city capital and take the county too
		event_target:emf_capital = {
			duchy = {
				any_direct_de_jure_vassal_title = {
					limit = {
						location = {
							port = yes
							NOR = {
								province = event_target:emf_capital
								any_province_holding = {
									is_capital = yes
									holding_type = city
									owner = { is_patrician = yes }
								}
							}
						}
					}
					location = {
						random_province_holding = {
							limit = {
								holding_type = city
								owner = {
									OR = {
										character = event_target:emf_liege
										is_patrician = no
									}
								}
							}
							grant_title_no_opinion = ROOT
							dejure_liege_title = {
								grant_title_no_opinion = ROOT
							}
							province_capital = yes
							ROOT = {
								set_defacto_liege = event_target:emf_liege
								emf_liege_change = yes
							}
							break = yes
						}
					}
				}
			}
		}

		# Look for an existing city in liege's capital (not owned by another patrician)
		event_target:emf_capital = {
			random_province_holding = {
				limit = {
					holding_type = city
					owner = {
						NOR = {
							character = event_target:emf_liege
							is_patrician = yes
						}
					}
				}
				grant_title_no_opinion = ROOT
				ROOT = {
					set_defacto_liege = event_target:emf_liege
					emf_liege_change = yes
				}
				break = yes
			}
		}

		# Look for an existing non-coastal city somewhere within the capital duchy (not owned by another patrician)
		# Try to find provinces in which we can make our city capital and take the county too
		event_target:emf_capital = {
			duchy = {
				any_direct_de_jure_vassal_title = {
					limit = {
						location = {
							port = no
							NOT = { province = event_target:emf_capital }
							NOT = {
								any_province_holding = {
									is_capital = yes
									holding_type = city
									owner = { is_patrician = yes }
								}
							}
						}
					}
					location = {
						random_province_holding = {
							limit = {
								holding_type = city
								owner = {
									OR = {
										character = event_target:emf_liege
										is_patrician = no
									}
								}
							}
							grant_title_no_opinion = ROOT
							dejure_liege_title = {
								grant_title_no_opinion = ROOT
							}
							province_capital = yes
							ROOT = {
								set_defacto_liege = event_target:emf_liege
								emf_liege_change = yes
							}
							break = yes
						}
					}
				}
			}
		}

		# Look for an existing coastal city somewhere within the capital duchy (not owned by another patrician)
		# Settle for provinces in which we won't be able to take the county and make our city capital
		event_target:emf_capital = {
			duchy = {
				any_direct_de_jure_vassal_title = {
					limit = {
						location = {
							port = yes
							NOT = { province = event_target:emf_capital }
						}
					}
					location = {
						random_province_holding = {
							limit = {
								holding_type = city
								owner = {
									OR = {
										character = event_target:emf_liege
										is_patrician = no
									}
								}
							}
							grant_title_no_opinion = ROOT
							ROOT = {
								set_defacto_liege = event_target:emf_liege
								emf_liege_change = yes
							}
							break = yes
						}
					}
				}
			}
		}

		# Look for an existing non-coastal city somewhere within the capital duchy (not owned by another patrician)
		# Settle for provinces in which we won't be able to take the county and make our city capital
		event_target:emf_capital = {
			duchy = {
				any_direct_de_jure_vassal_title = {
					limit = {
						location = {
							port = no
							NOT = { province = event_target:emf_capital }
						}
					}
					location = {
						random_province_holding = {
							limit = {
								holding_type = city
								owner = {
									OR = {
										character = event_target:emf_liege
										is_patrician = no
									}
								}
							}
							grant_title_no_opinion = ROOT
							ROOT = {
								set_defacto_liege = event_target:emf_liege
								emf_liege_change = yes
							}
							break = yes
						}
					}
				}
			}
		}

		# Try to build a city in the capital to hold
		if = {
			limit = {
				event_target:emf_capital = {
					has_empty_holding = yes
				}
			}
			event_target:emf_capital = {
				build_holding = {
					type = city
					holder = ROOT
				}
			}
			# Give it some basic buildings
			random_demesne_title = {
				limit = { holding_type = city }
				add_building = ct_wall_1
				add_building = ct_wall_2
				add_building = ct_marketplace_1
				add_building = ct_marketplace_2
				add_building = ct_guard_1
				add_building = ct_barracks_1
				if = {
					limit = { location = { port = yes } }
					add_building = ct_port_1
					add_building = ct_shipyard_1
				}
				refill_holding_levy = yes
			}
			set_defacto_liege = event_target:emf_liege
			emf_liege_change = yes
			break = yes
		}
	}
}

# emf_mr.12
#
# Building Family Palace buildings for newly generated patricians
character_event = {
	id = emf_mr.12
	desc = HIDE_EVENT
	hide_window = yes
	is_triggered_only = yes
	
	trigger = {
		is_patrician = yes
		family_palace = {
			# Only newly generated patricians don't have the first level mansion built because it has extra_tech_building_start = 0.0 and a tech requirement of 0
			NOT = { has_building = fp_mansion_1 }
		}
	}
	
	option = {
		name = OK
		
		# Build buildings corresponding to highest level that any fellow patrician has in that building
		
		# Mansion
		if = {
			limit = {
				liege = {
					OR = {
						any_vassal = {
							is_patrician = yes
							family_palace = {
								has_building = fp_mansion_4
							}
						}
						AND = {
							is_patrician = yes
							family_palace = {
								has_building = fp_mansion_4
							}
						}
					}
				}
			}
			family_palace = { add_building = fp_mansion_4 }
		}
		else_if = {
			limit = {
				liege = {
					OR = {
						any_vassal = {
							is_patrician = yes
							family_palace = {
								has_building = fp_mansion_3
							}
						}
						AND = {
							is_patrician = yes
							family_palace = {
								has_building = fp_mansion_3
							}
						}
					}
				}
			}
			family_palace = { add_building = fp_mansion_3 }
		}
		else_if = {
			limit = {
				liege = {
					OR = {
						any_vassal = {
							is_patrician = yes
							family_palace = {
								has_building = fp_mansion_2
							}
						}
						AND = {
							is_patrician = yes
							family_palace = {
								has_building = fp_mansion_2
							}
						}
					}
				}
			}
			family_palace = { add_building = fp_mansion_2 }
		}
		else = {
			family_palace = { add_building = fp_mansion_1 }
		}
		
		# Barracks
		if = {
			limit = {
				liege = {
					OR = {
						any_vassal = {
							is_patrician = yes
							family_palace = {
								has_building = fp_barracks_3
							}
						}
						AND = {
							is_patrician = yes
							family_palace = {
								has_building = fp_barracks_3
							}
						}
					}
				}
			}
			family_palace = { add_building = fp_barracks_3 }
		}
		else_if = {
			limit = {
				liege = {
					OR = {
						any_vassal = {
							is_patrician = yes
							family_palace = {
								has_building = fp_barracks_2
							}
						}
						AND = {
							is_patrician = yes
							family_palace = {
								has_building = fp_barracks_2
							}
						}
					}
				}
			}
			family_palace = { add_building = fp_barracks_2 }
		}
		else_if = {
			limit = {
				liege = {
					OR = {
						any_vassal = {
							is_patrician = yes
							family_palace = {
								has_building = fp_barracks_1
							}
						}
						AND = {
							is_patrician = yes
							family_palace = {
								has_building = fp_barracks_1
							}
						}
					}
				}
			}
			family_palace = { add_building = fp_barracks_1 }
		}
		
		# Stable
		if = {
			limit = {
				liege = {
					OR = {
						any_vassal = {
							is_patrician = yes
							family_palace = {
								has_building = fp_stable_3
							}
						}
						AND = {
							is_patrician = yes
							family_palace = {
								has_building = fp_stable_3
							}
						}
					}
				}
			}
			family_palace = { add_building = fp_stable_3 }
		}
		else_if = {
			limit = {
				liege = {
					OR = {
						any_vassal = {
							is_patrician = yes
							family_palace = {
								has_building = fp_stable_2
							}
						}
						AND = {
							is_patrician = yes
							family_palace = {
								has_building = fp_stable_2
							}
						}
					}
				}
			}
			family_palace = { add_building = fp_stable_2 }
		}
		else_if = {
			limit = {
				liege = {
					OR = {
						any_vassal = {
							is_patrician = yes
							family_palace = {
								has_building = fp_stable_1
							}
						}
						AND = {
							is_patrician = yes
							family_palace = {
								has_building = fp_stable_1
							}
						}
					}
				}
			}
			family_palace = { add_building = fp_stable_1 }
		}
		
		# Bowyer
		if = {
			limit = {
				liege = {
					OR = {
						any_vassal = {
							is_patrician = yes
							family_palace = {
								has_building = fp_bowyer_3
							}
						}
						AND = {
							is_patrician = yes
							family_palace = {
								has_building = fp_bowyer_3
							}
						}
					}
				}
			}
			family_palace = { add_building = fp_bowyer_3 }
		}
		else_if = {
			limit = {
				liege = {
					OR = {
						any_vassal = {
							is_patrician = yes
							family_palace = {
								has_building = fp_bowyer_2
							}
						}
						AND = {
							is_patrician = yes
							family_palace = {
								has_building = fp_bowyer_2
							}
						}
					}
				}
			}
			family_palace = { add_building = fp_bowyer_2 }
		}
		else_if = {
			limit = {
				liege = {
					OR = {
						any_vassal = {
							is_patrician = yes
							family_palace = {
								has_building = fp_bowyer_1
							}
						}
						AND = {
							is_patrician = yes
							family_palace = {
								has_building = fp_bowyer_1
							}
						}
					}
				}
			}
			family_palace = { add_building = fp_bowyer_1 }
		}
		
		# Shipyard
		if = {
			limit = {
				liege = {
					OR = {
						any_vassal = {
							is_patrician = yes
							family_palace = {
								has_building = fp_shipyard_3
							}
						}
						AND = {
							is_patrician = yes
							family_palace = {
								has_building = fp_shipyard_3
							}
						}
					}
				}
			}
			family_palace = { add_building = fp_shipyard_3 }
		}
		else_if = {
			limit = {
				liege = {
					OR = {
						any_vassal = {
							is_patrician = yes
							family_palace = {
								has_building = fp_shipyard_2
							}
						}
						AND = {
							is_patrician = yes
							family_palace = {
								has_building = fp_shipyard_2
							}
						}
					}
				}
			}
			family_palace = { add_building = fp_shipyard_2 }
		}
		else_if = {
			limit = {
				liege = {
					OR = {
						any_vassal = {
							is_patrician = yes
							family_palace = {
								has_building = fp_shipyard_1
							}
						}
						AND = {
							is_patrician = yes
							family_palace = {
								has_building = fp_shipyard_1
							}
						}
					}
				}
			}
			family_palace = { add_building = fp_shipyard_1 }
		}
		
		# Warehouse
		if = {
			limit = {
				liege = {
					OR = {
						any_vassal = {
							is_patrician = yes
							family_palace = {
								has_building = fp_warehouse_3
							}
						}
						AND = {
							is_patrician = yes
							family_palace = {
								has_building = fp_warehouse_3
							}
						}
					}
				}
			}
			family_palace = { add_building = fp_warehouse_3 }
		}
		else_if = {
			limit = {
				liege = {
					OR = {
						any_vassal = {
							is_patrician = yes
							family_palace = {
								has_building = fp_warehouse_2
							}
						}
						AND = {
							is_patrician = yes
							family_palace = {
								has_building = fp_warehouse_2
							}
						}
					}
				}
			}
			family_palace = { add_building = fp_warehouse_2 }
		}
		else_if = {
			limit = {
				liege = {
					OR = {
						any_vassal = {
							is_patrician = yes
							family_palace = {
								has_building = fp_warehouse_1
							}
						}
						AND = {
							is_patrician = yes
							family_palace = {
								has_building = fp_warehouse_1
							}
						}
					}
				}
			}
			family_palace = { add_building = fp_warehouse_1 }
		}
		
		# Garden
		if = {
			limit = {
				liege = {
					OR = {
						any_vassal = {
							is_patrician = yes
							family_palace = {
								has_building = fp_garden_3
							}
						}
						AND = {
							is_patrician = yes
							family_palace = {
								has_building = fp_garden_3
							}
						}
					}
				}
			}
			family_palace = { add_building = fp_garden_3 }
		}
		else_if = {
			limit = {
				liege = {
					OR = {
						any_vassal = {
							is_patrician = yes
							family_palace = {
								has_building = fp_garden_2
							}
						}
						AND = {
							is_patrician = yes
							family_palace = {
								has_building = fp_garden_2
							}
						}
					}
				}
			}
			family_palace = { add_building = fp_garden_2 }
		}
		else_if = {
			limit = {
				liege = {
					OR = {
						any_vassal = {
							is_patrician = yes
							family_palace = {
								has_building = fp_garden_1
							}
						}
						AND = {
							is_patrician = yes
							family_palace = {
								has_building = fp_garden_1
							}
						}
					}
				}
			}
			family_palace = { add_building = fp_garden_1 }
		}
		
		# Cellar
		if = {
			limit = {
				liege = {
					OR = {
						any_vassal = {
							is_patrician = yes
							family_palace = {
								has_building = fp_cellar_3
							}
						}
						AND = {
							is_patrician = yes
							family_palace = {
								has_building = fp_cellar_3
							}
						}
					}
				}
			}
			family_palace = { add_building = fp_cellar_3 }
		}
		else_if = {
			limit = {
				liege = {
					OR = {
						any_vassal = {
							is_patrician = yes
							family_palace = {
								has_building = fp_cellar_2
							}
						}
						AND = {
							is_patrician = yes
							family_palace = {
								has_building = fp_cellar_2
							}
						}
					}
				}
			}
			family_palace = { add_building = fp_cellar_2 }
		}
		else_if = {
			limit = {
				liege = {
					OR = {
						any_vassal = {
							is_patrician = yes
							family_palace = {
								has_building = fp_cellar_1
							}
						}
						AND = {
							is_patrician = yes
							family_palace = {
								has_building = fp_cellar_1
							}
						}
					}
				}
			}
			family_palace = { add_building = fp_cellar_1 }
		}
		
		# Shrine
		if = {
			limit = {
				liege = {
					OR = {
						any_vassal = {
							is_patrician = yes
							family_palace = {
								has_building = fp_shrine_3
							}
						}
						AND = {
							is_patrician = yes
							family_palace = {
								has_building = fp_shrine_3
							}
						}
					}
				}
			}
			family_palace = { add_building = fp_shrine_3 }
		}
		else_if = {
			limit = {
				liege = {
					OR = {
						any_vassal = {
							is_patrician = yes
							family_palace = {
								has_building = fp_shrine_2
							}
						}
						AND = {
							is_patrician = yes
							family_palace = {
								has_building = fp_shrine_2
							}
						}
					}
				}
			}
			family_palace = { add_building = fp_shrine_2 }
		}
		else_if = {
			limit = {
				liege = {
					OR = {
						any_vassal = {
							is_patrician = yes
							family_palace = {
								has_building = fp_shrine_1
							}
						}
						AND = {
							is_patrician = yes
							family_palace = {
								has_building = fp_shrine_1
							}
						}
					}
				}
			}
			family_palace = { add_building = fp_shrine_1 }
		}
		
		# Vault
		if = {
			limit = {
				liege = {
					OR = {
						any_vassal = {
							is_patrician = yes
							family_palace = {
								has_building = fp_vault_3
							}
						}
						AND = {
							is_patrician = yes
							family_palace = {
								has_building = fp_vault_3
							}
						}
					}
				}
			}
			family_palace = { add_building = fp_vault_3 }
		}
		else_if = {
			limit = {
				liege = {
					OR = {
						any_vassal = {
							is_patrician = yes
							family_palace = {
								has_building = fp_vault_2
							}
						}
						AND = {
							is_patrician = yes
							family_palace = {
								has_building = fp_vault_2
							}
						}
					}
				}
			}
			family_palace = { add_building = fp_vault_2 }
		}
		else_if = {
			limit = {
				liege = {
					OR = {
						any_vassal = {
							is_patrician = yes
							family_palace = {
								has_building = fp_vault_1
							}
						}
						AND = {
							is_patrician = yes
							family_palace = {
								has_building = fp_vault_1
							}
						}
					}
				}
			}
			family_palace = { add_building = fp_vault_1 }
		}
	}
}

# emf_mr.13
#
# Allocating Great Councillor positions
character_event = {
	id = emf_mr.13
	desc = HIDE_EVENT
	hide_window = yes
	is_triggered_only = yes
	
	trigger = {
		is_patrician = yes
		is_merchant_republic = no
		is_councillor = no
	}
	
	option = {
		name = OK
		
		if = {
			limit = { can_hold_title = title_great_councillor_1 }
			give_minor_title = title_great_councillor_1
		}
		else_if = {
			limit = { can_hold_title = title_great_councillor_2 }
			give_minor_title = title_great_councillor_2
		}
		else_if = {
			limit = { can_hold_title = title_great_councillor_3 }
			give_minor_title = title_great_councillor_3
		}
		else_if = {
			limit = { can_hold_title = title_great_councillor_4 }
			give_minor_title = title_great_councillor_4
		}
	}
}

# emf_mr.14
#
# Ping event for expanding a trade post into a city
province_event = {
	id = emf_mr.14
	
	hide_window = yes
	
	is_triggered_only = yes
	
	immediate = {
		save_event_target_as = trade_post_province
		owner = {
			top_liege = {
				save_event_target_as = province_owner
			}
		}
		trade_post_owner = {
			save_event_target_as = trade_post_owner
			character_event = {
				id = emf_mr.15
			}
		}
	}
}

# emf_mr.15
#
# Ping event for expanding a trade post into a city to mark the trade post owner as FROM for the letter event
character_event = {
	id = emf_mr.15
	
	hide_window = yes
	
	is_triggered_only = yes
	
	immediate = {
		event_target:province_owner = {
			letter_event = {
				id = emf_mr.16
			}
		}
	}
}

# emf_mr.16
#
# Event to offer purchasing of a city holding in the designated province
letter_event = {
	id = emf_mr.16
	desc = emf_mr.16.desc
	border = GFX_event_letter_frame_diplomacy
	
	is_triggered_only = yes
	
	option = {
		name = YES # Agree
		ai_chance = {
			factor = 100
			modifier = {
				factor = 2.0
				trait = greedy
			}
			modifier = {
				factor = 0.5
				NOT = {
					opinion = {
						who = event_target:trade_post_owner
						value = -100
					}
				}
			}
			modifier = {
				factor = 0.5
				NOT = {
					opinion = {
						who = event_target:trade_post_owner
						value = -75
					}
				}
			}
			modifier = {
				factor = 0.5
				NOT = {
					opinion = {
						who = event_target:trade_post_owner
						value = -50
					}
				}
			}
			modifier = {
				factor = 0.5
				NOT = {
					opinion = {
						who = event_target:trade_post_owner
						value = -25
					}
				}
			}
			modifier = {
				factor = 2.0
				opinion = {
					who = event_target:trade_post_owner
					value = 25
				}
			}
			modifier = {
				factor = 2.0
				opinion = {
					who = event_target:trade_post_owner
					value = 50
				}
			}
			modifier = {
				factor = 2.0
				opinion = {
					who = event_target:trade_post_owner
					value = 75
				}
			}
			modifier = {
				factor = 2.0
				opinion = {
					who = event_target:trade_post_owner
					value = 100
				}
			}
		}
		if = {
			limit = {
				event_target:trade_post_province = {
					num_of_settlements = 6
				}
			}
			event_target:trade_post_owner = {
				wealth = -900
			}
		}
		else_if = {
			limit = {
				event_target:trade_post_province = {
					num_of_settlements = 5
				}
			}
			event_target:trade_post_owner = {
				wealth = -800
			}
		}
		else_if = {
			limit = {
				event_target:trade_post_province = {
					num_of_settlements = 4
				}
			}
			event_target:trade_post_owner = {
				wealth = -700
			}
		}
		else_if = {
			limit = {
				event_target:trade_post_province = {
					num_of_settlements = 3
				}
			}
			event_target:trade_post_owner = {
				wealth = -600
			}
		}
		else_if = {
			limit = {
				event_target:trade_post_province = {
					num_of_settlements = 2
				}
			}
			event_target:trade_post_owner = {
				wealth = -500
			}
		}
		else_if = {
			limit = {
				event_target:trade_post_province = {
					num_of_settlements = 1
				}
			}
			event_target:trade_post_owner = {
				wealth = -400
			}
		}
		wealth = 300
		set_truce = {
			who = event_target:trade_post_owner
			days = 1825
		} 
		event_target:trade_post_owner = {
			set_truce = {
				who = ROOT
				days = 1825
			}
			event_target:trade_post_province = {
				build_holding = {
					type = city
					holder = PREV
				}
			}
			letter_event = { id = emf_mr.17 }
		}
	}
	
	option = {
		name = NO # Disagree
		ai_chance = {
			factor = 100
			modifier = {
				factor = 2.0
				NOT = {
					opinion = {
						who = event_target:trade_post_owner
						value = -100
					}
				}
			}
			modifier = {
				factor = 2.0
				NOT = {
					opinion = {
						who = event_target:trade_post_owner
						value = -75
					}
				}
			}
			modifier = {
				factor = 2.0
				NOT = {
					opinion = {
						who = event_target:trade_post_owner
						value = -50
					}
				}
			}
			modifier = {
				factor = 2.0
				NOT = {
					opinion = {
						who = event_target:trade_post_owner
						value = -25
					}
				}
			}
			modifier = {
				factor = 0.5
				opinion = {
					who = event_target:trade_post_owner
					value = 25
				}
			}
			modifier = {
				factor = 0.5
				opinion = {
					who = event_target:trade_post_owner
					value = 50
				}
			}
			modifier = {
				factor = 0.5
				opinion = {
					who = event_target:trade_post_owner
					value = 75
				}
			}
			modifier = {
				factor = 0.5
				opinion = {
					who = event_target:trade_post_owner
					value = 100
				}
			}
		}
		event_target:trade_post_owner = {
			letter_event = { id = emf_mr.18 }
		}
	}
}

# emf_mr.17
#
# Event to informing that the offer to purchase a city holding has been approved
letter_event = {
	id = emf_mr.17
	desc = emf_mr.17.desc
	border = GFX_event_letter_frame_diplomacy
	
	is_triggered_only = yes
	
	option = {
		name = OK
	}
}

# emf_mr.18
#
# Event to informing that the offer to purchase a city holding has been declined
letter_event = {
	id = emf_mr.18
	desc = emf_mr.18.desc
	border = GFX_event_letter_frame_diplomacy
	
	is_triggered_only = yes
	
	option = {
		name = OK
	}
}

# emf_mr.19
#
# Automatically remove commander monthly prestige-cancelling modifier if it no longer applies
character_event = {
	id = emf_mr.19
	hide_window = yes
	
	trigger = {
		# Very first check makes sure that this exits out as quickly as possible for everyone for whom this is not relevant
		has_character_modifier = emf_cancel_commander_monthly_prestige
		NAND = {
			liege = { is_merchant_republic = yes }
			emf_can_be_patrician_heir_if_can_inherit = yes
			has_minor_title = title_commander
		}
	}
	
	mean_time_to_happen = {
		days = 1
	}
	
	immediate = {
		remove_character_modifier = emf_cancel_commander_monthly_prestige
	}
}

# emf_mr.20
#
# Automatically add commander monthly prestige-cancelling modifier if it no longer applies
# Needed because emf_can_be_patrician_heir_if_can_inherit's conditions don't all have on_action stuff associated with them
character_event = {
	id = emf_mr.20
	hide_window = yes
	
	trigger = {
		# Order of checks makes sure that this block is resolved as quickly as possible for those for whom this is not relevant
		has_minor_title = title_commander
		liege = { is_merchant_republic = yes }
		NOT = { has_character_modifier = emf_cancel_commander_monthly_prestige }
		emf_can_be_patrician_heir_if_can_inherit = yes
	}
	
	mean_time_to_happen = {
		days = 1
	}
	
	immediate = {
		add_character_modifier = {
			name = emf_cancel_commander_monthly_prestige
			duration = -1
			hidden = yes
		}
	}
}

# emf_mr.100 - emf_mr.101
#
# Events to promote a Great Councilor patrician to an actual council position
character_event = {
	id = emf_mr.100
	picture = GFX_evt_courtiers_talking
	border = GFX_event_normal_frame_diplomacy
	desc = EVTDESC_ZE_6021
	
	is_triggered_only = yes
	
	immediate = {
		#first, we set a char modifier and check what job the councillor has now
		set_character_flag = swapping_councillors

		#Check how many options we display
		if = {
			limit = {
				event_target:moving_councillor = { can_be_chancellor_trigger = yes }
				OR = {
					AND = {
						ai = no
						primary_title = { NOT = { has_law = protected_appointment_1 } }
					}
					NOT = { job_chancellor = { is_powerful_vassal = yes } }
				}
				OR = {
					ai = no
					NOT = {
						job_chancellor = {
							attribute_diff = {
								character = FROM
								attribute = diplomacy
								value = 0
							}
						}
					}
				}
			}
			set_character_flag = option_1_displayed
		}
		if = {
			limit = {
				event_target:moving_councillor = { can_be_marshal_trigger = yes }
				OR = {
					AND = {
						ai = no
						primary_title = { NOT = { has_law = protected_appointment_1 } }
					}
					NOT = { job_marshal = { is_powerful_vassal = yes } }
				}
				OR = {
					ai = no
					NOT = {
						job_marshal = {
							attribute_diff = {
								character = FROM
								attribute = martial
								value = 0
							}
						}
					}
				}
			}
			set_character_flag = option_2_displayed
		}
		if = {
			limit = {
				event_target:moving_councillor = { can_be_treasurer_trigger = yes }
				OR = {
					AND = {
						ai = no
						primary_title = { NOT = { has_law = protected_appointment_1 } }
					}
					NOT = { job_treasurer = { is_powerful_vassal = yes } }
				}
				OR = {
					ai = no
					NOT = {
						job_treasurer = {
							attribute_diff = {
								character = FROM
								attribute = stewardship
								value = 0
							}
						}
					}
				}
			}
			set_character_flag = option_3_displayed
		}
		if = {
			limit = {
				event_target:moving_councillor = { can_be_spymaster_trigger = yes }
				OR = {
					AND = {
						ai = no
						primary_title = { NOT = { has_law = protected_appointment_1 } }
					}
					NOT = { job_spymaster = { is_powerful_vassal = yes } }
				}
				OR = {
					ai = no
					NOT = {
						job_spymaster = {
							attribute_diff = {
								character = FROM
								attribute = intrigue
								value = 0
							}
						}
					}
				}
			}
			set_character_flag = option_4_displayed
		}
		if = {
			limit = {
				event_target:moving_councillor = {
					can_be_spiritual_trigger = yes
					NOT = { religion_group = muslim }
				}
				OR = {
					AND = {
						ai = no
						primary_title = { NOT = { has_law = protected_appointment_1 } }
					}
					NOT = { job_spiritual = { is_powerful_vassal = yes } }
				}
				OR = {
					ai = no
					NOT = {
						job_spiritual = {
							attribute_diff = {
								character = FROM
								attribute = learning
								value = 0
							}
						}
					}
				}
			}
			set_character_flag = option_5_displayed
		}
	}
	
	option = { #is chancellor a possible swap
		name = EVTOPTA_ZE_6021
		trigger = {
			has_character_flag = option_1_displayed
		}
		if = {
			limit = { job_chancellor = { always = yes } }
			job_chancellor = {
				remove_title = job_chancellor
				save_event_target_as = old_councillor
			}
		}
		event_target:moving_councillor = {
			hidden_tooltip = { emf_remove_great_councilor_title_for_promotion = yes }
			give_job_title = job_chancellor
		}
	}

	option = { #is marshal a possible swap
		name = EVTOPTB_ZE_6021
		trigger = {
			has_character_flag = option_2_displayed
		}
		if = {
			limit = { job_marshal = { always = yes } }
			job_marshal = {
				remove_title = job_marshal
				save_event_target_as = old_councillor
			}
		}
		event_target:moving_councillor = {
			hidden_tooltip = { emf_remove_great_councilor_title_for_promotion = yes }
			give_job_title = job_marshal
		}
	}

	option = { #is treasurer a possible swap
		name = EVTOPTC_ZE_6021
		trigger = {
			has_character_flag = option_3_displayed
		}
		if = {
			limit = { job_treasurer = { always = yes } }
			job_treasurer = {
				remove_title = job_treasurer
				save_event_target_as = old_councillor
			}
		}
		event_target:moving_councillor = {
			hidden_tooltip = { emf_remove_great_councilor_title_for_promotion = yes }
			give_job_title = job_treasurer
		}
	}
	
	option = { #is spymaster a possible swap
		name = EVTOPTD_ZE_6021
		trigger = {
			has_character_flag = option_4_displayed
			OR = {
				ai = yes
				NOT = {
					calc_true_if = {
						amount = 4
						has_character_flag = option_1_displayed
						has_character_flag = option_2_displayed
						has_character_flag = option_3_displayed
						has_character_flag = option_4_displayed
						has_character_flag = option_5_displayed
					}
				}
			}
		}
		if = {
			limit = { job_spymaster = { always = yes } }
			job_spymaster = {
				remove_title = job_spymaster
				save_event_target_as = old_councillor
			}
		}
		event_target:moving_councillor = {
			hidden_tooltip = { emf_remove_great_councilor_title_for_promotion = yes }
			give_job_title = job_spymaster
		}
	}

	option = { #is spiritual a possible swap
		name = EVTOPTE_ZE_6021
		trigger = {
			has_character_flag = option_5_displayed
			OR = {
				ai = yes
				NOT = {
					calc_true_if = {
						amount = 4
						has_character_flag = option_1_displayed
						has_character_flag = option_2_displayed
						has_character_flag = option_3_displayed
						has_character_flag = option_4_displayed
						has_character_flag = option_5_displayed
					}
				}
			}
		}
		if = {
			limit = { job_spiritual = { always = yes } }
			job_spiritual = {
				remove_title = job_spiritual
				save_event_target_as = old_councillor
			}
		}
		event_target:moving_councillor = {
			hidden_tooltip = { emf_remove_great_councilor_title_for_promotion = yes }
			give_job_title = job_spiritual
		}
	}

	option = {
		name = EVTOPTX_ZE_6021
		trigger = {
			ai = no
			calc_true_if = {
				amount = 4
				has_character_flag = option_1_displayed
				has_character_flag = option_2_displayed
				has_character_flag = option_3_displayed
				has_character_flag = option_4_displayed
				has_character_flag = option_5_displayed
			}
		}
		hidden_tooltip = {
			set_character_flag = dont_clear_flag
			character_event = { id = emf_mr.101 }
		}
	}

	option = {
		name = EVTOPTF_ZE_6021
		trigger = { ai = no }
	}
	
	after = {
		if = {
			limit = { NOT = { has_character_flag = dont_clear_flag } }
			clr_character_flag = swapping_councillors
			clr_character_flag = option_1_displayed
			clr_character_flag = option_2_displayed
			clr_character_flag = option_3_displayed
			clr_character_flag = option_4_displayed
			clr_character_flag = option_5_displayed
		}
		clr_character_flag = dont_clear_flag
		event_target:old_councillor = { character_event = { id = emf_mr.13 } }
	}
}

character_event = {
	id = emf_mr.101
	picture = GFX_evt_courtiers_talking
	border = GFX_event_normal_frame_diplomacy
	desc = EVTDESC_ZE_6021

	is_triggered_only = yes
	
	immediate = {
		set_character_flag = swapping_councillors
	}

	option = { #is spymaster a possible swap
		name = EVTOPTD_ZE_6021
		trigger = {
			has_character_flag = option_4_displayed
		}
		if = {
			limit = { job_spymaster = { always = yes } }
			job_spymaster = {
				remove_title = job_spymaster
				save_event_target_as = old_councillor
			}
		}
		event_target:moving_councillor = {
			hidden_tooltip = { emf_remove_great_councilor_title_for_promotion = yes }
			give_job_title = job_spymaster
		}
	}

	option = { #is spiritual a possible swap
		name = EVTOPTE_ZE_6021
		trigger = {
			has_character_flag = option_5_displayed
		}
		if = {
			limit = { job_spiritual = { always = yes } }
			job_spiritual = {
				remove_title = job_spiritual
				save_event_target_as = old_councillor
			}
		}
		event_target:moving_councillor = {
			hidden_tooltip = { emf_remove_great_councilor_title_for_promotion = yes }
			give_job_title = job_spiritual
		}
	}

	option = {
		name = EVTOPTX_ZE_6021
		hidden_tooltip = {
			set_character_flag = dont_clear_flag
			character_event = { id = emf_mr.100 }
		}
	}

	option = {
		name = EVTOPTF_ZE_6021
	}
	
	after = {
		if = {
			limit = { NOT = { has_character_flag = dont_clear_flag } }
			clr_character_flag = swapping_councillors
			clr_character_flag = option_1_displayed
			clr_character_flag = option_2_displayed
			clr_character_flag = option_3_displayed
			clr_character_flag = option_4_displayed
			clr_character_flag = option_5_displayed
		}
		clr_character_flag = dont_clear_flag
		event_target:old_councillor = { character_event = { id = emf_mr.13 } }
	}
}
