# -*- ck2 -*-

namespace = emf_seljuk

##################################
# Rise of the Seljuks
##################################

# All of the Seljuk-related events in mongol_events.txt have been moved here, because they are heavily customized and/or
# not at all present in vanilla.

# emf_seljuk.0 -- Seljuk appears and begins his first adventure [ normal version wherein he is spawned ]
character_event = {
    id = emf_seljuk.0

    hide_window = yes

    religion = hip_religion
    has_global_flag = emf_seljuk_ahistorical_start

    trigger = {
        has_landed_title = e_hip
        NOR = {
            has_global_flag = emf_seljuk_invaded
            has_global_flag = emf_seljuk_spawned
            has_game_rule = { name = turkic_invasions value = off }
            has_game_rule = { name = adventurers value = none }
            has_global_flag = seljuk_spawned # FIXME TMP-SAVE-COMPAT: not set in Hydra3 and beyond, drop after Hydra
        }
        OR = {
            AND = {
                NOT = { has_game_rule = { name = turkic_invasions value = random } }
                year = 965
                NOT = { year = 985 }
            }
            AND = {
                has_game_rule = { name = turkic_invasions value = random }
                year = 809
                NOT = { year = 1200 }
            }
        }
        OR = {
            c_merv = { owner = { top_liege = { emf_seljuk_valid_initial_invasion_target_ruler = yes } } }
            c_dihistan = { owner = { top_liege = { emf_seljuk_valid_initial_invasion_target_ruler = yes } } }
            c_tus = { owner = { top_liege = { emf_seljuk_valid_initial_invasion_target_ruler = yes } } }
        }
    }

    mean_time_to_happen = {
        months = 24
        modifier = {
            factor = 0.5
            year = 970
            NOT = { has_game_rule = { name = turkic_invasions value = random } }
        }
        modifier = {
            factor = 0.25
            year = 975
            NOT = { has_game_rule = { name = turkic_invasions value = random } }
        }
        modifier = {
            factor = 42
            has_game_rule = { name = turkic_invasions value = random }
        }
    }

    immediate = {
        # Pick the target
        emf_seljuk_target_initial_invasion = yes

        if = {
            limit = { NOT = { event_target:seljuk_origin = { always = yes } } }
            log = "ASSERT: emf_seljuk.0: failed to find an origin province in which Seljuk can spawn his troops"
            break = yes
        }

        # Now create Seljuk
        if = {
            limit = { has_global_flag = SWMH }
            create_character = {
                random_traits = no
                historical = yes
                dynasty = 613 # Seljuk
                name = "Seljuk"
                culture = oghuz # SWMH-specific
                religion = sunni
                age = 30
                attributes = {
                    martial = 12
                    diplomacy = 8
                    stewardship = 5
                    intrigue = 4
                    learning = 3
                }
                health = 7
                trait = brilliant_strategist
            }
        }
        else = {
            create_character = {
                random_traits = no
                historical = yes
                dynasty = 613 # Seljuk
                name = "Seljuk"
                culture = turkish
                religion = sunni
                age = 30
                attributes = {
                    martial = 12
                    diplomacy = 8
                    stewardship = 5
                    intrigue = 4
                    learning = 3
                }
                health = 7
                trait = brilliant_strategist
            }
        }
        new_character = {
            add_trait = wroth
            add_trait = cruel
            add_trait = proud
            add_trait = zealous
            add_trait = ambitious
            add_trait = adventurer
            set_dynasty_flag = emf_is_historical
            set_character_flag = emf_seljuk_himself
            emf_new_character = yes
            log = "INFO: emf_seljuk.0: Seljuk (#[This.GetID]) has successfully spawned"
            character_event = { id = emf_seljuk.1 } # spawn family & court
            character_event = { id = emf_seljuk.3 } # create adventurer title & launch invasion
        }
    }
}

# Spawn Seljuk's children and extra courtiers
character_event = {
    id = emf_seljuk.1

    hide_window = yes
    is_triggered_only = yes

    immediate = {
        # Create his sons
        create_character = {
            name="Arslan Esra'íl"
            random_traits = yes
            dynasty = ROOT
            religion = ROOT
            culture = ROOT
            female = no
            age = 5
            genetic_father = ROOT
        }
        create_character = {
            name="Yunus"
            random_traits = yes
            dynasty = ROOT
            religion = ROOT
            culture = ROOT
            female = no
            age = 1
            genetic_father = ROOT
        }
        create_character = {
            name="Miká'íl"
            random_traits = yes
            dynasty = ROOT
            religion = ROOT
            culture = ROOT
            female = no
            age = 0
            genetic_father = ROOT
        }
    }
    after = {
        set_global_flag = emf_seljuk_spawned
    }
}

# emf_seljuk.2 -- A Seljuk is alive and begins his first conquest [ uses historical characters & their progeny ]
character_event = {
    id = emf_seljuk.2

    hide_window = yes

    religion = hip_religion
    has_global_flag = emf_seljuk_historical_start

    trigger = {
        has_landed_title = e_hip
        NOR = {
            year = 1100
            has_global_flag = emf_seljuk_invaded
            has_game_rule = { name = turkic_invasions value = off }
            has_game_rule = { name = adventurers value = none }
            emf_seljuk_invader = { is_alive = yes } # cached trait
        }
        OR = {
            c_merv = { owner = { top_liege = { emf_seljuk_valid_initial_invasion_target_ruler = yes } } }
            c_dihistan = { owner = { top_liege = { emf_seljuk_valid_initial_invasion_target_ruler = yes } } }
            c_tus = { owner = { top_liege = { emf_seljuk_valid_initial_invasion_target_ruler = yes } } }
        }
        c_3030 = { # historical Seljuk
            any_dynasty_member = { emf_seljuk_can_become_invader = yes }
        }
        NOT = {
            any_independent_ruler = {
                emf_seljuk_dynasty = yes
                is_landed = yes
                mercenary = no
                holy_order = no
            }
        }
    }

    mean_time_to_happen = {
        months = 120
        modifier = { factor = 0.5  year = 1020 }
        modifier = { factor = 0.4  year = 1025 }
        modifier = { factor = 0.33 year = 1030 }
        modifier = { factor = 0.25 year = 1035 }
        modifier = { factor = 0.25 year = 1040 }
        modifier = { factor = 0.25 year = 1045 }
        modifier = { factor = 0.1  year = 1050 }
    }

    immediate = {
        c_3038 = { # Tughril-Beg Seljuk
            emf_seljuk_cleanup_potential_invader = yes
            if = {
                limit = {
                    NOT = { event_target:emf_seljuk_invader = { always = yes } }
                    emf_seljuk_can_become_invader = yes
                }
                save_event_target_as = emf_seljuk_invader
                break = yes
            }
        }
        c_3040 = { # Alp Arslan Seljuk
            emf_seljuk_cleanup_potential_invader = yes
            if = {
                limit = {
                    NOT = { event_target:emf_seljuk_invader = { always = yes } }
                    emf_seljuk_can_become_invader = yes
                }
                save_event_target_as = emf_seljuk_invader
                break = yes
            }
        }
        c_3030 = {
            if = { # Seljuk himself
                limit = {
                    NOT = { event_target:emf_seljuk_invader = { always = yes } }
                    emf_seljuk_can_become_invader = yes
                }
                save_event_target_as = emf_seljuk_invader
                break = yes
            }
            random_dynasty_member = {
                limit = {
                    NOT = { event_target:emf_seljuk_invader = { always = yes } }
                    historical = yes
                    emf_seljuk_can_become_invader = yes
                    NOT = {
                        any_dynasty_member = {
                            NOT = { character = PREV }
                            is_older_than = PREV
                            historical = yes
                            emf_seljuk_can_become_invader = yes
                        }
                    }
                }
                save_event_target_as = emf_seljuk_invader
                break = yes
            }
            random_dynasty_member = {
                limit = {
                    NOT = { event_target:emf_seljuk_invader = { always = yes } }
                    emf_seljuk_can_become_invader = yes
                    NOT = {
                        any_dynasty_member = {
                            NOT = { character = PREV }
                            is_older_than = PREV
                            emf_seljuk_can_become_invader = yes
                        }
                    }
                }
                save_event_target_as = emf_seljuk_invader
                break = yes
            }
        }
    }

    option = {
        name = CANCEL
        trigger = { NOT = { event_target:emf_seljuk_invader = { is_alive = yes } } }
        log = "ASSERT: emf_seljuk.2: failed to select a historical Seljuk character: aborting!"
    }

    option = {
        name = OK
        trigger = { event_target:emf_seljuk_invader = { is_alive = yes } }
        event_target:emf_seljuk_invader = { character_event = { id = emf_seljuk.3 } }
    }
}

# emf_seljuk.3 -- continuation of emf_seljuk.2: ROOT is the selected invader
character_event = {
    id = emf_seljuk.3

    is_triggered_only = yes
    hide_window = yes

    immediate = {
        log = "INFO: emf_seljuk.3: a Seljuk, [This.GetTitledName] (#[This.GetID]), has been selected for their initial invasion"

        if = {
            limit = {
                is_ruler = yes
                mercenary = yes
            }
            primary_title = {
                ROOT = { set_character_flag = emf_seljuk_origin_merc_captain_of_@PREV }
            }
        }
        else_if = {
            limit = {
                is_ruler = no
                liege = { mercenary = yes }
            }
            liege = {
                primary_title = {
                    ROOT = { set_character_flag = emf_seljuk_origin_merc_commander_of_@PREV }
                }
            }
        }
        else_if = {
            limit = { independent = no }
            liege = {
                ROOT = { set_character_flag = emf_seljuk_origin_former_vassal_of_@PREV }
            }
        }

        # Abdicate if nec.
        if = {
            limit = { is_ruler = yes }
            emf_abdicate = yes
        }

        # Pick the target
        emf_seljuk_target_initial_invasion = yes

        if = {
            limit = { NOT = { event_target:seljuk_origin = { always = yes } } }
            log = "ASSERT: emf_seljuk.3: failed to find an origin province in which a historical Seljuk can spawn his troops"
            break = yes
        }

        character_event = { id = emf_seljuk.4 } # create adventurer title & launch invasion
    }
}

# emf_seljuk.4 -- launch initial invasion
character_event = {
    id = emf_seljuk.4

    is_triggered_only = yes
    hide_window = yes

    immediate = {
        event_target:seljuk_target_province = { duchy = { save_event_target_as = emf_cb_title } }
        log = "--> origin province (troops spawn here): [seljuk_origin.GetName] (#[seljuk_origin.GetID]/[seljuk_origin.County.GetID])"
        log = "--> target ruler: [seljuk_target_ruler.GetTitledFirstName] [seljuk_target_ruler.GetOnlyDynastyName] (#[seljuk_target_ruler.GetID]/[seljuk_target_ruler.PrimaryTitle.GetID])"
        log = "--> target duchy: [emf_cb_title.GetBaseName] ([emf_cb_title.GetID])"
        wealth = 500
        prestige = 500
        # Give adventurer title and start war
        event_target:seljuk_origin = {
            ROOT = {
                set_defacto_liege = THIS
                create_title = {
                    tier = DUKE
                    landless = yes
                    temporary = yes
                    culture = THIS
                    name = "CLAIMANT_ADVENTURE"
                    holder = THIS
                }
                # Just skip to a feudal government
                emf_switch_to_feudal_gov = yes
                # Become an invader
                emf_seljuk_become_invader = yes
                # Create some extra courtiers
                emf_create_courtiers = yes
                # Spawn mad stax
                emf_seljuk_spawn_initial_unit = yes
                emf_seljuk_spawn_adventure_unit = yes
                emf_seljuk_spawn_adventure_unit = yes
                emf_seljuk_spawn_adventure_unit = yes
                emf_seljuk_spawn_adventure_unit = yes
                emf_seljuk_spawn_adventure_unit = yes
                emf_seljuk_spawn_adventure_unit = yes
                emf_seljuk_spawn_adventure_unit = yes
                # And on to the adventure...
                set_character_flag = do_not_disturb
                set_character_flag = duchy_adventurer
                set_character_flag = emf_cb_pass_tmp
                war = {
                    target = event_target:seljuk_target_ruler
                    casus_belli = emf_seljuk_adventure
                    thirdparty_title = event_target:emf_cb_title
                    infamy = 0
                }
                character_event = { id = emf_seljuk.5 days = 1 } # Ensure that the war was declared and didn't invalidate
            }
        }
    }
}

# emf_seljuk.5 -- war ping event for Seljuks' initial invasion
character_event = {
    id = emf_seljuk.5

    is_triggered_only = yes
    hide_window = yes

    immediate = {
        if = {
            limit = { any_war = { using_cb = emf_seljuk_adventure } }
            log = "INFO: emf_seljuk.5: the initial Seljuk duchy adventure war was successfully declared"
            set_global_flag = emf_seljuk_invaded
        }
        else = {
            log = "ERROR: emf_seljuk.5: the initial Seljuk duchy adventure war was not successfully declared, or it invalidated right away!"
            event_target:seljuk_target_ruler = {
                primary_title = { set_global_flag = emf_seljuk_failed_to_declare_initial_war_on_@THIS }
            }
            event_target:seljuk_target_province = {
                duchy = { set_global_flag = emf_seljuk_failed_to_declare_initial_war_for_@THIS }
            }
        }
    }
}

# Seljuk is successful!
# Fired from the emf_seljuk_adventure CB
narrative_event = {
    id = emf_seljuk.10
    picture = GFX_evt_mongols
    border = GFX_event_narrative_frame_war

    is_triggered_only = yes
    major = yes

    title = {
        trigger = { has_character_flag = emf_seljuk_himself }
        text = emf_seljuk.10.title
    }
    title = {
        trigger = { NOT = { has_character_flag = emf_seljuk_himself } }
        text = emf_seljuk.10.title_descendant
    }
    desc = {
        trigger = { has_character_flag = emf_seljuk_himself }
        text = emf_seljuk.10.desc
    }
    desc = {
        trigger = { NOT = { has_character_flag = emf_seljuk_himself } }
        text = emf_seljuk.10.desc_descendant
    }

    immediate = {
        set_global_flag = emf_seljuk_won_initial_invasion
        prestige = 500
        if = {
            limit = { independent = no }
            set_defacto_liege = ROOT
            emf_liege_change = yes
        }
        if = {
            limit = { NOT = { religion_group = muslim } }
            religion = sunni
        }
        emf_seljuk_spawn_reinforcements = yes
        log = "INFO: emf_seljuk.5: Seljuks win their first war!"
    }

    option = {
        name = emf_seljuk.10.opt.a
        trigger = {
            trait = emf_seljuk_invader
        }
    }
    option = {
        name = emf_seljuk.10.opt.b
        trigger = {
            NOT = { trait = emf_seljuk_invader }
            OR = {
                culture = turkish
                culture = turkmen
                culture = oghuz
                culture = karluk
                culture = cuman
                culture = pecheneg
            }
        }
    }
    option = {
        name = emf_seljuk.10.opt.c
        trigger = {
            NOT = { trait = emf_seljuk_invader }
            NOR = {
                culture = turkish
                culture = turkmen
                culture = oghuz
                culture = karluk
                culture = cuman
                culture = pecheneg
            }
        }
    }
}

# emf_seljuk.11 -- on_death maintenance for the current invader
character_event = {
    id = emf_seljuk.11

    is_triggered_only = yes
    hide_window = yes

    only_playable = yes
    has_character_flag = emf_seljuk_invader
    ai = yes

    trigger = {
        trait = emf_seljuk_invader
    }

    immediate = {
        # TODO: this is going to get a lot more complicated when Islamic Succession Laws == Historical (i.e., Seljuks will
        # follow a custom succession type based upon seniority and merit instead of gavelkind or forced primogeniture)
        current_heir = {
            if = {
                limit = { dynasty = ROOT }
                emf_seljuk_become_invader = yes
                character_event = { id = emf_seljuk.12 days = 1 }
            }
        }
    }
}

# emf_seljuk.12 -- on_death maintenance for the current invader, sent to their heir on the day after their death
character_event = {
    id = emf_seljuk.12

    is_triggered_only = yes
    hide_window = yes

    immediate = {
        if = {
            limit = { independent = no }
            reverse_opinion = { who = LIEGE modifier = opinion_rightful_subjugation }
            set_defacto_liege = ROOT
            emf_liege_change = yes
        }
        if = {
            limit = {
                NOT = { religion_group = muslim }
                FROM = { religion_group = muslim }
            }
            religion = FROM
        }
        else_if = {
            limit = { NOT = { religion_group = muslim } }
            religion = sunni
        }
        character_event = { id = emf_seljuk.20 } # Successor revitalizes the state (if he meets the trigger)
    }
}

# emf_seljuk.20 -- Seljuk's successor revitalizes the new state (i.e., gets reinforcements) -- on_yearly_pulse and
#                  immediately after death of the last invader
character_event = {
    id = emf_seljuk.20
    desc = EVTDESC60207
    picture = GFX_evt_mongols
    border = GFX_event_normal_frame_war

    is_triggered_only = yes
    hide_from = yes

    only_independent = yes
    religion_group = muslim

    trigger = {
        trait = emf_seljuk_invader
        higher_real_tier_than = COUNT
        martial > 6
        NOR = {
            has_character_flag = emf_seljuk_reinforcements
            has_earmarked_regiments = emf_seljuk_event_troops
            year = 1100
            realm_size = 150
            tier = EMPEROR
            trait = blinded
            trait = eunuch
            trait = infirm
            trait = content
            trait = craven
            trait = depressed
            trait = imbecile
        }
    }

    immediate = {
        emf_seljuk_spawn_reinforcements = yes
    }

    option = {
        name = EVTOPTA60207
    }
}

# Event troops no longer needed
character_event = {
    id = emf_seljuk.21
    desc = EVTDESC60208
    picture = GFX_evt_mongols
    border = GFX_event_normal_frame_war

    only_independent = yes
    war = no
    has_character_flag = emf_seljuk_reinforcements

    trigger = {
        tier = EMPEROR
        has_earmarked_regiments = emf_seljuk_event_troops
        realm_size = 150
    }

    mean_time_to_happen = {
        years = 5
    }

    option = {
        name = EVTOPTA60208
        disband_event_forces = emf_seljuk_event_troops
    }
}

# Prompt AI to use the manifest destiny CB
character_event = {
    id = emf_seljuk.30

    hide_window = yes

    only_independent = yes
    min_age = 16
    capable_only = yes
    prisoner = no
    war = no
    ai = yes

    trigger = {
        OR = {
            AND = {
                emf_seljuk_dynasty = yes
                NOT = { year = 1200 }
            }
            dynasty = 800 # Timurids
        }
        wealth = 0
        mercenary = no
        is_tributary = no
        is_ill = no
        has_regent = no
        NOR = {
            realm_size = 300
            trait = content
            trait = humble
            trait = craven
            trait = maimed
            trait = depressed
            trait = infirm
            is_inaccessible_trigger = yes
        }
        any_independent_ruler = {
            is_merchant_republic = no
            reverse_realm_levy_diff = { who = ROOT value = 10000 }
            any_realm_title = {
                tier = COUNT
                location = {
                    region = emf_region_manifest_destiny
                    any_neighbor_province = { owner_under_ROOT = yes }
                }
            }
            NOR = {
                dynasty = ROOT
                same_realm = ROOT
                reverse_has_truce = ROOT
                is_allied_with = ROOT
                has_non_aggression_pact_with = ROOT
                reverse_opinion = { who = ROOT value = 25 }
                pays_tribute_to = ROOT
                ROOT = { pays_tribute_to = PREV }
            }
        }
    }

    mean_time_to_happen = {
        months = 12
    }

    immediate = {
        # First priority
        random_independent_ruler = {
            limit = {
                is_merchant_republic = no
                reverse_realm_levy_diff = { who = ROOT value = 10000 }
                any_realm_title = {
                    tier = COUNT
                    location = {
                        region = emf_region_manifest_destiny_tier_1
                        any_neighbor_province = { owner_under_ROOT = yes }
                    }
                }
                NOR = {
                    dynasty = ROOT
                    same_realm = ROOT
                    reverse_has_truce = ROOT
                    is_allied_with = ROOT
                    has_non_aggression_pact_with = ROOT
                    reverse_opinion = { who = ROOT value = 25 }
                    pays_tribute_to = ROOT
                    ROOT = { pays_tribute_to = PREV }
                }
            }
            save_event_target_as = target_ruler
            random_realm_title = {
                limit = {
                    tier = COUNT
                    location = {
                        region = emf_region_manifest_destiny_tier_1
                        any_neighbor_province = { owner_under_ROOT = yes }
                    }
                }
                kingdom = {
                    ROOT = {
                        war = {
                            casus_belli = manifest_destiny_invasion
                            target = PREVPREVPREV
                            thirdparty_title = PREV
                            infamy = 0
                        }
                    }
                }
                break = yes
            }
        }
        # Second priority
        random_independent_ruler = {
            limit = {
                is_merchant_republic = no
                reverse_realm_levy_diff = { who = ROOT value = 10000 }
                any_realm_title = {
                    tier = COUNT
                    location = {
                        region = emf_region_manifest_destiny_tier_2
                        any_neighbor_province = { owner_under_ROOT = yes }
                    }
                }
                NOR = {
                    dynasty = ROOT
                    same_realm = ROOT
                    reverse_has_truce = ROOT
                    is_allied_with = ROOT
                    has_non_aggression_pact_with = ROOT
                    reverse_opinion = { who = ROOT value = 25 }
                    pays_tribute_to = ROOT
                    ROOT = { pays_tribute_to = PREV }
                }
            }
            save_event_target_as = target_ruler
            random_realm_title = {
                limit = {
                    tier = COUNT
                    location = {
                        region = emf_region_manifest_destiny_tier_2
                        any_neighbor_province = { owner_under_ROOT = yes }
                    }
                }
                kingdom = {
                    ROOT = {
                        war = {
                            casus_belli = manifest_destiny_invasion
                            target = PREVPREVPREV
                            thirdparty_title = PREV
                            infamy = 0
                        }
                    }
                }
                break = yes
            }
        }
        # Third priority
        random_independent_ruler = {
            limit = {
                is_merchant_republic = no
                reverse_realm_levy_diff = { who = ROOT value = 10000 }
                any_realm_title = {
                    tier = COUNT
                    location = {
                        region = emf_region_manifest_destiny_tier_3
                        any_neighbor_province = { owner_under_ROOT = yes }
                    }
                }
                NOR = {
                    dynasty = ROOT
                    same_realm = ROOT
                    reverse_has_truce = ROOT
                    is_allied_with = ROOT
                    has_non_aggression_pact_with = ROOT
                    reverse_opinion = { who = ROOT value = 25 }
                    pays_tribute_to = ROOT
                    ROOT = { pays_tribute_to = PREV }
                }
            }
            save_event_target_as = target_ruler
            random_realm_title = {
                limit = {
                    tier = COUNT
                    location = {
                        region = emf_region_manifest_destiny_tier_3
                        any_neighbor_province = { owner_under_ROOT = yes }
                    }
                }
                kingdom = {
                    ROOT = {
                        war = {
                            casus_belli = manifest_destiny_invasion
                            target = PREVPREVPREV
                            thirdparty_title = PREV
                            infamy = 0
                        }
                    }
                }
                break = yes
            }
        }
    }
}

# Oghuz ruler becomes Turkmen after becoming non-nomadic
character_event = {
    id = emf_seljuk.40
    desc = EVTDESC60220
    picture = GFX_evt_mongols

    only_playable = yes
    culture = oghuz
    min_age = 16
    prisoner = no
    capable_only = yes
    war = no
    has_global_flag = SWMH

    trigger = {
        is_nomadic = no
        OR = {
            independent = yes
            liege = { culture = turkmen }
            liege = { culture = turkish }
            NOT = {
                any_liege = {
                    OR = {
                        culture = turkish
                        culture = turkmen
                        culture = oghuz
                    }
                }
            }
        }
        NOR = {
            is_inaccessible_trigger = yes
            has_character_flag = refuse_culture_conversion
            any_liege = { has_character_flag = refuse_culture_conversion }
        }
    }

    mean_time_to_happen = {
        years = 25
        modifier = {
            factor = 2.0
            NOT = { age = 30 }
        }
        modifier = {
            factor = 0.5
            liege = { culture = turkmen }
        }
        modifier = {
            factor = 0.5
            capital_scope = { culture = turkmen }
        }
        modifier = {
            factor = 0.5
            independent = no
            liege = { independent = no }
            NOT = { any_liege = { NOT = { culture = turkmen } } }
        }
    }

    option = {
        name = EVTOPTA60220 # Convert
        culture = turkmen
        capital_scope = {
            if = {
                limit = {
                    ROOT = { higher_tier_than = BARON }
                    culture = oghuz
                }
                culture = turkmen
            }
        }
        hidden_tooltip = {
            any_courtier = {
                limit = {
                    is_ruler = no
                    culture = oghuz
                    prisoner = no
                    is_incapable = no
                }
                culture = turkmen
            }
            any_vassal = {
                limit = {
                    is_playable = no
                    culture = oghuz
                    prisoner = no
                    is_incapable = no
                }
                culture = turkmen
                any_courtier = {
                    limit = {
                        is_ruler = no
                        culture = oghuz
                        prisoner = no
                        is_incapable = no
                    }
                    culture = turkmen
                }
            }
        }
    }
    option = {
        name = EVTOPTB60220 # Refuse
        trigger = { ai = no }
        set_character_flag = refuse_culture_conversion
    }
}

# Turkmen ruler becomes Turkish if in Anatolia
character_event = {
    id = emf_seljuk.41
    desc = EVTDESC60221
    picture = GFX_evt_mongols

    only_playable = yes
    culture = turkmen
    min_age = 16
    prisoner = no
    capable_only = yes
    war = no
    has_global_flag = SWMH

    trigger = {
        year = 1200
        is_nomadic = no
        is_tribal = no
        capital_scope = { region = world_asia_minor }
        OR = {
            liege = { culture = turkish }
            independent = yes
            NOT = { any_liege = { culture = turkmen } }
        }
        NOR = {
            is_inaccessible_trigger = yes
            has_character_flag = refuse_culture_conversion
            any_liege = { has_character_flag = refuse_culture_conversion }
        }
    }

    mean_time_to_happen = {
        years = 25
        modifier = {
            factor = 2.0
            NOT = { age = 30 }
        }
        modifier = {
            factor = 0.5
            liege = { culture = turkish }
        }
        modifier = {
            factor = 0.5
            capital_scope = { culture = turkish }
        }
        modifier = {
            factor = 0.5
            independent = no
            liege = { independent = no }
            NOT = { any_liege = { NOT = { culture = turkish } } }
        }
    }

    option = {
        name = EVTOPTA60220 # Convert
        culture = turkish
        capital_scope = {
            if = {
                limit = {
                    ROOT = { higher_tier_than = BARON }
                    culture = turkmen
                }
                culture = turkish
            }
        }
        hidden_tooltip = {
            any_courtier = {
                limit = {
                    is_ruler = no
                    culture = turkmen
                    prisoner = no
                    is_incapable = no
                }
                culture = turkish
            }
            any_vassal = {
                limit = {
                    is_playable = no
                    culture = turkmen
                    prisoner = no
                    is_incapable = no
                }
                culture = turkish
                any_courtier = {
                    limit = {
                        is_ruler = no
                        culture = turkmen
                        prisoner = no
                        is_incapable = no
                    }
                    culture = turkish
                }
            }
        }
    }
    option = {
        name = EVTOPTB60220 # Refuse
        trigger = { ai = no }
        set_character_flag = refuse_culture_conversion
    }
}

# emf_seljuk.100 -- startup event [ROOT=isis]
character_event = {
    id = emf_seljuk.100

    is_triggered_only = yes
    hide_window = yes

    immediate = {
        c_3030 = { # Seljuk
            if = {
                limit = { is_alive = yes }
                set_character_flag = emf_seljuk_himself # In case he's picked to invade, for proper narrative event text
            }
        }

        if = {
            limit = { start_date >= 1018.1.1 } # TODO: timeline extension before 1018 will require adjustment
            set_global_flag = emf_seljuk_historical_start
        }
        else = {
            set_global_flag = emf_seljuk_ahistorical_start
        }

        if = {
            limit = {
                any_independent_ruler = {
                    emf_seljuk_dynasty = yes
                    is_landed = yes
                    mercenary = no
                    holy_order = no
                }
            }
            set_global_flag = emf_seljuk_historical_start_landed
            if = {
                limit = {
                    NOT = {
                        any_independent_ruler = {
                            emf_seljuk_dynasty = yes
                            is_landed = yes
                            mercenary = no
                            holy_order = no
                            tier = EMPEROR
                        }
                    }
                }
                c_3038 = { # Tughril-Beg
                    if = {
                        limit = {
                            independent = yes
                            is_landed = yes
                            mercenary = no
                            holy_order = no
                            emf_seljuk_can_become_invader_base = yes
                        }
                        save_event_target_as = emf_seljuk_invader
                        break = yes
                    }
                }
                c_3040 = { # Alp Arslan
                    if = {
                        limit = {
                            independent = yes
                            is_landed = yes
                            mercenary = no
                            holy_order = no
                            emf_seljuk_can_become_invader_base = yes
                        }
                        save_event_target_as = emf_seljuk_invader
                        break = yes
                    }
                }
                c_3042 = { # Malik Shah
                    if = {
                        limit = {
                            independent = yes
                            is_landed = yes
                            mercenary = no
                            holy_order = no
                            emf_seljuk_can_become_invader_base = yes
                        }
                        save_event_target_as = emf_seljuk_invader
                        break = yes
                    }
                }
                random_independent_ruler = {
                    limit = {
                        emf_seljuk_dynasty = yes
                        is_landed = yes
                        mercenary = no
                        holy_order = no
                        emf_seljuk_can_become_invader_base = yes
                        dynasty_head = { character = PREV }
                    }
                    save_event_target_as = emf_seljuk_invader
                    break = yes
                }
                random_independent_ruler = {
                    limit = {
                        emf_seljuk_dynasty = yes
                        is_landed = yes
                        mercenary = no
                        holy_order = no
                        emf_seljuk_can_become_invader_base = yes
                    }
                    save_event_target_as = emf_seljuk_invader
                    break = yes
                }
                random_independent_ruler = {
                    limit = {
                        emf_seljuk_dynasty = yes
                        is_landed = yes
                        mercenary = no
                        holy_order = no
                        dynasty_head = { character = PREV }
                    }
                    save_event_target_as = emf_seljuk_invader
                    break = yes
                }
                random_independent_ruler = {
                    limit = {
                        emf_seljuk_dynasty = yes
                        is_landed = yes
                        mercenary = no
                        holy_order = no
                    }
                    save_event_target_as = emf_seljuk_invader
                    break = yes
                }
            }
        }
    }

    option = {
        name = OK
        event_target:emf_seljuk_invader = {
            log = "INFO: emf_seljuk.100: selected landed, independent Seljuk Invader: [This.GetTitledName] (#[This.GetID]/[This.PrimaryTitle.GetID])"
            emf_seljuk_become_invader = yes
            character_event = { id = emf_seljuk.20 } # Successor revitalizes the state (if he meets the trigger)
        }
    }
}
